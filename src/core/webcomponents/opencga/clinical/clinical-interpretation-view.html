<link rel="import" href="../../../webcomponents/cellbase/variation/cellbase-variantannotation-view.html">
<link rel="import" href="../variant/variant-beacon-network.html">
<!--<link rel="import" href="../variant/variant-genome-browser.html">-->
<link rel="import" href="../../../../genome-browser/webcomponent/genome-browser.html">


<dom-module id="clinical-interpretation-view">

    <template>
        <style include="jso-styles">
            .containerDiv {
                margin-top: 20px;
            }
            .clinical-bottom-tab-title {
                font-size: 115%;
                font-weight: bold;
            }
            .file-metrics-table-FILTER {
                border-bottom: 2px solid #ccc;
            }
        </style>

        <div class="containerDiv">
            <div class="row">

                <div id="{{prefix}}mainIntepretation" class="col-xs-10 col-md-offset-1 col-sm-10 col-md-10 col-lg-10 toppad">

                    <h2 style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-color: #ddd">
                        Interpretation Analysis: {{interpretation.name}}
                    </h2>


                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingTwo">
                                <h4 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo" on-click="_summaryOnClick">
                                        <i id="{{prefix}}SummaryCollapseIcon" class="fa fa-minus-square-o" aria-hidden="true"></i> Summary
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseTwo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo">
                                <div class="panel-body">
                                    <div class="col-md-12">
                                        <div class="col-md-4">
                                            <label>Sample</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">
                                                        {{interpretation.clinicalAnalysis.subject.samples.0.name}} &nbsp;&nbsp; (<a style="font-weight: bold"><i class="fa fa-external-link" aria-hidden="true"></i> Clinical Data</a>)
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">File:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.file.name}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Genome Assembly:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.file.assembly}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Somatic:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.samples.0.somatic}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Phenotypes:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.clinicalAnalysis.subject.samples.0.ontologyTerms}}">
                                                            <span>{{item.name}} (<a href="http://compbio.charite.de/hpoweb/showterm?id={{item.id}}" target="_blank">{{item.id}}</a>)</span>
                                                            <br>
                                                        </template>
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Description:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.samples.0.description}}</span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Subject</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">
                                                        {{interpretation.clinicalAnalysis.subject.name}} &nbsp;&nbsp; (<a style="font-weight: bold"><i class="fa fa-external-link" aria-hidden="true"></i> Clinical Data</a>)
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Sex (karyotype):</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.sex}} &nbsp;&nbsp; ({{interpretation.clinicalAnalysis.subject.karyotypicSex}})</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Date of Birth:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.dateOfBirth}} &nbsp;&nbsp; ({{interpretation.clinicalAnalysis.subject.lifeStatus}})</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Parental Consanguinity:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.parentalConsanguinity}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Phenotypes:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.clinicalAnalysis.subject.ontologyTerms}}">
                                                            <span>{{item.name}} (<a href="http://compbio.charite.de/hpoweb/showterm?id={{item.id}}" target="_blank">{{item.id}}</a>)</span>
                                                            <br>
                                                        </template>
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Description:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.description}}</span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Family</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.family.name}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Phenotypes:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.clinicalAnalysis.family.diseases}}">
                                                            <span>{{item.name}} (<a href="http://compbio.charite.de/hpoweb/showterm?id={{item.id}}" target="_blank">{{item.id}}</a>)</span>
                                                            <br>
                                                        </template>
                                                    </span>
                                                </div>

                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Pedigree:</label>
                                                    <span class="col-md-8">
                                                        <img width="120px" src="https://openi.nlm.nih.gov/imgs/512/160/2743802/PMC2743802_mv-v15-1881-f1.png" style="padding: 10px 10px">
                                                        <br>
                                                        <span>Click <a href="" style="font-weight: bold">here</a> for more info</span>
                                                    </span>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <br>
                                        <div class="col-md-4">
                                            <label>Analysis</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Name (date):</label>
                                                    <span class="col-md-8">{{interpretation.name}} &nbsp; ({{interpretation.creationDate}})</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Type:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.type}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Analyst:</label>
                                                    <span class="col-md-8">{{interpretation.analyst.name}} (<a>{{interpretation.analyst.email}}</a>)</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Description:</label>
                                                    <span class="col-md-8">{{interpretation.description}}</span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Software</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">
                                                        {{interpretation.software.name}} (<a href="{{interpretation.software.website}}" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i> website</a>)
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Version:</label>
                                                    <span class="col-md-8">
                                                        {{interpretation.software.version}} (<a href="{{interpretation.software.repository}}/commit/{{interpretation.software.commit}}" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i> commit</a>)
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 2px">
                                                    <label class="col-md-4">Dependencies:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.versions}}">
                                                            <span>{{item.name}} (v{{item.version}})</span>
                                                        </template>
                                                    </span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Variant Filters</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <template is="dom-repeat" items="{{_toArray(interpretation.filters)}}">
                                                    <div class="form-group" style="margin: 0px 2px">
                                                        <label class="col-md-4">{{item.name}}:</label>
                                                        <span class="col-md-8">{{item.value}}</span>
                                                    </div>
                                                </template>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>

                    <div style="padding-top: 5px">
                        <h2 style="border-bottom-width: 1px;border-bottom-style: solid;border-bottom-color: #ddd">Reported Variants</h2>


                        <div class="panell panel--default">
                            <div class="panel--body">
                                <!--<div class="row">-->
                                <div class="col-md-12" style="padding: 5px 0px 15px 0px">
                                    <div class="btn-toolbar" role="toolbar" aria-label="..." style="float: right">
                                        <!--<div class="btn-group" role="group" aria-label="..." style="padding: 10px 10px">-->
                                        <!--<label style="padding-top: 8px">Filters</label>-->
                                        <!--</div>-->
                                        <div class="btn-group btn-group-sm" role="group" aria-label="..." style="padding: 10px 0px">
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons active" on-click="updateQuery">
                                                All
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                Missense
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                LoF
                                            </button>
                                        </div>

                                        <div class="btn-group btn-group-sm" role="group" aria-label="..." style="padding: 10px 0px">
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons active" on-click="updateQuery">
                                                All
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                SNV
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                INDEL
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                SV
                                            </button>
                                        </div>

                                        <div class="btn-group btn-group-sm" role="group" aria-label="..." style="padding: 10px 0px">
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons active" on-click="updateQuery">
                                                All
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                Tier 1
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                Tier 2
                                            </button>
                                            <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                                Tier 3
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <!--</div>-->
                            </div>
                        </div>

                        <div class="col-md-15" style="padding: 12px 0px 0px 0px">
                            <div id="{{prefix}}ToolbarLeft" class="col-md-6" style="padding: 15px 0px 0px 0px">
                                <span style="padding: 0px 0px 0px 0px">
                                    Showing <label>{{from}}-{{to}}</label> of <label>{{numTotalResultsText}}</label> variants
                                </span>
                            </div>

                            <div class="col-md-6" style="padding: 0px">
                                <div class="form-inline">
                                    <div class="form-group" style="padding: 0px;float: right">
                                        <div class="input-group">
                                            <input type="text" class="form-control" name="date" size="20" placeholder="Search for...">
                                            <span class="input-group-btn">
                                                <button type="button" class="btn btn-default"><i class="fa fa-search" aria-hidden="true"></i></button>
                                            </span>
                                        </div>

                                        <div class="btn-group">
                                            <button type="button" class="btn btn-primary"><i class="fa fa-pencil" aria-hidden="true"></i>&nbsp;&nbsp;Update</button>
                                            <button type="button" class="btn btn-primary"><i class="fa fa-comments-o" aria-hidden="true"></i>&nbsp;&nbsp;Review Case</button>
                                            <button type="button" class="btn btn-primary"><i class="fa fa-file-text-o" aria-hidden="true"></i>&nbsp;&nbsp;Create Report <span class="badge">{{reportVariants.length}}</span></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="{{prefix}}GridTableDiv" style="margin-top: 5px">
                            <table id="{{prefix}}mainTable" data-pagination="true" data-page-list="[5, 10, 25]"
                                   data-show-export="true" data-detail-view="true" data-detail-formatter="detailFormatter">
                                <thead style="background-color: #eee"></thead>
                            </table>
                        </div>
                    </div>


                    <div style="padding-top: 10px">
                        <h3>Variant Detail View: {{variant}}</h3>
                        <!-- Bottom TABs -->
                        <div style="padding-top: 20px">
                            <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active">
                                    <a href="#{{prefix}}Annotation" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                        Current Annotation
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a href="#{{prefix}}Genotype" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                        Genotype Stats
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a href="#{{prefix}}FileMetrics" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                        File Metrics
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a href="#{{prefix}}BeaconNetwork" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                        Beacon Network
                                    </a>
                                </li>
                                <li role="presentation">
                                    <a href="#{{prefix}}GenomeBrowser" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                        Genome Browser
                                    </a>
                                </li>
                            </ul>

                            <div class="tab-content" style="height: 680px">
                                <!-- Current Annotation Tab -->
                                <div role="tabpanel" class="tab-pane active" id="{{prefix}}Annotation">
                                    <cellbase-variantannotation-view data="{{variant}}" prefix="{{prefix}}"
                                                                     cellbase-client="{{cellbaseClient}}"
                                                                     mode="vertical"
                                                                     hash-fragment-credentials="{{hashFragmentCredentials}}"
                                                                     consequence-types="{{consequenceTypes}}"
                                                                     protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                     style="font-size: 12px">
                                    </cellbase-variantannotation-view>
                                </div>

                                <!-- Genotypes & Files Tab -->
                                <div id="{{prefix}}Genotype" role="tabpanel" class="tab-pane">
                                    Under construction.
                                </div>

                                <!-- File Metrics Tab -->
                                <div id="{{prefix}}FileMetrics" role="tabpanel" class="tab-pane">
                                    <div class="col-md-8 col-md-offset-1" style="padding-top: 20px">
                                        <table class="table table-hover">
                                            <thead>
                                            <tr>
                                                <th>VCF Attribute</th>
                                                <template is="dom-repeat" items="{{interpretation.clinicalAnalysis.family.members}}" as="member">
                                                    <th>{{member.name}}</th>
                                                </template>
                                            </tr>
                                            </thead>
                                            <tbody id="{{prefix}}TableTBody">
                                            <template is="dom-repeat" items="{{_getFileMetricsArray(variantObj.studies.0.files)}}" as="attrs">
                                                <tr id="{{attrs.name}}" class$="file-metrics-table-{{attrs.name}}">
                                                    <td><span style="font-weight: bold">{{attrs.name}}</span></td>
                                                    <template is="dom-repeat" items="{{attrs.values}}" as="attr">
                                                        <td>{{attr}}</td>
                                                    </template>
                                                </tr>
                                            </template>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!--Beacon network-->
                                <div role="tabpanel" class="tab-pane" id="{{prefix}}BeaconNetwork">
                                    <br>
                                    <button class="btn btn-primary" type="button" on-click="triggerBeacon">Search Beacon Network</button>
                                    <a data-toggle="tooltip" title="Beacon Network is a search engine across the world's public beacons. You can find it here - https://beacon-network.org/#/">
                                        <i class="fa fa-info-circle" aria-hidden="true"></i>
                                    </a>
                                    <br>
                                    <br>
                                    <variant-beacon-network clear="{{variant}}" variant="{{variantToBeacon}}"></variant-beacon-network>
                                </div>

                                <!-- Genome Browser -->
                                <div role="tabpanel" class="tab-pane" id="{{prefix}}GenomeBrowser">
                                    <div class="" style="padding: 0px 5px">
                                        <!--<variant-genome-browser project="{{project}}" study="{{study}}" samples="{{samples}}" active="{{_genomeBrowserActive}}"-->
                                        <!--opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}" region="{{regionGenomeBrowser}}">-->
                                        <!--</variant-genome-browser>-->
                                        <genome-browser cellbase-client="{{cellbaseClient}}" opencga-client="{{opencgaClient}}"
                                                        species={{species}} region="{{regionGenomeBrowser}}"
                                                        study="{{study}}" project="{{project}}" active="{{_genomeBrowserActive}}">
                                        </genome-browser>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <script>
        class ClinicalInterpretationView extends Polymer.Element {
            constructor() {
                super();
                this.prefix = "clinical-interpretation-" + Utils.randomString(6);
                this.tracks = {
                    sequence: {type: "sequence"},
                    gene: {type: "gene"}
                }
//                this.regionGenomeBrowser= {chromosome: "21", start: 22859462, end: 22859610};
            }
            static get is() {
                return "clinical-interpretation-view";
            }
            static get properties() {
                return {
                    title: {
                        type: String,
                        value: ""
                    },
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object
                    },
                    proteinSubstitutionScores: {
                        type: Object
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    interpretation: {
                        type: Object
                    },
                    species: {
                        type: Object
                    }
                };
            }
            static get observers() {
                return [
                    'projectStudyObtained(project, study)'
                ]
            }
            ready() {
                super.ready();
                this._summaryCollapsed = false;
//                this.samples = ["NA12877"];
                this.variantObj = {};
                this.reportVariants = [];
            }
            _attachDom(dom) {
                this.appendChild(dom);
            }
            connectedCallback() {
                super.connectedCallback();
                this.render();
                let table = $('#' + this.prefix + 'mainTable');
                let _this = this;
                table.on('expand-row.bs.table', function (e, index, row, $detail) {
//                    debugger
                    let res = _this.detailFormatter(index, row);
                    $detail.html(res);
                    console.log('row expanded', e, index);
                });

                // Add click event to "Add to Report" button
                PolymerUtils.querySelectorAll(".interpretation-add-to-report").forEach(elem => elem.addEventListener("click", function (e) {
                    _this.onAddVariantToReport(e.target.dataset.variantId);
                    e.stopPropagation();
                }, true));
            }
            _summaryOnClick() {
                if (this._summaryCollapsed) {
                    $("#" + this.prefix + "SummaryCollapseIcon").removeClass("fa-plus-square-o").addClass("fa-minus-square-o");
                } else {
                    $("#" + this.prefix + "SummaryCollapseIcon").removeClass("fa-minus-square-o").addClass("fa-plus-square-o");
                }
                this._summaryCollapsed = !this._summaryCollapsed;
            }

            onAddVariantToReport(variantId) {
                let _reportVariants = this.reportVariants;
                if (!_reportVariants.includes(variantId)) {
                    PolymerUtils.getElementById("v" + variantId + "ButtonText").innerHTML = "Remove from Report";
                    PolymerUtils.removeClass("v" + variantId + "Button", "btn-success");
                    PolymerUtils.addClass("v" + variantId + "Button", "btn-danger");
                    PolymerUtils.removeClass("v" + variantId + "ButtonIcon", "fa-check");
                    PolymerUtils.addClass("v" + variantId + "ButtonIcon", "fa-times");

                    _reportVariants.push(variantId);
                } else {
                    PolymerUtils.getElementById("v" + variantId + "ButtonText").innerHTML = "Add to Report";
                    PolymerUtils.removeClass("v" + variantId + "Button", "btn-danger");
                    PolymerUtils.addClass("v" + variantId + "Button", "btn-success");
                    PolymerUtils.removeClass("v" + variantId + "ButtonIcon", "fa-times");
                    PolymerUtils.addClass("v" + variantId + "ButtonIcon", "fa-check");

                    let idx = _reportVariants.indexOf(variantId);
                    _reportVariants.splice(idx, 1);
                }
                this.reportVariants = [];
                this.reportVariants = _reportVariants;
            }

            _getFileMetricsArray() {
                if (this.variantObj === undefined || this.variantObj.studies === undefined) {
                    return [];
                }
                let files = this.variantObj.studies[0].files;
                // Let's find all the existing attributes
                let attributesSet = new Set();
                for (let file of files) {
                    for(let attr of Object.keys(file.attributes)) {
                        if (attr !== "QUAL" && attr !== "FILTER") {
                            attributesSet.add(attr);
                        }
                    }
                }
                let attributesArray = Array.from(attributesSet.values()).sort();
                attributesArray.unshift("QUAL", "FILTER");
                // We store the values as: result = [{name: "AC", values: [1, 2, 3, 4]}]
                let result = [];
                for (let attr of attributesArray) {
                    let tmp = {name: attr, values: []};
                    for (let file of files) {
                        tmp.values.push(file.attributes[attr]);
                    }
                    result.push(tmp);
                }
                return result;
            }
            detailFormatter(value, row) {
//                debugger
                let ctHtml = [];
                for (let ct of row.annotation.consequenceTypes) {
                    let x = "<span class='col-md-12' style='padding: 0px'>";
                    if (ct.geneName !== undefined) {
                        x += `<span class='col-md-3'>
                            <span style="font-weight: bold">${ct.geneName}</span> (<a href='http://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g=${ct.ensemblGeneId};r=13:32315474-32400266' target="_blank">${ct.ensemblGeneId}</a>)
                          </span>`;
                        x += `<span class='col-md-3'><a href="http://www.ensembl.org/Homo_sapiens/Transcript/Summary?db=core;t=${ct.ensemblTranscriptId}" target="_blank">${ct.ensemblTranscriptId}</a> (${ct.biotype})</span>`;
                    } else {
                        x += `<span class='col-md-3' style="font-weight: bold">NA</span>`;
                        x += `<span class='col-md-3' style="font-weight: bold">NA</span>`;
                    }
                    x += `<span class='col-md-3'>`;
                    for (let so of ct.sequenceOntologyTerms) {
                        x += `<span><span style="font-weight: bold">${so.name}</span>&nbsp;(${so.accession})</span> `;
                    }
                    x += `</span>`;
                    x += `<span class='col-md-3'>`;
                    if (ct.exonOverlap !== undefined) {
                        x += `<span><span style="font-weight: bold">cDNA:</span> ${ct.cdnaPosition}, <span style="font-weight: bold">CDS:</span> ${ct.cdsPosition}, <span style="font-weight: bold">Codon:</span> ${ct.codon}, <span style="font-weight: bold">Exon:</span> ${ct.exonOverlap[0].number}</span>`;
                    }
                    x += "</span>";
                    x += "</span>";
                    ctHtml.push(x);
                }
                let commentsHtml = [];
                for (let comment of row.comments) {
                    let x = `<span class='col-md-12'>${comment.comment} (${comment.author}, ${comment.date})</span><br>`;
                    commentsHtml.push(x);
                }
                console.log(row.annotation.consequenceTypes)
                let html = `<div class="col-md-12" style="padding: 2px 0px">
                                <div class="col-md-2" style="padding: 0px 5px">
                                    <label>Consequence Type:</label>
                                </div>
                                <div class="col-md-10" style="padding: 0px 5px">
                                    <form class="form-horizontal">
                                        <div class="form-group" style="margin: 0px 2px">
                                            ${ctHtml.join("\n")}
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="col-md-12" style="padding: 2px 0px">
                                <div class="col-md-2" style="padding: 0px 5px">
                                    <label>Comments:</label>
                                </div>
                                <div class="col-md-10" style="padding: 0px 5px">
                                    <form class="form-horizontal">
                                        <div class="form-group" style="margin: 0px 2px">
                                            ${commentsHtml.join("\n")}
                                        </div>
                                    </form>
                                </div>
                            </div>`;
                return html;
            }
            render() {
                this.variant = ""; // Empty the variant every time the grid is loaded
                this.from = 1;
                this.to = Math.min(this.interpretation.reportedVariants.length, 10);
                this.numTotalResultsText = this.interpretation.reportedVariants.length.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                console.log(this.interpretation);
                this.cols = this._refreshTableColumns();
                this._genomeBrowserActive = false;
                this._collapse = false;
                let _this = this;
                let _table = $('#' + this.prefix + 'mainTable');
                $('#' + this.prefix + 'mainTable').bootstrapTable('destroy');
                $("#" + this.prefix + "mainTable").bootstrapTable({
                    data: _this.interpretation.reportedVariants,
                    columns: _this.cols,
                    onPageChange: function (page, size) {
                        _this.from = (page - 1) * size + 1;
                        _this.to = page * size;
                    },
                    onClickRow: function (row, $element) {
                        $('.success').removeClass('success');
                        $($element).addClass('success');
                        _this._onSelectVariant(row);
                        _this._genomeBrowserActive = true;
                        _this.regionGenomeBrowser = new Region({chromosome: row.chromosome, start: row.start, end: row.end});
                    },
                    onPostBody: function (data) {
                        if (UtilsNew.isNotUndefinedOrNull(_table)) {
                            PolymerUtils.querySelector(_table.selector).rows[2].setAttribute('class', 'success');
                            _this._onSelectVariant(data[0]);
                        }
                    }
                });
            }
            _onSelectVariant(row) {
                if (typeof row !== "undefined") {
//                    let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                    this.variant = row.id;
                    this.variantObj = row;
                    this.dispatchEvent(new CustomEvent('selectvariant', {detail: {id: this.variant, variant: row}, bubbles: true, composed: true}));
                }
            }
            projectStudyObtained(project, study) {
                if (typeof this.project !== "undefined" && this.project.alias !== "" && typeof this.study !== "undefined" && this.study.alias !== "") {
                    this.hashFragmentCredentials = {
                        project: this.project.alias,
                        study: this.study.alias
                    };
                }
            }
            variantIdFormatter(value, row, index) {
                let res = "";
                if (UtilsNew.isNotUndefinedOrNull(row.id)) {
                    res += "<label>" + row.id + "</label><br>";
                    if (row.annotation.cytoband !== undefined) {
                        res += "<label>" + row.annotation.cytoband[0].name + "</label><br>";
                    }
                }
                if (UtilsNew.isNotUndefinedOrNull(row.names) && row.names.length > 0) {
                    res += "<label><a href='https://www.ncbi.nlm.nih.gov/projects/SNP/snp_ref.cgi?searchType=adhoc_search&type=rs&rs="
                        + row.names[0]+ "' target='_blank'>dbSNP " + row.names[0] + "</a></label>";
                }
                return res;
            }
            geneFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined") {
                    if (typeof row.annotation !== "undefined" && typeof row.annotation.consequenceTypes !== "undefined" && row.annotation.consequenceTypes.length > 0) {
                        let visited = {};
                        let geneLinks = [];
                        for (let i = 0; i < row.annotation.consequenceTypes.length; i++) {
                            if (typeof row.annotation.consequenceTypes[i].geneName !== "undefined" && row.annotation.consequenceTypes[i].geneName !== ""
                                && typeof visited[row.annotation.consequenceTypes[i].geneName] === "undefined") {
                                if (typeof this.field.context.project !== "undefined" && typeof this.field.context.study !== "undefined") {
                                    geneLinks.push('<a style="cursor: pointer;white-space: nowrap" href="#gene/' + this.field.context.project.alias +'/' +
                                        this.field.context.study.alias + '/' + row.annotation.consequenceTypes[i].geneName + '">' + row.annotation.consequenceTypes[i].geneName + '</a>');
                                } else {
                                    geneLinks.push('<a style="cursor: pointer;white-space: nowrap">' + row.annotation.consequenceTypes[i].geneName + '</a>')
                                }
                                visited[row.annotation.consequenceTypes[i].geneName] = true;
                            }
                        }
                        return geneLinks.join(', ');
                    }
                }
                return '-';
            }
            geneAnnotationFormatter(value, row, index) {
                let val = "<span style='color: red'>missense_variant</span><br>c123T>C";
                return val;
            }
            prediciotnFormatter(value, row, index) {
                let res = "";
                if (UtilsNew.isNotUndefinedOrNull(row.reportEvents)){
                    row.reportEvents.forEach((reportEvent) => {
                        if (UtilsNew.isNotUndefinedOrNull(reportEvent.prediction)) {
                        res += "<label>" + reportEvent.prediction + "</label>";
                    }
                    if (UtilsNew.isNotUndefinedOrNull(reportEvent.score)) {
                        res += " (<label>" + reportEvent.score + "</label>)";
                    }
                });
                }
                return res;
            }
            zigosityFormatter(value, row, index) {
                let res = "";
                if (UtilsNew.isNotUndefinedOrNull(row.studies)) {
                    let left, right;
                    switch (row.studies[0].samplesData[this.field.memberIdx][0]) {
                        case "0/0":
                        case "0|0":
                            left = "white";
                            right = "white";
                            break;
                        case "0/1":
                        case "1/0":
                            left = "black";
                            right = "white";
                            break;
                        case "1/1":
                        case "1|1":
                            left = "black";
                            right = "black";
                            break;
                    }
                    res = `<table>
                                <tr style="padding: 0px;">
                                    <td style="padding: 0px"><div style='width: 15px;height: 15px;border: 1px solid black;border-radius: 50%;background-color: ${left}'></div></td>
                                    <td style="padding: 0px"><div style='width: 15px;height: 15px;border: 1px solid black;border-radius: 50%;background-color: ${right}'></div></td>
                                </tr>
                           </table>`;
                }
                return res;
            }
            fileMetricsFormatter(value, row, index) {
                let val;
                if (row !== undefined && row.studies !== undefined && row.studies.length > 0) {
                    val = `<div class="col-md-12" style="padding: 0px">
                                                <form class="form-horizontal">
                                                    <div class="form-group" style="margin: 0px 2px">
                                                        <label class="col-md-4">Quality:</label>
                                                        <span class="col-md-8">${row.studies[0].files[0].attributes.QUAL}</span>
                                                    </div>
                                                    <div class="form-group" style="margin: 0px 2px">
                                                        <label class="col-md-4">Filter:</label>
                                                        <span class="col-md-8">${row.studies[0].files[0].attributes.FILTER}</span>
                                                    </div>
                                                    <div class="form-group" style="margin: 0px 2px">
                                                        <label class="col-md-4">DP:</label>
                                                        <span class="col-md-8">${row.studies[0].files[0].attributes.DP}</span>
                                                    </div>
                                                </form>
                                            </div>`;
                }
                return val;
            }

            interpretationFormatter(value, row, index) {
                let res = `<button id="v${row.id}Button" type='button' class='btn btn-success btn-xs interpretation-add-to-report' data-variant-id='${row.id}'>
                                <i id="v${row.id}ButtonIcon" class="fa fa-check interpretation-add-to-report" aria-hidden="true" data-variant-id='${row.id}'></i>
                                <span id="v${row.id}ButtonText" class="interpretation-add-to-report" data-variant-id='${row.id}'>Add to Report</span>
                           </button>`;
                return res + "<br><br><span>Comments (" + row.comments.length + ")</span>";
            }
            
            _refreshTableColumns() {
                this.cols = this._createDefaultColumns();
                if (typeof this.cols !== "undefined" && typeof this.interpretation.clinicalAnalysis.family !== "undefined"
                    && Object.keys(this.interpretation.clinicalAnalysis.family.members).length > 0) {
                    let zigosityIdx = 5;
                    let members = this.interpretation.clinicalAnalysis.family.members;
                    this.cols[0].splice(zigosityIdx, 0, {
                        title: "Zigosity",
                        rowspan: 1,
                        colspan: members.length,
                        halign: 'center'
                    });
                    for(let i = 0; i < members.length; i++) {
                        this.cols[1].splice(i, 0, {
                            title: members[i].name,
                            field: {
                                memberIdx: i,
                                memberName: members[i].name,
                            },
                            rowspan: 1,
                            colspan: 1,
                            halign: 'center',
                            formatter: this.zigosityFormatter
                        });
                    }
                }
                return this.cols;
            }
            _createDefaultColumns() {
                return [
                    [
                        {
                            title: "Variant",
                            field: "variant",
                            rowspan: 2,
                            colspan: 1,
                            formatter: this.variantIdFormatter,
                            halign: 'center',
                            sortable: true
                        },
                        {
                            title: "Genes",
                            field: {name: "genes", context: this},
                            rowspan: 2,
                            colspan: 1,
                            halign: 'center',
                            formatter: this.geneFormatter,
                        },
                        {
                            title: "Type",
                            field: "type",
                            rowspan: 2,
                            colspan: 1,
                            halign: 'center'
                        },
                        {
                            title: "Gene Annotation",
                            field: "consequence",
                            rowspan: 2,
                            colspan: 1,
                            formatter: this.geneAnnotationFormatter,
                            halign: 'center'
                        },
                        {
                            title: "Prediction",
                            field: "prediction",
                            rowspan: 2,
                            colspan: 1,
                            halign: 'center',
                            formatter: this.prediciotnFormatter
                        },
                        {
                            title: "Max allele freq",
                            field: "masAllele",
                            rowspan: 2,
                            colspan: 1,
                            halign: 'center'
                        },
                        {
                            title: "File metrics",
                            field: "read",
                            rowspan: 2,
                            colspan: 1,
                            formatter: this.fileMetricsFormatter,
                            halign: 'center'
                        },
                        {
                            title: "Custom Annotations",
                            field: "customAnnotations",
                            rowspan: 2,
                            colspan: 1,
                            halign: 'center'
                        },
                        {
                            title: "Interpretation",
                            field: "interpretation",
                            rowspan: 2,
                            colspan: 1,
                            formatter: this.interpretationFormatter,
                            halign: 'center'
                        }
                    ],
                    []
                ];
            }

            triggerBeacon(e) {
                this.variantToBeacon = this.variant;
            }

            _toArray(obj) {
                return Object.keys(obj).map(function(key) {
                    return {
                        name: key,
                        value: obj[key]
                    };
                });
            }
        }
        customElements.define(ClinicalInterpretationView.is, ClinicalInterpretationView);
    </script>
</dom-module>