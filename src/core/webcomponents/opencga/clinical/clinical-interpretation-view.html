
<link rel="import" href="../../../webcomponents/cellbase/variation/cellbase-variantannotation-view.html">
<link rel="import" href="../variant/variant-beacon-network.html">
<link rel="import" href="../variant/variant-genome-browser.html">

<dom-module id="clinical-interpretation-view">

    <template>
        <style include="jso-styles">
            .containerDiv {
                margin-top: 20px;
            }
            .clinical-bottom-tab-title {
                font-size: 115%;
                font-weight: bold;
            }
        </style>

        <div class="panel" style="margin-bottom: 15px">
            <h3 style="margin: 10px 10px 10px 15px">
                 <span  on-click="onCollapse"  style="cursor: pointer;margin: 0px 30px 0px 0px">
                    <i class="fa fa-bars" aria-hidden="true"></i>
                </span>
                <i class="fa fa-filter" aria-hidden="true"></i>{{title}}
            </h3>
        </div>
        <div class="containerDiv">
            <div class="row">

                <div id="{{prefix}}mainIntepretation" class="col-xs-10  col-md-offset-1 col-sm-10 col-md-10 col-lg-10 toppad">
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingTwo">
                                <h4 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseTwo" aria-expanded="true" aria-controls="collapseTwo">
                                        Interpretation Summary
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseTwo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingTwo">
                                <div class="panel-body">
                                    <div class="col-md-12">
                                        <div class="col-md-4">
                                            <label>Sample</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.samples.0.name}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">File:</label>
                                                    <span class="col-md-8">NA0001.vcf.gz</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Genome Assembly:</label>
                                                    <span class="col-md-8">GRCh38</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Somatic:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.samples.0.somatic}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Phenotypes:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.clinicalAnalysis.subject.samples.0.ontologyTerms}}">
                                                            <span>{{item.name}} (<a href="http://compbio.charite.de/hpoweb/showterm?id={{item.id}}" target="_blank">{{item.id}}</a>)</span>
                                                            <br>
                                                        </template>
                                                    </span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Subject</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.name}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Sex (karyotype):</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.sex}} ({{interpretation.clinicalAnalysis.subject.karyotypicSex}})</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Date of Birth:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.dateOfBirth}} ({{interpretation.clinicalAnalysis.subject.lifeStatus}})</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Parental Consanguinity:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.subject.parentalConsanguinity}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Phenotypes:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.clinicalAnalysis.subject.ontologyTerms}}">
                                                            <span>{{item.name}} (<a href="http://compbio.charite.de/hpoweb/showterm?id={{item.id}}" target="_blank">{{item.id}}</a>)</span>
                                                            <br>
                                                        </template>
                                                    </span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Family</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.family.name}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Phenotypes:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.clinicalAnalysis.family.diseases}}">
                                                            <span>{{item.name}} (<a href="http://compbio.charite.de/hpoweb/showterm?id={{item.id}}" target="_blank">{{item.id}}</a>)</span>
                                                            <br>
                                                        </template>
                                                    </span>
                                                </div>

                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Pedigree:</label>
                                                    <span class="col-md-8">
                                                        <img width="160px" src="https://openi.nlm.nih.gov/imgs/512/160/2743802/PMC2743802_mv-v15-1881-f1.png" style="padding: 10px 10px">
                                                        <br>
                                                        <span>Click <a href="" style="font-weight: bold">here</a> for more info</span>
                                                    </span>
                                                </div>
                                            </form>
                                        </div>
                                    </div>

                                    <div class="col-md-12">
                                        <br>
                                        <div class="col-md-4">
                                            <label>Interpretation Analysis</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Name (date):</label>
                                                    <span class="col-md-8">{{interpretation.name}} ({{interpretation.creationDate}})</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Type:</label>
                                                    <span class="col-md-8">{{interpretation.clinicalAnalysis.type}}</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Analyst:</label>
                                                    <span class="col-md-8">{{interpretation.analyst.name}} (<a>{{interpretation.analyst.email}}</a>)</span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Description:</label>
                                                    <span class="col-md-8">{{interpretation.description}}</span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Software</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Name:</label>
                                                    <span class="col-md-8">
                                                        {{interpretation.software.name}} (<a href="{{interpretation.software.website}}" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i> website</a>)
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Version:</label>
                                                    <span class="col-md-8">
                                                        {{interpretation.software.version}} (<a href="{{interpretation.software.repository}}/commit/{{interpretation.software.commit}}" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i> commit</a>)
                                                    </span>
                                                </div>
                                                <div class="form-group" style="margin: 0px 10px">
                                                    <label class="col-md-4">Dependencies:</label>
                                                    <span class="col-md-8">
                                                        <template is="dom-repeat" items="{{interpretation.versions}}">
                                                            <span>{{item.name}} (v{{item.version}})</span>
                                                        </template>
                                                    </span>
                                                </div>
                                            </form>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Variant Filters</label>
                                            <hr style="margin: 2px 0px;border-top: 2px solid #eee">
                                            <form class="form-horizontal">
                                                <template is="dom-repeat" items="{{_toArray(interpretation.filters)}}">
                                                    <div class="form-group" style="margin: 0px 10px">
                                                        <label class="col-md-4">{{item.name}}:</label>
                                                        <span class="col-md-8">{{item.value}}</span>
                                                    </div>
                                                </template>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>


                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingThree">
                                <h4 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion"
                                       href="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
                                        Reported Variants
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseThree" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingThree">
                                <div class="panel-body">
                                    <div class="btn-group btn-group" role="group" aria-label="..." style="padding: 10px;float: right">
                                        <button type="button" class="btn btn-default btn-warning gene-ct-buttons active" on-click="updateQuery">
                                            All
                                        </button>
                                        <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                            Missense
                                        </button>
                                        <button type="button" class="btn btn-default btn-warning gene-ct-buttons" on-click="updateQuery">
                                            LoF
                                        </button>
                                    </div>

                                    <div id="{{prefix}}ToolbarLeft" style="float: left;margin: 25px 0px 0px 5px">
                                        <span style="font-size: 14px">Showing <label>{{from}}-{{to}}</label> of <label>{{numTotalResultsText}}</label> variants</span>
                                    </div>

                                    <div id="{{prefix}}GridTableDiv" style="margin-top: 10px">
                                        <table id="{{prefix}}mainTable" data-pagination="true" data-page-list="[10, 25]" data-show-export="true">
                                            <thead style="background-color: #eee"></thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom TABs -->
                    <div style="padding-top: 20px">
                        <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
                            <li role="presentation" class="active">
                                <a href="#{{prefix}}Annotation" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                    Current Updated Annotation
                                </a>
                            </li>
                            <li role="presentation">
                                <a href="#{{prefix}}Genotype" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                    Genotype Stats
                                </a>
                            </li>
                            <li role="presentation">
                                <a href="#{{prefix}}BeaconNetwork" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                    Beacon Network
                                </a>
                            </li>
                            <li role="presentation">
                                <a href="#{{prefix}}GenomeBrowser" role="tab" data-toggle="tab" class="clinical-bottom-tab-title">
                                    Genome Browser
                                </a>
                            </li>
                        </ul>

                        <div class="tab-content" style="height: 680px">
                            <!-- Current Annotation Tab -->
                            <div role="tabpanel" class="tab-pane active" id="{{prefix}}Annotation">
                                <cellbase-variantannotation-view data="{{variant}}" prefix="{{prefix}}"
                                                                 cellbase-client="{{cellbaseClient}}"
                                                                 mode="vertical"
                                                                 hash-fragment-credentials="{{hashFragmentCredentials}}"
                                                                 consequence-types="{{consequenceTypes}}"
                                                                 protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                                 style="font-size: 12px">
                                </cellbase-variantannotation-view>
                            </div>

                            <!--Genotypes & Files Tab-->
                            <div role="tabpanel" class="tab-pane" id="{{prefix}}Genotype">
                                Under construction.
                            </div>

                            <!--Beacon network-->
                            <div role="tabpanel" class="tab-pane" id="{{prefix}}BeaconNetwork">
                                <br>
                                <button class="btn btn-primary" type="button" on-click="triggerBeacon">Search Beacon Network</button>
                                <a data-toggle="tooltip" title="Beacon Network is a search engine across the world's public beacons. You can find it here - https://beacon-network.org/#/">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                                <br>
                                <br>
                                <variant-beacon-network clear="{{variant}}" variant="{{variantToBeacon}}"></variant-beacon-network>
                            </div>

                            <!-- Genome Browser -->
                            <div role="tabpanel" class="tab-pane" id="{{prefix}}GenomeBrowser">
                                <div class="" style="padding: 0px 5px">
                                    <variant-genome-browser project="{{project}}" study="{{study}}" samples="{{samples}}" active="{{_genomeBrowserActive}}"
                                                            opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}" region="{{regionGenomeBrowser}}">
                                    </variant-genome-browser>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </template>

    <script>
        class ClinicalInterpretationView extends Polymer.Element {
            constructor() {
                super();
                this.prefix = "clinical-interpretation-" + Utils.randomString(6);
            }
            static get is() {
                return "clinical-interpretation-view";
            }
            static get properties() {
                return {
                    title: {
                        type: String,
                        value: ""
                    },
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object
                    },
                    proteinSubstitutionScores: {
                        type: Object
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    interpretation: {
                        type: Object
                    }
                };
            }
            static get observers() {
                return [
                    'projectStudyObtained(project, study)'
                ]
            }
            ready() {
                super.ready();
            }
            _attachDom(dom) {
                this.appendChild(dom);
            }
            connectedCallback() {
                super.connectedCallback();
                this.render();
            }
            render() {
                this.variant = ""; // Empty the variant every time the grid is loaded
                this.from = 1;
                this.to = Math.min(this.interpretation.reportedVariants.length, 10);
                this.numTotalResultsText = this.interpretation.reportedVariants.length.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                console.log(this.interpretation);
                this.cols = this.loadMainTableColumns();
                this._genomeBrowserActive = false;
                this._collapse = false;
                let _this = this;
                let _table = $('#' + this.prefix + 'mainTable');
                $('#' + this.prefix + 'mainTable').bootstrapTable('destroy');
                $("#" + this.prefix + "mainTable").bootstrapTable({
                    data: _this.interpretation.reportedVariants,
                    columns: _this.cols,
//                    onClickRow: function (row, $element) {
//                        console.log("onClickRow");
//                        _this.variant = row.id;
//
//                        _this._genomeBrowserActive = true;
//                        _this.regionGenomeBrowser = new Region({chromosome: row.chromosome, start: row.start, end: row.end});
//                    },
//                    onLoadSuccess: function (data) {
//                        console.log("onLoadSuccess");
//                    },
                    onPageChange: function (page, size) {
                        _this.from = (page - 1) * size + 1;
                        _this.to = page * size;
                    },
                    onClickRow: function (row, $element) {
                        $('.success').removeClass('success');
                        $($element).addClass('success');
                        _this.variant = row.id;
                        _this._genomeBrowserActive = true;
                        _this.regionGenomeBrowser = new Region({chromosome: row.chromosome, start: row.start, end: row.end});
//                        _this._onSelectVariant(row);
                    },
                    onLoadSuccess: function (data) {
                        // The first time we mark as selected the first row that is rows[2] since the first two rows are the header
                        debugger
                        if (UtilsNew.isNotUndefinedOrNull(_table)) {
                            PolymerUtils.querySelector(_table.selector).rows[1].setAttribute('class', 'success');
                            _this._onSelectVariant(data.rows[0]);
                        }
                    },
                });
            }
            _onSelectVariant(row) {
                if (typeof row !== "undefined") {
                    let _variant = row.chromosome + ":" + row.start + ":" + row.reference + ":" + row.alternate;
                    this.variant = _variant;
                    this.dispatchEvent(new CustomEvent('selectvariant', {detail: {id: _variant, variant: row}}));
                }
            }
            computedLengthComments(comments) {
                return comments.length;
            }
            projectStudyObtained(project, study) {
                if (typeof this.project !== "undefined" && this.project.alias !== "" && typeof this.study !== "undefined" && this.study.alias !== "") {
                    this.hashFragmentCredentials = {
                        project: this.project.alias,
                        study: this.study.alias
                    };
                }
            }
            geneFormatter(value, row, index) {
                if (typeof row !== "undefined" && typeof row.annotation !== "undefined") {
                    if (typeof row.annotation !== "undefined" && typeof row.annotation.consequenceTypes !== "undefined" && row.annotation.consequenceTypes.length > 0) {
                        var visited = {};
                        var geneLinks = [];
                        for (let i = 0; i < row.annotation.consequenceTypes.length; i++) {
                            if (typeof row.annotation.consequenceTypes[i].geneName !== "undefined" && row.annotation.consequenceTypes[i].geneName != ""
                                && typeof visited[row.annotation.consequenceTypes[i].geneName] === "undefined") {
                                if (typeof this.field.context.project !== "undefined" && typeof this.field.context.study !== "undefined") {
                                    geneLinks.push('<a style="cursor: pointer;white-space: nowrap" href="#gene/' + this.field.context.project.alias +'/' +
                                        this.field.context.study.alias + '/' + row.annotation.consequenceTypes[i].geneName + '">' + row.annotation.consequenceTypes[i].geneName + '</a>');
                                } else {
                                    geneLinks.push('<a style="cursor: pointer;white-space: nowrap">' + row.annotation.consequenceTypes[i].geneName + '</a>')
                                }
                                visited[row.annotation.consequenceTypes[i].geneName] = true;
                            }
                        }
                        return geneLinks.join(',');
                    }
                }
                return '-';
            }
            loadMainTableColumns() {
                let _this = this;
                const initCols = [
                    [
                        {
                            title: "Variant",
                            field: "variant",
                            colspan: 1,
                            rowspan: 1,
                            formatter: function (value, row, index) {
                                let res = "";
                                if (UtilsNew.isNotUndefinedOrNull(row.id)){
                                    res += "<label>" + row.id + "</label><br>";
                                }
                                if (UtilsNew.isNotUndefinedOrNull(row.names) && row.names.length > 0) {
                                    res += "<label><a href='https://www.ncbi.nlm.nih.gov/projects/SNP/snp_ref.cgi?searchType=adhoc_search&type=rs&rs="
                                        + row.names[0]+ "' target='_blank'>dbSNP " + row.names[0] + "</a></label>";
                                }
                                return res;
                            },
                            halign: 'center'
                        },
                        {
                            title: "Genes",
                            field: {name: "genes", context: this},
                            colspan: 1,
                            rowspan: 1,
                            halign: 'center',
                            formatter: this.geneFormatter,
                        },
                        {
                            title: "Type",
                            field: "type",
                            colspan: 1,
                            rowspan: 1,
                            halign: 'center'
                        },
                        {
                            title: "Gene Annotation",
                            field: "consequence",
                            colspan: 1,
                            rowspan: 1,
                            formatter: function (value, row, index) {
                                let val = "<span style='color: red'>missense_variant</span><br><br>c123T>C";
                                return val;
                            },
                            halign: 'center'
                        },
                        {
                            title: "Prediction",
                            field: "prediction",
                            colspan: 1,
                            rowspan: 1,
                            halign: 'center',
                            formatter: function (value, row, index) {
                                let res = "";
                                if (UtilsNew.isNotUndefinedOrNull(row.reportEvents)){
                                    row.reportEvents.forEach((reportEvent) => {
                                        if (UtilsNew.isNotUndefinedOrNull(reportEvent.prediction)) {
                                        res += "<label>" + reportEvent.prediction + "</label>";
                                    }
                                    if (UtilsNew.isNotUndefinedOrNull(reportEvent.score)) {
                                        res += " (<label>" + reportEvent.score + "</label>)";
                                    }
                                });
                                }
                                return res;
                            }
                        },
                        {
                            title: "Zigosity",
                            field: "zigosity",
                            colspan: 1,
                            rowspan: 1,
                            formatter: function (value, row, index) {
                                let res = "";
                                if(UtilsNew.isNotUndefinedOrNull(row.calledGenotypes)){
                                    row.calledGenotypes.forEach((genotype) => {
                                        if(UtilsNew.isNotUndefinedOrNull(genotype.genotype)) {
                                        res = res + "<label>" + genotype.genotype + "</label><br>";
                                    }
                                    if(UtilsNew.isNotUndefinedOrNull(genotype.zigosity)){
                                        res = res + "<label>" + genotype.zigosity + "</label>";
                                    }
                                });
                                }
                                return res;
                            },
                            halign: 'center'
                        },
                        {
                            title: "Max allele freq",
                            field: "masAllele",
                            colspan: 1,
                            rowspan: 1,
                            formatter: function (value, row, index) {
                                return value;
                            },
                            halign: 'center'
                        },
                        {
                            title: "File metrics",
                            field: "read",
                            colspan: 1,
                            rowspan: 1,
                            formatter: function (value, row, index) {
                                let val = "<span>DP: 18</span>";
                                return val;
                            },
                            halign: 'center'
                        },
                        {
                            title: "Custom Annotations",
                            field: "customAnnotations",
                            colspan: 1,
                            rowspan: 1,
                            formatter: function (value, row, index) {
                                return value;
                            },
                            halign: 'center'
                        },
                        {
                            title: "Interpretation",
                            field: "interpretation",
                            colspan: 1,
                            rowspan: 1,
                            formatter: function (value, row, index) {
                                let res = "<button type='button' class='btn btn-info'>Add to Report</button>";
                                return res + "<br><span>Comments(" + _this.computedLengthComments(row.comments) + ")</span>"
                            },
                            halign: 'center'
                        },
                    ]
                ];
                return initCols;
            }
            onCollapse() {
                if (this._collapsed) {
//                    $("#" + this.prefix + "FilterMenu").css("display", "inline");
                    $("#" + this.prefix + "filterBrowser").show(400);
                    PolymerUtils.removeClass(this.prefix + "mainIntepretation", ["col-xs-offset-0", "col-sm-offset-0", "col-md-offset-1", "col-lg-offset-1"])
                } else {
//                    $("#" + this.prefix + "FilterMenu").css("display", "none");
                    $("#" + this.prefix + "filterBrowser").hide(400);
                    PolymerUtils.addClass(this.prefix + "mainIntepretation", ["col-xs-offset-0", "col-sm-offset-0", "col-md-offset-1", "col-lg-offset-1"])
                }
                this._collapsed = !this._collapsed;
            }
            triggerBeacon(e) {
                this.variantToBeacon = this.variant;
            }
            _toArray(obj) {
                return Object.keys(obj).map(function(key) {
                    return {
                        name: key,
                        value: obj[key]
                    };
                });
            }
        }
        customElements.define(ClinicalInterpretationView.is, ClinicalInterpretationView);
    </script>
</dom-module>