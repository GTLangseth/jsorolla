<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../variant/variant-sample-grid.html">
<link rel="import" href="../catalog/samples/opencga-sample-filter.html">
<link rel="import" href="../catalog/samples/opencga-family-editor-new.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="../opencga-message-dialog.html">

<dom-module id="variant-clinical-samples">
    <template>
        <style include="jso-styles"></style>

        <div class="panel">
            <div class="col-md-2">
                <opencga-sample-filter study="{{study}}" config="{{config}}" samples="{{samples}}" prefix="{{prefix}}"
                                       opencga-client="{{opencgaClient}}"
                                       query="{{query}}" search="{{search}}">
                </opencga-sample-filter>
            </div>

            <div class="col-md-10">
                <br>
                <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}"
                                        filters="{{config.filters}}" fixed-filters="{{fixedFilters}}"
                                        alias="{{activeFilterAlias}}" refresh="{{search}}" on-clear="onClear"
                                        on-filterchange="onFilterChange"></opencga-active-filters>

                <h3>Sample Results</h3>
                <variant-sample-grid opencga-client="{{opencgaClient}}" study="{{study}}" samples="{{samples}}"
                                     search="{{search}}"></variant-sample-grid>

                <br>
                <h3>Analysis Type</h3>
                <div id="{{prefix}}toolbar">
                    <div class="btn-group btn-group-sm">
                        <button id="familyButton" class="button" on-click="addAnalysis"><img
                                src="[[importPath]]images/analysis_family_button.png" height="60"></button>
                        <button id="trioButton" class="button" on-click="addAnalysis"><img
                                src="[[importPath]]images/analysis_trio_button.png" height="60"></button>
                        <button id="duoButton" class="button" on-click="addAnalysis"><img
                                src="[[importPath]]images/analysis_duo_button.png" height="60"></button>
                        <button id="singleButton" class="button" on-click="addAnalysis"><img
                                src="[[importPath]]images/analysis_single_button.png" height="60"></button>
                        <button id="autoButton" class="button" on-click="addAnalysis"><img
                                src="[[importPath]]images/analysis_auto_button.png" height="60"></button>
                        <!--<button id="multiButton" class="button" on-click="addAnalysis"><img src="images/analysis_multi_button.png" height="60"></button>-->
                    </div>
                </div>
                <br>


                <div style="padding: 10px 0px">
                    <h3>Clinical Analysis</h3>
                    <template is="dom-if" if="{{unsavedAnalysis}}">
                        <div class="alert alert-warning" role="alert" style="margin:0 auto;">There are unsaved
                            analyses!
                        </div>
                    </template>
                    <div id="toolbar">
                        <button id="{{prefix}}DeleteAnalysisButton" class="btn btn-danger disabled"
                                on-click="deleteAnalysis">
                            <i class="fa fa-times"></i>&nbsp;Delete
                        </button>
                    </div>
                    <table id="{{prefix}}tableAnalysis" data-toolbar="#toolbar" data-search="true"
                           data-show-columns="true"
                           data-pagination="true" data-page-size="5" data-page-list="[5, 10, 25]"
                           data-checkbox-header="false" data-maintain-selected="true" style="cursor: pointer;">
                        <thead style="background-color: #eee"></thead>
                    </table>
                </div>

            </div>
        </div>

        <!-- Modal dialog for Family Editor-->
            <div class="modal fade" id="{{prefix}}FamilyEditor" tabindex="-1" role="dialog"
                 aria-labelledby="familyEditorLabel">
                <div class="modal-dialog modal-sm" role="document" style="width: 1300px;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="{{prefix}}FamilyEditorLabel">Family Editor</h4>
                        </div>
                        <div class="modal-body" style="height: 500px">
                            <template is="dom-if" if="{{showModalFamilyEditor}}" restamp="true">

                            <opencga-family-editor-new study="{{study}}" samples="{{_samplesAnalysis}}"
                                                       opencga-client="{{opencgaClient}}" family="{{family}}"
                                                       on-familychange="familyChange"></opencga-family-editor-new>
                            </template>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal" on-click="checkFamily">OK
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        <!-- Modal dialog for warnings -->
        <div class="modal fade" id="{{prefix}}warningModal" tabindex="-1" role="dialog"
             aria-labelledby="warningLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 500px;">
                <div class="modal-content">
                    <div class="modal-header alert alert-danger">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Warning!</h4>
                    </div>
                    <div id="{{prefix}}warningMsgDiv" class="modal-body" style="height: 100px"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <opencga-message-dialog opencga-client="{{opencgaClient}}" show-message-modal="{{showMessageModal}}"
                                settings-message-modal="{{settingsMessageModal}}"></opencga-message-dialog>

    </template>

    <script>
        class VariantClinicalSamples extends Polymer.Element {
            static get is() {
                return 'variant-clinical-samples';
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object,
                        observer: "renderAnalysisTable"
                    },
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object
                    },
                    samples: {
                        type: Array,
                        notify: true
                    },
                    prefix: {
                        type: String
                    },
                    filters: {
                        type: Object,
                        notify: true,
                        observer: "onFilterUpdate"
                    },
                    search: {
                        type: Object,
                        notify: true
                    },
                    config: {
                        type: Object
                    },
                    showMessageModal: {
                        type: Boolean,
                        notify: true
                    },
                    settingsMessageModal: {
                        type: Object,
                        notify: true
                    },
                    analysisChanged: {
                        type: Number,
                        observer: "renderAnalysisTable"
                    }
                }
            }

            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
                if (UtilsNew.isEmpty(this.prefix)) {
                    this.prefix = "sample" + Utils.randomString(6);
                }

                this._numAnalysisSelected = 0;
                this.analysisChanged = 0;
                this.currentAnalysis = {};
                this.selectedRow = -1;
                this.unsavedAnalysis = 0;
                this.fixedFilters = ["studies"];
            }

            renderAnalysisTable() {
                let _this = this;
                $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable('destroy');
                $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable({
                    columns: _this._getTableColumns(),
                    data: _this._analysis,
                    onCheck: function (row, elem) {
                        PolymerUtils.removeClass(_this.prefix + 'DeleteAnalysisButton', 'disabled');
                        _this._numAnalysisSelected++;
                    },
                    onUncheck: function (row, elem) {
                        _this._numAnalysisSelected--;
                        if (_this._numAnalysisSelected <= 0) {
                            PolymerUtils.addClass(_this.prefix + 'DeleteAnalysisButton', 'disabled');
                        }
                    },
                    onClickCell: function (field, value, row, elem) {
                        if (field === "editFamily") { // Only if cell related to family editor is selected, get samples for this analysis to the family editor
                            if (UtilsNew.isNotUndefinedOrNull(row.family)) {
                                _this.family = row.family;
                            } else {
                                _this.initFamily();
                            }
                            _this._samplesAnalysis = row.sampleList;
                            _this.currentAnalysis = row;
                            _this.selectedRow = elem.parent().data("index");
                        } else if (field === "action") { // Only if cell related to save is selected
                            if (row.family !== null) { // If a family is not defined, save can not be achieved
                                _this.saveAnalysis(row);
                            }
                        }
                    }
                });

            }

            initFamily() {
                if (UtilsNew.isNotUndefinedOrNull(this.samples)) {
                    this.family = {};
                    this.family.name = "";
                    this.family.description = "";
                    this.family.diseases = [];
                    this.family.members = [];
                    this.family.annotationSets = [];
//                    this.family.createDate = new Date();
                    this.family.attributes = {};
                    let _this = this;
                    this.samples.forEach((sample) => {
                        _this.family.members[sample.id] = {
                            member: {},
                            father: {},
                            mother: {},
                            diseases: new Set(),
                            carrier: [],
                            parentalConsanguinity: false
                        }
                    });
                }
            }


            connectedCallback() {
                super.connectedCallback();
                this.table = PolymerUtils.getElementById(this.prefix + "FamilySelector");
                this.renderAnalysisTable();
                let _this = this;
                $("#"+this.prefix + "FamilyEditor").on('shown.bs.modal', function (e) {
                    _this.showModalFamilyEditor = true;
                });

                $("#"+this.prefix + "FamilyEditor").on('hidden.bs.modal', function() {
                    _this.showModalFamilyEditor = false;
                });
            }

            /**
             * If filters have been removed, clean the values from the forms.
             */
            onFilterUpdate() {
                this.updateForms(this.filters);
            }

            updateForms(filters) {
                // This is just to avoid entering here when it has just been initialized
                if (this.prefix === undefined) {
                    return;
                }

                let sampleName = PolymerUtils.getElementById(this.prefix + "NameTextarea").value;
                if (!filters.hasOwnProperty("name") && sampleName !== undefined && sampleName.length > 0) {
                    PolymerUtils.setPropertyById(this.prefix + "NameTextarea", "value", "");
                }

                let individual = PolymerUtils.getElementById(this.prefix + "IndividualTextarea").value;
                if (!filters.hasOwnProperty("individual.id") && individual !== undefined && individual.length > 0) {
                    PolymerUtils.setPropertyById(this.prefix + "IndividualTextarea", "value", "");
                }

                if (this.filteredVariables.variables.length > 0) {
                    if (!filters.hasOwnProperty("annotation")) {
                        this.set("filteredVariables.variables", []);
                    } else if (filters.annotation.length < this.filteredVariables.variables.length) {
                        let tmpVariables = [];
                        filters.annotation.forEach(function (variable) {
                            tmpVariables.push(variable);
                        });

                        this.set("filteredVariables.variables", tmpVariables);
                    }
                }
            }

            /**
             * Read from the values in the forms, and sets the filters.
             */
            calculateFilters() {
                let filters = {};
                let sampleName = "";
                let individual = "";

                if (PolymerUtils.getElementById(this.prefix + "NameTextarea") !== null) {
                    sampleName = PolymerUtils.setPropertyById(this.prefix + "NameTextarea", "value", "");

                }
                if (PolymerUtils.getElementById(this.prefix + "IndividualTextarea") !== null) {
                    individual = PolymerUtils.setPropertyById(this.prefix + "IndividualTextarea", "value", "");
                }

                if (sampleName !== undefined && sampleName.length > 0) {
                    filters["name"] = "~" + sampleName;
                }

                if (individual !== undefined && individual.length > 0) {
                    filters["individual.id"] = "~" + individual;
                }

                if (this.filteredVariables.variables !== undefined && this.filteredVariables.variables.length > 0) {
                    let annotations = [];
                    this.filteredVariables.variables.forEach(function (variable) {
                        annotations.push(variable);
                    });
                    filters["annotation"] = annotations;
                }
                this.filters = filters;
            }

            onSearch() {
                // Convert the filters to an objectParam that can be directly send to the sample search
                let filterParams = {};

                let keys = Object.keys(this.filters);
                for (let i = 0; i < keys.length; i++) {
                    if (Array.isArray(this.filters[keys[i]])) {
                        let myArray = this.filters[keys[i]];

                        let myArrayFilter = [];

                        // The elements in the array can be either an object
                        if (Object.getPrototypeOf(myArray[0]) === Object.prototype) {
                            let myArray = this.filters[keys[i]];
                            for (let j = 0; j < myArray.length; j++) {
                                // TODO: We have to check if the value already has an operand
                                myArrayFilter.push(myArray[j].name + "=" + myArray[j].value);
                            }
                        } else {
                            // Or an array of strings or numbers
                            myArrayFilter = this.filters[keys[i]];
                        }

                        filterParams[keys[i]] = myArrayFilter.join(";");
                    } else {
                        filterParams[keys[i]] = this.filters[keys[i]];
                    }
                }

                if (this.filters.hasOwnProperty("annotation")) {
                    // Add the variable set whose annotations will be queried
                    filterParams["variableSetId"] = this.filteredVariables.variableSet;
                }
                this.search = filterParams;
            }

            addAnalysis(e) {

                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                let analysisId = Math.floor(Math.random() * 100) + 1;
                // Get the type of analysisId
                let analysisType = "";
                let _properMembers = -1;
                let _familyEditor = false;

                switch (e.currentTarget.id) {
                    case "familyButton":
                        analysisType = "Family";
                        _properMembers = 4;
                        _familyEditor = true;
                        break;
                    case "trioButton":
                        analysisType = "Trio";
                        _properMembers = 3;
                        _familyEditor = true;
                        break;
                    case "duoButton":
                        analysisType = "Duo";
                        _properMembers = 2;
                        _familyEditor = true;
                        break;
                    case "singleButton":
                        analysisType = "Single";
                        _properMembers = 1;
                        break;
                    case "autoButton":
                        analysisType = "Auto comparative";
                        _properMembers = 2;
                        break;
                    case "multiButton":
                        analysisType = "Multisample";
                        _properMembers = 2;
                        break;
                    default:
                        analysisType = "Family";
                        _properMembers = 4;
                        break;
                }

                if (this.analysisError(analysisType, this.samples.length, _properMembers)) {
                    let fullDate = new Date();
                    let twoDigitMonth = ((fullDate.getMonth().length + 1) === 1) ? (fullDate.getMonth() + 1) : '0' + (fullDate.getMonth() + 1);
                    let currentDate = fullDate.getDate() + "/" + twoDigitMonth + "/" + fullDate.getFullYear();

                    let samplesToShow = "";

                    for (let sampleIdx in this.samples) {
                        samplesToShow = samplesToShow + this.samples[sampleIdx].name + ",";
                    }
                    samplesToShow = samplesToShow.slice(0, -1);

                    let _this = this;

                    // Add analysis to property analysis so that can be used in prioritization
                    // This code will be removed as soon as analysis can be saved

                    let aux = Utils.randomString(6);

                    let _anObject = {
                        analysisID: _this.analysisFormatter("AN-" + analysisId, aux),
                        analysisSamples: samplesToShow,
                        analysisType: analysisType,
                        analysisDate: currentDate,
                        filter: "NO",
                        editFamily: _this.familyFormatter(_familyEditor, aux),
                        action: _this.actionFormatter(_familyEditor, aux),
                        sampleList: this.samples,
                        analysisIDinternal: aux,
                        family: null
                    };

                    if (UtilsNew.isNotUndefined(this._analysis)) {
                        this.push('_analysis', _anObject);
                    }
                    else {
                        this._analysis = [_anObject];
                    }

                    this.analysisChanged++;
                    this.unsavedAnalysis++;
                }
            }

            deleteAnalysis(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                let ids = $.map($(PolymerUtils.getElementById(this.prefix + 'tableAnalysis')).bootstrapTable('getSelections'), function (row) {
                    return row.analysisID;
                });

                $(PolymerUtils.getElementById(this.prefix + 'tableAnalysis')).bootstrapTable('remove', {
                    field: 'analysisID',
                    values: ids
                });
                this.unsavedAnalysis--;
            }

            saveAnalysis(rowInfo) {
//                let children = rowInfo.family.pedigree.children;
//                let _affectedSample = "";
//                for (let i = 0; i < children.length; i++) {
//                    if (children[i].affected) {
//                        _affectedSample = children[i].name;
//                    }
//                }

                let _analysisType = "";
                switch (rowInfo.analysisType) {
                    case "Single":
                        _analysisType = "SINGLE";
                        break;
                    case "Duo":
                        _analysisType = "DUO";
                        break;
                    case "Trio":
                        _analysisType = "TRIO";
                        break;
                    case "Family":
                        _analysisType = "FAMILY";
                        break;
                    case "Auto comparative":
                        _analysisType = "AUTO";
                        break;
                    case "Multisample":
                        _analysisType = "MULTISAMPLE";
                        break;
                }

                if (this.opencgaClient instanceof OpenCGAClient) {
                    // Get family members
//                    let _father = null;
//                    if (UtilsNew.isNotUndefined(rowInfo.family.pedigree.father)) {
//                        for (let j = 0; j < rowInfo.sampleList.length; j++) {
//                            if (rowInfo.family.pedigree.father.name === rowInfo.sampleList[j].name) {
//                                _father = rowInfo.sampleList[j].individual.id;
//                            }
//                        }
//                    }
//
//                    let _mother = null;
//                    if (UtilsNew.isNotUndefined(rowInfo.family.pedigree.mother)) {
//                        for (let j = 0; j < rowInfo.sampleList.length; j++) {
//                            if (rowInfo.family.pedigree.mother.name === rowInfo.sampleList[j].name) {
//                                _mother = rowInfo.sampleList[j].individual.id;
//                            }
//                        }
//                    }
//
//                    let _children = [];
//                    let myChild = rowInfo.family.pedigree.children;
//                    let _sex = "";
//                    for (let i = 0; i < myChild.length; i++) {
//                        for (let j = 0; j < rowInfo.sampleList.length; j++) {
//                            if (myChild[i].name === rowInfo.sampleList[j].name) {
//                                switch (rowInfo.sampleList[j].role) {
//                                    case "son":
//                                        _sex = "MALE";
//                                        break;
//                                    case "daughter":
//                                        _sex = "FEMALE";
//                                        break;
//                                    case "undefined":
//                                        _sex = "UNKNOWN";
//                                        break;
//                                }
//                                _children.push({
//                                    "name": rowInfo.sampleList[j].individual.id,
//                                    "sex": _sex,
//                                    "fatherId": _father,
//                                    "motherId": _mother
//                                });
//                            }
//                        }
//                    }

                    let params = {
                        study: this.project.alias + ":" + this.study.alias
                    };
                    let body = Object.assign({},rowInfo.family);
                    let membersNew =[];
                    body.members.forEach((member) => {
                        let newMember = Object.assign(member);
                        newMember.diseases = Array.from(newMember.diseases)
                        membersNew.push(member);
                    });
                    body.members = membersNew;



                    let _this = this;
                    if(UtilsNew.isUndefinedOrNull(body.id)){
                    this.opencgaClient.families().create(params, body)
                        .then(function (response) {
                            if (response.response[0].numResults >= 1) {
                                $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable('updateRow', {
                                    index: _this.selectedRow, row: {
                                        family: response[0].result[0]
                                    }
                                });
                            }
                            // Create analysis
//                            let analysisInfo = {
//                                analysisID: PolymerUtils.getElementById(_this.prefix + "analysisID" + rowInfo.analysisIDinternal).value,
//                                type: _analysisType,
//                                familyID: rowInfo.family.name,
//                                proband: _children[0].name, // TO BE CHANGED
//                                sample: _affectedSample // TO BE CHANGED
//                            };
//                            _this.createAnalysis(analysisInfo);
                        })
                        .catch(function (response) {
                            _this.settingsMessageModal = {
                                messageHeader: "Error",
                                messageBody: [response.error],
                                type: "danger",
                                height: "100px",
                                width: "500px"
                            };

                            _this.showMessageModal = true;
                        });
                    }else{
//                        this.opencgaClient.families().update(params, body)
//                        .then(function (response) {
//                            // Create analysis
////                            let analysisInfo = {
////                                analysisID: PolymerUtils.getElementById(_this.prefix + "analysisID" + rowInfo.analysisIDinternal).value,
////                                type: _analysisType,
////                                familyID: rowInfo.family.name,
////                                proband: _children[0].name, // TO BE CHANGED
////                                sample: _affectedSample // TO BE CHANGED
////                            };
////                            _this.createAnalysis(analysisInfo);
//                        })
//                        .catch(function (response) {
//                            _this.settingsMessageModal = {
//                                messageHeader: "Error",
//                                messageBody: [response.error],
//                                type: "danger",
//                                height: "100px",
//                                width: "500px"
//                            };
//
//                            _this.showMessageModal = true;
//                        });
                    }
                }
            }

            createAnalysis(analysisInfo) {
                let params = {
                    study: this.project.alias + ":" + this.study.alias
                };
                let body = {
                    "name": analysisInfo.analysisID,
                    "type": analysisInfo.type,
                    "family": analysisInfo.familyID,
                    "proband": analysisInfo.proband,
                    "sample": analysisInfo.sample,
                    "attributes": {
                        "filter": false
                    }
                };
                let _this = this;
                this.opencgaClient.clinical().create(params, body)
                    .then(function (response) {
                        _this.unsavedAnalysis--;
                    })
                    .catch(function (response) {
                        _this.settingsMessageModal = {
                            messageHeader: "Error",
                            messageBody: [response.error],
                            type: "danger",
                            height: "100px",
                            width: "500px"
                        };
                        _this.showMessageModal = true;
                    });
            }

            familyFormatter(familyEditor, randomString) {
                if (familyEditor) {
                    return '<button data-toggle="modal" id="' + this.prefix + 'Editor' + randomString + '" role="button" type="button" class="btn btn-sm btn-success" data-target="#' + this.prefix + 'FamilyEditor" ><i class="fa fa-cog" aria-hidden="true"></i>&nbsp;Edit</button>';
                }
                else { // Is not a family analysis -> a family cannot be edited
                    return '<button data-toggle="modal" id="' + this.prefix + 'Editor' + randomString + '" role="button" type="button" class="btn btn-sm btn-success disabled" data-target="#' + this.prefix + 'FamilyEditor"><i class="fa fa-cog" aria-hidden="true"></i>&nbsp;Edit</button>';
                }
            }

            actionFormatter(familyEditor, randomString) {
                if (familyEditor) {
                    return '<button type="button" id="' + this.prefix + 'Save' + randomString + '" class="btn btn-sm btn-primary" disabled><i class="fa fa-floppy-o" aria-hidden="true"></i>&nbsp;Save</button>';
                }
                else { // If not a family analysis, such analysis can be saved inmediatly
                    return '<button type="button" id="' + this.prefix + 'Save' + randomString + '" class="btn btn-sm btn-primary"><i class="fa fa-floppy-o" aria-hidden="true"></i>&nbsp;Save</button>';
                }
            }

            analysisFormatter(analysisID, randomString) {
                return '<input type="text" id="' + this.prefix + 'analysisID' + randomString + '" class="form-control" value="' + analysisID + '" maxlength="75">';
            }

            analysisError(analysisType, introducedLength, properLength) {
                if ((analysisType === 'Trio' || analysisType === 'Duo' || analysisType === 'Single' || analysisType === 'Auto comparative') && introducedLength != properLength) {
                    PolymerUtils.innerHTML(this.prefix + "warningMsgDiv", "Incorrect number of samples selected (" + introducedLength.toString() + ") for " + analysisType + " analysis (" + properLength.toString() + ")");
                    $(PolymerUtils.getElementById(this.prefix + "warningModal")).modal('show');
                    return false;
                }
                else if ((analysisType === 'Family' || analysisType === 'Multisample') && introducedLength < properLength) {
                    PolymerUtils.innerHTML(this.prefix + "warningMsgDiv", "Incorrect number of samples selected (" + introducedLength.toString() + ") for " + analysisType + " analysis (at least " + properLength.toString() + ")");
                    $(PolymerUtils.getElementById(this.prefix + "warningModal")).modal('show');
                    return false;
                }
                else
                    return true;
            }

            familyChange(e, family) { // Event fired by opencga-family-editor web component
                this.family = family;

            }

            checkFamily(e) {
                e.preventDefault();
                console.log(this.family);


//                let ped = new Pedigree(this.family.pedigree);
                let _this = this;
                $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable('updateRow', {
                    index: _this.selectedRow, row: {
                        family: _this.family
                    }
                });

//                let rowInfo = $(PolymerUtils.getElementById(this.prefix + "tableAnalysis")).bootstrapTable('showRow', {
//                    index: _this.selectedRow, isIdField: false
//                });
//                this.saveAnalysis(rowInfo);
                PolymerUtils.removeAttribute(this.prefix + "Save" + this.currentAnalysis.analysisIDinternal, "disabled");
//                if ((this.currentAnalysis.analysisType === "Duo" && ped.isDuo() && this.family.name != "") ||
//                    (this.currentAnalysis.analysisType === "Trio" && ped.isTrio() && this.family.name != "") ||
//                    (this.currentAnalysis.analysisType === "Family" && ped.isFamily() && this.family.name != "")) {
//
//                }
            }

            _getTableColumns() {
                this._columns = [
                    [
                        {
                            field: 'state',
                            checkbox: true,
                            align: 'center',
                            valign: 'middle'
                        },
                        {
                            field: 'analysisID',
                            title: 'Analysis ID'
                        },
                        {
                            field: 'analysisSamples',
                            title: 'Samples'
                        },
                        {
                            field: 'analysisType',
                            title: 'Analysis type'
                        },
                        {
                            field: 'analysisDate',
                            title: 'Date'
                        },
                        {
                            field: 'filter',
                            title: 'Filter'
                        },
                        {
                            field: 'editFamily',
                            title: 'Family'
                        },
                        {
                            field: 'action',
                            title: 'Action'
                        },
                        {
                            field: 'sampleList',
                            visible: false
                        },
                        {
                            field: 'analysisIDinternal',
                            visible: false
                        },
                        {
                            field: 'family',
                            visible: false
                        }
                    ]
                ];
                return this._columns;
            }

            onClear() {
                this.query = {studies: this.project.alias + ":" + this.study.alias};
                this.search = {};
            }

            onFilterChange(e) {
                this.query = e.detail;
                this.search = e.detail;
            }

            static get observers() {
                return ['calculateFilters(filteredVariables.variables.*)'];
            }
        }

        customElements.define(VariantClinicalSamples.is, VariantClinicalSamples);

    </script>
</dom-module>
