<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="variant-sample-selector.html">
<link rel="import" href="variant-sample-grid.html">
<link rel="import" href="../clinical/variant-clinical-selector.html">
<link rel="import" href="../../commons/variant-modal-ontology.html">


<dom-module id="variant-browser-filter">
    <template>
        <style include="jso-styles">
            span + span {
                margin-left: 10px;
            }

            .browser-ct-scroll {
                max-height: 450px;
                overflow-y: scroll;
            }

            .browser-ct-tree-view,
            .browser-ct-tree-view * {
                padding: 0;
                margin: 0;
                list-style: none;
            }

            .browser-ct-tree-view li ul {
                margin: 0 0 0 22px;
            }

            .browser-ct-tree-view * {
                vertical-align: middle;
            }

            .browser-ct-tree-view {
                /*font-size: 14px;*/
            }

            .browser-ct-tree-view input[type="checkbox"] {
                cursor: pointer;
            }

            .browser-ct-item {
                white-space: nowrap;
                display: inline
            }

            div.block {
                overflow: hidden;
            }

            div.block label {
                width: 80px;
                display: block;
                float: left;
                text-align: left;
                font-weight: normal;
            }

            select + select {
                margin-left: 10px;
            }

            select + input {
                margin-left: 10px;
            }

            .browser-subsection {
                font-size: 1.35rem;
                font-weight: bold;
                padding: 5px 0px;
                color: #444444;
                border-bottom: 1px solid rgba(221, 221, 221, 0.8);
            }

            .subsection-content {
                margin: 5px 5px;
            }

            span.searchingSpan{
                background-color: #286090;
            }
            .searchingButton{
                color: #fff;
            }
            .notbold{
                font-weight: normal;
            }
        </style>

        <div>
            <div style="width: 60%;margin: 0 auto">
                <button type="button" class="btn btn-primary btn-lg" style="width: 100%" on-click="onSearch">
                    <i class="fa fa-search" aria-hidden="true" style="padding: 0px 5px"></i>
                    {{config.filter.searchButtonText}}
                </button>
            </div>

            <br>



            <!--<div id="{{prefix}}FilterMenu">-->
            <div id="FilterMenu">

            </div>




            <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">

                <!-- STUDY filters -->
                <template is="dom-if" if="{{studyFilterVisibility.visible}}">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="{{prefix}}StudiesHeading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                                   href="#{{prefix}}Studies" aria-expanded="true" aria-controls="{{prefix}}Studies">
                                    {{config.filter.study.title}}
                                    <!--<div style="float: right" class="tooltip-div">-->
                                        <!--<a data-toggle="tooltip"-->
                                           <!--title="Use this filter to find variants which are: 1) also present in all of the selected studies below, 2) not present in any of the studies selected below or 3) present in at least one of the studies selected below">-->
                                            <!--<i class="fa fa-info-circle" aria-hidden="true"></i></a>-->
                                    <!--</div>-->
                                </a>
                            </h4>
                        </div>

                        <div id="{{prefix}}Studies" class$="panel-collapse collapse {{collapsed}}" role="tabpanel" aria-labelledby="{{prefix}}StudiesHeading">
                            <div class="panel-body">

                                <!-- Samples sub-section -->
                                <template is="dom-if" if="{{studyFilterVisibility.samples}}">
                                    <div style="padding: 0px 0px 5px 0px">
                                        <div class="browser-subsection">Samples</div>

                                        <template is="dom-if" if="{{config.filter.study.samples.selector}}">
                                            <div style="margin: 10px 5px">
                                                <span>Select Sample:</span>

                                                <!--<div class="form-inline">-->
                                                <!--<div class="form-group">-->
                                                <div class="row">
                                                    <div class="col-md-9">
                                                        <input id="{{prefix}}AutocompleteSampleSearchInput" type="text" class="form-control" placeholder="Search name..."
                                                               list$="{{prefix}}AutocompleteSampleSearchDataList" on-keyup="_autocompleteSampleSearch">
                                                        <datalist id="{{prefix}}AutocompleteSampleSearchDataList">
                                                            <template is="dom-repeat" items="{{autocompleteSampleData}}">
                                                                <option id="{{prefix}}Sample{{item.name}}" value="{{item.name}}" data-sample$="{{item}}">
                                                            </template>
                                                        </datalist>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <button type="button" class="btn btn-default btn-sm form-control" on-click="onSampleChange">
                                                            <i class="fa fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <!--</div>-->
                                                <!--</div>-->
                                            </div>
                                        </template>

                                        <div style="margin: 5px 5px">
                                            <span>Select Sample Genotypes:</span>

                                            <template is="dom-if" if="{{!showSampleGenotypes}}">
                                                <br>
                                                <span style="color: darkred;padding: 5px 0px 0px 10px">No samples selected</span>
                                            </template>

                                            <template is="dom-if" if="{{!showSampleGenotypes}}">
                                                <template is="dom-if" if="{{showFamilySegregationSelector}}">
                                                    <div class="form-inline">
                                                        <div class="form-group" style="margin: 5px 0px">
                                                            <label class="col-md-4" style="padding-left: 8px">Segregation:</label>
                                                            <div class="col-md-8">
                                                                <!--<button class="btn btn-default btn-sm dropdown-toggle" type="button"-->
                                                                <!--id="segregationPrioritizationDropdown" data-toggle="dropdown"-->
                                                                <!--aria-haspopup="true" aria-expanded="true" disabled$="{{isDisabledRadioAnalysisAndSettings()}}">-->
                                                                <!--Select ...-->
                                                                <!--<span class="caret"></span>-->
                                                                <!--</button>-->
                                                                <!--<ul class="dropdown-menu" aria-labelledby="segregationPrioritizationDropdown"-->
                                                                <!--on-click="selectSegregation">-->
                                                                <!--<template is="dom-repeat" items="{{config.segregation}}">-->
                                                                <!--<li><a>{{item}}</a></li>-->
                                                                <!--</template>-->
                                                                <!--</ul>-->

                                                                <select id="{{prefix}}{{study.alias}}{{cohort.id}}CohortOperator2" name="{{cohort.id}}Operator"
                                                                        class$="form-control input-sm {{prefix}}FilterSelect" on-change="selectSegregation" style="width: 150px">
                                                                    <template is="dom-repeat" items="{{config.filter.study.samples.segregation}}">
                                                                        <option value$="{{item}}">{{item}}</option>
                                                                    </template>
                                                                </select>

                                                            </div>
                                                        </div>
                                                    </div>
                                                </template>
                                            </template>


                                            <table id="{{prefix}}SampleGenotypeTable" class="table table-hover" style="margin-bottom: 5px;display: none">
                                                <thead>
                                                <tr>
                                                    <th>Sample</th>
                                                    <th>0/0</th>
                                                    <th>0/1</th>
                                                    <th>1/1</th>
                                                    <th>./.</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <!--<template is="dom-repeat" items="{{samples}}" as="sample">-->
                                                <!--<tr id="{{sample.name}}">-->
                                                <!--<td id="{{prefix}}{{sample.name}}RowName" class$="{{sample.className}}">{{sample.name}}</td>-->
                                                <!--<td><input id="{{prefix}}{{sample.name}}00Checkbox" type="checkbox" value="0/0" data-id$="{{sample.name}}"-->
                                                <!--on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"checked></td>-->
                                                <!--<td><input id="{{prefix}}{{sample.name}}01Checkbox" type="checkbox" value="0/1" data-id$="{{sample.name}}"-->
                                                <!--on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"></td>-->
                                                <!--<td><input id="{{prefix}}{{sample.name}}11Checkbox" type="checkbox" value="1/1" data-id$="{{sample.name}}"-->
                                                <!--on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"></td>-->
                                                <!--<td><input id="{{prefix}}{{sample.name}}MissingCheckbox" type="checkbox" value="./." data-id$="{{sample.name}}"-->
                                                <!--on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"></td>-->
                                                <!--</tr>-->
                                                <!--</template>-->
                                                </tbody>
                                            </table>


                                        </div>
                                    </div>
                                </template>

                                <!-- Cohorts sub-section -->
                                <template is="dom-if" if="{{studyFilterVisibility.cohorts}}">
                                    <div style="padding: 10px 0px">
                                        <div class="browser-subsection">Cohort Stats (MAF)</div>

                                        <template is="dom-if" if="{{!_isNotEmptyArray('_cohorts')}}">
                                            <label style="color: darkred;padding: 10px 0px 0px 15px">No cohorts defined</label>
                                        </template>

                                        <template is="dom-repeat" items="{{_cohorts}}" as="cohort">
                                            <div class="form-horizontal">
                                                <div class="form-group" style="margin: 5px 0px">
                                                    <span class="col-md-4 control-label">{{cohort.name}}</span>
                                                    <div class="col-md-4">
                                                        <select id="{{prefix}}{{study.alias}}{{cohort.id}}CohortOperator" name="{{cohort.id}}Operator"
                                                                class$="form-control input-sm {{prefix}}FilterSelect" on-change="updateQueryFilters" style="padding: 0px 5px">
                                                            <option value="<" selected><</option>
                                                            <option value="<="><=</option>
                                                            <option value=">">></option>
                                                            <option value=">=">>=</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <input type="text" value="" class$="form-control input-sm col-md-4 {{prefix}}FilterTextInput"
                                                               name="{{study.alias}}_{{cohort.id}}" id="{{prefix}}{{study.alias}}{{cohort.id}}Cohort"
                                                               on-keyup="updateQueryFilters">
                                                    </div>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Scores sub-section -->
                                <template is="dom-if" if="{{studyFilterVisibility.scores}}">
                                    <div style="padding: 10px 0px">
                                        <div class="browser-subsection">Variant Scores</div>
                                        <label style="color: darkred;padding: 10px 0px 0px 15px">Coming soon</label>
                                    </div>
                                </template>

                                <!-- Studies sub-section -->
                                <template is="dom-if" if="{{studyFilterVisibility.studies}}">
                                    <div style="padding: 10px 0px">
                                        <div class="browser-subsection">Studies Filter</div>

                                        <div style="margin: 5px 5px">

                                            <select class$="form-control input-sm {{prefix}}FilterSelect" id="includeOtherStudy" style="width: 50%;" on-change="updateQueryFilters">
                                                <option value="in" selected>In (AND)</option>
                                                <!--<option value="not in">Not In</option>-->
                                                <option value="atleast">At least (OR)</option>
                                            </select>

                                            <!--<div class="form-horizontal">-->

                                            <div id="{{prefix}}DifferentStudies" class="form-group">
                                                <!--<div class="checkbox">-->
                                                <!--<label>-->
                                                <br>

                                                <input type="checkbox" value="{{study.alias}}" data-id="{{study.id}}" checked disabled>
                                                <span style="font-weight: bold;font-style: italic;color: darkred">
                                                    {{study.alias}}
                                                </span>
                                                <!--</label>-->
                                                <!--</div>-->
                                                <!--<br>-->
                                                <template is="dom-repeat" items="{{differentStudies}}">
                                                    <!--<div class="checkbox">-->
                                                    <!--<label>-->
                                                    <br>
                                                    <input type="checkbox" value$="{{item.alias}}" data-id="{{item.id}}"
                                                           on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox">
                                                    {{item.alias}}
                                                    <!--<br>-->
                                                    <!--</label>-->
                                                    <!--</div>-->
                                                </template>
                                            </div>
                                            <!--</div>-->
                                        </div>
                                    </div>
                                </template>

                                <!-- Clinical Data sub-section -->
                                <template is="dom-if" if="{{studyFilterVisibility.clinicalData}}">
                                    <div style="padding: 10px 0px">
                                        <div class="browser-subsection">Clinical Data</div>
                                        <label style="color: darkred;padding: 10px 0px 0px 15px">Coming soon</label>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <br>
                <!-- Genomic filter -->
                <!--<div class="panel panel-default">-->
                    <!--<div class="panel-heading" role="tab" id="{{prefix}}PositionHeading">-->
                        <!--<h4 class="panel-title">-->
                            <!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"-->
                               <!--href="#{{prefix}}Position" aria-expanded="true" aria-controls="{{prefix}}Position">-->
                                <!--Genomic-->
                                <!--&lt;!&ndash;<div style="float: right" class="tooltip-div">&ndash;&gt;-->
                                <!--&lt;!&ndash;<a data-toggle="tooltip" title="Set filters related with genomic position, which include genomic intervals, gene and other genomic features, panels, gene biotypes, etc.">&ndash;&gt;-->
                                <!--&lt;!&ndash;<i class="fa fa-info-circle" aria-hidden="true"></i>&ndash;&gt;-->
                                <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                            <!--</a>-->
                        <!--</h4>-->
                    <!--</div>-->
                    <!--<div id="{{prefix}}Position" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}PositionHeading">-->
                        <!--<div class="panel-body">-->

                            <!--<div class="form-group">-->
                                <!--<div class="browser-subsection" id="chromosomalLocationId" name="Chromosomal Location">Chromosomal Location-->
                                    <!--&lt;!&ndash;<div id ="ChromosomalLocationqtip"></div>&ndash;&gt;-->
                                    <!--<div style="float: right" class="tooltip-div">-->
                                    <!--&lt;!&ndash;<a data-toggle="tooltip" title="Filter out variants falling outside the genomic interval(s) defined">&ndash;&gt;-->
                                    <!--<a><i class="fa fa-info-circle" aria-hidden="true" id = "chromosomalLocationTooltip"></i></a>-->
                                    <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="subsection-content">-->
                                    <!--<textarea id="{{prefix}}LocationTextarea" name="location" class$="form-control clearable {{prefix}}FilterTextInput"-->
                                              <!--rows="3" placeholder="3:444-55555,1:1-100000" on-keyup="updateQueryFilters"></textarea>-->
                                <!--</div>-->
                            <!--</div>-->

                            <!--<div class="form-group">-->
                                <!--<div class="browser-subsection" id="featureIdsId" name="Feature Ids">Feature IDs (gene, SNP, ...)-->
                                    <!--<div style="float: right" class="tooltip-div">-->
                                        <!--&lt;!&ndash;<a data-toggle="tooltip" title="Filter out variants falling outside the genomic features (gene, transcript, SNP, etc.) defined">&ndash;&gt;-->
                                            <!--<a><i class="fa fa-info-circle" aria-hidden="true" id = "featureIdsTooltip"></i></a>-->
                                        <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="subsection-content">-->
                                    <!--<div class="row">-->
                                        <!--<div class="col-md-9">-->
                                            <!--<input id="{{prefix}}FeatureIdText" type="text" class="form-control" list="datalist"-->
                                                   <!--placeholder="Search for Gene Symbols" value="" on-keyup="callAutocomplete">-->
                                            <!--<datalist id="datalist">-->
                                                <!--<template is="dom-repeat" items="{{autocompleteData}}">-->
                                                    <!--<option value="{{item.name}}">-->
                                                <!--</template>-->
                                            <!--</datalist>-->
                                        <!--</div>-->
                                        <!--<div class="col-md-3">-->
                                            <!--<button type="button" class="btn btn-default btn-sm form-control" on-click="addFeatureId">-->
                                                <!--<i class="fa fa-plus"></i>-->
                                            <!--</button>-->
                                        <!--</div>-->
                                    <!--</div>-->
                                    <!--<div class="form-group">-->
                                        <!--<textarea id="{{prefix}}FeatureTextarea" name="geneSnp" class$="form-control clearable {{prefix}}FilterTextInput"-->
                                                  <!--rows="3" placeholder="BRCA2,ENSG00000139618,ENST00000544455,rs28897700"-->
                                                  <!--on-keyup="updateQueryFilters" style="margin-top: 5px"></textarea>-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->

                            <!--<div class="form-group">-->
                                <!--<div class="browser-subsection" id="geneDiseasePanelsId" name="Gene Disease Panels">Gene Disease Panels-->
                                    <!--<div style="float: right" class="tooltip-div">-->
                                        <!--&lt;!&ndash;<a data-toggle="tooltip" title="Filter out variants falling outside the genomic intervals (typically genes) defined by the panel(s) chosen">&ndash;&gt;-->
                                            <!--<a><i class="fa fa-info-circle" aria-hidden="true" id = "geneDiseasePanelsTooltip"></i></a>-->
                                        <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="subsection-content">-->
                                    <!--<select class$="form-control {{prefix}}FilterSelect" id="{{prefix}}PanelApps" on-change="onGeneDiseasePanelChange">-->
                                        <!--<option value="none">Select a panel...</option>-->
                                        <!--<template is="dom-repeat" items="{{panelList}}" sort="sortPanelApp">-->
                                            <!--<option value="{{item.name}}">{{item.title}} ({{item.genes.length}})</option>-->
                                        <!--</template>-->
                                    <!--</select>-->
                                    <!--<div style="padding-top: 5px">-->
                                        <!--<textarea id="{{prefix}}PanelAppsTextarea" name="panelAppsTextarea"-->
                                                  <!--class$="form-control clearable {{prefix}}FilterTextInput"-->
                                                  <!--rows="3" placeholder="No panel selected" on-keyup="updateQueryFilters"></textarea>-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->

                            <!--<div class="form-group">-->
                                <!--<div class="browser-subsection" id="geneBiotypeId" name="Gene Biotype">Gene Biotype-->
                                    <!--<div style="float: right" class="tooltip-div">-->
                                        <!--&lt;!&ndash;<a data-toggle="tooltip" title="Only considers variants falling within the specified gene biotypes">&ndash;&gt;-->
                                            <!--<a><i class="fa fa-info-circle" aria-hidden="true" id = "geneBiotypeTooltip"></i></a>-->
                                        <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="subsection-content">-->
                                    <!--<select class="selectpicker form-control" id="{{prefix}}GeneBiotypes" on-change="updateQueryFilters"-->
                                            <!--data-size="10" data-live-search="true" data-selected-text-format="count" multiple>-->
                                        <!--<template is="dom-repeat" items="{{biotypes}}">-->
                                            <!--<option value="{{item}}">{{item}}</option>-->
                                        <!--</template>-->
                                    <!--</select>-->
                                <!--</div>-->
                            <!--</div>-->

                            <!--<div class="form-group" style="margin-bottom: 5px">-->
                                <!--<div class="browser-subsection" id="variantTypeId" name="Variant Type">Variant Type-->
                                    <!--<div style="float: right" class="tooltip-div">-->
                                        <!--&lt;!&ndash;<a data-toggle="tooltip" title="Only considers variants of the selected type">&ndash;&gt;-->
                                            <!--<a><i class="fa fa-info-circle" aria-hidden="true" id = "variantTypeTooltip"></i></a>-->
                                        <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                    <!--</div>-->
                                <!--</div>-->
                                <!--<div class="subsection-content">-->
                                    <!--<div id="{{prefix}}Type">-->
                                        <!--<input type="checkbox" value="SNV,SNP" on-change="updateQueryFilters"-->
                                               <!--class$="{{prefix}}FilterCheckBox"> SNV<br>-->
                                        <!--<input type="checkbox" value="MNV" on-change="updateQueryFilters"-->
                                               <!--class$="{{prefix}}FilterCheckBox"> MNV<br>-->
                                        <!--<input type="checkbox" value="CNV" on-change="updateQueryFilters"-->
                                               <!--class$="{{prefix}}FilterCheckBox"> CNV<br>-->
                                        <!--<input type="checkbox" value="SV" on-change="updateQueryFilters"-->
                                               <!--class$="{{prefix}}FilterCheckBox"> SV<br>-->
                                        <!--<input type="checkbox" value="INDEL" on-change="updateQueryFilters"-->
                                               <!--class$="{{prefix}}FilterCheckBox"> INDEL-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->

                <!--Population Frequency filter-->
                <!--<div class="panel panel-default">-->
                    <!--<div class="panel-heading" role="tab" id="{{prefix}}PopulationFrequencyHeading">-->
                        <!--<h4 class="panel-title">-->
                            <!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"-->
                               <!--href="#{{prefix}}PopulationFrequency" aria-expanded="false" aria-controls="{{prefix}}PopulationFrequency">-->
                                <!--Population Frequency-->
                                <!--&lt;!&ndash;<div style="float: right" class="tooltip-div">&ndash;&gt;-->
                                    <!--&lt;!&ndash;<a data-toggle="tooltip" title="Set filters related with known allelic frequencies in different populations, taken from different databases.">&ndash;&gt;-->
                                        <!--&lt;!&ndash;<i class="fa fa-info-circle" aria-hidden="true"></i>&ndash;&gt;-->
                                    <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                            <!--</a>-->
                        <!--</h4>-->
                    <!--</div>-->
                    <!--<div id="{{prefix}}PopulationFrequency" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}PopulationFrequencyHeading">-->
                        <!--<div class="panel-body">-->

                            <!--&lt;!&ndash; This code create the population frequencies menu filter form populationFrequencies from config.js &ndash;&gt;-->
                            <!--<template is="dom-repeat" items="{{populationFrequencies.studies}}" as="study">-->

                                <!--<div class="subsection-content">-->
                                    <!--<div class="form-group">-->
                                        <!--<div class="browser-subsection">-->
                                            <!--<i id="{{prefix}}{{study.id}}Icon" data-id="{{prefix}}{{study.id}}"-->
                                               <!--on-click="handleCollapseAction" class="fa fa-plus" style="cursor: pointer;padding-right: 10px"></i>-->
                                            <!--{{study.title}}-->
                                            <!--<div style="float: right" class="tooltip-div">-->
                                                <!--<a data-toggle="tooltip" title="{{study.tooltip}}">-->
                                                    <!--<i class="fa fa-info-circle" aria-hidden="true"></i>-->
                                                <!--</a>-->
                                            <!--</div>-->
                                        <!--</div>-->
                                    <!--</div>-->

                                    <!--&lt;!&ndash; If there is not submenu we just display a button &ndash;&gt;-->
                                    <!--<template is="dom-if" if="{{study.populations}}">-->
                                        <!--<div id="{{prefix}}{{study.id}}" class="form-horizontal" hidden>-->
                                            <!--<template is="dom-repeat" items="{{study.populations}}" as="popFreq">-->
                                                <!--<div class="row" style="margin: 5px 0px">-->
                                                    <!--&lt;!&ndash;<label class="browser-popFreqName">{{popFreq.title}}</label>&ndash;&gt;-->
                                                    <!--<span class="col-md-3 control-label" data-toggle="tooltip" data-placement="top" title$="{{popFreq.title}}">{{popFreq.id}}</span>-->
                                                    <!--<div class="col-md-4" style="padding: 0px 10px">-->
                                                        <!--<select id="{{prefix}}{{study.id}}{{popFreq.id}}Operator" name="{{popFreq.id}}Operator"-->
                                                                <!--on-change="updateQueryFilters" class$="form-control input-sm {{prefix}}FilterSelect" style="padding: 0px 5px">-->
                                                            <!--<option value="<" selected><</option>-->
                                                            <!--<option value="<="><=</option>-->
                                                            <!--<option value=">">></option>-->
                                                            <!--<option value=">=">>=</option>-->
                                                        <!--</select>-->
                                                    <!--</div>-->
                                                    <!--<div class="col-md-5" style="padding: 0px 10px">-->
                                                        <!--<input type="text" value="" class$="form-control input-sm {{prefix}}FilterTextInput"-->
                                                               <!--name="{{study.id}}_{{popFreq.id}}" id="{{prefix}}{{study.id}}{{popFreq.id}}"-->
                                                               <!--on-keyup="updateQueryFilters">-->
                                                    <!--</div>-->
                                                <!--</div>-->
                                            <!--</template>-->
                                        <!--</div>-->
                                    <!--</template>-->
                                <!--</div>-->
                            <!--</template>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->

                <!--Protein Substitution Scores filter-->
                <!--<div class="panel panel-default">-->
                    <!--<div class="panel-heading" role="tab" id="{{prefix}}}ProteinSubstitutionScoreHeading">-->
                        <!--<h4 class="panel-title">-->
                            <!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"-->
                               <!--href="#{{prefix}}ProteinSubstitutionScore"-->
                               <!--aria-expanded="false" aria-controls="{{prefix}}ProteinSubstitutionScore">-->
                                <!--Deleteriousness-->
                                <!--&lt;!&ndash;<div style="float: right" class="tooltip-div">&ndash;&gt;-->
                                    <!--&lt;!&ndash;<a data-toggle="tooltip" title="Set filters related with predicted deleterious effect of the variant according to different impact predictors. ">&ndash;&gt;-->
                                        <!--&lt;!&ndash;<a><i class="fa fa-info-circle" aria-hidden="true" id = "scoresTooltip"></i></a>&ndash;&gt;-->
                                    <!--&lt;!&ndash;</a>&ndash;&gt;-->
                                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                            <!--</a>-->
                        <!--</h4>-->
                    <!--</div>-->
                    <!--<div id="{{prefix}}ProteinSubstitutionScore" class="panel-collapse collapse" role="tabpanel"-->
                         <!--aria-labelledby="{{prefix}}ProteinSubstitutionScoreHeading">-->
                        <!--<div class="panel-body">-->
                            <!--<div class="browser-subsection" id = "proteinSubstitutionScoreId" name="Protein Substitution Score">Protein Substitution Score-->
                                <!--&lt;!&ndash; New Tooltip in the sub-section title &ndash;&gt;-->
                                <!--<div style="float: right" class="tooltip-div">-->
                                    <!--<a data-toggle="tooltip"><i class="fa fa-info-circle" aria-hidden="true" id="proteinSubstitutionScoreTooltip"></i></a>-->
                                <!--</div>-->
                            <!--</div>-->

                            <!--<div style="padding-top: 10px">-->
                                <!--<span style="padding-left: 0px;">SIFT</span>-->

                                <!--<div class="row">-->
                                    <!--<div class="col-md-5" style="padding-right: 5px">-->
                                        <!--<select class="options" name="Sift" id="{{prefix}}SiftValues"  on-change="checkScore" class$="{{prefix}}FilterSelect form-control input-sm">-->
                                            <!--<option value="score" selected>Score...</option>-->
                                            <!--<option value="tolerated">Tolerated</option>-->
                                            <!--<option value="deleterious">Deleterious</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-3" style="padding: 0px 5px">-->
                                        <!--<select name="siftOperator" id="{{prefix}}SiftOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect form-control input-sm" style="padding: 0px 5px">-->
                                            <!--<option value="<"><</option>-->
                                            <!--<option value="<="><=</option>-->
                                            <!--<option value=">"selected>></option>-->
                                            <!--<option value=">=">>=</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-4" style="padding-left: 5px">-->
                                        <!--<input id="{{prefix}}SiftInput" name="Sift" type="text" value=""-->
                                               <!--class$="{{prefix}}FilterTextInput form-control input-sm" on-keyup="updateQueryFilters">-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->

                            <!--<div style="padding-top: 15px">-->
                                <!--<span style="padding-top: 10px;padding-left: 0px;">Polyphen</span>-->
                                <!--&lt;!&ndash;<div style="float: right" class="tooltip-div">&ndash;&gt;-->
                                <!--&lt;!&ndash;<a data-toggle="tooltip"&ndash;&gt;-->
                                <!--&lt;!&ndash;title=" Choose, either a Benign/probably damaging qualitative score or provide below a quantitative impact value. Polyphen scores are considered Benign (<0.15), Possibly damaging (0.15-0.85) or Damaging (>0.85)"><i&ndash;&gt;-->
                                <!--&lt;!&ndash;class="fa fa-info-circle" aria-hidden="true"></i></a>&ndash;&gt;-->
                                <!--&lt;!&ndash;</div>&ndash;&gt;-->
                                <!--&lt;!&ndash;<br>&ndash;&gt;-->
                                <!--<div class="row">-->
                                    <!--<div class="col-sm-5" style="padding-right: 5px">-->
                                        <!--<select class="options" name="Polyphen" id="{{prefix}}PolyphenValues" on-change="checkScore" class$="{{prefix}}FilterSelect form-control input-sm">-->
                                            <!--<option value="score" selected>Score...</option>-->
                                            <!--<option value="benign">Benign</option>-->
                                            <!--<option value="unknown">Unknown</option>-->
                                            <!--<option value="possibly damaging">Possibly damaging</option>-->
                                            <!--<option value="probably damaging">Probably damaging</option>-->
                                            <!--<option value="possibly damaging,probably damaging">Possibly & Probably damaging-->
                                            <!--</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-sm-3" style="padding: 0px 5px">-->
                                        <!--<select name="polyphenOperator" id="{{prefix}}PolyphenOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect form-control input-sm" style="padding: 0px 5px">-->
                                            <!--<option value=">" selected>></option>-->
                                            <!--<option value=">=">>=</option>-->
                                            <!--<option value="<" ><</option>-->
                                            <!--<option value="<="><=</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-sm-4" style="padding-left: 5px">-->
                                        <!--<input type="text" value="" class$="{{prefix}}FilterTextInput form-control input-sm"-->
                                               <!--id="{{prefix}}PolyphenInput" name="Polyphen" on-keyup="updateQueryFilters">-->
                                    <!--</div>-->
                                <!--</div>-->

                                <!--<form style="padding-top: 15px">-->
                                    <!--<label style="font-weight: normal;">Logical Operator</label>-->
                                    <!--<input type="radio" name="pss" id="pssOrRadio" value="or" class$="{{prefix}}FilterRadio"-->
                                           <!--checked disabled on-change="updateQueryFilters" style="margin-left: 10px"> OR<br>-->
                                    <!--<input type="radio" name="pss" id="pssAndRadio" value="and"-->
                                           <!--class$="{{prefix}}FilterRadio" disabled on-change="updateQueryFilters"-->
                                           <!--style="margin-left: 102px"> AND<br>-->
                                <!--</form>-->
                                <!--<br>-->
                            <!--</div>-->


                            <!--<div class="browser-subsection" id = "CADDId" name="CADD">CADD-->
                                <!--<div style="float: right" class="tooltip-div">-->
                                <!--<a data-toggle="tooltip">-->
                                <!--&lt;!&ndash;&lt;!&ndash;title="Raw values have relative meaning, with higher values indicating that a variant is more likely to be simulated (or not observed) and therefore more likely to have deleterious effects. If discovering causal variants within an individual, or small groups, of exomes or genomes te use of the scaled CADD score is recommended.">&ndash;&gt;-->
                                <!--<i class="fa fa-info-circle" aria-hidden="true" id ="CADDTooltip"></i></a>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div style="padding-top: 10px">-->

                                <!--<div class="row">-->
                                    <!--<div class="col-md-5 form-group" style="padding-right: 5px">-->
                                        <!--<span class="control-label">Raw</span>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-3" style="padding: 0px 5px">-->
                                        <!--<select name="caddRawOperator" id="{{prefix}}CaddRawOperator"-->
                                                <!--on-change="updateQueryFilters" class$="{{prefix}}FilterSelect form-control input-sm" style="padding: 0px 5px">-->
                                            <!--<option value="<"><</option>-->
                                            <!--<option value="<="><=</option>-->
                                            <!--<option value=">" selected>></option>-->
                                            <!--<option value=">=">>=</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-4" style="padding-left: 5px">-->
                                        <!--<input type="text" value="" class$="{{prefix}}FilterTextInput form-control input-sm"-->
                                               <!--id="{{prefix}}CaddRawInput" name="caddRaw" on-keyup="updateQueryFilters">-->
                                    <!--</div>-->

                                <!--</div>-->
                            <!--</div>-->

                            <!--<div style="padding-top: 10px">-->
                                <!--<div class="row">-->
                                    <!--<span class="col-md-5 control-label" style="padding-right: 5px">Scaled</span>-->
                                    <!--<div class="col-md-3" style="padding: 0px 5px">-->
                                        <!--<select name="caddRScaledOperator" id="{{prefix}}CaddScaledOperator"-->
                                                <!--on-change="updateQueryFilters" class$="{{prefix}}FilterSelect form-control input-sm" style="padding: 0px 5px">-->
                                            <!--<option value="<" selected><</option>-->
                                            <!--<option value="<="><=</option>-->
                                            <!--<option value=">">></option>-->
                                            <!--<option value=">=">>=</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-4" style="padding-left: 5px">-->
                                        <!--<input type="text" value="" class$="{{prefix}}FilterTextInput form-control input-sm"-->
                                               <!--id="{{prefix}}CaddScaledInput" name="caddScaled" on-keyup="updateQueryFilters">-->
                                    <!--</div>-->
                                    <!--&lt;!&ndash;<div style="float: right" class="tooltip-div">&ndash;&gt;-->
                                    <!--&lt;!&ndash;<a data-toggle="tooltip"&ndash;&gt;-->
                                    <!--&lt;!&ndash;title="A scaled C-score of greater of equal 10 indicates that the substitution is predicted to be within the 10% most deleterious substitutions that you can do to the human genome, a score of greater or equal 20 indicates the 1% most deleterious and so on. If you would like to apply a cutoff on deleteriousness, it is suggested by the CADD authors to put a cutoff somewhere between 10 and 20. Maybe at 15, as this also happens to be the median value for all possible canonical splice site changes and non-synonymous variants"><i&ndash;&gt;-->
                                    <!--&lt;!&ndash;class="fa fa-info-circle" aria-hidden="true"></i></a>&ndash;&gt;-->
                                    <!--&lt;!&ndash;</div>&ndash;&gt;-->
                                <!--</div>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->

                <!--Conservation Scores filter-->
                <!--<div class="panel panel-default">-->
                    <!--<div class="panel-heading" role="tab" id="{{prefix}}conservationFilterHeading">-->
                        <!--<h4 class="panel-title">-->
                            <!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"-->
                               <!--href="#{{prefix}}ConservationFilter" aria-expanded="false" aria-controls="{{prefix}}ConservationFilter">-->
                                <!--Conservation-->
                            <!--</a>-->
                        <!--</h4>-->
                    <!--</div>-->
                    <!--<div id="{{prefix}}ConservationFilter" class="panel-collapse collapse" role="tabpanel"-->
                         <!--aria-labelledby="{{prefix}}conservationFilterHeading">-->
                        <!--<div class="panel-body">-->
                            <!--<div class="block container-fluid">-->
                            <!--<div style="padding-top: 10px">-->
                                <!--<div class="row">-->
                                    <!--<span class="col-md-5 control-label" style="padding-right: 5px"> PhyloP</span>-->
                                    <!--<div class="col-md-3" style="padding: 0px 5px">-->
                                        <!--<select name="phylopOperator" id="{{prefix}}PhylopOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect form-control input-sm" style="padding: 0px 5px">-->
                                            <!--<option value="<"><</option>-->
                                            <!--<option value="<="><=</option>-->
                                            <!--<option value=">" selected>></option>-->
                                            <!--<option value=">=">>=</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-4" style="padding-left: 5px">-->
                                        <!--<input type="text" value="" class$="{{prefix}}FilterTextInput form-control input-sm"-->
                                               <!--id="{{prefix}}PhylopInput" name="phylop" on-keyup="updateQueryFilters">-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div style="float: right" class="tooltip-div">-->
                            <!--<a data-toggle="tooltip"-->
                            <!--title="PhyloP scores measure evolutionary conservation at individual alignment sites. The scores are interpreted as follows compared to the evolution expected under neutral drift: positive scores (max 3.0) mean conserved positions and negative scores (min -14.0) indicate positive selection.  PhyloP scores are useful to evaluate signatures of selection at particular nucleotides or classes of nucleotides (e.g., third codon positions, or first positions of miRNA target sites)"><i-->
                            <!--class="fa fa-info-circle" aria-hidden="true"></i></a>-->
                            <!--</div>-->
                            <!--</div>-->
                            <!--<div class="block container-fluid">-->
                            <!--<div style="padding-top: 10px">-->
                                <!--<div class="row">-->
                                    <!--<span class="col-md-5 control-label" style="padding-right: 5px">PhastCons</span>-->
                                    <!--<div class="col-md-3" style="padding: 0px 5px">-->
                                        <!--<select name="phastconsOperator" id="{{prefix}}PhastconsOperator"-->
                                                <!--on-change="updateQueryFilters" class$="{{prefix}}FilterSelect form-control input-sm" style="padding: 0px 5px">-->
                                            <!--<option value="<" ><</option>-->
                                            <!--<option value="<="><=</option>-->
                                            <!--<option value=">" selected>></option>-->
                                            <!--<option value=">=">>=</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-4" style="padding-left: 5px">-->
                                        <!--<input type="text" value="" class$="{{prefix}}FilterTextInput form-control input-sm"-->
                                               <!--id="{{prefix}}PhastconsInput" name="phastCons" on-keyup="updateQueryFilters">-->
                                        <!--&lt;!&ndash;<div style="float: right" class="tooltip-div">&ndash;&gt;-->
                                        <!--&lt;!&ndash;<a data-toggle="tooltip"&ndash;&gt;-->
                                        <!--&lt;!&ndash;title="PhastCons estimates the probability that each nucleotide belongs to a conserved element, based on the multiple alignment. The phastCons scores represent probabilities of negative selection and range between 0 (non-conserved) and 1 (highly conserved)."><i&ndash;&gt;-->
                                        <!--&lt;!&ndash;class="fa fa-info-circle" aria-hidden="true"></i></a>&ndash;&gt;-->
                                        <!--&lt;!&ndash;</div>&ndash;&gt;-->
                                    <!--</div>-->
                                <!--</div>-->
                            <!--</div>-->
                            <!--<div style="padding-top: 10px">-->
                                <!--<div class="row">-->
                                    <!--<span class="col-md-5 control-label" style="padding-right: 5px">Gerp</span>-->
                                    <!--<div class="col-md-3" style="padding: 0px 5px">-->
                                        <!--<select name="gerpOperator" id="{{prefix}}GerpOperator" on-change="updateQueryFilters"-->
                                                <!--class$="{{prefix}}FilterSelect form-control input-sm" style="padding: 0px 5px">-->
                                            <!--<option value="<"><</option>-->
                                            <!--<option value="<="><=</option>-->
                                            <!--<option value=">" selected>></option>-->
                                            <!--<option value=">=">>=</option>-->
                                        <!--</select>-->
                                    <!--</div>-->
                                    <!--<div class="col-md-4" style="padding-left: 5px">-->
                                        <!--<input type="text" value="" class$="{{prefix}}FilterTextInput form-control input-sm"-->
                                               <!--id="{{prefix}}GerpInput" name="gerp" on-keyup="updateQueryFilters">-->
                                        <!--&lt;!&ndash;<div style="float: right" class="tooltip-div">&ndash;&gt;-->
                                        <!--&lt;!&ndash;<a data-toggle="tooltip"&ndash;&gt;-->
                                        <!--&lt;!&ndash;title="Genomic Evolutionary Rate Profiling (GERP) score estimate the level of conservation of positions . Scores ≥ 2 indicate evolutionary constraint to and ≥ 3 indicate purifying selection."><i&ndash;&gt;-->
                                        <!--&lt;!&ndash;class="fa fa-info-circle" aria-hidden="true"></i></a>&ndash;&gt;-->
                                        <!--&lt;!&ndash;</div>&ndash;&gt;-->
                                    <!--</div>-->
                                <!--</div>-->

                                <!--<form style="padding-top: 15px">-->
                                    <!--<label style="font-weight: normal;">Logical Operator</label>-->
                                    <!--<input type="radio" name="conservation" id="conservationOrRadio" value="or"-->
                                           <!--class$="{{prefix}}FilterRadio" checked disabled on-change="updateQueryFilters" style="margin-left: 10px"> OR<br>-->
                                    <!--<input type="radio" name="conservation" id="conservationAndRadio" value="and"-->
                                           <!--class$="{{prefix}}FilterRadio" disabled on-change="updateQueryFilters" style="margin-left: 102px"> AND<br>-->
                                <!--</form>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->

                <!--Consequence Type filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}ConsequenceTypeHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                               href="#{{prefix}}ConsequenceType" aria-expanded="false" aria-controls="{{prefix}}ConsequenceType">
                                Consequence Type
                                <!--<div style="float: right" class="tooltip-div">-->
                                <!--<a data-toggle="tooltip" title="Only considers variants falling in the specified gene regions and with the specified effect, as defined by the consequence types">-->
                                <!--<i class="fa fa-info-circle" aria-hidden="true"></i>-->
                                <!--</a>-->
                                <!--</div>-->
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}ConsequenceType" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}consequenceTypeHeading">
                        <div class="panel-body browser-ct-scroll">
                            <div class="form-group">
                                <div class="browser-subsection">Loss-of-Function (LoF) terms</div>
                                <div class="form-check" style="margin-top: 5px;">
                                    <div class="form-check-label">

                                        <label id="{{prefix}}LossOfFunctionCheckBoxLabel" class="notbold">
                                            <input id="{{prefix}}LossOfFunctionCheckBox" type="checkbox"
                                                   class$="{{prefix}}FilterCheckBox form-check-input" on-change="updateConsequenceTypeFilter">
                                            LoF terms</label>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="browser-subsection">Consequence Type terms</div>

                                <div class="browser-ct-tree-view browser-ct-item">
                                    <ul id="{{prefix}}consequenceTypeFilter">
                                        <template is="dom-repeat" items="{{consequenceTypes.categories}}" as="category">
                                            <li id="{{category.title}}" class="form-check" style="margin-top: 10px;">
                                                <!--First check if there is a title for that category-->
                                                <template is="dom-if" if="{{checkTitle(category)}}">
                                                    <!--If it is a category, only title is shown as it doesn't have any SO term associated with it-->
                                                    <template is="dom-if" if="{{category.isCategory}}">
                                                        <label class="form-check-label notbold">
                                                            <input type="checkbox" on-change="updateConsequenceTypeFilter"
                                                                   class$="{{prefix}}FilterCheckBox"> {{category.title}}
                                                        </label>
                                                    </template>
                                                    <!--If it is not a category, SO terms should be shown along with its actual title-->
                                                    <template is="dom-if" if="{{!category.isCategory}}">
                                                        <input type="checkbox" on-change="updateConsequenceTypeFilter"
                                                               data-id="{{category.name}}"
                                                               class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                        <span title="{{item.description}}">
                                                                {{category.title}} (<a
                                                                href="http://www.sequenceontology.org/browser/current_svn/term/{{category.id}}"
                                                                target="_blank">{{category.id}}</a>)</span>

                                                    </template>
                                                </template>
                                                <!--Title is optional. Consequence type name is taken in case title is not given-->
                                                <template is="dom-if" if="{{!checkTitle(category)}}">
                                                    <!--If it is a category, only name is shown as it doesn't have any SO term associated with it-->
                                                    <template is="dom-if" if="{{category.isCategory}}">
                                                        <div class="form-check" style="margin-top: 10px;">
                                                            <label class="form-check-label notbold">
                                                                <input type="checkbox" on-change="updateConsequenceTypeFilter"
                                                                       class$="{{prefix}}FilterCheckBox"> {{category.name}}
                                                            </label>
                                                        </div>
                                                    </template>
                                                    <!--If it is not a category, SO terms should be shown along with its actual name-->
                                                    <template is="dom-if" if="{{!category.isCategory}}">
                                                        <div class="form-check" style="margin-top: 10px;">
                                                            <label class="form-check-label notbold">
                                                                <input type="checkbox" on-change="updateConsequenceTypeFilter"
                                                                       data-id="{{category.name}}"
                                                                       class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                                <span title="{{item.description}}">
                                                        {{category.name}} (<a
                                                                        href="http://www.sequenceontology.org/browser/current_svn/term/{{category.id}}"
                                                                        target="_blank">{{category.id}}</a>)</span>
                                                            </label>
                                                        </div>
                                                    </template>
                                                </template>
                                                <ul>
                                                    <template is="dom-repeat" items="{{category.terms}}">
                                                        <li class="form-check">
                                                            <label class="form-check-label notbold">
                                                                <input type="checkbox" data-id="{{item.name}}" on-change="updateConsequenceTypeFilter"
                                                                       class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                                <span title="{{item.description}}">
                                                                {{item.name}} (<a
                                                                        href="http://www.sequenceontology.org/browser/current_svn/term/{{item.id}}"
                                                                        target="_blank">{{item.id}}</a>)
                                                                </span>
                                                            </label>
                                                        </li>
                                                    </template>
                                                </ul>
                                            </li>
                                        </template>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gene Ontology filter-->
                <!--<div class="panel panel-default">-->
                    <!--<div class="panel-heading" role="tab" id="{{prefix}}GeneOntologyHeading">-->
                        <!--<h4 class="panel-title">-->
                            <!--<a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"-->
                               <!--href="#{{prefix}}GeneOntology" aria-expanded="false" aria-controls="{{prefix}}GeneOntology">-->
                                <!--Gene Ontology-->
                            <!--</a>-->
                        <!--</h4>-->
                    <!--</div>-->
                    <!--<div id="{{prefix}}GeneOntology" class="panel-collapse collapse" role="tabpanel"-->
                         <!--aria-labelledby="{{prefix}}GeneOntologyHeading">-->
                        <!--<div class="panel-body">-->
                            <!--<span class="browser-subsection">GO Accessions</span>-->
                            <!--<div class="form-group">-->
                                <!--<textarea id="{{prefix}}GeneOntologyTextarea" readonly class$="form-control clearable {{prefix}}FilterTextInput"-->
                                          <!--rows="3" name="geneOntology" placeholder="GO:0000145" on-keyup="updateQueryFilters"></textarea>-->
                                <!--<span class="input-group-addon btn btn-primary searchingSpan" on-click="openModalGo">-->
                                    <!--<strong style="color: white;" >Add Go Term</strong>-->
                                    <!--<i class="fa fa-search searchingButton" aria-hidden="true"></i>-->
                                <!--</span>-->
                            <!--</div>-->
                        <!--</div>-->
                    <!--</div>-->
                <!--</div>-->

                <!-- Phenotype-Disease filter -->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}TraitsHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                               href="#{{prefix}}Traits" aria-expanded="false" aria-controls="{{prefix}}HumanPhenotypeOntology">
                                Phenotype-Disease (<span style="color: red">New!</span>)
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}Traits" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="{{prefix}}TraitsHeading">
                        <div class="panel-body">
                            <div class="form-group">
                                <span class="browser-subsection">HPO Accessions</span>
                                <textarea id="{{prefix}}HumanPhenotypeOntologyTextarea" readonly class$="form-control clearable {{prefix}}FilterTextInput"
                                          rows="3" name="hpo" placeholder="HP:0000001, HP:3000079" on-keyup="updateQueryFilters"></textarea>
                                <span class="input-group-addon btn btn-primary searchingSpan" on-click="openModalHpo">
                                    <strong style="color: white;" >Add HPO Term</strong>
                                    <i class="fa fa-search searchingButton" aria-hidden="true"></i>
                                </span>
                            </div>

                            <div class="form-group">
                                <span class="browser-subsection">ClinVar Accessions</span>
                                <textarea id="{{prefix}}ClinVarTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="3"
                                          name="clinvar" placeholder="RCV000058226"
                                          on-keyup="updateQueryFilters"></textarea>
                            </div>

                            <div class="form-group">
                                <span class="browser-subsection">Full-text search on HPO, ClinVar, protein domains or keywords.
                                    Some OMIM and Orphanet IDs are also supported (<span style="color: red">New!</span>)
                                </span>
                                <textarea id="{{prefix}}TraitsTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="5"
                                          name="traits" placeholder="Full-text search, e.g. *melanoma*"
                                          on-keyup="updateQueryFilters"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <variant-modal-ontology prefix="{{prefix}}" ebi-config="{{ebiConfig}}" on-propagateok="propagateOkHPO"
                                ontology-filter="{{ontologyFilter}}" term="{{ontologyTerm}}" selected-terms="{{selectedTermsOntology}}">
        </variant-modal-ontology>


        <!-- Modal dialog for Sample Browser in prioritization-->
        <!--<div class="modal fade" id="{{prefix}}SampleBrowser" tabindex="-1" role="dialog"-->
        <!--aria-labelledby="sampleBrowserLabel">-->
        <!--<div class="modal-dialog modal-lg" role="document" style="width: 1440px;">-->
        <!--<div class="modal-content">-->
        <!--<div class="modal-header">-->
        <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span-->
        <!--aria-hidden="true">&times;</span></button>-->
        <!--<h4 class="modal-title" id="{{prefix}}SampleBrowserLabel">Family Selector</h4>-->
        <!--</div>-->
        <!--<div class="modal-body" style="height: 680px">-->
        <!--&lt;!&ndash;<opencga-family-selector opencga-client="{{opencgaClient}}" study-id="{{study.id}}" samples="{{samples}}" prefix="{{prefix}}"></opencga-family-selector>&ndash;&gt;-->
        <!--<variant-sample-selector opencga-client="{{opencgaClient}}" project="{{project}}" study="{{study}}"-->
        <!--mode="{{analysisType}}" samples="{{samples}}" on-familychange="onFamilyChange">-->
        <!--</variant-sample-selector>-->
        <!--</div>-->
        <!--<div class="modal-footer">-->
        <!--<button type="button" class="btn btn-primary" data-dismiss="modal" on-click="closeModalSample">-->
        <!--OK-->
        <!--</button>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->

        <!--Modal dialog for Analysis Browser-->
        <!--<div class="modal fade" id="{{prefix}}AnalysisBrowser" tabindex="-1" role="dialog"-->
        <!--aria-labelledby="sampleBrowserLabel">-->
        <!--<div class="modal-dialog modal-lg" role="document" style="width: 1280px;">-->
        <!--<div class="modal-content">-->
        <!--<div class="modal-header">-->
        <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span-->
        <!--aria-hidden="true">&times;</span></button>-->
        <!--<h4 class="modal-title" id="{{prefix}}AnalysisBrowserLabel">Analysis Selector</h4>-->
        <!--</div>-->
        <!--<div class="modal-body" style="height: 780px">-->
        <!--<variant-clinical-selector opencga-client="{{opencgaClient}}" analysis-selected="{{analysisSelected}}" analysis-modal="{{analysisModal}}" study="{{study}}" show-pedigree="{{showPedigree}}"></variant-clinical-selector>-->
        <!--</div>-->
        <!--<div class="modal-footer">-->
        <!--<button type="button" class="btn btn-primary" data-dismiss="modal" on-click="showSegregation">-->
        <!--OK-->
        <!--</button>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
    </template>

    <script>
        class VariantBrowserFilter extends Polymer.Element {

            constructor() {
                super();

                this.prefix = "var-browser-filter-" + Utils.randomString(6);
            }

            static get is() {
                return 'variant-browser-filter';
            }

            static get properties() {
                return {
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object,
                        observer: 'updateDifferentStudies'
                    },
                    studies: {
                        type: Array
//                        observer: 'updateDifferentStudies'
                    },
                    opencgaClient: {
                        type: Object
                    },
                    cellbaseClient: {
                        type: Object
                    },
                    config: {
                        type: Object
                    },
                    populationFrequencies: {
                        type: Object
                    },
                    consequenceTypes: {
                        type: Object
                    },
                    query: {
                        type: Object,
                        notify: true,
                        observer: 'queryObserver'
                    },
                    search: {
                        type: Object,
                        notify: true
                    },
                    samples: {
                        type: Array
//                        value: [{id: "", name: "aaa"}, {id: "", name: "bbb"}]
                    },
//                    sampleGenotypes: {
//                        type: Object,
//                        value: {}
//                    },
                    family: {
                        type: Object,
                        observer: "familyObserver"
                    },
                    biotypes: {
                        type: Array
                    },
                    segregation: {
                        type: String,
                        value: "Select ..."
//                        observer: "segregate"
                    },
                    analysisSelected: {
                        type: Object,
                        notify: true
                    },
                    clinicalAnalysis:{
                        type:Object,
                        observer: "clinicalAnalysisExistObserver"
                    }
                }
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            connectedCallback() {
                super.connectedCallback();

                this.clinicalAnalysisExistObserver();


                this._addEventListeners();
                this._addAllTooltips();
            }

            static get observers() {
                return [
                    "samplesObserver(samples.*)"
                ]
            }

            ready() {
                super.ready();

                // We initialise all objects
                this.init();

                this._renderFilterMenu();
            }

            init() {
                this.sampleGenotypesObj = {};
                this.query = {};
//                this.selectedAnalysisType();

                if (typeof PANELS !== "undefined") {
                    this.set('panelList', PANELS);
                }


//                if (UtilsNew.isNotUndefinedOrNull(this.family)) {
//                    this._addSample(this.family.members);
//                }
                if (UtilsNew.isUndefinedOrNull(this.samples)) {
                    this.samples = [];
                }
                this.showSampleGenotypes = this.samples.length > 0;

                this.showFamilySegregationSelector = this.family !== undefined && this.family !== null;


                this.modalHpoActive = false;
                this.modalGoActive = false;


                let _studyConfig = this.config.filter.study;

                this.studyFilterVisibility = {
                    samples: _studyConfig.samples !== undefined && _studyConfig.samples.visibility === "public",
                    cohorts: _studyConfig.cohorts !== undefined && _studyConfig.cohorts.visibility === "public",
                    scores: _studyConfig.scores !== undefined && _studyConfig.scores.visibility === "public",
                    studies: UtilsNew.isNotUndefinedOrNull(_studyConfig.studies) && _studyConfig.studies.visibility === "public"
                    && UtilsNew.isNotEmptyArray(this.studies) && this.studies.length > 1,
                    clinicalData: _studyConfig.samples !== undefined && _studyConfig.clinicalData.visibility === "public",
                    visible: this.config.filter.study.samples.visibility === "public" || this.config.filter.study.cohorts.visibility === "public"
                    || this.config.filter.study.studies.visibility === "public" || this.config.filter.study.clinicalData.visibility === "public"
                };

                // Show cohorts
                if (!this.config.filter.study.collapsed) {
                    this.collapsed = "in";
                }

                this._genotypes = ["0/0", "0/1", "1/1", "./."];
            }

            _autocompleteSampleSearch(e) {
                // Only gene symbols are going to be searched and not Ensembl IDs
                let sampleNamePrefix = PolymerUtils.getElementById(this.prefix  + "AutocompleteSampleSearchInput").value;
                if (UtilsNew.isNotUndefinedOrNull(sampleNamePrefix) && sampleNamePrefix.length >= 4) {
                    let _this = this;
                    this.opencgaClient.samples()
                        .search({
                            study: _this.project.alias + ":" + _this.study.alias,
                            name: "~^" + sampleNamePrefix,
                            include: "id,name",
                            limit: 20}, {})
                        .then(function (response) {
                            _this.autocompleteSampleData = response.response[0].result;
                        });
                }
            }

            onSampleChange(e) {
                if (UtilsNew.isNotUndefinedOrNull(this.samples)) {
                    let sampleSearchInput = PolymerUtils.getElementById(this.prefix + "AutocompleteSampleSearchInput");
                    let sampleString = PolymerUtils.getElementById(this.prefix + "Sample" + sampleSearchInput.value).dataset.sample;
                    let sample = JSON.parse(sampleString);

                    if (UtilsNew.isNotUndefinedOrNull(sample)) {
                        // Default genotype when adding samples is 0/1, 1/1
                        if (UtilsNew.isUndefinedOrNull(this.query.genotype)) {
                            this.query.genotype = sample.name + ":0/1,1/1";
                        } else {
                            this.query.genotype += ";" + sample.name + ":0/1,1/1";
                        }

                        // This triggers the call to samplesObserver()
                        this.push("samples", sample);

                        // Empty previous Sample selection
                        this.autocompleteSampleData = [];
                        sampleSearchInput.value = "";

                        // Notify the sample change
                        this.dispatchEvent(new CustomEvent("samplechange", {
                            detail: {samples: this.samples}, bubbles: true, composed: true
                        }));
                    }
                }
            }

            samplesObserver(e) {
                this.renderSampleGenotypesTable();

                this.updateQueryFilters();
            }

            familyObserver() {
                if (UtilsNew.isNotUndefinedOrNull(this.samples) && UtilsNew.isNotUndefinedOrNull(this.family)) {
                    // Updating samples triggers the call to samplesObserver()
                    if (UtilsNew.isNotUndefinedOrNull(this.family.members) && Array.isArray(this.family.members)) {
                        this.family.members.foreach(item => this.sampleGenotypes[item] = []);
                        this.set("samples", this.family.members);
                    } else {
                        this.set("samples", []);
                    }

                    // Notify the sample change
                    this.dispatchEvent(new CustomEvent("samplechange", {
                        detail: {samples: this.samples, family: this.family}, bubbles: true, composed: true
                    }));
                }
            }


            renderSampleGenotypesTable(sampleGenotypes) {
                if (UtilsNew.isUndefinedOrNull(sampleGenotypes)) {
                    sampleGenotypes = {};
                    if (UtilsNew.isNotUndefinedOrNull(this.query) && UtilsNew.isNotEmpty(this.query.genotype)) {
                        sampleGenotypes = {};
                        let samplesWithGT = this.query.genotype.split(';');
                        for (let i = 0; i < samplesWithGT.length; i++) {
                            let [sample, genotypes] = samplesWithGT[i].split(':');
                            sampleGenotypes[sample] = genotypes.split(',');
                        }
                    }
                }

                let table = PolymerUtils.getElementById(this.prefix + "SampleGenotypeTable");
                if (UtilsNew.isUndefinedOrNull(table) || UtilsNew.isUndefinedOrNull(this.samples)) {
                    console.log("Sample Array or Genotypes table are still undefined")
                    return;
                }

                // Delete all existing rows
                let tableBody = table.getElementsByTagName('tbody')[0];
                while(tableBody.rows.length) {
                    tableBody.deleteRow(0);
                }

                for (let sample of this.samples) {
                    let tr = tableBody.insertRow(-1);
                    tr.setAttribute("id", sample.name);

                    let td = tr.insertCell(0);
                    let nameText = document.createTextNode(sample.name);
                    td.appendChild(nameText);

                    for (let genotype of this._genotypes) {
                        let td = tr.insertCell(-1);

                        let cell = document.createElement("INPUT");
                        cell.setAttribute("id", this.prefix + "SampleGenotypeCheckbox" + genotype);
                        cell.setAttribute("type", "checkbox");
                        cell.setAttribute("class", this.prefix + "genotypes " + this.prefix + "FilterCheckBox");
                        cell.setAttribute("value", genotype);
                        cell.setAttribute("data-id", sample.name);
                        cell.addEventListener("change", this.updateSampleGenotypeFilter.bind(this));
                        if (UtilsNew.isNotUndefinedOrNull(sampleGenotypes[sample.name]) && sampleGenotypes[sample.name].includes(genotype)) {
                            cell.setAttribute("checked", true);
                        }

                        td.appendChild(cell);
                    }
                }

                // Change visibility
                if (this.samples.length > 0) {
                    this.showSampleGenotypes = true;
                    PolymerUtils.setAttribute(this.prefix + "SampleGenotypeTable", "style", "display: inline");
                } else {
                    this.showSampleGenotypes = false;
                    PolymerUtils.setAttribute(this.prefix + "SampleGenotypeTable", "style", "display: none");
                }
            }


            updateSampleGenotypeFilter(e) {
//                if (UtilsNew.isUndefinedOrNull(this.sampleGenotypes[e.target.dataset.id])) {
//                    this.sampleGenotypes[e.target.dataset.id] = [];
//                }
//
//                if (e.target.checked) {
//                    this.sampleGenotypes[e.target.dataset.id].push(e.target.defaultValue);
//                } else {
//                    let index = this.sampleGenotypes[e.target.dataset.id].indexOf(e.target.defaultValue);
//                    this.sampleGenotypes[e.target.dataset.id].splice(index, 1);
//                }
//
//                // Update the sample genotypes, the observer will call to 'renderSampleGenotypesTable'
//                this.sampleGenotypes = Object.assign({}, this.sampleGenotypes);

                this.updateQueryFilters();
            }

            // This method manipulates this.samples object including dispatching the event and refreshing web
//            _addSample(sample) {
//                if (UtilsNew.isNotUndefinedOrNull(sample) && UtilsNew.isNotUndefinedOrNull(this.samples)) {
//                    // If 'sample' is an array we need to set instead of push to avoid multiple refresh events
//                    if (Array.isArray(sample)) {
//                        this.set("samples", sample);
//                    } else {
//                        // If 'sample' is an object we just add default genotypes and push it
//                        if (UtilsNew.isUndefinedOrNull(this.sampleGenotypes[sample.name])) {
//                            this.sampleGenotypes[sample.name] = ["0/1", "1/1"];
//                        }
//                        this.push("samples", sample);
//                    }
//
//                    // Launch and refresh the web
//                    this.dispatchEvent(new CustomEvent("samplechange", {detail: {samples: this.samples}, bubbles: true, composed: true}));
//                    this.showSampleGenotypes = this.samples.length > 0;
//                }
//            }


            propagateOkHPO(e) {
                if (this.openHPO) {
                    PolymerUtils.setValue(this.prefix + "HumanPhenotypeOntologyTextarea", e.detail.result.join(","));
                    this.selectedTermsHPO = e.detail.originalResult;
                } else {
                    PolymerUtils.setValue(this.prefix + "GeneOntologyTextarea", e.detail.result.join(","));
                    this.selectedTermsGO = e.detail.originalResult;
                }
                $("#" + this.prefix + "ontologyModal").modal('hide');
                this.updateQueryFilters();
            }

            openModalOntology() {
                this.selectedTermsOntology = this.selectedTermsHPO;
                $("#" + this.prefix + "ontologyModal").modal('show');
            }

            openModalHpo() {
                this.openHPO = true;
                this.ontologyFilter = "hp";
                this.ontologyTerm = "HPO";
                this.openModalOntology();
            }

            openModalGo() {
                this.openHPO = false;
                this.ontologyFilter = "go";
                this.ontologyTerm = "GO";
                this.openModalOntology();
            }

            onSearch() {
                this.search = this.query;
            }

            queryObserver() {
                if (this._reset) {
                    console.log("queryObserver: calling to 'setQueryFilters()'")
                    this.setQueryFilters();
                } else {
                    this._reset = true;
                }
            }

            handleCollapseAction(e) {
                let id = e.target.dataset.id;
                let elem = $('#' + id)[0];
                elem.hidden = !elem.hidden;
                if (elem.hidden) {
                    e.target.className = "fa fa-plus";
                } else {
                    e.target.className = "fa fa-minus";
                }
            }

            checkTitle(consequenceType) {
                return typeof consequenceType.title !== "undefined" && consequenceType.title !== null;
            }

            updateDifferentStudies() {
                let differentStudies = [];
                if (typeof this.study !== "undefined") {

                    if (UtilsNew.isNotUndefinedOrNull(this.studies)) {
                        for (let i = 0; i < this.studies.length; i++) {
                            if (this.study.alias !== this.studies[i].alias) {
                                differentStudies.push(this.studies[i]);
                            }
                        }
                        this.differentStudies = differentStudies;
                    }

                    // Update cohorts from config, this updates the Cohort filter MAF
                    if (typeof this.config !== "undefined" && typeof this.config.filter.study.cohorts.cohortPerStudy !== "undefined") {
                        this._cohorts = this.config.filter.study.cohorts.cohortPerStudy[this.study.alias];
                    }

//                    this._studyCohortBoolean = differentStudies.length > 0 || (typeof this._cohorts !== "undefined" && this._cohorts.length > 0);

                    // Setting mandatory field for variant query
                    this.query = {studies: this.project.alias + ":" + this.study.alias};
                }
            }


            updateConsequenceTypeFilter(e) {
                // Select LoF term checkboxes
                let lofCheckBox = PolymerUtils.getElementById(this.prefix + "LossOfFunctionCheckBox");
                if (e.target.id === this.prefix + "LossOfFunctionCheckBox") {
                    let checkBoxes = PolymerUtils.querySelectorAll("li input", this.prefix + "consequenceTypeFilter");
                    for (let i = 0; i < this.consequenceTypes.lof.length; i++) {
                        for (let j = 0; j < checkBoxes.length; j++) {
                            if (checkBoxes[j].dataId === this.consequenceTypes.lof[i]) {
                                checkBoxes[j].checked = lofCheckBox.checked;
                                break;
                            }
                        }
                    }
                }

                // Select/Unselect the items from one category
                if (e.target.parentNode.parentNode.id !== "") {
                    $("#" + e.target.parentNode.parentNode.id).children('ul').children('li').children('label').children('input').prop("checked", e.target.checked);
                }
//                let selected = $('.soTermCheckBox');
                let soTerms = [];
                let selected = PolymerUtils.querySelectorAll("li input", this.prefix + "consequenceTypeFilter");
                for (let i = 0; i < selected.length; i++) {
                    if (selected[i].checked && typeof selected[i].dataId !== "undefined") {
                        soTerms.push(selected[i].dataId);
                    } else {
                        // If one term from LoF array is not selected we remove LoF check
                        if (lofCheckBox.checked && this.consequenceTypes.lof.includes(selected[i].dataId)) {
                            lofCheckBox.checked = false;
                        }
                    }
                }

                this.set('ct', soTerms);
                this.updateQueryFilters();
            }

            checkScore(e) {
                let inputElement = $("#" + this.prefix + e.target.name + "Input");
                let operatorElement = $("#" + this.prefix + e.target.name + "Operator");
                if (e.target.value === "score") {
                    inputElement.prop("disabled", false);
                    operatorElement.prop("disabled", false);
                } else {
                    inputElement.val("");
                    operatorElement.val("<");
                    inputElement.prop("disabled", true);
                    operatorElement.prop("disabled", true);
                }
                this.updateQueryFilters();
            }

            clear() {
                // This will trigger the event that call to setQueryFilters
                this.query = {};

                // This refresh the variant main grid
                this.search = {};
            }

            setQueryFilters() {
                // Empty everything before rendering
                this._clearHtmlDom();

//                this.query.genotype = "HG00956:0/1";
                // Sample Genotypes
//                if (UtilsNew.isNotEmpty(this.query.genotype)) {
//                    let _sampleGenotypes = {};
//                    let samplesWithGT = this.query.genotype.split(';');
//                    for (let i = 0; i < samplesWithGT.length; i++) {
//                        let [sample, genotypes] = samplesWithGT[i].split(':');
//                        _sampleGenotypes[sample] = genotypes.split(',');
//                    }
//                    // This assignment is observed by renderSampleGenotypesTable
////                    this.sampleGenotypes = _sampleGenotypes;
//                    debugger
//                    this.renderSampleGenotypesTable(_sampleGenotypes);
//                }
                this.renderSampleGenotypesTable();

                // Cohorts
                let cohortArray = [];
                if (typeof this.query.maf !== "undefined") {
                    cohortArray = this.query.maf.split(new RegExp("[,;]"));
                    for (let i = 0; i < cohortArray.length; i++) {
                        let [study, cohortFreq] = cohortArray[i].split(':');
                        let [cohort, freq] = cohortFreq.split(/[<=>]+/);
                        let operator = cohortFreq.split(/[-A-Za-z0-9._:]+/)[1];
//                        this.$$("#" + this.prefix + study + cohort + "Cohort").value = freq;
//                        this.$$("#" + this.prefix + study + cohort + "CohortOperator").value = operator;
                        PolymerUtils.setValue(this.prefix + study + cohort + "Cohort", freq);
                        PolymerUtils.setValue(this.prefix + study + cohort + "CohortOperator", operator);
                    }
                }

                // Studies
                if (typeof this.query.studies !== "undefined") {
                    if (this.$.includeOtherStudy !== null && this.$.differentStudies !== null) {
                        let studies = this.query.studies.split(new RegExp("[,;]"));
                        if (studies.length > 1) {
//                            let checkBoxes = this.$$("#differentStudies").querySelectorAll("input");
                            let checkBoxes = PolymerUtils.querySelectorAll("input", this.prefix + "DifferentStudies");
                            for (let i = 0; i < studies.length; i++) {
                                let study = studies[i].split(':')[1];
                                for (let j = 0; j < checkBoxes.length; j++) {
                                    if (checkBoxes[j].value === study) {
                                        checkBoxes[j].checked = true;
                                    }
                                }
                            }
                        }
                    }
                }

                // Position
                if (typeof this.query.region !== "undefined") {
                    $("#" + this.prefix + "LocationTextarea").val(this.query.region);
                }

                // XRefs, Gene and Variant Ids
                if (typeof this.query["annot-xref"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "FeatureTextarea", this.query["annot-xref"]);
//                } else if (typeof this.query.gene !== "undefined") {
//                    this.$$("#" + this.prefix + "FeatureTextarea").value = this.query.gene;
                } else if (typeof this.query.ids !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "FeatureTextarea", this.query.ids);
                }

                // Biotype
                if (typeof this.query["annot-biotype"] !== "undefined") {
//                    PolymerUtils.setValue(this.prefix + "GeneBiotypes", this.query["annot-biotype"]);
                    $("#" + this.prefix + "GeneBiotypes").selectpicker('val', this.query["annot-biotype"].split(","));
                }

                // Panel - annot-panel
                if (typeof this.query["gene"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "PanelAppsTextarea", this.query.gene);
                }

                // Type
                if (typeof this.query.type !== "undefined") {
                    let types = this.query.type.split(",");
                    let checkBoxes = PolymerUtils.querySelectorAll("input", this.prefix + "Type");
                    for (let i = 0; i < types.length; i++) {
                        for (let j = 0; j < checkBoxes.length; j++) {
                            if (checkBoxes[j].value === types[i]) {
                                checkBoxes[j].checked = true;
                            }
                        }
                    }
                }

                // Population Freqs
                let pfArray = [];
                if (typeof this.query["alternate_frequency"] !== "undefined") {
                    pfArray = this.query["alternate_frequency"].split(new RegExp("[,;]"));
                }
                if (typeof this.populationFrequencies !== "undefined" && typeof this.populationFrequencies.studies !== "undefined" && this.populationFrequencies.studies.length > 0) {
                    for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                        let study = this.populationFrequencies.studies[i].id;
                        for (let j = 0; j < this.populationFrequencies.studies[i].populations.length; j++) {
                            let population = this.populationFrequencies.studies[i].populations[j].id;
                            if (pfArray.length > 0) {
                                for (let k = 0; k < pfArray.length; k++) {
                                    let pf = pfArray[k];
                                    if (pf.startsWith(study + ":" + population)) {
//                                        this.$$("#" + this.prefix + study + population).value = pf.split(/[<=>]+/)[1];
//                                        this.$$("#" + this.prefix + study + population + "Operator").value = pf.split(/[-A-Za-z0-9._:]+/)[1];
                                        PolymerUtils.setValue(this.prefix + study + population, pf.split(/[<=>]+/)[1]);
                                        PolymerUtils.setValue(this.prefix + study + population + "Operator", pf.split(/[-A-Za-z0-9._:]+/)[1]);
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                // Protein Substitution scores
                if (typeof this.query["protein_substitution"] !== "undefined") {
                    let pss = this.query["protein_substitution"].split(new RegExp("[,;]"));
                    if (pss.length > 0) {
                        for (let i = 0; i < pss.length; i++) {
                            if (pss[i].startsWith("sift")) {
                                let value = pss[i].split("sift")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
//                                    this.$$("#" + this.prefix + "SiftInput").value = value.split(/[<=>]+/)[1];
//                                    this.$$("#" + this.prefix + "SiftOperator").value = value.split(/[-0-9.]+/)[0];
                                    PolymerUtils.setValue(this.prefix + "SiftInput", value.split(/[<=>]+/)[1]);
                                    PolymerUtils.setValue(this.prefix + "SiftOperator", value.split(/[-0-9.]+/)[0]);
                                } else {
//                                    this.$$("#" + this.prefix + "SiftValues").value = value.split('==')[1];
                                    PolymerUtils.setValue(this.prefix + "SiftValues", value.split('==')[1]);
                                }
                                this.$$("#" + this.prefix + "SiftInput").disabled = !(value.startsWith("<") || value.startsWith(">"));
                                this.$$("#" + this.prefix + "SiftOperator").disabled = !(value.startsWith("<") || value.startsWith(">"));
                            } else if (pss[i].startsWith("polyphen")) {
                                let value = pss[i].split("polyphen")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
//                                    this.$$("#" + this.prefix + "PolyphenInput").value = value.split(/[<=>]+/)[1];
//                                    this.$$("#" + this.prefix + "PolyphenOperator").value = value.split(/[-0-9.]+/)[0];
                                    PolymerUtils.setValue(this.prefix + "PolyphenInput", value.split(/[<=>]+/)[1]);
                                    PolymerUtils.setValue(this.prefix + "PolyphenOperator", value.split(/[-0-9.]+/)[0]);
                                } else {
//                                    this.$$("#" + this.prefix + "PolyphenValues").value = value.split('==')[1];
                                    PolymerUtils.setValue(this.prefix + "PolyphenValues", value.split('==')[1]);
                                }
                                this.$$("#" + this.prefix + "PolyphenInput").disabled = !(value.startsWith("<") || value.startsWith(">"));
                                this.$$("#" + this.prefix + "PolyphenOperator").disabled = !(value.startsWith("<") || value.startsWith(">"));
                            }
                        }
                    }
                }

                // Cadd scores
                if (typeof this.query["annot-functional-score"] !== "undefined") {
                    let fields = this.query["annot-functional-score"].split(new RegExp("[,;]"));
                    for (let i = 0; i < fields.length; i++) {
                        let source = fields[i].split(/[<=>]+/)[0];
                        switch (source) {
                            case "cadd_raw":
                                PolymerUtils.setValue(this.prefix + "CaddRawInput", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "CaddRawOperator", fields[i].split(/[-A-Za-z0-9_]+/)[1]);
                                break;
                            case "cadd_scaled":
                                PolymerUtils.setValue(this.prefix + "CaddScaledInput", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "CaddScaledOperator", fields[i].split(/[-A-Za-z0-9_]+/)[1]);
                                break;
                        }
                    }
                }

                // Conservation
                if (typeof this.query.conservation !== "undefined") {
                    let fields = this.query.conservation.split(new RegExp("[,;]"));
                    for (let i = 0; i < fields.length; i++) {
                        let source = fields[i].split(/[<=>]+/)[0];
                        switch (source) {
                            case "phylop":
                                PolymerUtils.setValue(this.prefix + "PhylopInput", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "PhylopOperator", fields[i].split(/[-A-Za-z0-9]+/)[1]);
                                break;
                            case "phastCons":
                                PolymerUtils.setValue(this.prefix + "PhastconsInput", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "PhastconsOperator", fields[i].split(/[-A-Za-z0-9]+/)[1]);
                                break;
                            case "gerp":
                                PolymerUtils.setValue(this.prefix + "GerpInput", fields[i].split(/[<=>]+/)[1]);
                                PolymerUtils.setValue(this.prefix + "GerpOperator", fields[i].split(/[-A-Za-z0-9]+/)[1]);
                                break;
                        }
                    }
                }

                // Consequence Type
                if (typeof this.query["annot-ct"] !== "undefined") {
                    let types = this.query["annot-ct"].split(",");
                    let checkBoxes = PolymerUtils.querySelectorAll("li input", this.prefix + "consequenceTypeFilter");
                    for (let i = 0; i < types.length; i++) {
                        for (let j = 0; j < checkBoxes.length; j++) {
                            if (checkBoxes[j].dataId === types[i]) {
                                checkBoxes[j].checked = true;
                            }
                        }
                    }
                } else {
                    this.set('ct', []); // Clearing the consequence type that is taken by this.query
                }

                // Gene Ontology and Human Phenotype Ontology
                if (typeof this.query["annot-go"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "GeneOntologyTextarea", this.query["annot-go"]);
                }
                if (typeof this.query["annot-hpo"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "HumanPhenotypeOntologyTextarea", this.query["annot-hpo"]);
                }
                if (typeof this.query["clinvar"] !== "undefined") {
                    PolymerUtils.setValue(this.prefix + "ClinVarTextarea", this.query["clinvar"]);
                }
            }

            onGeneDiseasePanelChange() {
                let panelName = PolymerUtils.getElementById(this.prefix + "PanelApps").value;
                for (let i = 0; i < this.panelList.length; i++) {
                    if (this.panelList[i].name === panelName) {
                        let panel = this.panelList[i];
                        PolymerUtils.getElementById(this.prefix + "PanelAppsTextarea").value = panel.genes;
                        break;
                    }
                }
                this.updateQueryFilters();
            }

            sortPanelApp(a, b) {
                if (a.title === b.title) {
                    return 0;
                }
                return a.title < b.title ? -1 : 1;
            }

            updateQueryFilters() {
                let _filters = {};

                // Adding sample genotypes filter
//                let _genotypes = [];
//                if (UtilsNew.isNotUndefinedOrNull(this.sampleGenotypes)) {
//                    Object.keys(this.sampleGenotypes)
//                        .forEach(sample => _genotypes.push(sample + ":" + this.sampleGenotypes[sample].join(",")));
//                }
//                _filters.genotype = _genotypes.join(';');
                let selectedGenotypes = $("." + this.prefix + "genotypes:checkbox:checked");
                if (selectedGenotypes.length > 0) {
                    let sampleGenotypesObj = {};
                    for (let i = 0; i < selectedGenotypes.length; i++) {
                        if (typeof sampleGenotypesObj[selectedGenotypes[i].getAttribute("data-id")] === "undefined") {
                            sampleGenotypesObj[selectedGenotypes[i].getAttribute("data-id")] = {};
                        }
                        sampleGenotypesObj[selectedGenotypes[i].getAttribute("data-id")][selectedGenotypes[i].defaultValue] = selectedGenotypes[i].checked;
                    }
                    let _genotypes = [];
                    for (let sampleName in sampleGenotypesObj) {
                        let gts = [];
                        for (let sampleGT in sampleGenotypesObj[sampleName]) {
                            if (sampleGenotypesObj[sampleName][sampleGT] === true) {
                                gts.push(sampleGT);
                            }
                        }
                        if (gts.length > 0) {
                            _genotypes.push(sampleName + ':' + gts.join(','));
                        }
                    }
                    _filters.genotype = _genotypes.join(';');
                }

                // Add Cohort stats MAF filter: [{study.alias}]:{cohort}[<|>|<=|>=]{number}
                let cohortFreq = [];
                if (typeof this._cohorts !== "undefined" && this._cohorts.length > 0) {
                    for (let i = 0; i < this._cohorts.length; i++) {
                        let cohort = this._cohorts[i].id;
                        let cohortInput = PolymerUtils.getElementById(this.prefix + this.study.alias + cohort + "Cohort");
                        let operator = PolymerUtils.getElementById(this.prefix + this.study.alias + cohort + "CohortOperator");
//                        if (this.$$("#" + this.prefix + this.study.alias + cohort + "Cohort").value !== "" || this.$$("#" + this.prefix + this.study.alias + cohort + "CohortOperator").value !== "<") {
                        if ((cohortInput !== null && cohortInput.value !== "") || (operator !== null && operator.value !== "<")) {
                            let operator = operator.value;
                            let study = this.study.alias;
                            // to be removed!!
                            if (study === "BRIDGE") {
                                study = "bridge";
                            }
                            let pf = study + ":" + cohort + operator + cohortInput.value;
                            cohortFreq.push(pf);
                        }
                    }
                }
                if (cohortFreq.length > 0) {
                    _filters["maf"] = cohortFreq.join(';');
                }

                // Studies - This section is not renderer when only study exists
                let studies = [this.project.alias + ":" + this.study.alias];
                let selectedStudies = PolymerUtils.querySelectorAll("input:checked", this.prefix + "DifferentStudies");
                if (UtilsNew.isNotUndefinedOrNull(selectedStudies)) {
                    for (let i = 0; i < selectedStudies.length; i++) {
                        if (studies.indexOf(this.project.alias + ':' + selectedStudies[i].value) === -1) {
                            studies.push(this.project.alias + ':' + selectedStudies[i].value);
                        }
                    }
                    switch (PolymerUtils.getElementById("includeOtherStudy").value) {
                        case "in":
                            _filters.studies = studies.join(';');
                            break;
                        case "atleast":
                            _filters.studies = studies.join(',');
                            break;
                        case "not in":
                            let notInStudies = [];
                            let currentStudy = this.project.alias + ':' + this.study.alias;
                            for (let j = 0; j < studies.length; j++) {
                                if (currentStudy === studies[j]) {
                                    // Always add the study that we are browsing currently
                                    notInStudies.push(studies[j]);
                                } else {
                                    notInStudies.push("!" + studies[j]);
                                }
                            }
                            _filters.studies = notInStudies.join(";");
                            break;
                    }
                }

                // Regions
                let locationTextArea = PolymerUtils.getElementById(this.prefix + "LocationTextarea");
                if (UtilsNew.isNotUndefinedOrNull(locationTextArea) && UtilsNew.isNotEmpty(locationTextArea.value)) {
                    _filters.region = locationTextArea.value;
                }

                // Features: Gene, SNP ID
                let featureTextArea = PolymerUtils.getElementById(this.prefix + "FeatureTextarea");
                if (UtilsNew.isNotUndefinedOrNull(featureTextArea) && UtilsNew.isNotEmpty(featureTextArea.value)) {
                    if (featureTextArea.value.startsWith("rs") || featureTextArea.value.split(':').length > 2) {
                        _filters["annot-xref"] = featureTextArea.value;
                    } else {
                        _filters["annot-xref"] = featureTextArea.value.toUpperCase();
                    }
                }

                // Panel - annot-panel
                let panelsDropdown = PolymerUtils.getElementById(this.prefix + "PanelApps");
                let panelsTextArea = PolymerUtils.getElementById(this.prefix + "PanelAppsTextarea");
                if (UtilsNew.isNotUndefinedOrNull(panelsDropdown) && (panelsDropdown.value !== "none" || panelsTextArea.value !== "")) {
                    _filters["gene"] = panelsTextArea.value;
                }

                // Biotype
                let biotypeDropdown = PolymerUtils.getElementById(this.prefix + "GeneBiotypes");
                if (UtilsNew.isNotUndefinedOrNull(biotypeDropdown) && UtilsNew.isNotEmpty(biotypeDropdown.value)) {
                    let types = PolymerUtils.querySelectorAll("option:checked", biotypeDropdown);
                    let biotypes = [];
                    types.forEach(option => biotypes.push(option.value));
                    _filters["annot-biotype"] = biotypes.join(",");
                }

                // Type
                let typeCheckbox = PolymerUtils.getElementById(this.prefix + "Type");
                if (UtilsNew.isNotUndefinedOrNull(typeCheckbox)) {
                    let types = PolymerUtils.querySelectorAll("input:checked", typeCheckbox);
                    let typesAux = [];
                    if (types.length > 0) {
                        for (let i = 0; i < types.length; i++) {
                            typesAux.push(types[i].value);
                        }
                        _filters.type = typesAux.join(',');
                    }
                }

                // Population Frequencies
                // Population minor allele frequency: {study}:{population}[<|>|<=|>=]{number}
                let popFreq = [];
                if (UtilsNew.isNotUndefinedOrNull(this.populationFrequencies) && UtilsNew.isNotEmptyArray(this.populationFrequencies.studies)) {
                    for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                        let study = this.populationFrequencies.studies[i].id;
                        for (let j = 0; j < this.populationFrequencies.studies[i].populations.length; j++) {
                            let population = this.populationFrequencies.studies[i].populations[j].id;

                            let studyTextbox = PolymerUtils.getElementById(this.prefix + study + population);
                            if ((UtilsNew.isNotUndefinedOrNull(studyTextbox) && UtilsNew.isNotEmpty(studyTextbox.value))) {
                                let operator = PolymerUtils.getElementById(this.prefix + study + population + "Operator");
                                let pf = study + ":" + population + operator.value + studyTextbox.value;
                                popFreq.push(pf);
                            }
                        }
                    }
                }
                if (popFreq.length > 0) {
                    _filters["alternate_frequency"] = popFreq.join(';');
                }

                // Protein Substitution Scores -  Sift and Polyphen
                let pss = [];
                let numFilters = 0;
                let subsScores = ["Sift", "Polyphen"];
                for (let subsScore of subsScores) {
                    let dropdownValues = PolymerUtils.getElementById(this.prefix + subsScore + "Values");
                    let textboxInput = PolymerUtils.getElementById(this.prefix + subsScore + "Input");
                    let operator = PolymerUtils.getElementById(this.prefix + subsScore + "Operator");
                    if (dropdownValues !== null && dropdownValues.value === "score" && textboxInput !== null && textboxInput.value !== "") {
                        pss.push(subsScore.toLowerCase() + operator.value + textboxInput.value);
                        numFilters++;
                    } else if (dropdownValues !== null && dropdownValues.value !== "score") {
//                        let value = dropdownValues.value;
//                        let splitValues = value.split(',');
//                        for (let i = 0; i < splitValues.length; i++) {
//                            pss.push(subsScore.toLowerCase() + "==" + splitValues[i]);
//                        }
                        pss.push(subsScore.toLowerCase() + "==" + dropdownValues.value);
                        numFilters++;
                    }
                }
                // If both Sift and Polyphen are selected then we activate the AND/OR control
                if (numFilters === 2) {
                    $("input:radio[name=pss]").attr('disabled', false);
                }
                if (pss.length > 0) {
                    let filter = $('input:radio[name=pss]:checked').val();
                    if (filter === "and") {
                        _filters.protein_substitution = pss.join(';');
                    } else {
                        _filters.protein_substitution = pss.join(',');
                    }
                }

                // Cadd scores
                let cadd = [];
                let caddRawInput = PolymerUtils.getElementById(this.prefix + "CaddRawInput");
                let caddScaledInput = PolymerUtils.getElementById(this.prefix + "CaddScaledInput");
                if (UtilsNew.isNotUndefinedOrNull(caddRawInput) && UtilsNew.isNotUndefinedOrNull(caddScaledInput)) {
                    if (UtilsNew.isNotEmpty(caddRawInput.value)) {
                        cadd.push("cadd_raw" + PolymerUtils.getElementById(this.prefix + "CaddRawOperator").value + caddRawInput.value);
                    }
                    if (UtilsNew.isNotEmpty(caddScaledInput.value)) {
                        cadd.push("cadd_scaled" + PolymerUtils.getElementById(this.prefix + "CaddScaledOperator").value + caddScaledInput.value);
                    }
                }
                if (cadd.length > 0) {
                    _filters["annot-functional-score"] = cadd.join(',');
                }

                // Conservation
                let arr = {"Phylop": "phylop", "Phastcons": "phastCons", "Gerp": "gerp"};
                let conserArr = [];
                for (let key of Object.keys(arr)) {
                    let inputTextArea = PolymerUtils.getElementById(this.prefix + key + "Input");
                    if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                        let operator = PolymerUtils.getElementById(this.prefix + key + "Operator");
                        conserArr.push(arr[key] + operator.value + inputTextArea.value);
                    }
                }
                // Disable OR/AND logical operator
                if (conserArr.length > 1) {
                    $("input:radio[name=conservation]").attr('disabled', false);
                } else {
                    $("input:radio[name=conservation]").attr('disabled', true);
                }
                if (conserArr.length > 0) {
                    let filter = $('input:radio[name=conservation]:checked').val();
                    if (filter === "and") {
                        _filters.conservation = conserArr.join(';');
                    } else {
                        _filters.conservation = conserArr.join(',');
                    }
                }

                // Consequence Type
                if (UtilsNew.isNotEmptyArray(this.ct)) {
                    _filters["annot-ct"] = this.ct.join(',');
                }

                // Gene Ontology and Human Phenotype Ontology
                let inputTextArea = PolymerUtils.getElementById(this.prefix + "GeneOntologyTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    _filters["annot-go"] = inputTextArea.value;
                }

                inputTextArea = PolymerUtils.getElementById(this.prefix + "HumanPhenotypeOntologyTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    _filters["annot-hpo"] = inputTextArea.value;
                }

                inputTextArea = PolymerUtils.getElementById(this.prefix + "ClinVarTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    _filters["clinvar"] = inputTextArea.value;
                }

                inputTextArea = PolymerUtils.getElementById(this.prefix + "TraitsTextarea");
                if (UtilsNew.isNotUndefinedOrNull(inputTextArea) && UtilsNew.isNotEmpty(inputTextArea.value)) {
                    _filters["traits"] = inputTextArea.value;
                }

                // To prevent to call setQueryFilters we set this to false
                this._reset = false;
                this.query = _filters;
                this._reset = true;
            }

            callAutocomplete(e) {
                // Only gene symbols are going to be searched and not Ensembl IDs
                let featureId = PolymerUtils.getElementById(this.prefix  + "FeatureIdText").value;
                if (UtilsNew.isNotUndefinedOrNull(featureId) && featureId.length >= 3 && !featureId.startsWith("ENS")) {
                    let _this = this;
                    _this.cellbaseClient.get('feature', 'id', featureId.toUpperCase(), 'starts_with', {}, {})
                        .then(function (response) {
                            let options = "";
                            for (let id of response.response[0].result) {
                                options += `<option value="${id.name}">`;
                            }
                            PolymerUtils.innerHTML(_this.prefix + "FeatureDatalist", options);
                        });
                }
            }

            addFeatureId(e) {
                let allIds = [];
                let featureTextArea = PolymerUtils.getElementById(this.prefix + "FeatureTextarea");
                if (UtilsNew.isNotUndefinedOrNull(featureTextArea) && UtilsNew.isNotEmpty(featureTextArea.value)) {
                    allIds = featureTextArea.value.split(',');
                }

                let featureIdText = PolymerUtils.getElementById(this.prefix + "FeatureIdText");
                if (allIds.indexOf(featureIdText.value) === -1) {
                    allIds.push(featureIdText.value);
                }
                featureIdText.value = "";
                featureTextArea.value = allIds;

                this.updateQueryFilters();
            }

            selectSegregation(e) {
                e.preventDefault();
                this.segregation = e.target.innerHTML;
            }

            _clearHtmlDom() {
                // Empty samples and genotypes
//                this.set('samples', []);
//                this.sampleGenotypes = {};

                // Empty everything before rendering
                $("." + this.prefix + "FilterSelect").prop('selectedIndex', 0);
                $("." + this.prefix + "FilterSelect").prop("disabled", false);
                $("." + this.prefix + "FilterTextInput").val("");
                $("." + this.prefix + "FilterTextInput").prop("disabled", false);
                $("." + this.prefix + "FilterCheckBox").prop("checked", false);
                $("." + this.prefix + "FilterRadio").prop("checked", false);
                $("." + this.prefix + "FilterRadio").filter('[value="or"]').prop('checked', true);
                $("." + this.prefix + "FilterRadio").prop("disabled", true);



                // Deselect bootstrap-select dropdowns
                $("#" + this.prefix + "GeneBiotypes").selectpicker('val', []);
            }

            showSegregation(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
//                this.samples = this.analysisSelected.sampleList;
//                this.
                $("#analysisSelectedDiv").show();
//                $("#segregationDropdownDiv").show();
            }

            closeModalSample(e) {
                this.dispatchEvent(new CustomEvent("closemodalsample", {detail: {}, bubbles: true, composed: true}));
            }

//            showClinicalSelector(e){
//                e.preventDefault();
//                if (UtilsNew.isUndefined(this.analysisModal)){
//                    this.analysisModal = true;
//                }
//                else {
//                    this.analysisModal = ! this.analysisModal;
//                }
//                $("#" + this.prefix + "AnalysisBrowser").modal('show');
//
//            }

            clinicalAnalysisExistObserver(e){
//                if(UtilsNew.isNotUndefinedOrNull(this.clinicalAnalysis)){
//                    PolymerUtils.setAttribute(this.prefix + "analysisSettings", "disabled", "disabled");
//                    PolymerUtils.setAttribute(this.prefix + "selectAnalysisType", "disabled", "disabled");
//                }
            }

            _isNotEmptyArray(str) {
                let arr = this[str];
                return UtilsNew.isNotEmptyArray(arr);
            }





            _renderFilterMenu() {
                let html = "";
                for (let section of this.config.filter.sections) {
                    html += this._createSection(section, this.prefix);
                }
                this.$.FilterMenu.innerHTML = html;
            }

            _createSection(section, prefix) {
                let id = section.title.replace(" ", "");
                let collapsed = section.collapsed ? "" : "in";

                let header= `
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="${prefix}${id}Heading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#${prefix}Accordion"
                                    href="#${prefix}${id}" aria-expanded="true" aria-controls="${prefix}${id}">
                                    ${section.title}
                                </a>
                            </h4>
                        </div>

                        <div id="${prefix}${id}" class="panel-collapse collapse ${collapsed}" role="tabpanel" aria-labelledby="${prefix}${id}Heading">
                            <div class="panel-body">
                `;

                // We get the HTML content for each subsection
                let content = "";
                for (let subsection of section.subsections) {
                    content += this._createSubSection(subsection);
                }

                let footer = `
                            </div>
                        </div>
                    </div>
                `;

                return header + content + footer;
            }

            _createSubSection(subsection) {
                // Add subsection header
                let header = `
                    <div class="form-group">
                        <div class="browser-subsection" id="${subsection.id}" name="${subsection.title}">${subsection.title}
                            <div style="float: right" class="tooltip-div">
                                <a><i class="fa fa-info-circle" aria-hidden="true" id="${subsection.id}Tooltip"></i></a>
                            </div>
                        </div>
                        <div class="subsection-content">
                `;

                let content = "";
                switch (subsection.id) {
                    case "location":
                        content = this._getLocationHtml(this.prefix);
                        break;
                    case "feature":
                        content = this._getFeatureHtml(this.prefix);
                        break;
                    case "geneDiseasePanels":
                        content = this._getGeneDiseasePanelsHtml(this.prefix);
                        break;
                    case "biotype":
                        content = this._getBiotypeHtml(this.prefix);
                        break;
                    case "variantType":
                        content = this._getVariantTypeHtml(this.prefix);
                        break;
                    case "1kG_phase3":
                    case "EXAC":
                    case "ESP6500":
                        header = `
                            <div class="form-group">
                                <div class="browser-subsection" id="${subsection.id}" name="${subsection.title}">
                                    <i id="${this.prefix}${subsection.id}Icon" data-id="${this.prefix}${subsection.id}"
                                            class="fa fa-plus" style="cursor: pointer;padding-right: 10px"></i>
                                        ${subsection.title}
                                    <div style="float: right" class="tooltip-div">
                                        <a><i class="fa fa-info-circle" aria-hidden="true" id="${subsection.id}Tooltip"></i></a>
                                    </div>
                                </div>
                            <div class="subsection-content">
                        `;
                        content = this._getPopulationFrequencyHtml(subsection.id, this.prefix);
                        break;
                    case "proteinSubstitutionScore":
                        content = this._getProteinSubstitutionScore(this.prefix);
                        break;
                    case "cadd":
                        content = this._getCadd(this.prefix);
                        break;
                    case "conservation":
                        content = this._getConservation(this.prefix);
                        break;
                    case "goAccessions":
                        content = this._getGoAccessions(this.prefix);
                        break;
                }

                // Add subsection footer
                let footer = `
                        </div>
                    </div>
                `;

                return header + content + footer;
            }

            _getLocationHtml(prefix) {
                return `
                    <textarea id="${prefix}LocationTextarea" name="location" class="form-control clearable ${prefix}FilterTextInput"
                        rows="3" placeholder="3:444-55555,1:1-100000"></textarea>
                `;
            }

            _getFeatureHtml(prefix) {
                return `
                    <div class="row">
                        <div class="col-md-9">
                            <input id="${prefix}FeatureIdText" type="text" class="form-control" list="${prefix}FeatureDatalist"
                                    placeholder="Search for Gene Symbols" value="">
                                <datalist id="${prefix}FeatureDatalist"></datalist>
                        </div>
                        <div class="col-md-3">
                            <button id="${prefix}FeatureAddButton" type="button" class="btn btn-default btn-sm form-control">
                                <i class="fa fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                            <textarea id="${prefix}FeatureTextarea" name="geneSnp" class="form-control clearable ${prefix}FilterTextInput"
                                rows="3" placeholder="BRCA2,ENSG00000139618,ENST00000544455,rs28897700" style="margin-top: 5px"></textarea>
                    </div>
                `;
            }

            _getGeneDiseasePanelsHtml(prefix) {
                let options = "";
                this.panelList.sort(this.sortPanelApp).forEach((item) => {
                    options += `<option value="${item.name}">${item.title} (${item.genes.length})</option>`;
                });

                return `
                    <select class="form-control ${prefix}FilterSelect" id="${prefix}PanelApps">
                        <option value="none">Select a panel...</option>
                        ${options}
                    </select>
                    <div style="padding-top: 5px">
                        <textarea id="${prefix}PanelAppsTextarea" name="panelAppsTextarea"
                                  class="form-control clearable ${prefix}FilterTextInput"
                                  rows="3" placeholder="No panel selected"></textarea>
                    </div>
                `;
            }


            _getBiotypeHtml(prefix) {
                let options = "";
                for (let biotype of this.biotypes) {
                    options += `<option value="${biotype}">${biotype}</option>`;
                }
                return `
                    <select class="selectpicker form-control" id="${prefix}GeneBiotypes" data-size="10" data-live-search="true"
                            data-selected-text-format="count" multiple>
                        ${options}
                    </select>
                `;
            }

            _getVariantTypeHtml(prefix) {
                return `
                    <div id="${prefix}Type">
                        <input type="checkbox" value="SNV,SNP" class="${prefix}FilterCheckBox"> SNV<br>
                        <input type="checkbox" value="MNV" class="${prefix}FilterCheckBox"> MNV<br>
                        <input type="checkbox" value="CNV" class="${prefix}FilterCheckBox"> CNV<br>
                        <input type="checkbox" value="SV" class="${prefix}FilterCheckBox"> SV<br>
                        <input type="checkbox" value="INDEL" class="${prefix}FilterCheckBox"> INDEL
                    </div>
                `;
            }

            _getPopulationFrequencyHtml(studyId, prefix) {
                let study;
                for (let st of this.populationFrequencies.studies) {
                    if (st.id === studyId) {
                        study = st;
                        break;
                    }
                }

                let content = "";
                for (let popFreq of study.populations) {
                    content += `
                        <div class="row" style="margin: 5px 0px">
                            <span class="col-md-3 control-label" data-toggle="tooltip" data-placement="top" title="${popFreq.title}">${popFreq.id}</span>
                            <div class="col-md-4" style="padding: 0px 10px">
                                <select id="${prefix}${studyId}${popFreq.id}Operator" name="${popFreq.id}Operator"
                                        class="form-control input-sm ${prefix}FilterSelect" style="padding: 0px 5px">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-5" style="padding: 0px 10px">
                                <input id="${prefix}${studyId}${popFreq.id}" type="text" value="" class="form-control input-sm ${prefix}FilterTextInput"
                                        name="${study.id}_${popFreq.id}">
                            </div>
                        </div>
                    `;
                }

                return `
                    <div id="${prefix}${studyId}" class="form-horizontal" hidden>
                        ${content}
                    </div>
                `;
            }

            _getProteinSubstitutionScore(prefix) {
                return `
                       <div style="padding-top: 10px">
                            <span style="padding-left: 0px;">SIFT</span>
                            <div class="row">
                                <div class="col-md-5" style="padding-right: 5px">
                                    <select  name="Sift" id="${prefix}SiftValues" class="${prefix}FilterSelect form-control input-sm options">
                                        <option value="score" selected>Score...</option>
                                        <option value="tolerated">Tolerated</option>
                                        <option value="deleterious">Deleterious</option>
                                    </select>
                                </div>
                                <div class="col-md-3" style="padding: 0px 5px">
                                    <select name="siftOperator" id="${prefix}SiftOperator" class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                        <option value="<"><</option>
                                        <option value="<="><=</option>
                                        <option value=">"selected>></option>
                                        <option value=">=">>=</option>
                                    </select>
                                </div>
                                <div class="col-md-4" style="padding-left: 5px">
                                    <input id="${prefix}SiftInput" name="Sift" type="text" value=""
                                           class="${prefix}FilterTextInput form-control input-sm">
                                </div>
                            </div>
                        </div>

                        <div style="padding-top: 15px">
                            <span style="padding-top: 10px;padding-left: 0px;">Polyphen</span>
                            <div class="row">
                                <div class="col-sm-5" style="padding-right: 5px">
                                    <select name="Polyphen" id="${prefix}PolyphenValues" class="${prefix}FilterSelect form-control input-sm options">
                                        <option value="score" selected>Score...</option>
                                        <option value="benign">Benign</option>
                                        <option value="unknown">Unknown</option>
                                        <option value="possibly damaging">Possibly damaging</option>
                                        <option value="probably damaging">Probably damaging</option>
                                        <option value="possibly damaging,probably damaging">Possibly & Probably damaging</option>
                                    </select>
                                </div>
                                <div class="col-sm-3" style="padding: 0px 5px">
                                    <select name="polyphenOperator" id="${prefix}PolyphenOperator" class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                        <option value=">" selected>></option>
                                        <option value=">=">>=</option>
                                        <option value="<" ><</option>
                                        <option value="<="><=</option>
                                    </select>
                                </div>
                                <div class="col-sm-4" style="padding-left: 5px">
                                    <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                        id="${prefix}PolyphenInput" name="Polyphen" >
                                </div>
                            </div>

                            <form style="padding-top: 15px">
                                <label style="font-weight: normal;">Logical Operator</label>
                                <input type="radio" name="pss" id="${prefix}pssOrRadio" value="or" class="${prefix}FilterRadio"
                                    checked disabled  style="margin-left: 10px"> OR<br>
                                <input type="radio" name="pss" id="${prefix}pssAndRadio" value="and"
                                    class="${prefix}FilterRadio" disabled style="margin-left: 102px"> AND  <br>
                            </form>
                            <br>
                        </div>
                `;
            }


            _getCadd(prefix) {
                return `
                    <div style="padding-top: 10px">
                        <div class="row">
                            <div class="col-md-5 form-group" style="padding-right: 5px">
                                <span class="control-label">Raw</span>
                            </div>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="caddRawOperator" id="${prefix}CaddRawOperator"
                                 class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<"><</option>
                                        <option value="<="><=</option>
                                        <option value=">" selected>></option>
                                        <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                   id="${prefix}CaddRawInput" name="caddRaw">
                            </div>

                        </div>
                    </div>

                    <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px">Scaled</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="caddRScaledOperator" id="${prefix}CaddScaledOperator"
                                class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                       id="${prefix}CaddScaledInput" name="caddScaled">
                            </div>
                        </div>
                    </div>
                `;
            }

            _getConservation(prefix) {
                return `
                     <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px"> PhyloP</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="phylopOperator" id="${prefix}PhylopOperator" class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<"><</option>
                                    <option value="<="><=</option>
                                    <option value=">" selected>></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                   id="${prefix}PhylopInput" name="phylop">
                            </div>
                        </div>
                    </div>

                     <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px">PhastCons</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="phastconsOperator" id="${prefix}PhastconsOperator"
                                       class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<" ><</option>
                                    <option value="<="><=</option>
                                    <option value=">" selected>></option>
                                    <option value=">=">>=</option>
                                </select>
                            </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                   id="${prefix}PhastconsInput" name="phastCons">
                            </div>
                        </div>
                    </div>

                    <div style="padding-top: 10px">
                        <div class="row">
                            <span class="col-md-5 control-label" style="padding-right: 5px">Gerp</span>
                            <div class="col-md-3" style="padding: 0px 5px">
                                <select name="gerpOperator" id="${prefix}GerpOperator"
                                        class="${prefix}FilterSelect form-control input-sm" style="padding: 0px 5px">
                                    <option value="<"><</option>
                                    <option value="<="><=</option>
                                    <option value=">" selected>></option>
                                    <option value=">=">>=</option>
                                </select>
                             </div>
                            <div class="col-md-4" style="padding-left: 5px">
                                <input type="text" value="" class="${prefix}FilterTextInput form-control input-sm"
                                    id="${prefix}GerpInput" name="gerp">
                            </div>
                        </div>

                        <form style="padding-top: 15px">
                            <label style="font-weight: normal;">Logical Operator</label>
                            <input type="radio" name="conservation" id="${prefix}conservationOrRadio" value="or"
                                class="${prefix}FilterRadio" checked disabled  style="margin-left: 10px"> OR<br>
                            <input type="radio" name="conservation" id="${prefix}conservationAndRadio" value="and"
                                class="${prefix}FilterRadio" disabled style="margin-left: 102px"> AND<br>
                        </form>
                    </div>
                `;
            }

            _getGoAccessions(prefix) {
                return `
                    <div class="form-group">
                        <textarea id="${prefix}GeneOntologyTextarea" readonly class="form-control clearable ${prefix}FilterTextInput"
                                  rows="3" name="geneOntology" placeholder="GO:0000145"></textarea>
                        <span class="input-group-addon btn btn-primary searchingSpan" id="${prefix}buttonOpenGoAccesions">
                            <strong style="color: white;" >Add Go Term</strong>
                            <i class="fa fa-search searchingButton" aria-hidden="true"></i>
                        </span>
                    </div>
                `;
            }


            _addEventListeners() {
                let keyupEvents = ["LocationTextarea", "FeatureTextarea", "PanelAppsTextarea", "FilterTextInput", "CaddScaledInput", "SiftInput",
                    "PolyphenInput", "PhylopInput", "PhastconsInput", "GerpInput", "GeneOntologyTextarea"];
                for (let id of keyupEvents) {
                    let element = PolymerUtils.getElementById(this.prefix + id);
                    if (UtilsNew.isNotUndefinedOrNull(element)) {
                        element.addEventListener('keyup', this.updateQueryFilters.bind(this));
                    }
                }

                let changeEvents = ["GeneBiotypes", "Type", "CaddRawOperator", "CaddScaledOperator", "SiftOperator", "PolyphenOperator",
                    "pssOrRadio", "pssAndRadio", "PhylopOperator", "PhastconsOperator", "GerpOperator", "conservationAndRadio", "conservationOrRadio"];
                for (let id of changeEvents) {
                    let element = PolymerUtils.getElementById(this.prefix + id);
                    if (UtilsNew.isNotUndefinedOrNull(element)) {
                        element.addEventListener('change', this.updateQueryFilters.bind(this));
                    }
                }

                // Add events for Feature IDs
                PolymerUtils.getElementById(this.prefix + "FeatureIdText").addEventListener('keyup', this.callAutocomplete.bind(this));
                PolymerUtils.getElementById(this.prefix + "FeatureAddButton").addEventListener('click', this.addFeatureId.bind(this));

                // Add events for gene disease panels
                PolymerUtils.getElementById(this.prefix + "PanelApps").addEventListener('change', this.onGeneDiseasePanelChange.bind(this));


                // Add events for Population Frequency
                for (let study of this.populationFrequencies.studies) {
                    let element = PolymerUtils.getElementById(this.prefix + study.id + "Icon");
                    if (UtilsNew.isNotUndefinedOrNull(element)) {
                        element.addEventListener('click', this.handleCollapseAction.bind(this));
                    }

                    for (let pop of study.populations) {
                        PolymerUtils.getElementById(this.prefix + study.id + pop.id).addEventListener('keyup', this.updateQueryFilters.bind(this));
                        PolymerUtils.getElementById(this.prefix + study.id + pop.id + "Operator").addEventListener('change', this.updateQueryFilters.bind(this));
                    }
                }

                // Add events Protein substitution score
                PolymerUtils.getElementById(this.prefix + "SiftValues").addEventListener('change', this.checkScore.bind(this));
                PolymerUtils.getElementById(this.prefix + "PolyphenValues").addEventListener('change', this.checkScore.bind(this));

                // Add events gene ontology
                PolymerUtils.getElementById(this.prefix + "buttonOpenGoAccesions").addEventListener('click', this.openModalGo.bind(this));
            }

            _addAllTooltips() {
                for (let section of this.config.filter.sections) {
                    for (let subsection of section.subsections) {
                        if (UtilsNew.isNotEmpty(subsection.tooltip)) {
                            let tooltipIcon = $("#" + subsection.id + "Tooltip");
                            if (UtilsNew.isNotUndefinedOrNull(tooltipIcon)) {
                                this._addTooltip(tooltipIcon, subsection.title, subsection.tooltip);
                            }
                        }
                    }
                }
            }

            _addTooltip(div, title, content) {
                div.qtip({
                    content: {
                        title: title,
                        text: content
                    },
                    position: {
                        target: "mouse",
                        adjust: {
                            x: 2, y: 2,
                            mouse: false
                        }
                    },
                    style: {
                        width: true,
//                        classes:  "ocb-tooltip-font" + "  ui-tooltip ui-tooltip-shadow"},
                        classes: this.config.filter.tooltip.classes
                    },
                    show: {
                        delay: 200
                    },
                    hide: {
                        fixed: true,
                        delay: 300
                    }
                });
            }
        }

        customElements.define(VariantBrowserFilter.is, VariantBrowserFilter);
    </script>
</dom-module>
