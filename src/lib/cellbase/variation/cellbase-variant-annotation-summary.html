
<dom-module id="cellbase-variant-annotation-summary">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div>
            <b>Variant:</b> {{data.chromosome}}:{{data.start}}:{{data.reference}}:{{data.alternate}}<br>
            <b>Consequence Type:</b> {{data.displayConsequenceType}}<br>
            <b>Population Frequency:</b><br>
            <template is="dom-repeat" items="{{data.populationFrequencies}}" as="popFreq">
                <template is="dom-if" if="{{checkforAll(popFreq)}}">
                    {{popFreq.study}}: <b><i>{{popFreq.population}}</i></b> - {{popFreq.altAlleleFreq}} &nbsp;
                    <template is="dom-repeat" items="{{minimumFreq}}" as="minFreq">
                        <template is="dom-if" if="{{checkSameStudy(popFreq, minFreq)}}">
                            <b><i>Minimum:</i></b> {{minFreq.freq}} ({{minFreq.population}})
                        </template>
                    </template>
                    <br>
                </template>
            </template>

            <b>Number of Variant Trait Association:</b> {{numberVTA}}<br>
            <b>Number of Gene Trait Association:</b> {{numberGTA}}<br>
            <b>Conservation:</b><br>
            <template is="dom-repeat" items="{{conservation}}">
                {{item.source}} - {{item.score}} <br>
            </template>
            <b>Cadd:</b><br>
            <template is="dom-repeat" items="{{functionalScore}}">
                {{item.source}} - {{item.score}}<br>
            </template>
            <!--<table class="table table-hover table-bordered" style="width: 60%; margin: auto; text-align: justify;">-->
                <!--<thead style="background-color: #eee">-->
                <!--<tr>-->
                    <!--<th>Source</th>-->
                    <!--<th>Score</th>-->
                <!--</tr>-->
                <!--</thead>-->
                <!--<tbody>-->
                <!--<template is="dom-repeat" items="{{conservation}}">-->
                    <!--<tr>-->
                        <!--<td>{{item.source}}</td>-->
                        <!--<td>{{item.score}}</td>-->
                    <!--</tr>-->
                <!--</template>-->
                <!--<template is="dom-repeat" items="{{functionalScore}}">-->
                    <!--<tr>-->
                        <!--<td>{{item.source}}</td>-->
                        <!--<td>{{item.score}}</td>-->
                    <!--</tr>-->
                <!--</template>-->
                <!--</tbody>-->
            <!--</table>-->
        </div>
    </template>
    <script>
        Polymer({
            is: 'cellbase-variant-annotation-summary',
            properties: {
                data: {
                    type: Object,
                    value: {},
                    observer: 'variantAnnotationChanged'
                },
                minimumFreq: {
                    type: Array
                }
            },
            checkforAll: function(populationFreq) {
                return populationFreq.population == "ALL";
            },
            checkSameStudy: function(popFreq, minFreq) {
                return !!(popFreq.study == minFreq.study && minFreq.population != "ALL");
            },
            variantAnnotationChanged: function(neo, old) {
                let _this = this;

                if (typeof this.data !== "undefined") {
                    if (_this.data.variantTraitAssociation != null) {
                        _this.numberVTA = Object.keys(_this.data.variantTraitAssociation).length;
                    } else {
                        _this.numberVTA = 0;
                    }

                    if (_this.data.geneTraitAssociation != null) {
                        _this.numberGTA = _this.data.geneTraitAssociation.length;
                    }

                    let conservation = [];
                    for (let i in _this.data.conservation) {
                        conservation.push({source: _this.data.conservation[i].source.charAt(0).toUpperCase()
                        + _this.data.conservation[i].source.slice(1), score: Number(_this.data.conservation[i].score).toFixed(3)});
                    }
                    _this.conservation = conservation;

                    let functionalScore = [];
                    for (let i in _this.data.functionalScore) {
                        functionalScore.push({source: _this.data.functionalScore[i].source.charAt(0).toUpperCase()
                        + _this.data.functionalScore[i].source.slice(1), score: Number(_this.data.functionalScore[i].score).toFixed(3)});
                    }
                    _this.functionalScore = functionalScore;

                    let minimumFreq = [];
                    if (_this.data.populationFrequencies != null) {
                        let minFreq = {};
                        for (let i in _this.data.populationFrequencies) {
                            let populationFreq = _this.data.populationFrequencies[i];
                            if (Object.keys(minFreq).length === 0 && minFreq.constructor === Object) {
                                minFreq.freq = populationFreq.altAlleleFreq;
                                minFreq.population = populationFreq.population;
                                minFreq.study = populationFreq.study;
                            } else if (populationFreq.study == minFreq.study) {
                                if (populationFreq.altAlleleFreq < minFreq.freq) {
                                    minFreq.freq = populationFreq.altAlleleFreq;
                                    minFreq.population = populationFreq.population;
                                    minFreq.study = populationFreq.study;
                                }
                            } else {
                                minimumFreq.push({freq: minFreq.freq, population: minFreq.population, study: minFreq.study});
                                minFreq.freq = populationFreq.altAlleleFreq;
                                minFreq.population = populationFreq.population;
                                minFreq.study = populationFreq.study;
                            }
                        }
                        minimumFreq.push({freq: minFreq.freq, population: minFreq.population, study: minFreq.study}); // last study's minimum frequency have to be pushed
                    }
                    _this.minimumFreq = minimumFreq;

                }
            }
        });
    </script>
</dom-module>