<polymer-element name="jso-class-comparison" attributes="userData selectedOption selectedStudy studies">
<template>
    <link rel="stylesheet" href="../jso-style.css">
    <style>
        :host {
            display: block;
            position: absolute;
            box-sizing: border-box;
            background-color: #FFFFFF;
            padding: 30px 100px;

            z-index: 50000;
            top: 90px;

            left: 0;
            right: 0;
            margin-left: auto;
            margin-right: auto;

            width: 40vw;
            border: 0px solid #c6d0da;
            border-width: 1px;
            /*border-top-width: 1px;*/
            transition: all 0.2s;
            box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.2);
        }

        .title {
            text-align: center;
            font-size: 25px;
            color: #666;
        }

        .icon {
            color: #445D76;
            font-size: 50px;
        }

        label {
            display: inline-block;
            color: #666;
            margin-top: 3px;
            /*width: 150px;*/
        }

        label::after {
            content: ':'
        }

        .action {
            /*margin-top: 30px;*/
            background-color: #f5f5f5 !important;
            text-align: center;
        }

        .action:active {
            background-color: #445D76 !important;
            color: #fff !important;
        }

        .message {
            margin-top: 20px;
        }

        div.button {
            /*display: inline-block;*/
            width: 300px
        }

        /*jso-file-browser {*/
        /*width: 70%;*/
        /*}*/

        span {
            border: 1px solid;
        }
    </style>
    <div class="title">
        <div>
            Differential expression: class comparison
        </div>
        <div class="icon">
            <!--<font-awesome icon="magic"></font-awesome>-->
        </div>
    </div>
    <form id="form">
        <h3>Examples</h3>

        <div class="button action" on-click="{{loadExample1}}">Load example 1</div>

        <div>
            <h3>Output parameters</h3>
            <jso-project-browser class="input-project-browser" id="outdir" studies="{{studies}}" selectedStudy="{{selectedStudy}}" ></jso-project-browser>
        </div>
        <div>
            <h3>Select your data</h3>
            <jso-project-browser class="input-project-browser" id="inputFile" studies="{{studies}}" selectedStudy="{{selectedStudy}}" on-file-select="{{handleFileSelect}}"></jso-project-browser>
        </div>
        <div>
            <h3>Select the class to analyse</h3>
            <jso-class-viewer id="jsoClassViewer" contentFile="{{contentFile}}" loadedMainSelect="{{loadedMainSelect}}"
                              loadedChildrenSelect="{{loadedChildrenSelect}}" changedChildrenSelect="{{changedChildrenSelect}}"></jso-class-viewer>

        </div>
        <div id="testDiv">
            <h3>Select test</h3>
            <input id="one_rg_1" name="one_rg" class="fc-radioitem fc-disabled" type="radio" value="limma" checked="checked" disabled on-click="{{radioTestClicked}}">Limma
            <hr>
            <input id="two_rg_1" name="two_rg" class="fc-radioitem" type="radio" value="t" checked="checked" disabled on-click="{{radioTestClicked}}">T-test<br>
            <input id="two_rg_2" name="two_rg" class="fc-radioitem" type="radio" value="limma" disabled on-click="{{radioTestClicked}}">Limma<br>
            <input id="two_rg_3" name="two_rg" class="fc-radioitem" type="radio" value="fold_change" disabled on-click="{{radioTestClicked}}">Fold-change
            <div id="fold_change_div" hidden>
                <h3>Select fold-change value</h3>
                <label>Fold-change value</label>
                <input name="fold_change_value" id="fold_change_value" class="fc-decimal fc-text fc-disabled" type="text" value="2">
            </div>
            <hr>
            <input id="multi_rg_1" name="multi_rg" class="fc-radioitem fc-disabled" type="radio" value="anova" checked="checked" disabled on-click="{{radioTestClicked}}">Anova<br>
            <input id="multi_rg_2" name="multi_rg" class="fc-radioitem fc-disabled" type="radio" value="limma" disabled on-click="{{radioTestClicked}}">Limma<br>
        </div>
        <div id="multiple_test_correction_div">
            <h3>Select multiple-test correction</h3>
            <input id="correction_1" name="correction" class="fc-radioitem" type="radio" value="fdr" checked="checked">Benjamini
            and Hochberg (BH), FDR <br>
            <input id="correction_2" name="correction" class="fc-radioitem" type="radio" value="by"> Benjamini and
            Yekutieli (BY) <br>
            <input id="correction_3" name="correction" class="fc-radioitem" type="radio" value="hochberg">Hochberg <br>
            <input id="correction_4" name="correction" class="fc-radioitem" type="radio" value="holm">Holm <br>
            <input id="correction_5" name="correction" class="fc-radioitem" type="radio"
                   value="bonferroni">Bonferroni<br>
        </div>

        <div id="adjusted_p_value_div">
            <h3>Select adjusted p-value</h3>
            <label>Adj. p-value (0.0-1.0)</label><input name="p_value" id="p_value" class="fc-decimal fc-text"
                                                        type="text" value="{{p_value}}">
        </div>

        <h3>Job information</h3>

        <label>Job name</label> <input type="text" id="jobName" value="{{jobName}}" required pattern="[a-zA-Z0-9]+">
        <textarea required value="{{description}}"></textarea>

        <div class="button action" on-click="{{handleForm}}">Run</div>
    </form>
    <div class="message">{{message}}</div>

</template>
<script>
Polymer({
    created: function () {
        this.jobName = 'JobName';
        this.toolName = "class-comparison";
        this.description = "Job description.";

        /** Tool input parameters **/
        this.class_name = "";
        this.class_values = "";
        this.correction = "";
        this.dataset = "";
        this.fold_change_value = "";
        this.outdir = "";
        this.p_value = 0.05;
        this.species = "";
        this.test = "";

    },
    ready: function () {
//        debugger
    },
    handleFileSelect: function(e){
        var file = e.detail.file;
        if(file.type == "FILE")
            this.getContentFile(file);
    },
    loadExampleFile: function (exampleFileName) {
        var me = this;
        OpencgaManager.files.contentExample({
            query: {
                toolName: this.toolName,
                fileName: exampleFileName
            },
            request: {
                //method: 'POST',
                success: function (response) {
                    me.contentFile = response;
                },
                error: function () {
                    me.message = 'Server error, try again later.';
                }
            }
        })
    },
    getContentFile: function (file) {

        var me = this;
        if (String(file.id).indexOf("example_") >= 0) {
            this.loadExampleFile(file.path);
        } else {
            OpencgaManager.files.content({
                id: file.id,
                query: {
                    sid: Cookies('bioinfo_sid')
                },
                request: {
                    //method: 'POST',
                    success: function (response) {
                        me.contentFile = response;
                    },
                    error: function () {
                        var message = 'Server error, try again later.';
                    }
                }
            })
        }
    },

//    list1Changed: function (oldV, newV) {
//
//        if (typeof oldV != 'undefined') {
//            this.getContentFile(newV);
//        }
//    },
    handleForm: function () {
        this.launchJob();

    },
    launchJob: function () {
        var me = this;

        this.test = this.getSelectedTest();
        this.class_name = this.$.jsoClassViewer.getMainSelect().value;
        this.class_values = this.getClassValues();
        var query = {
            sid: Cookies("bioinfo_sid"),
            studyId: this.selectedStudy.id,
            toolId: this.toolName,
            outdir: this.$.outdir.selectedFile.id,
            name: this.jobName,
            description: this.description,
            "class-name": this.class_name,
            "class-values": this.class_values,
            dataset: this.$.inputFile.selectedFile.id,
//            "fold-change-value": this.fold_change_value,
//            "p-value": this.p_value,
            test: this.test
        };
        if (this.$.two_rg_3.disabled == false && this.$.two_rg_3.checked)
            query["fold-change-value"] = this.$.fold_change_value.value;
        else {
            query["correction"] = this.$.multiple_test_correction_div.querySelector('input[name="correction"]:checked').value;
            query["p-value"] = this.p_value;
        }
        OpencgaManager.jobs.create({
            query: query,
            request: {
                //method: 'POST',
                success: function (response) {
                    if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                        var userId = response.response[0].result[0].id;
                        me.message = userId + ' created';
                        me.selectedOption = "jobLaunched"
                    } else {
                        me.message = response.response[0].errorMsg;
                    }
                },
                error: function () {
                    me.message = 'Server error, try again later.';
                }
            }
        })
    },
    loadExample1: function (e) {

        this.jobName = "Differential expression - Class comparison demo (correlation.txt)";
        this.description = "Just a differencial expression demo";
        this.newFolderName = "de_" + Math.floor((Math.random() * 100) + 1);
        this.list1 = {id: "example_correlation.txt", path: "correlation.txt"};
        this.p_value = 0.05;
        this.$.multi_rg_1.checked = true;
        this.$.correction_1.checked = true;

    },
    loadedMainSelectChanged: function (oldV, newV) {
        /** This is mainly for the examples **/
        var me = this;
        if (newV == true) {
            var select = this.$.jsoClassViewer.getMainSelect();
            select.addEventListener("change", function () {
                me.manageClass()
            });

//            if (this.list1.id == "example_correlation.txt") {
//                select.value = "indep";
//                this.$.jsoClassViewer.selectChange();
//            }
        }
    },
    loadedChildrenSelectChanged: function (oldV, newV) {
        var me = this;
        if (newV == true) {
            var childrenSelect = this.$.jsoClassViewer.getChildrenSelect().children;
            for (var i = 0; i < childrenSelect.length; i++) {
                var select = childrenSelect[i];
                select.addEventListener("change", function () {
                    me.manageTest()
                });
            }
            /** This is mainly for the examples **/
//            if (this.list1.id == "example_correlation.txt") {
//                childrenSelect[0].value = 1;
//                childrenSelect[1].value = 3;
//                childrenSelect[2].value = 5;
//                childrenSelect[3].value = 7;
//                childrenSelect[4].value = 9;
//
//                this.$.one_rg_1.disabled = true;
//                this.$.two_rg_1.disabled = true;
//                this.$.two_rg_2.disabled = true;
//                this.$.two_rg_3.disabled = true;
//                this.$.multi_rg_1.disabled = false;
//                this.$.multi_rg_2.disabled = false;
//            }
        }
    },
    manageClass: function () {
        this.loadedChildrenSelect = false;
        var select = this.$.jsoClassViewer.getMainSelect();
        if (select.value == "none") {
            this.$.one_rg_1.disabled = true;
            this.$.two_rg_1.disabled = true;
            this.$.two_rg_2.disabled = true;
            this.$.two_rg_3.disabled = true;
            this.$.multi_rg_1.disabled = true;
            this.$.multi_rg_2.disabled = true;
        }
    },
    manageTest: function () {
        var childrenSelect = this.$.jsoClassViewer.getChildrenSelect().children;
        var count = 0;
        for (var i = 0; i < childrenSelect.length; i++) {
            var select = childrenSelect[i];
            if (select.value != "none")
                count++;
        }
        if (count == 0) {
            this.$.one_rg_1.disabled = true;
            this.$.two_rg_1.disabled = true;
            this.$.two_rg_2.disabled = true;
            this.$.two_rg_3.disabled = true;
            this.$.multi_rg_1.disabled = true;
            this.$.multi_rg_2.disabled = true;
        }
        if (count == 1) {
            this.$.one_rg_1.disabled = false;
            this.$.two_rg_1.disabled = true;
            this.$.two_rg_2.disabled = true;
            this.$.two_rg_3.disabled = true;
            this.$.multi_rg_1.disabled = true;
            this.$.multi_rg_2.disabled = true;
        }
        if (count == 2) {
            this.$.one_rg_1.disabled = true;
            this.$.two_rg_1.disabled = false;
            this.$.two_rg_2.disabled = false;
            this.$.two_rg_3.disabled = false;
            this.$.multi_rg_1.disabled = true;
            this.$.multi_rg_2.disabled = true;
        }
        if (count > 2) {
            this.$.one_rg_1.disabled = true;
            this.$.two_rg_1.disabled = true;
            this.$.two_rg_2.disabled = true;
            this.$.two_rg_3.disabled = true;
            this.$.multi_rg_1.disabled = false;
            this.$.multi_rg_2.disabled = false;
        }
    },
    radioTestClicked: function () {
        if (this.$.two_rg_3.checked) {
            this.$.fold_change_div.hidden = false;
            this.$.adjusted_p_value_div.hidden = true;
            this.$.multiple_test_correction_div.hidden = true;
        }
        else {
            this.$.fold_change_div.hidden = true;
            this.$.adjusted_p_value_div.hidden = false;
            this.$.multiple_test_correction_div.hidden = false;
        }

    },
    getSelectedTest: function () {
        var inputs = this.$.testDiv.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            var input = inputs[i];
            if (input.disabled == false && input.checked)
                return input.value;
        }
    },
    getClassValues: function () {
        var childrenSelect = this.$.jsoClassViewer.getChildrenSelect().children;
        var classValues = new Array();
        for (var i = 0; i < childrenSelect.length; i++) {
            var children = childrenSelect[i];
            if (children.value != "none")
                classValues.push(children.value)
        }
        return classValues.join(",");
    }

});
</script>
</polymer-element>
