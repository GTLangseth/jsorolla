<polymer-element name="jso-cellbase-attribute-import" attributes="attributeManager hideFlag">
    <template>
        <link rel="stylesheet" href="jso-style.css">
        <link rel="stylesheet" href="jso-panel.css">
        <style>
            :host {
                display: block;
                position: relative;
                box-sizing: border-box;
                background-color: #FFFFFF;

                width: 600px;
                height: 420px;
            }

            #panel {
                width: 100%;
                height: 100%;
            }

            #header[horizontal] > * {
                margin-right: 3px;
            }

            #header[horizontal] > *:last-child {
                margin-right: 0px;
            }

            .remove::after {
                font-family: FontAwesome;
                content: '\f00d';
                color: #c70804;
            }

            .newattr::after {
                font-family: FontAwesome;
                content: '\f067';
                color: #00AA33;
            }

            .newvalue::after {
                font-family: FontAwesome;
                content: '\f061';
                color: #0081c2;
            }

            #left {
                width: 200px;
                border-right: 1px solid #d3d3d3;
                box-sizing: border-box;
            }

            #left [horizontal] > * {
                margin-right: 3px;
            }

            #left [horizontal] > *:last-child {
                margin-right: 0px;
            }

            #edit {
                box-sizing: border-box;
                padding: 0 5px;
            }

            #edit > * {
                margin-top: 3px;
            }

            #attributelist {
                box-sizing: border-box;
                padding: 0 5px;
                overflow-y: auto;
            }

            #attributelist > * {
                margin-top: 3px;
                /*padding: 2px 5px 5px 5px;*/
                /*box-sizing: border-box;*/
                /*margin-top: 2px;*/
            }

            /*[attributeselected] {*/
            /*background-color: #445D76 !important;*/
            /*color: #fff !important;*/
            /*border-color: rgba(102, 175, 233, .5) !important;*/
            /*}*/

            #tablewrap {
                position: relative;
                background-color: #FAFAFA;
            }

            #table {
                overflow-y: hidden;
                overflow-x: auto;
                margin-right: 5px;
                border-right: 1px solid #d3d3d3;
                background-color: #ffffff;
            }

            .customPager {
                background-color: #fafafa;
                box-sizing: border-box;
                border-top: 1px solid #cccccc;
                color: #445D76;
                padding: 3px;
            }

            .customPagerScroll {
                position: absolute;
                top: 0;
                right: 0;
                width: 5px;
                background-color: #c5c5c5;
                /*background-color: #3F3F3F;*/
            }

            div.button[data-checked=true] {
                color: #24303D;
            }
        </style>
        <div class="panel panel-shadow" id="panel" vertical layout>
            <div class="header" id="header" horizontal layout>
                <div class="text">Import Cellbase attributes</div>
                <div class="headeractions" horizontal end-justified layout flex>
                    <div class="text headerexpand" expanded?={{expanded}} on-click="{{handleExpand}}"></div>
                    <div class="text headerclose" on-click="{{handleClose}}"></div>
                </div>
            </div>
            <div class="container" flex horizontal layout>
                <div id="attributelist" flex>
                    <template repeat="{{spe in species}}">
                        <div class="button action" flex
                             data-checked="{{ speciesSelected == spe}}"
                             on-click="{{handleSpeciesSelect}}">
                            {{spe.name}}
                        </div>
                    </template>
                </div>
                <div id="attributelist" flex>
                    <template repeat="{{column in attributeManager.columns}}">
                        <div horizontal layout>
                            <div class="button action" flex
                                 data-checked="{{ editSelected == column}}"
                                 on-click="{{handleEditSelect}}">
                                {{column.title}}
                            </div>
                        </div>
                    </template>
                </div>
                <div id="attributelist" flex>
                    <template repeat="{{item in extList}}">
                        <div horizontal layout>
                            <div class="button action" flex
                                 data-checked="{{ item.selected }}"
                                 on-click="{{handleItemSelect}}">
                                {{item.boxLabel}}
                            </div>
                        </div>
                    </template>
                </div>
                <div id="attributelist" flex>
                    <template repeat="{{item in funcList}}">
                        <div horizontal layout>
                            <div class="button action" flex
                                 data-checked="{{ item.selected }}"
                                 on-click="{{handleItemSelect}}">
                                {{item.boxLabel}}
                            </div>
                        </div>
                    </template>
                </div>
                <div id="attributelist" flex>
                    <template repeat="{{item in repoList}}">
                        <div horizontal layout>
                            <div class="button action" flex
                                 data-checked="{{ item.selected }}"
                                 on-click="{{handleItemSelect}}">
                                {{item.boxLabel}}
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            <div class="footer" horizontal layout>
                <div horizontal end-justified layout flex>
                    <div class="button action" on-click="{{handleGo}}" style="width:100px;">Go</div>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            created: function () {
                this.species = [
                    {name: "Homo sapiens", value: "hsapiens"},
                    {name: "Mus musculus", value: "mmusculus"},
                    {name: "Rattus norvegicus", value: "rnorvegicus"},
                    {name: "Bos taurus", value: "btaurus"},
                    {name: "Gallus gallus", value: "ggallus"},
                    {name: "Sus scrofa", value: "sscrofa"},
                    {name: "Canis familiaris", value: "cfamiliaris"},
                    {name: "Drosophila melanogaster", value: "dmelanogaster"},
                    {name: "Caenorhabditis elegans", value: "celegans"},
                    {name: "Saccharomyces cerevisiae", value: "scerevisiae"},
                    {name: "Danio rerio", value: "drerio"},
                    {name: "Schizosaccharomyces pombe", value: "spombe"},
                    {name: "Escherichia coli", value: "ecoli"},
                    {name: "Human immunodeficiency virus 1", value: "hiv-1"},
                    {name: "Influenza A virus", value: "flu-a"},
                    {name: "Clostridium botulinum", value: "cbotulinum"},
                    {name: "Arabidopsis thaliana", value: "athaliana"},
                    {name: "Plasmodium falciparum", value: "pfalciparum"},
                    {name: "Dictyostelium discoideum", value: "ddiscoideum"},
                    {name: "Mycobacterium tuberculosis", value: "mtuberculosis"},
                    {name: "Neisseria meningitidis serogroup B", value: "nmeningitidis"},
                    {name: "Chlamydia trachomatis", value: "ctrachomatis"},
                    {name: "Oryza sativa", value: "osativa"},
                    {name: "Toxoplasma gondii", value: "tgondii"},
                    {name: "Xenopus tropicalis", value: "xtropicalis"},
                    {name: "Salmonella typhimurium", value: "styphimurium"},
                    {name: "Taeniopygia guttata", value: "tguttata"},
                    {name: "Staphylococcus aureus N315", value: "saureus"}
                ];

                this.extList = [
                    {"boxLabel": "HGNC Symbol", selected: false, "inputValue": {db: "hgnc_symbol", field: "id"}},
                    {"boxLabel": "Ensembl gene", selected: true, "inputValue": {db: "ensembl_gene", field: "id"}},
//        {"boxLabel": "MIM gene",  "inputValue": {db: "omim_gene", field: "id"}}, //mysql cellbase
                    {
                        "boxLabel": "Ensembl protein",
                        selected: false,
                        "inputValue": {db: "ensembl_protein", field: "id"}
                    },
                    {"boxLabel": "UCSC Stable ID", selected: false, "inputValue": {db: "ucsc_stable_id", field: "id"}},
                    {"boxLabel": "Havana gene", selected: false, "inputValue": {db: "havana_gene", field: "id"}},
                    {
                        "boxLabel": "UniProtKB/Swiss-Prot",
                        selected: false,
                        "inputValue": {db: "Uniprot/SWISSPROT", field: "id"}
                    }, //mysql cellbase
                    {
                        "boxLabel": "UniProtKB/TrEMBL",
                        selected: false,
                        "inputValue": {db: "uniprotkb/trembl", field: "id"}
                    },
                    {"boxLabel": "Uniprotkb Acc", selected: false, "inputValue": {db: "uniprotkb_acc", field: "id"}},
                    {"boxLabel": "Uniprotkb ID", selected: false, "inputValue": {db: "uniprotkb_id", field: "id"}},
                    {"boxLabel": "UniParc", selected: false, "inputValue": {db: "uniparc", field: "id"}},
                    {"boxLabel": "miRBase", selected: false, "inputValue": {db: "miRBase", field: "id"}},

                    {
                        "boxLabel": "Ensembl transcript",
                        selected: true,
                        "inputValue": {db: "ensembl_transcript", field: "id"}
                    },
                    {
                        "boxLabel": "HGNC transcript name",
                        selected: false,
                        "inputValue": {db: "hgnc_transcript_name", field: "id"}
                    },
                    {
                        "boxLabel": "Havana transcript",
                        selected: false,
                        "inputValue": {db: "havana_transcript", field: "id"}
                    },
                    {"boxLabel": "RefSeq peptide", selected: false, "inputValue": {db: "refseq_peptide", field: "id"}},
                    {"boxLabel": "RefSeq mRNA", selected: false, "inputValue": {db: "refseq_mrna", field: "id"}}
                ];

                this.funcList = [
//        {"boxLabel": "Biotype", "name": "biotype", "inputValue": "biotype"},

                    {"boxLabel": "GO Term Accession", selected: false, "inputValue": {db: "go", field: "id"}},
                    {"boxLabel": "GO Term Name", selected: false, "inputValue": {db: "go", field: "description"}},
                    {
                        "boxLabel": "Propagated GO Accession",
                        selected: false,
                        "inputValue": {db: "projected_go", field: "id"}
                    },
                    {
                        "boxLabel": "Propagated GO Name",
                        selected: false,
                        "inputValue": {db: "projected_go", field: "description"}
                    },
                    {
                        "boxLabel": "GOSlim GOA Accession",
                        selected: false,
                        "inputValue": {db: "goslim_goa", field: "id"}
                    },
                    {
                        "boxLabel": "GOSlim GOA Name",
                        selected: false,
                        "inputValue": {db: "goslim_goa", field: "description"}
                    },
                    {"boxLabel": "InterPro ID", selected: false, "inputValue": {db: "interpro", field: "id"}},
                    {
                        "boxLabel": "InterPro Short Description",
                        selected: false,
                        "inputValue": {db: "interpro", field: "description"}
                    }
                ];


                this.repoList = [
//        {"boxLabel": "PDB",  "inputValue": {db: "pdb", field: "id"}}, //mysql cellbase
                    {
                        "boxLabel": "European Nucleotide Archive",
                        selected: false,
                        "inputValue": {db: "european_nucleotide_archive", field: "id"}
                    },
                    {
                        "boxLabel": "Human Protein Atlas",
                        selected: false,
                        "inputValue": {db: "human_protein_atlas", field: "id"}
                    },
                    {
                        "boxLabel": "INSDC protein ID",
                        selected: false,
                        "inputValue": {db: "insdc_protein_id", field: "id"}
                    }
                ];

                this.attributeManager;

                this.editSelected;
                this.speciesSelected = this.species[0];
            },
            handleClose: function () {
                this.hideFlag = true;
            },
            handleExpand: function () {
                this.expanded = !this.expanded;
                if (this.expanded) {
                    this.style.width = '100vw';
                    this.style.height = '100vh';
                    this.style.position = 'fixed';
                    this.style.top = '0';
                } else {
                    this.style.width = '';
                    this.style.height = '';
                    this.style.position = '';
                    this.style.top = '';
                }
            },
            handleEditSelect: function (e) {
                this.editSelected = e.target.templateInstance.model.column;
            },
            handleSpeciesSelect: function (e) {
                this.speciesSelected = e.target.templateInstance.model.spe;
            },
            handleItemSelect: function (e) {
                var item = e.target.templateInstance.model.item;
                item.selected = !item.selected;
            },
            handleGo: function () {
                this.retrieveData();
            },
            retrieveData: function () {
                var me = this;

                var columns = [];
                var columnsMap = {};
                var dbnamesMap = {};

                var processCheckBoxes = function (item) {
                    if (item.selected) {
                        var label = item.boxLabel;
                        var columnId = item.inputValue.db + item.inputValue.field;
                        var column = {
                            defaultValue: "",
                            name: columnId,
                            title: label,
                            type: "string"
                        }
                        var idx = columns.push(column) - 1;
                        columnsMap[columnId] = idx;

                        if (!dbnamesMap[item.inputValue.db]) {
                            dbnamesMap[item.inputValue.db] = true;
                        }
                    }
                }
                this.extList.forEach(processCheckBoxes);
                this.funcList.forEach(processCheckBoxes);
                this.repoList.forEach(processCheckBoxes);

//
                var queries = [];
                for (var i = 0; i < this.attributeManager.data.length; i++) {
                    var row = this.attributeManager.data[i];
                    queries.push(row[this.editSelected.name]);
                }


                if (queries.length > 0) {

                    CellBaseManager.get({
                        species: this.speciesSelected.value,
                        category: 'feature',
                        subCategory: 'id',
                        query: queries.toString(),
                        resource: 'xref',
                        params: {
                            dbname: Object.keys(dbnamesMap)
                        },
                        success: function (data) {
                            var row;
                            for (var r = 0; r < data.response.length; r++) {
                                var response = data.response[r];
                                var xrefs = response.result;
                                row = me.attributeManager.data[r];
                                if (xrefs.length > 0) {
                                    for (var i = 0; i < xrefs.length; i++) {
                                        var xref = xrefs[i];

                                        var mapId1 = xref.dbName + 'id';
                                        var mapId2 = xref.dbName + 'description';

                                        var index1 = columnsMap[mapId1];
                                        var index2 = columnsMap[mapId2];

                                        if (index1 != null) {
                                            if (!row[mapId1]) {
                                                row[mapId1] = '';
                                            }
                                            if (row[mapId1] === '') {
                                                row[mapId1] += xref.id;
                                            } else {
                                                row[mapId1] += ',' + xref.id;
                                            }
                                        }
                                        if (index2 != null) {
                                            if (!row[mapId2]) {
                                                row[mapId2] = '';
                                            }
                                            if (row[mapId2] === '') {
                                                row[mapId2] += xref.description;
                                            } else {
                                                row[mapId2] += ',' + xref.description;
                                            }
                                        }
                                    }
                                }
                            }
                            for (var i = 0; i < columns.length; i++) {
                                var column = columns[i];
                                me.attributeManager.addColumn(column);
                            }
                        }
                    });
                }
            }
        });
    </script>
</polymer-element>