<dom-module id="jso-attribute-edit">
    <style>
        :host {
            display: block;
            box-sizing: border-box;
            background-color: #FFFFFF;

            width: 630px;
            height: 572px;
        }

        #main {
            width: 100%;
            height: 100%;
        }

        .remove::after {
            font-family: FontAwesome;
            content: '\f00d';
            color: #c70804;
        }

        .delete:hover {
            color: #c70804;
        }

        .newattr::after {
            font-family: FontAwesome;
            content: '\f067';
            color: #00AA33;
        }

        .newvalue::after {
            font-family: FontAwesome;
            content: '\f061';
            color: #0081c2;
        }

        .remove,
        .newattr,
        .newvalue {
            width: 23px;
            margin-left: 3px;
        }

        #left {
            width: 220px;
            border-right: 1px solid #d3d3d3;
            box-sizing: border-box;
        }

        #left [horizontal] > * {
            margin-right: 3px;
        }

        #left [horizontal] > *:last-child {
            margin-right: 0px;
        }

        .selbox {
            /*height: 130px;*/
            box-sizing: border-box;
            overflow-y: auto;
            border: 1px solid #d3d3d3;
            background-color: #FFF;
        }

        .selitem {
            padding: 2px 5px;
        }

        .selitem[data-checked] {
            background-color: #ddd;
        }

        .bar {
            background-color: #fafafa;
            box-sizing: border-box;
            color: #445D76;
            padding: 3px;
            height: 32px;
            border-bottom: 1px solid #cccccc;
        }

        .bar > div {
            margin: 0 2px;
        }

    </style>
    <template>
        <div id="main" class="flex horizontal layout">
            <div id="left">

                <div class="jso-formbox jso-fit">
                    <div class="jso-formtitle">Edit</div>
                    <div class="jso-formcontent vertical layout">
                        <label class="jso">Edit attribute for selected items</label>

                        <div class="vertical layout">
                            <div class="jso-select">
                                <select id="selectEdit">
                                    <template is="dom-repeat" items={{columns}} as="column" filter="isColumnEditable">
                                        <option value="{{column.name}}">{{column.title}}</option>
                                    </template>
                                </select>
                            </div>

                            <div class="horizontal layout" style="margin-top: 3px;">
                                <input flex type="text" class="jso" value="{{newValue}}" placeholder="Attribute value">

                                <div class="jso-btn jso-btn-shdw newvalue" on-click="handleEditApply"></div>
                            </div>
                        </div>

                        <label class="jso" style="margin-top: 10px;">Add new attribute</label>

                        <div class="horizontal layout">
                            <input flex type="text" class="jso" value="{{newColumnName}}" placeholder="Attribute name">

                            <div class="jso-btn jso-btn-shdw newattr" on-click="handleAddApply"></div>
                        </div>

                        <label class="jso" style="margin-top:10px;">Delete attribute</label>

                        <div class="horizontal layout">
                            <div class="jso-select flex">
                                <select id="selectDelete">
                                    <template is="dom-repeat" items={{columns}} as="column" filter="isColumnEditable">
                                        <option value="{{column.name}}">{{column.title}}</option>
                                    </template>
                                </select>
                            </div>
                            <div class="jso-btn jso-btn-shdw remove" on-click="handleRemoveApply"></div>
                        </div>
                    </div>
                </div>

                <div class="jso-formbox jso-fit flex" style="border-top-width:1px">
                    <div class="jso-formtitle horizontal layout">
                        <div class="flex">Filters</div>
                        <div class="actions horizontal layout">
                            <div data-checked$="{{isAddFilterSelected(_filterSelectedOption)}}">
                                <i class="fa fa-plus" on-click="handleAddNewFilter"></i>
                            </div>
                            <div data-checked$="{{isViewFilterSelected(_filterSelectedOption)}}">
                                <i class="fa fa-eye" on-click="handleViewFilters"></i>
                            </div>
                            <template if="{{filters.length > 0}}">
                                <!--<div on-click="{{handleDeleteFilters}}">Remove all</div>-->
                                <i class="fa fa-times" hidden$={{!areFilters(_filters)}} on-click="handleDeleteFilters"></i>
                            </template>
                        </div>
                    </div>

                    <div class="jso-formcontent" vertical layout>

                        <template is="dom-if" if="{{isViewFilterSelected(_filterSelectedOption)}}">
                            <div class="selbox" style="height: 280px;">
                                <template is="dom-if" if="{{!areFilters(_filters)}}">
                                    <div class="selitem flex">No filters to show.<br>
                                        Click
                                        <i class="fa fa-plus"></i>
                                        to add a new filter.
                                    </div>
                                </template>
                                <template is="dom-repeat" items="{{_filters}}" as="filter" index-as="filterIndex">
                                    <div class="selitem flex horizontal layout">
                                        <div class="flex vertical layout">
                                            <div>Attribute:
                                                <span>{{filter.attributeName}}</span>
                                            </div>
                                            <div style="text-transform: capitalize">rule:
                                                <span>{{filter.match}}</span>
                                                <span>{{filter.attributeType}}</span>
                                            </div>
                                            <div>Value:
                                                <span>{{filter.queryString}}</span>
                                            </div>
                                        </div>
                                        <i class="fa fa-times delete" on-click="handleDeleteFilter"></i>
                                    </div>
                                </template>
                            </div>

                        </template>

                        <template is="dom-if" if="{{isAddFilterSelected(_filterSelectedOption)}}">
                            <label class="jso">Attribute:</label>

                            <div class="jso-select">
                                <select id="filterAttributeSelect">
                                    <template is="dom-repeat" items={{columns}} as="column">
                                        <option value="{{column.name}}">{{column.title}}</option>
                                    </template>
                                </select>
                            </div>


                            <label class="jso">Data type:</label>

                            <div class="selbox">
                                <div class="selitem flex" data-checked$="{{isAttributeString(_attributeType)}}"
                                     on-click="handleAttributeTypeSelect" data-name="string">String
                                </div>
                                <div class="selitem flex" data-checked$="{{isAttributeNumber(_attributeType)}}"
                                     on-click="handleAttributeTypeSelect" data-name="number">Number
                                </div>
                            </div>

                            <template is="dom-if" if="{{isAttributeString(_attributeType)}}">
                                <label class="jso">String matching:</label>

                                <div class="selbox" style="height: 122px;">
                                    <div class="selitem flex" data-checked$="{{isStringMatchExact(_stringMatch)}}"
                                         on-click="handleStringMatchSelect" data-name="exact">Exact
                                    </div>
                                    <div class="selitem flex" data-checked$="{{isStringMatchContains(_stringMatch)}}"
                                         on-click="handleStringMatchSelect" data-name="contains">Contains
                                    </div>
                                    <div class="selitem flex" data-checked$="{{isStringMatchNotcontains(_stringMatch)}}"
                                         on-click="handleStringMatchSelect" data-name="notcontains">Not contains
                                    </div>
                                </div>
                            </template>

                            <template is="dom-if" if="{{isAttributeNumber(_attributeType)}}">
                                <label class="jso">Number matching:</label>

                                <div class="selbox">
                                    <div class="selitem flex" data-checked$="{{isNumberMatchEquals(_numberMatch)}}"
                                         on-click="handleNumberMatchSelect" data-name="equals">Equals
                                    </div>
                                    <div class="selitem flex" data-checked$="{{isNumberMatchNotequal(_numberMatch)}}"
                                         on-click="handleNumberMatchSelect" data-name="notequal">Not equal to
                                    </div>

                                    <div class="selitem flex" data-checked$="{{isNumberMatchGreater(_numberMatch)}}"
                                         on-click="handleNumberMatchSelect" data-name="greater">Greater than
                                    </div>
                                    <div class="selitem flex" data-checked$="{{isNumberMatchGreaterequal(_numberMatch)}}"
                                         on-click="handleNumberMatchSelect" data-name="greaterequal">Greater than or equal to
                                    </div>

                                    <div class="selitem flex" data-checked$="{{isNumberMatchLess(_numberMatch)}}"
                                         on-click="handleNumberMatchSelect" data-name="less">Less than
                                    </div>
                                    <div class="selitem flex" data-checked$="{{isNumberMatchLessequal(_numberMatch)}}"
                                         on-click="handleNumberMatchSelect" data-name="lessequal">Less than or equal to
                                    </div>
                                </div>
                            </template>

                            <div style="margin-top:5px;" class="horizontal layout">
                                <div class="flex">
                                    <input type="text" class="jso" value="{{_queryString}}" placeholder="Query string">
                                </div>
                                <div class="jso-btn jso-btn-shdw" on-click="handleCreateFilter">
                                    Add filter
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>


            <div id="right" class="flex vertical layout">
                <div class="bar horizontal layout center">
                    <div class="jso-btn jso-btn-shdw" on-click="handleSelectAll">Select all</div>
                    <div class="jso-btn jso-btn-shdw" on-click="handleDeselectAll">Deselect all</div>

                    <div class="flex">
                        <label class="control">
                            <input type="checkbox" checked$="{{showSelected}}" on-change="{{handleShowSelected}}">
                            <span title="Switch view beetwen all nodes or selected nodes">Show only selected</span>
                        </label>
                    </div>
                </div>
                <!-- <div id="tablewrap" class="flex vertical layout"> -->

                    <!--<iron-list items="{{items}}" as="item" id="il">-->
                        <!--<template>-->
                            <!--<div style="height:30px;">asdf:<span>{{row.name}}</span></div>-->
                        <!--</template>-->
                    <!--</iron-list>-->

                    <jso-table id="table" enable-paging enable-select enable-edit columns="{{columns}}" data="{{items}}" selected="{{selected}}" page-size="16" style="height:540px"></jso-table>


                    <!--<sortable-table id="table" flex-->
                                    <!--data="{{currentData}}"-->
                                    <!--columns="{{attributeManager.columns}}"-->
                                    <!--rowSelection="{{!showSelected}}"-->
                                    <!--multiselect="{{multiSelect}}"-->
                                    <!--selected="{{ !showSelected ? attributeManager.selected : [] }}"-->
                                    <!--page="{{page}}"-->
                                    <!--pageSize="{{pageSize}}">-->
                        <!--<template id="inputTemplate">-->
                            <!--<td class="edit">-->
                                <!--<input type="text" value="{{row[column.name]}}" on-blur="{{cellEditFinished}}">-->
                            <!--</td>-->
                        <!--</template>-->
                    <!--</sortable-table>-->
                    <!--<div class="customPagerScroll"-->
                         <!--style="height:calc(100% / {{table.lastPage}}); top:{{ (table.page-1) / table.lastPage * 100}}%"></div>-->
                <!-- </div> -->
                <!--<div class="customPager" horizontal layout>-->
                    <!--<div class="text">{{table.dataSize}} {{type}}{{table.dataSize != 1 ? 's' : ''}}</div>-->
                    <!--<div class="jso-btn jso-btn-shdw" disabled?="{{table.page<=1}}" on-click="{{moveToPreviousPage}}">-->
                        <!--&lt;</div>-->
                    <!--<div class="text"> {{table.page}} of {{table.lastPage}}</div>-->
                    <!--<div class="jso-btn jso-btn-shdw" disabled?="{{table.page>=table.lastPage}}"-->
                         <!--on-click="{{moveToNextPage}}">&gt;</div>-->
                <!--</div>-->
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'jso-attribute-edit',
        properties: {
            columns: {
                type: Array
            },
            items: {
                type: Array
            },
            selected: {
                type: Array
            },
            _filters: {
                type: Array,
                value: function () {
                    return [];
                }
            },
            _filterSelectedOption: {
                type: String,
                value: 'add'
            },
            _attributeType: {
                type: String,
                value: 'string'
            },
            _stringMatch: {
                type: String,
                value: 'exact'
            },
            _numberMatch: {
                type: String,
                value: 'equal'
            },
            _queryString: {
                type: String,
                value: ''
            },
            _showSelected: {
                type: Boolean,
                value: false
            },
        },
        observers: [
            'itemsChanged(items.splices)',
        ],
        itemsChanged: function (changeRecord) {
            console.log('attrbute edit items changed')
            if (changeRecord) {
                console.log('attrbute edit items changed record')
//                changeRecord.indexSplices.forEach(function (s) {
//                    s.removed.forEach(function (vertex) {
//
//                    });
//
//                }, this);
//            } else {
//
            }
        },
        computeItem:function(item, column){
            var value;
            if (column.formula) {
                value = column.formula(item);
            } else {
                value = item[column.name];
            }
            return value;
        },
        createdOFF: function () {
            this.page = 1;
            this.defaultPageSize = 18;
            this.pageSize = this.defaultPageSize;


            this.multiSelect = true;

            this.showSelected = false;
            this.currentData = [];

//                this.editSelected;
            this.newColumnName = '';
            this.newValue = '';

            /*Search*/
            this.attributeType = 'string';
            this.stringMatch = 'exact';
            this.numberMatch = 'equal';
            this.queryString = '';

            this.filterSelectedOption = 'add'
        },
        readyOFF: function () {
            var me = this;
            this.table = this.$.table;
            this.table.cellEditFinished = function (e) {
                var row = e.target.templateInstance.model.row;
                me.attributeManager._updateRow(row);
            }
        },
        observeOFF: {
            "attributeManager.data": "handleDataChanged",
            "attributeManager.selected": "handleSelectedChanged"
        },

        areFilters: function (_filters) {
            return _filters.length > 0;
        },

        isColumnEditable: function (column) {
            return column.name != 'id';
        },
        isAddFilterSelected: function (_filterSelectedOption) {
            return _filterSelectedOption == 'add';
        },
        isViewFilterSelected: function (_filterSelectedOption) {
            return _filterSelectedOption == 'view';
        },
        isAttributeString: function (_attributeType) {
            return _attributeType == 'string';
        },
        isAttributeNumber: function (_attributeType) {
            return _attributeType == 'number';
        },

        isStringMatchExact: function (_stringMatch) {
            return _stringMatch == 'exact';
        },
        isStringMatchContains: function (_stringMatch) {
            return _stringMatch == 'contains';
        },
        isStringMatchNotcontains: function (_stringMatch) {
            return _stringMatch == 'notcontains';
        },

        isNumberMatchEquals: function (_numberMatch) {
            return _numberMatch == 'equals';
        },
        isNumberMatchNotequal: function (_numberMatch) {
            return _numberMatch == 'notequal';
        },
        isNumberMatchGreater: function (_numberMatch) {
            return _numberMatch == 'greater';
        },
        isNumberMatchGreaterequal: function (_numberMatch) {
            return _numberMatch == 'greaterequal';
        },
        isNumberMatchLess: function (_numberMatch) {
            return _numberMatch == 'less';
        },
        isNumberMatchLessequal: function (_numberMatch) {
            return _numberMatch == 'lessequal';
        },


        showSelectedChanged: function () {
            this._checkCurrentData();
        },
        handleDataChanged: function () {
            this._checkCurrentData();
        },
        handleSelectedChanged: function () {
            this._checkCurrentData();
        },
        _checkCurrentData: function () {
            if (this.showSelected) {
                this.currentData = this.attributeManager.selected;
            } else {
                this.currentData = this.attributeManager.data;
            }

            var filteredData = [];
            if (this._filters.length > 0) {
                for (var i = 0; i < this._filters.length; i++) {
                    var filter = this._filters[i];
                    filteredData = this._applyFilter(filter, this.currentData, filteredData, i);
                }
                this.currentData = filteredData;
            }
        },
        handleExpand: function () {
            this.super();
            this.page = 1;
        },
        handleShowSelected: function () {
            this.showSelected = !this.showSelected;
            if (this.showSelected) {
                this.page = 1;
            }
        },
//            handleEditSelect: function (e) {
//                if (this.editSelected == e.currentTarget.dataset.name) {
//                    this.editSelected = null;
//                } else {
//                    this.editSelected = e.currentTarget.dataset.name;
//                }
//            },
        handleEditApply: function (e) {
            this.attributeManager.updateRowsColumn(this.attributeManager.selected, this.$.selectEdit.value, this.newValue);
            this.attributeManager._update();
        },
        handleRemoveApply: function (e) {
            if (confirm('Delete this attribute?')) {
//                    if (this.editSelected == e.currentTarget.dataset.name) {
//                        this.editSelected = null;
//                    }

                this.attributeManager.removeColumnByName(this.$.selectDelete.value);
            }
        },
        handleAddApply: function (e) {
            if (this.newColumnName != '') {
                var added = this.attributeManager.addColumn({
                    defaultValue: "",
                    name: this.newColumnName.toLowerCase(),
                    title: this.newColumnName,
                    type: "string",
                    cellTemplate: "inputTemplate"
                });
                if (added) {
                    this.newColumnName = '';
                }
            }
        },
        handleSelectAll: function () {
            this.attributeManager.selectAll();
        },
        handleDeselectAll: function () {
            this.attributeManager.deselectAll();
        },
        /* Search */
        handleAttributeNameSelect: function (e) {
            this.attributeName = e.currentTarget.dataset.name;
        },
        handleAttributeTypeSelect: function (e) {
            this._attributeType = e.currentTarget.dataset.name;
        },
        handleStringMatchSelect: function (e) {
            this._stringMatch = e.currentTarget.dataset.name;
        },
        handleNumberMatchSelect: function (e) {
            this._numberMatch = e.currentTarget.dataset.name;
        },
        handleCreateFilter: function () {
            var attributeName = this.shadowRoot.querySelector('#filterAttributeSelect').value;

            var match;
            if (this.attributeType == 'string') {
                match = this.stringMatch;
            } else if (this.attributeType == 'number') {
                match = this.numberMatch;
            }

            var filter = {
                attributeName: attributeName,
                queryString: this.queryString,
                attributeType: this.attributeType,
                match: match
            };
            this._filters.push(filter);
            this._checkCurrentData();
            this.handleViewFilters();
        },
        _applyFilter: function (filter, fullData, filteredData, filterIndex) {
            var dataToIterate;
            if (filterIndex == 0) {
                dataToIterate = fullData;
            } else {
                dataToIterate = filteredData;
            }

            if (filter.attributeType == 'string') {
                switch (filter.match) {
                    case 'exact':
                        dataToIterate = this.selectByColumnValue(dataToIterate, filter.attributeName, filter.queryString);
                        break;
                    case 'contains':
                        dataToIterate = this.selectByColumnContainsValue(dataToIterate, filter.attributeName, filter.queryString);
                        break;
                    case 'notcontains':
                        dataToIterate = this.selectByColumnContainsValue(dataToIterate, filter.attributeName, filter.queryString, true);
                        break;
                }
            } else if (filter.attributeType == 'number') {
                switch (filter.match) {
                    case 'equals':
                        dataToIterate = this.selectByColumnValue(dataToIterate, filter.attributeName, filter.queryString);
                        break;
                    case 'notequal':
                        dataToIterate = this.selectByColumnContainsValue(dataToIterate, filter.attributeName, filter.queryString, true);
                        break;
                    case 'greater':
                        dataToIterate = this.selectByColumnComparationValue(dataToIterate, filter.attributeName, filter.queryString, '>');
                        break;
                    case 'greaterequal':
                        dataToIterate = this.selectByColumnComparationValue(dataToIterate, filter.attributeName, filter.queryString, '>', true);
                        break;
                    case 'less':
                        dataToIterate = this.selectByColumnComparationValue(dataToIterate, filter.attributeName, filter.queryString, '<');
                        break;
                    case 'lessequal':
                        dataToIterate = this.selectByColumnComparationValue(dataToIterate, filter.attributeName, filter.queryString, '<', true);
                        break;
                }
            }
            return dataToIterate;
        },
        selectByColumnValue: function (data, column, value) {
            var selected = [];
            for (var i = 0; i < data.length; i++) {
                var row = data[i];
                if (row[column] === value) {
                    selected.push(row);
                }
            }
            return selected;
        },
        selectByColumnContainsValue: function (data, column, value, notContains) {
            var selected = [];
            if (notContains == true) {
                for (var i = 0; i < data.length; i++) {
                    var row = data[i];
                    if (row[column].indexOf(value) == -1) {
                        selected.push(row);
                    }
                }
            } else {
                for (var i = 0; i < data.length; i++) {
                    var row = data[i];
                    if (row[column].indexOf(value) != -1) {
                        selected.push(row);
                    }
                }
            }
            return selected;
        },
        selectByColumnComparationValue: function (data, column, value, comparation, includeValue) {
            if (!isNaN(value)) {
                var selected = [];
                if (comparation == '>') {
                    if (includeValue) {
                        for (var i = 0; i < data.length; i++) {
                            var row = data[i];
                            if (!isNaN(row[column]) && parseFloat(row[column]) >= parseFloat(value)) {
                                selected.push(row);
                            }
                        }
                    } else {
                        for (var i = 0; i < data.length; i++) {
                            var row = data[i];
                            if (!isNaN(row[column]) && parseFloat(row[column]) > parseFloat(value)) {
                                selected.push(row);
                            }
                        }
                    }
                } else if (comparation == '<') {
                    if (includeValue) {
                        for (var i = 0; i < data.length; i++) {
                            var row = data[i];
                            if (!isNaN(row[column]) && parseFloat(row[column]) <= parseFloat(value)) {
                                selected.push(row);
                            }
                        }
                    } else {
                        for (var i = 0; i < data.length; i++) {
                            var row = data[i];
                            if (!isNaN(row[column]) && parseFloat(row[column]) < parseFloat(value)) {
                                selected.push(row);
                            }
                        }
                    }
                }
                return selected;
            } else {
                return data;
            }
        },
        handleDeleteFilter: function (e) {
            var index = e.target.model.filterIndex;
            this._filters.splice(index, 1);
            this._checkCurrentData();
        },
        handleDeleteFilters: function (e) {
            this._filters = [];
            this._checkCurrentData();
        },
        handleViewFilters: function (e) {
            this._filterSelectedOption = 'view';
        },
        handleAddNewFilter: function (e) {
            this._filterSelectedOption = 'add';
        }
    });
</script>