<polymer-element name="jso-attribute-edit" attributes="selectedMenu attributeManager type">
    <template>
        <link rel="stylesheet" href="../sortable-table.css">
        <link rel="stylesheet" href="../jso-style.css">
        <link rel="stylesheet" href="../jso-panel.css">
        <style>
            :host {
                display: block;
                position: relative;
                box-sizing: border-box;
                background-color: #FFFFFF;

                width: 600px;
                height: 420px;
            }

            #panel {
                width: 100%;
                height: 100%;
            }

            #header[horizontal] > * {
                margin-right: 3px;
            }

            #header[horizontal] > *:last-child {
                margin-right: 0px;
            }

            .remove::after {
                font-family: FontAwesome;
                content: '\f00d';
                color: #c70804;
            }

            .newattr::after {
                font-family: FontAwesome;
                content: '\f067';
                color: #00AA33;
            }

            .newvalue::after {
                font-family: FontAwesome;
                content: '\f061';
                color: #0081c2;
            }

            #left {
                width: 200px;
                border-right: 1px solid #d3d3d3;
                box-sizing: border-box;
            }

            #left [horizontal] > * {
                margin-right: 3px;
            }

            #left [horizontal] > *:last-child {
                margin-right: 0px;
            }

            #edit {
                box-sizing: border-box;
                padding: 0 5px;
            }

            #edit > * {
                margin-top: 3px;
            }

            #attributelist {
                box-sizing: border-box;
                padding: 0 5px;
                overflow-y: auto;
            }

            #attributelist > * {
                margin-top: 3px;
                /*padding: 2px 5px 5px 5px;*/
                /*box-sizing: border-box;*/
                /*margin-top: 2px;*/
            }

            /*[attributeselected] {*/
            /*background-color: #445D76 !important;*/
            /*color: #fff !important;*/
            /*border-color: rgba(102, 175, 233, .5) !important;*/
            /*}*/

            #tablewrap {
                position: relative;
                background-color: #FAFAFA;
            }

            #table {
                overflow-y: hidden;
                overflow-x: auto;
                margin-right: 10px;
                border-right: 1px solid #d3d3d3;
                background-color: #ffffff;
            }

            .customPager {
                background-color: #fafafa;
                box-sizing: border-box;
                border-top: 1px solid #cccccc;
                color: #445D76;
                padding: 3px;
            }

            .customPagerScroll {
                position: absolute;
                top: 0;
                right: 0;
                width: 10px;
                /*background-color: #c5c5c5;*/
                background-color: #A9A9A9;
            }
        </style>
        <div class="panel panel-shadow" id="panel" vertical layout>
            <div class="header" id="header" horizontal layout>
                <div class="text">Edit {{type}} attributes</div>
                <div class="headeractions" horizontal end-justified layout flex>
                    <div class="text headerexpand" expanded?={{expanded}} on-click="{{handleExpand}}"></div>
                    <div class="text headerclose" on-click="{{handleClose}}"></div>
                </div>
            </div>
            <div class="container" flex horizontal layout>
                <div id="left" vertical layout>
                    <div id="edit" vertical layout>
                        <div class="button action" data-checked="{{showSelected}}" on-click="{{handleShowSelected}}">
                            Show selection
                        </div>
                        <div horizontal layout style="margin-bottom: 10px;">
                            <div flex class="button action" on-click="{{handleSelectAll}}">Select all</div>
                            <div flex class="button action" on-click="{{handleDeselectAll}}">Deselect all</div>
                        </div>
                        <div horizontal layout>
                            <input flex type="text" value="{{newValue}}" placeholder="Batch selection edit">

                            <div class="button action newvalue" on-click="{{handleEditApply}}"></div>
                        </div>
                        <div horizontal layout>
                            <input flex type="text" value="{{newColumnName}}" placeholder="Add new attribute">

                            <div class="button action newattr" on-click="{{handleAddApply}}"></div>
                        </div>
                    </div>
                    <div id="attributelist" flex>
                        <template repeat="{{column in attributeManager.columns}}">
                            <template if="{{column.name != 'id'}}">
                                <div horizontal layout>
                                    <div class="button action" flex
                                         data-checked="{{ editSelected == column.name}}"
                                         data-name="{{column.name}}"
                                         on-click="{{handleEditSelect}}">
                                        {{column.title}}
                                    </div>
                                    <div class="button action remove" data-name="{{column.name}}"
                                         on-click="{{handleRemoveApply}}"></div>
                                </div>
                            </template>
                        </template>
                    </div>
                </div>
                <div flex vertical layout>
                    <div id="tablewrap" flex horizontal layout on-wheel="{{handleScroll}}">
                        <sortable-table id="table" flex
                                        data="{{!showSelected ? attributeManager.data : attributeManager.selected }}"
                                        columns="{{attributeManager.columns}}"
                                        rowselection="{{!showSelected}}"
                                        multiselect="{{multiSelect}}"
                                        selected="{{ !showSelected ? attributeManager.selected : [] }}"
                                        page="{{page}}"
                                        pageSize="{{pageSize}}">
                            <template id="inputTemplate">
                                <td class="edit">
                                    <input type="text" value="{{row[column.name]}}">
                                </td>
                            </template>
                        </sortable-table>
                        <div class="customPagerScroll"
                             style="height:calc(100% / {{table.lastPage}}); top:{{ (table.page-1) / table.lastPage * 100}}%"></div>
                    </div>
                    <div class="customPager" horizontal layout>
                        <div class="text">{{table.dataSize}} {{type}}{{table.dataSize != 1 ? 's' : ''}}</div>
                        <div class="button action" disabled?="{{table.page<=1}}" on-click="{{moveToPreviousPage}}">
                            &lt;</div>
                        <div class="text"> {{table.page}} of {{table.lastPage}}</div>
                        <div class="button action" disabled?="{{table.page>=table.lastPage}}"
                             on-click="{{moveToNextPage}}">&gt;</div>
                    </div>
                </div>
            </div>
        </div>

    </template>
    <script>
        Polymer({
            created: function () {
                this.selectedAux;

                this.page = 1;
                this.defaultPageSize = 12;
                this.pageSize = this.defaultPageSize;

                this.attributeManager;

                this.multiSelect = true;

                this.showSelected = false;

                this.editSelected;
                this.newColumnName = '';
                this.newValue = '';
                this.expanded = false;
            },
            ready: function () {
                this.table = this.$.table;
            },
            handleScroll: function (e) {
                e.preventDefault();
                if (e.deltaY > 0) {
                    this.moveToNextPage();
                }
                if (e.deltaY < 0) {
                    this.moveToPreviousPage();
                }
            },
            moveToNextPage: function () {
                this.$.table.moveToNextPage();
            },
            moveToPreviousPage: function () {
                this.$.table.moveToPreviousPage();
            },
            handleClose: function () {
                this.selectedMenu = '';
            },
            handleExpand: function () {
                this.page = 1;
                this.expanded = !this.expanded;
                if (this.expanded) {
                    this.style.width = '100%';
                    this.style.height = 'calc(100% - 60px)';
                    this.style.position = 'fixed';
                    this.style.top = '60px';
                    this.style.left = '0';
                    this.pageSize = Math.floor(this.$.table.getBoundingClientRect().height / 25) - 2;
                } else {
                    this.style.width = '';
                    this.style.height = '';
                    this.style.position = '';
                    this.style.top = '';
                    this.style.left = '';
                    this.pageSize = this.defaultPageSize;
                }
            },
            handleShowSelected: function () {
                this.showSelected = !this.showSelected;
            },
            handleEditSelect: function (e) {
                if (this.editSelected == e.currentTarget.dataset.name) {
                    this.editSelected = null;
                } else {
                    this.editSelected = e.currentTarget.dataset.name;
                }
            },
            handleEditApply: function (e) {
                this.attributeManager.updateRowsColumn(this.attributeManager.selected, this.editSelected, this.newValue);
            },
            handleRemoveApply: function (e) {
                if (confirm('Delete this attribute?')) {
                    if (this.editSelected == e.currentTarget.dataset.name) {
                        this.editSelected = null;
                    }
                    this.attributeManager.removeColumnByName(e.currentTarget.dataset.name);
                }
            },
            handleAddApply: function (e) {
                if (this.newColumnName != '') {
                    var added = this.attributeManager.addColumn({
                        defaultValue: "",
                        name: this.newColumnName.toLowerCase(),
                        title: this.newColumnName,
                        type: "string",
                        cellTemplate: "inputTemplate"
                    });
                    if (added) {
                        this.newColumnName = '';
                    }
                }
            },
            handleSelectAll: function () {
                this.attributeManager.selectAll();
            },
            handleDeselectAll: function () {
                this.attributeManager.deselectAll();
            }
        })
        ;
    </script>
</polymer-element>