<polymer-element name="jso-attribute-render-table"
                 attributes="renderProperty attributeManager controlType defaultValue">
    <template>
        <link rel="stylesheet" href="../../jso-style.css">
        <link rel="stylesheet" href="../../jso-panel.css">
        <style>
            :host {
                display: block;
                position: absolute;
                box-sizing: border-box;
                background-color: #FFFFFF;

                z-index: 50000;
                top: 0px;

                left: 250px;
                /*right: 0;*/
                /*margin-left: auto;*/
                /*margin-right: auto;*/

                width: 400px;
                /*border: 0px solid #c6d0da;*/
                /*border-width: 1px;*/
                /*border-top-width: 1px;*/
                transition: all 0.2s;
                /*box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.2);*/
            }

            .header > * {
                float: left;
            }

            #close {
                float: right;
            }

            #close:after {
                font-family: FontAwesome;
                content: '\f00d';
            }

            #close:hover {
                color: #8b0000;
            }

            .header {
                text-transform: capitalize;
            }

            .container {
                box-sizing: border-box;
                padding: 2px 5px 5px 5px;
            }

            [vertical] > * {
                margin-top: 3px;
            }

            [horizontal] > * {
                margin-right: 3px;
            }

            [horizontal] > *:last-child {
                margin-right: 0px;
            }


            core-list {
                height: 150px;
                border: 1px solid #d3d3d3;
                border-top-width: 0;
            }

            .item {
                height: 27px;
                padding: 2px;
                box-sizing: border-box;
            }

            .item > div {
                padding: 3px 4px;
            }
            .item > div.color-control {
                padding: 0px;
            }

            .item > input {
                /*border-color: transparent;*/
                /*background-color: transparent;*/
            }

            .item:nth-child(2n+1) {
                background-color: #f5f5f5;
            }

            .item:hover {
                background-color: #ddd;
            }

            .table-head {
                border: 1px solid #d3d3d3;
                background-color: #f2f2f2;
                font-weight: bold;
                color: #666;
            }

            .table-head > div {
                border-right: 1px solid #d3d3d3;
                padding: 7px 10px;
            }

            .table-head > div:last-child {
                border-right-width: 0;
                margin-right: 20px;
            }

            .action {
                width: 100px;
            }
        </style>
        <div class="panel panel-shadow">
            <div class="header">
                <div class="text">{{renderProperty}} rendering configuration</div>
                <div id="close" class="text" on-click="{{handleClose}}"></div>
            </div>
            <div class="container" vertical layout>
                <div horizontal layout>
                    <div class="dropdown" flex>
                        <div tabindex="-1" class="button">
                            {{attributeName}}
                        </div>
                        <ul>
                            <template repeat="{{column in attributeManager.columns}}">
                                <li on-mousedown="{{handleAttributeNameSelect}}" data-name="{{column.name}}">
                                    {{column.title}}
                                </li>
                            </template>
                        </ul>
                    </div>
                    <div class="dropdown" flex>
                        <div tabindex="-1" class="button">
                            {{attributeType}}
                        </div>
                        <ul>
                            <li on-mousedown="{{handleAttributeTypeSelect}}" data-name="string">String</li>
                            <li on-mousedown="{{handleAttributeTypeSelect}}" data-name="number">Number</li>
                        </ul>
                    </div>
                </div>
                <template if="{{attributeType == 'string'}}">
                    <div horizontal layout>
                        <div class="button">Select all</div>
                        <div class="button">Deselect all</div>
                        <div class="button">Apply direct</div>
                        <div class="text">Selection:</div>
                        <template if="{{controlType == 'number'}}">
                            <input flex type="number" value="{{defaultValue}}">
                        </template>
                        <template if="{{controlType == 'color'}}">
                            <jso-color-picker flex color="{{defaultValue}}"></jso-color-picker>
                        </template>
                    </div>
                </template>
                <template if="{{attributeType == 'number'}}">
                    <div vertical layout>
                        <div horizontal layout>
                            <div class="button" on-click="{{handleAddPoint}}">Add point</div>
                            <div class="button" on-click="{{handleApplyInterpolation}}">Apply</div>
                        </div>
                        <template repeat="{{point, index in points}}">
                            <jso-attribute-render-table-number-point
                                    point="{{point}}" points="{{points}}"
                                    allowRemove="{{index != 0 && index != points.length -1}}">
                            </jso-attribute-render-table-number-point>
                        </template>
                    </div>
                </template>
                <div>
                    <div class="table-head" horizontal layout>
                        <div flex>Attribute value</div>
                        <div flex>Render property value</div>
                    </div>
                    <core-list data="{{uniqueData}}" height="27">
                        <template>
                            <div horizontal layout class="item">
                                <div flex>{{model.attribute}}</div>
                                <template if="{{controlType == 'number'}}">
                                    <input flex type="number" value="{{model.render}}">
                                </template>
                                <template if="{{controlType == 'color'}}">
                                    <div flex horizontal layout class="color-control">
                                        <input flex type="color" value="{{model.render}}">
                                        <input flex type="text" value="{{model.render}}">
                                    </div>
                                </template>
                            </div>
                        </template>
                    </core-list>
                </div>
                <div horizontal layout end-justified>
                    <div class="button action">OK</div>
                </div>
            </div>

    </template>
    <script>
        Polymer({
            created: function () {
                this.attributeName = 'select attribute';
                this.attributeType = 'number';
                this.uniqueData = [];

                this.points = [
                    {value: 0, render: 0},
                    {value: 0, render: 0}
                ];
            },
            ready: function () {
            },

            attributeNameChanged: function (oldValue, newValue) {
                this._updateUniqueValues();
            },
            /* Observers */
            observe: {
                'attributeManager.data': 'handleAttributeManagerChange'
            },
            handleAttributeManagerChange: function (oldValue, newValue) {
                this._updateUniqueValues();
            },

            handleClose: function () {
                this.renderProperty = null;
            },
            handleAttributeNameSelect: function (e) {
                this.attributeName = e.currentTarget.dataset.name;
            },
            handleAttributeTypeSelect: function (e) {
                this.attributeType = e.currentTarget.dataset.name;
            },
            handleAddPoint: function () {
                this.points.splice(this.points.length - 1, 0, {
                    value: 0, render: 0
                });
            },
            handleApplyInterpolation: function () {
                this._updateUniqueInterpolatedValues();
            },

            _updateUniqueValues: function () {
                var uniqueMap = {};
                var uniqueData = [];
                var max;
                var min;
                for (var i = 0, l = this.attributeManager.data.length; i < l; i++) {
                    var row = this.attributeManager.data[i];
                    if (!uniqueMap[row[this.attributeName]]) {
                        uniqueMap[row[this.attributeName]] = true;
                        uniqueData.push({attribute: row[this.attributeName], render: this.defaultValue});
                        var attribute = parseFloat(row[this.attributeName]);
                        if (!max || attribute >= max) {
                            max = attribute;
                        }
                        if (!min || attribute <= min) {
                            min = attribute;
                        }
                    }
                }
                this.points[0].value = min;
                this.points[this.points.length - 1].value = max;
                this.uniqueData = uniqueData;
            },
            _updateUniqueInterpolatedValues: function () {
                this.points.sort(function (a, b) {
                    return a.value - b.value;
                });

                for (var i = 0, l = this.uniqueData.length; i < l; i++) {
                    var value = parseFloat(this.uniqueData[i].attribute);
                    for (var j = 0; j < this.points.length; j++) {
                        var point = this.points[j];
                        var nextPoint = this.points[j + 1];
                        if (nextPoint) {
                            var pointValue = parseFloat(point.value);
                            var pointRender = parseFloat(point.render);
                            var nextPointValue = parseFloat(nextPoint.value);
                            var nextPointRender = parseFloat(nextPoint.render);
                            if (value >= pointValue && value <= nextPointValue) {
                                var valueDiff = pointValue - nextPointValue;
                                var renderDiff = pointRender - nextPointRender;
                                var v = value - pointValue;
                                this.uniqueData[i].render = (v * renderDiff / valueDiff) + pointRender;
                            }
                        }
                    }
                }
            }
        });
    </script>
</polymer-element>

<polymer-element name="jso-attribute-render-table-number-point"
                 attributes="point points allowRemove">
    <template>
        <link rel="stylesheet" href="../../jso-style.css">
        <style>
            :host {
                display: block;
                position: relative;
                box-sizing: border-box;
                background-color: #FFFFFF;
            }

            [horizontal] > * {
                margin-right: 3px;
            }

            [horizontal] > *:last-child {
                margin-right: 0px;
            }

            .text {
                width: 100px;
            }

            #remove::after {
                font-family: FontAwesome;
                content: '\f00d';
            }

            #remove[allowRemove] {
                visibility: hidden
            }

            #remove[allowRemove=true] {
                visibility: inherit;
            }
        </style>
        <div horizontal layout>
            <input flex type="number" value="{{point.value}}">
            <input flex type="number" value="{{point.render}}">

            <div id="remove" class="button" allowRemove="{{allowRemove}}" on-click="{{handleRemove}}"></div>
        </div>
    </template>
    <script>
        Polymer({
            handleRemove: function () {
                this.points.splice(this.points.indexOf(this.point), 1);
            }
        });
    </script>
</polymer-element>