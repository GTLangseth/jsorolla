<dom-module id="jso-opencga-sample-info">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            position: relative;
            display: block;
            box-sizing: border-box;
            height: 100%;
            border-top: 1px solid var(--divider-color);
        }

        #sampleList,
        #sampleSelectedList {
            box-sizing: border-box;
            overflow-y: auto;
            height: calc(100% - 59px);
            /*height: 145px;*/
            border: 1px solid #ddd;
        }

        #sampleSelectedList {
            height: calc(100% - 35px);
        }

        #sampleList {
            border-top: 0;
        }

        .sam {
            width: 50%;
            padding: 5px;
        }

        .study-info {
            height: 30px;
            box-sizing: border-box;
            background-color: var(--light-secondary-color);
            border-top: 1px solid var(--divider-color);
            padding: 5px;
        }

        .sample-info {
            height: calc(100% - 30px);
            box-sizing: border-box;
        }

        #variantButton {
            border-radius: 5px;
            width: 150px;
            background-color: var(--dark-button-color) !important;
            color: var(--text-primary-color) !important;
            margin: 5px;
        }

        #addButton {
            width: 25px;
            font-size: 15px;
            color: #435f7a;
            margin-left: 5px;
            font-weight: bold;
        }

        #clearButton {
            width: 50px;
            color: #435f7a;
            font-weight: bold;
        }

        #variantButton:hover {
            background-color: var(--light-button-color) !important;
        }

        .msgError {
            color: #bf4747;
            font-style: italic;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        .fileName {
            font-weight: bold;
            color: #445D76;
            margin-left: 5px;
            width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .check{
          border: 1px solid var(--divider-color);
          border-right:0;
          padding-left: 6px;
        }
    </style>
    <template>
        <div class="sample-info horizontal layout">
            <div class="sam">
                <div class="horizontal layout center" style="height:25px">
                    <label>Samples from: </label>
                    <div class="flex fileName">{{fileName}}</div>
                </div>
                <div class="horizontal layout center" style="height:100%">
                    <div class="flex" style="width:100%;height:100%">
                        <div class="horizontal layout center">
                            <label class="jso-control horizontal layout check">
                                <input id="checkButton" class="jso" type="checkbox" on-change="handleToggle">
                                <span></span>
                            </label>
                            <input style="height:24px" id="searchInput" class="jso" type="text" placeholder="Search by name..." value="{{search::input}}">
                        </div>
                        <div id="sampleList" class="">
                            <template is="dom-repeat" items="{{filteredSamples}}">
                                <label class="horizontal layout center jso-control">
                                    <input class="jso" type="checkbox" sample="{{item}}">
                                    <span>{{item.name}}</span>(
                                    <span>{{item.source}}</span>)
                                </label>
                            </template>
                        </div>
                    </div>
                    <div id="addButton" class="jso-btn jso-btn-shdw" on-click="handleAddSample" title="Add selected samples"><i class="fa fa-arrow-right" aria-hidden="true"></i>
                    </div>
                </div>
            </div>
            <div class="sam right">
                <div class="horizontal layout center" style="height:25px">
                    <label>Selected Samples: </label>
                    <div class="flex">
                    </div>
                    <div id="clearButton" class="jso-btn jso-btn-shdw" on-click="handleClearSamples" title="Clear all selected samples">Clear
                    </div>
                </div>
                <div id="sampleSelectedList">
                    <template is="dom-repeat" items="{{sampleSelected}}">
                        <div class="horizontal layout center jso-control" style="margin-top:2px;">
                            <i style="margin-left:5px;" class="fa fa-times" sample="{{item.id}}" on-click="handleRemoveSample" title="Remove sample in selected sample list"></i>&nbsp;
                            <span style="margin-left:5px;">{{item.name}}</span>&nbsp;(
                            <span style="margin-left:5px;">{{item.source}}</span>)
                        </div>
                    </template>
                </div>
            </div>
        </div>
        <div class="study-info horizontal layout center">
            <label class="" style="margin-left:5px;">Study Type: </label>
            <div class="flex" style="font-weight:bold;color: #445D76;margin-left:5px;">{{study.type}}</div>
            <div class="msgError" title="{{indexMsg}}">{{indexMsg}}</div>
            <div class="horizontal layout center end-justified">
                <div id="variantButton" class="jso-btn jso-btn-shdw" on-click="handleViewVariantBrowswer" title="Explore selected samples"> Variant Browser
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "jso-opencga-sample-info",
        properties: {
            selectedFile: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: "selectedFileChanged"
            },

            filteredSamples: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,
            },
            sampleSelected: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                }
            },
            sampleMap: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            samples: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                },
                observer: 'samplesChanged'
            },
            search: {
                type: String,
                value: "",
                observer: 'searchNameChanged'
            },
            study: {
                type: Object,
                observer: 'studyChanged'
            },
            indexMsg: {
                type: String,
                value: ""
            },
        },

        selectedFileChanged: function(neo, old) {
            var me = this;
            if (neo) {
                this.set('fileName', neo.name);
                this.handleDeselectAll();
                var sams = [];
                var els = this.$.sampleList.querySelectorAll("input:checked");
                for (var i = 0; i < els.length; i++) {
                    els[i].checked = false;
                }
                for (var i = 0; i < neo.sampleIds.length; i++) {
                    var s = this._getSamplesInfo(neo.sampleIds[i]);
                    if (s != null) {
                        if (neo.index != null && neo.index.status == "INDEXING") {
                            s.status = "INDEXING";
                            var msg = neo.name + " is indexing";
                            me.set('indexMsg', msg);
                        } else {
                            s.status = (neo.index) ? neo.index.status : "NOT INDEXED";
                            me.set('indexMsg', "");
                        }
                    }
                    sams.push(s);
                }
                this.set("samples", sams);
            }

        },
        _getSamplesInfo: function(samplesIds) {
            var me = this;
            var sample = null;
            OpencgaManager.samples.info({
                id: samplesIds,
                query: {
                    sid: Cookies('bioinfo_sid'),
                },
                request: {
                    async: false,
                    success: function(response) {
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                            sample = response.response[0].result[0];
                        } else {
                            console.log('Server error, try again later.');
                        }
                    },
                    error: function() {
                        console.log('Server error, try again later.');
                    }
                }
            });
            return sample;
        },

        samplesChanged: function(neo, old) {
            var me = this;
            var searchFilterSamples = this._filterBySearch(this.samples);
            this.set('filteredSamples', searchFilterSamples);
        },
        _filterBySearch: function(samples) {
            if (this.search == "") {
                return samples;
            }
            var filteredSamples = [];
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                if (sample.name.toLowerCase().search(this.search.toLowerCase()) >= 0) {
                    filteredSamples.push(sample);
                }
            }
            return filteredSamples;
        },
        handleViewVariantBrowswer: function(e) {
            this.set("sampleSelected", this.sampleSelected);
            this.fire('viewvariantbrowser');
        },
        searchNameChanged: function(neo, old) {
            this.samplesChanged();
        },
        studyChanged: function(neo, old) {
            this.set('fileName', "");
            this.set("sampleMap", {});
            this.set("sampleSelected", []);
            this.set("filteredSamples", []);
            this.handleDeselectAll();
        },
        handleRemoveSample: function(e) {
            var id = e.currentTarget.sample;
            this.sampleMap[id] = null;
            for (var i = 0; i < this.sampleSelected.length; i++) {
                if (this.sampleSelected[i].id == id) {
                    this.splice('sampleSelected', i, 1);
                    break;
                }
            }

        },
        handleAddSample: function(e) {
            var sel = this.$.sampleList.querySelectorAll("input:checked");
            for (var i = 0; i < sel.length; i++) {
                var sample = sel[i].sample;
                if (sample.status == "READY") {
                    if (this.sampleMap[sample.id] == null) {
                        this.sampleMap[sample.id] = true;
                        this.push("sampleSelected", sel[i].sample);
                    }
                } else {
                    alert("All selected samples must be READY! Select samples from VCF in READY status.");
                }
            }
        },
        handleToggle: function(e) {
            if (e.currentTarget.checked) {
                this.handleSelectAll();
            } else {
                this.handleDeselectAll();
            }
        },
        handleSelectAll: function() {
            var select = this.$.sampleList.querySelectorAll("input");
            for (var i = 0; i < select.length; i++) {
                select[i].checked = true;
            }
        },
        handleDeselectAll: function() {
            this.$.checkButton.checked = false;
            var select = this.$.sampleList.querySelectorAll("input");
            for (var i = 0; i < select.length; i++) {
                select[i].checked = false;
            }
        },
        handleClearSamples: function(e) {
            this.set("sampleSelected", []);
            this.set("sampleMap", {});
        }

    });
</script>
