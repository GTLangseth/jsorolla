<dom-module id="jso-opencga-sample-info">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            position: relative;
            display: block;
            box-sizing: border-box;
        }

        #sampleList {
            box-sizing: border-box;
            height: 150px;
            background-color: var(--light-secondary-color);
            border-top: 1px solid var(--divider-color);
            padding: 5px;
            overflow-y: auto;
        }

        .study-info {
            height: 100%;
            box-sizing: border-box;
            background-color: var(--light-secondary-color);
            border-top: 1px solid var(--divider-color);
            padding: 5px;
        }

        #variantButton {
            border-radius: 5px;
            width: 150px;
            background-color: var(--dark-button-color) !important;
            color: var(--text-primary-color) !important;
        }

        #variantButton:hover {
            background-color: var(--light-button-color) !important;
        }
    </style>
    <template>
        <div class="study-info">
            <label class="" style="margin-left:10px;">Study Type: </label>
            <div class="flex" style="font-weight:bold;color: #445D76;margin-left:5px;">{{study.type}}</div>
            <div class="msgError" title="{{indexMsg}}">{{indexMsg}}</div>
            <div id="sampleList" class="vertical layout">
                <div class="">
                    <input id="searchInput" class="jso" type="text" style="width:100%;" placeholder="Search by name..." value="{{search::input}}">
                </div>
                <template is="dom-repeat" items="{{filteredSamples}}">
                    <label class="jso-control">
                        <input class="jso" type="checkbox" sample="{{item}}">
                        <span>{{item.name}}</span>
                    </label>
                </template>
            </div>
            <div id="variantButton" class="jso-btn jso-btn-shdw" on-click="handleViewVariantBrowswer" hidden$="{{!enableVariantBrowser}}" title="Explore selected samples"> Variant Browser
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "jso-opencga-sample-info",
        properties: {

            selected: {
                type: Object,
                notify: true,
                value: function() {
                    return null;
                }
            },
            selectedFile: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: "selectedFileChanged"
            },

            filteredSamples: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,
            },
            sampleSelected: {
                type: Object,
                notify: true,
                value: function() {
                    return {};
                }
            },
            samples: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                },
                observer: 'samplesChanged'
            },
            search: {
                type: String,
                value: "",
                observer: 'searchNameChanged'
            },
        },

        selectedFileChanged: function(neo, old) {
            if (neo) {
                this._getSamplesInfo(neo.sampleIds.join(","));
            }
        },
        _getSamplesInfo: function(samplesIds) {
            var me = this;
            OpencgaManager.samples.info({
                id: samplesIds,
                query: {
                    sid: Cookies('bioinfo_sid'),
                },
                request: {
                    async: true,
                    success: function(response) {
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                            me.set("samples", response.response[0].result);
                        } else {
                            console.log('Server error, try again later.');
                        }
                    },
                    error: function() {
                        console.log('Server error, try again later.');
                    }
                }
            });
        },

        samplesChanged: function(neo, old) {
            var me = this;
            console.log(this.search);
            var searchFilterSamples = this._filterBySearch(this.samples);
            this.set('filteredSamples', searchFilterSamples);
        },
        _filterBySearch: function(samples) {
            if (this.search == "") {
                return samples;
            }
            var filteredSamples = [];
            for (var i = 0; i < samples.length; i++) {
                var sample = samples[i];
                if (sample.name.toLowerCase().search(this.search.toLowerCase()) >= 0) {
                    filteredSamples.push(sample);
                }
            }
            return filteredSamples;
        },
        handleViewVariantBrowswer: function(e) {
            var samples = [];
            var sel = this.$.sampleList.querySelectorAll("input:checked");
            for (var i = 0; i < sel.length; i++) {
                samples.push(sel[i].sample);
            }
            this.set("sampleSelected", samples);
            // this.fire('sampleselected', this.sampleSelected);

            this.fire('viewvariantbrowser');
        },
        searchNameChanged: function(neo, old) {
            this.samplesChanged();
        },

    });
</script>
