<dom-module id="jso-opencga-job-list-item">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
        }

        :host(:hover) {
            background-color: var(--hover-color);
        }

        :host[selected] {
            background-color: var(--selected-color);
        }

        .job {
        }

        .capitalize {
            text-transform: capitalize;
        }

        .PREPARED {
            color: #919900;
        }

        .ERROR {
            color: #b30000;
        }

        .QUEUED {
            color: #ff8c00;
        }

        .RUNNING {
            color: #298c63;
        }

        .DONE {
            color: #00accc;
        }

        .READY {
            color: #0068cc;

        }

        .date {
            color: #696969;
            font-size: 0.9em;
        }

        .bar {
            width: 15px;
        }

        .bar > * {
            margin: 1px;
            color: #d3d3d3;
        }

        .bar > *:hover {
            color: #000;
            cursor: pointer;
        }

        .delete-job:hover {
            color: red !important;
            margin-right: 2px;
        }

        .relaunch-job:hover {
            color: green !important;
            margin-right: 2px;
        }

        .info-job:hover {
            color: blue !important;
        }

    </style>
    <template>
        <div horizontal layout>
            <div flex id="job">
                <!--<div flex id="job" on-mouseenter="{{handleMouseEnter}}" on-click="{{handleClick}}">-->
                <div>
                    <i class$="{{computeStatusIcon(job)}}"></i>
                    <span style="white-space: nowrap">{{job.name}}</span>
                </div>
                <div class="capitalize">{{computeToolName(job)}}</div>
                <div>
                    <span class$="{{computeStatusClass(job)}}">{{computeStatus(job)}}</span>
                    <span class="date">{{computeDate(job)}}</span>
                </div>
            </div>
            <div vertical layout class="bar" on-click="{{handleBarClick}}">
                <template is="dom-if" if="{{!isRunning(job)}}">
                    <i class="fa fa-trash-o delete-job" title="Delete Job" on-click="handleDeleteJob"></i>
                    <i class="fa fa-refresh relaunch-job" title="Relaunch Job" on-click="handleRelaunchJob"></i>
                    <i class="fa fa-info info-job" title="Job information" on-click="handleJobInformation"></i>
                </template>
            </div>
        </div>


    </template>
</dom-module>
<script>
    Polymer({
        is: "jso-opencga-job-list-item",
        properties: {
            job: {
                type: Object,
                notify: true
            },
            visitsHidden: {
                type: Boolean,
                value: false
            },
            study: {
                type: Object,
                value: function () {
                    return {};
                }
            }
        },
        created: function () {
        },
        computeDate: function (job) {
            return Utils.parseDate(job.date);
        },
        computeIcon: function (job) {
            var iconMap = {
                "READY": 'check fa fa-check',
                "FILE": 'fa fa-file-o'
            };
            return iconMap[job.status];
        },
        computeStatusIcon: function (job) {
            var iconMap = {
                "PREPARED": 'PREPARED fa fa-clock-o',
                "READY": 'READY fa fa-check',
                "ERROR": 'ERROR fa fa-times',
                "QUEUED": 'QUEUED fa fa-clock-o',
                "RUNNING": 'RUNNING fa fa-circle-o-notch fa-spin',
            };
            return iconMap[job.status];
        },
        computeStatus: function (job) {
            if (job.status === "DONE") {
                return "Finishing";
            }
            return job.status.toLowerCase();
        },
        computeStatusClass: function (job) {
            return "capitalize " + job.status;
        },
        computeToolName: function (job) {
            return job.toolName;
        },
        handleBarClick: function (e) {
            e.stopPropagation();
        },
        handleVisits: function (job) {
            return job.visits > 0
                    ;
        },
        isRunning: function (job) {
            return job.status == "RUNNING";
        },
        handleDeleteJob: function (e) {
            var jobId = this.job.id;
            e.stopPropagation();

            if (confirm("Are you sure?")) {
                var aux = OpencgaManager.jobs.delete({
                    id: jobId,
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        success: function (response) {

                        },
                        error: function () {
                            console.log('Server error, try again later.');
                        }
                    }
                });
            }
        },
        handleRelaunchJob: function (e) {
            e.stopPropagation();

            if (confirm("You are going to relaunch this Job. Are you sure?")) {

                var query = {
                    sid: Cookies("bioinfo_sid"),
                    studyId: this.study.id,
                    toolId: this.job.toolName,
                    name: this.job.name,
                    description: this.job.description,
                    "input": this.job.input[0],
                    "panel": this.job.input[1],
                    output: this.job.outDirId
                };

                OpencgaManager.jobs.create({
                    query: query,
                    request: {
                        //method: 'POST',
                        success: function (response) {
                        },
                        error: function () {
                        }
                    }
                })

            }
        },

        handleJobInformation: function (e) {
            e.stopPropagation();
        }

    })
    ;
</script>
