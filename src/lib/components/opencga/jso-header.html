<link rel="import" href="jso-login.html">
<link rel="import" href="jso-signup.html">
<link rel="import" href="jso-profile.html">
<link rel="import" href="jso-remember.html">
<!--

<link rel="import" href="jso-job-list.html">
<link rel="import" href="jso-job-launched.html">

-->

<dom-module id="jso-header">
    <style>
        :host {
            position: relative;
            display: block;
            box-sizing: border-box;
            cursor: default;
        }

        .main {
            position: relative;
            min-width: 970px;
            height: 60px;
            line-height: 60px;
            font-size: 18px;
            margin: 0;
            padding: 0;
            text-transform: none;
            box-shadow: 0px 0px 5px 5px rgba(0, 0, 0, 0.3);
            z-index: 2;
            background-color: inherit;
        }

        #tools {
            background-color: #FAFAFA;
        }

        #left > div,
        #right > div {
            display: block;
            text-align: center;
            padding: 0 5px;
            cursor: pointer;
        }

        div.icon {
            margin-left: 10px;
        }

        div.title {
            font-size: 30px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }

        div.description {
            font-size: 18px;
            padding-left: 10px;
            padding-bottom: 10px;
        }

        div.description:hover {
            cursor: default;
        }

        jso-login,
        jso-signup,
        jso-profile,
        jso-remember {
            z-index: 1;
        }

        jso-job-list {
            height: calc(100vh - 160px);
            width: 250px;
            right: 0px;
            top: 0px;
        }
    </style>
    <template>
        <div class="main horizontal layout">
            <div id="left" class="horizontal layout start-justified">
                <div class="icon hover" data-option="home" on-click="handleMenu">
                    <content select=".icon"></content>
                </div>
                <div class="title hover" data-option="home" on-click="handleMenu">
                    <content select=".title"></content>
                </div>
                <div id="description" class="description">
                    <content select=".description"></content>
                </div>
                <div style="cursor:default;">
                    <content select=".announce"></content>
                </div>
            </div>
            <div id="center" class="horizontal layout center-justified flex">
                <div hidden$="{{computeMenu(showMenuOnLogin, isLogged)}}">
                    <content select=".menu"></content>
                </div>
            </div>
            <div id="right" hidden$="{{!allowLogin}}" class="horizontal layout end-justified">
                <div id="user" class="color-1" hidden$="{{!isLogged}}">{{userText}}</div>

                <div hidden$="{{!allowBrowse}}">
                    <div id="projects" class="hover" data-option="projects" on-click="handleMenu"
                         hidden$="{{!isLogged}}">
                        <i class="fa fa-cloud-upload"></i>&nbsp;Upload
                    </div>
                </div>

                <div id="jobs" class="hover" data-option="jobs" on-click="handleJobClick"
                     hidden$="{{computeJobs(isLogged, allowJobs)}}">
                    <i class="fa fa-pencil-square-o"></i>
                    &nbsp;jobs
                </div>

                <div id="profile" class="hover" data-option="profile" on-click="handleMenu"
                     hidden$="{{computeProfile(isLogged, userText)}}">
                    <i class="fa fa-user"></i>&nbsp;profile
                </div>

                <div id="logout" class="hover" on-click="handleLogoutClick" hidden$="{{!isLogged}}">
                    <i class="fa fa-sign-out"></i>&nbsp;logout
                </div>

                <div id="login" class="hover" data-option="login" on-click="handleMenu" hidden$="{{isLogged}}">
                    <i class="fa fa-sign-in"></i>
                    &nbsp;log in
                </div>
                <div id="signup" class="hover" data-option="signup" on-click="handleMenu" hidden$="{{isLogged}}">
                    <i class="fa fa-pencil-square-o"></i>
                    &nbsp;sign up
                </div>
                <div>
                    <content select=".helpmenu"></content>
                </div>
            </div>
        </div>

        <div id="tools">
            <jso-login id="jsoLogin"
                       menu-option="login"
                       on-login="handleLogin"
                       on-remember="handleRemember"
                       on-signup="handleSignup">
            </jso-login>
            <jso-signup id="jsoSignup"
                        on-login="handleLogin"
                        menu-option="signup">
            </jso-signup>

            <jso-profile id="jsoProfile"
                         menu-option="profile">
            </jso-profile>

            <jso-remember menu-option="remember">
            </jso-remember>
        </div>
    </template>

    <!--<div class="content">-->


    <!--<template if="{{ selectedOption == 'jobLaunched' }}">-->
    <!--<jso-job-launched></jso-job-launched>-->
    <!--</template>-->

    <!--<template if="{{ showJobs ||  selectedOption == 'jobLaunched' }}">-->
    <!--<jso-job-list-->
    <!--jobItem="{{jobItem}}"-->
    <!--on-job-item-click="{{handleJobItemClick}}"-->
    <!--userData="{{userData}}"-->
    <!--selectedOption="{{selectedOption}}"-->
    <!--selectedStudy="{{selectedStudy}}"-->
    <!--allowedTools="{{allowedTools}}"-->
    <!--showJobs="{{showJobs}}"></jso-job-list>-->
    <!--</template>-->
    <!--</div>-->

    </template>
</dom-module>

<script>
    Polymer({
        is: "jso-header",
        properties: {
            checkTimeInterval: {
                type: Number,
                value: 5000,
                reflectToAttribute: true
            },
            selectedOption: {
                type: String,
                value: "home",
                notify: true,
                reflectToAttribute: true,
                observer: 'selectedOptionChanged'
            },
            allowLogin: {
                type: Boolean,
                value: true,
                reflectToAttribute: true
            },
            showMenuOnLogin: {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },
            isLogged: {
                type: Boolean,
                value: false
            },
            allowJobs: {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },
            allowBrowse: {
                type: Boolean,
                value: false,
                reflectToAttribute: true
            },
            showJobs: {
                type: Boolean,
                value: true
            },
            userData: {
                type: Object,
                notify: true
            },
            userText: {
                type: String,
                value: ''
            },
            jobItem: {
                type: Object
            },
            selectedStudy: {
                type: Object
            },
            allowedTools: {
                type: Array
            }
        },

        computeMenu: function (showMenuOnLogin, isLogged) {
            if (showMenuOnLogin) {
                return !isLogged;
            }
            return false;
        },
        computeProfile: function (isLogged, userText) {
            if (!isLogged || userText == 'anonymous') {
                return true;
            }
            return false;
        },
        computeJobs: function (isLogged, allowJobs) {
            if (!isLogged || !allowJobs) {
                return true;
            }
            return false;
        },
        selectedOptionChanged: function (neo, old) {
            var menuItems = Polymer.dom(this.root).querySelectorAll('[menu-option]');
            for (var i = 0; i < menuItems.length; i++) {
                var item = menuItems[i];
                var currentItemValue = item.getAttribute("menu-option");
                if (neo == currentItemValue) {
                    item.removeAttribute("hidden");
                } else {
                    item.setAttribute('hidden', '');
                }
            }
        },
        //TODO
        ready: function () {
            if (this.allowLogin) {
                if (Cookies("bioinfo_sid") && Cookies("bioinfo_user")) {
                    this.sessionInitiated();
                } else {
                    this.logout();
                }
            }
        },
        handleRemember: function (e) {
            this.selectedOption = 'remember';
        },
        handleSignup: function (e) {
            this.selectedOption = 'signup';
        },
        handleMenu: function (e) {
            var option = e.currentTarget.dataset['option'];
            console.log(option);
            if (option) {
                this.selectedOption = option;
            }
        },
        handleJobClick: function (e) {
            this.showJobs = !this.showJobs;
        },
        handleLogoutClick: function (e) {
            this.sessionFinished();
        },
        handleSupportMenu: function (e) {
            this.$.helpMenu.classList.toggle('help-menu-shown');
        },
        handleHelpMenuMouseOut: function () {
            this.$.helpMenu.classList.remove('help-menu-shown');
        },
        handleLogin: function (e) {
            if (e.detail.status) {
                this.sessionInitiated();
            } else {
                this.sessionFinished();
            }
            this.fire('session-change');
        },
        demoLogin: function (username) {
            this.$.jsoLogin.user = username;
            this.$.jsoLogin.password = "demo";
            this.$.jsoLogin._login();
        },
        anonymousSign: function () {
            this.$.jsoSignup.user = "anonymous" + Utils.randomString(40);
            this.$.jsoSignup.name = "anonymous";
            this.$.jsoSignup.email = "anonymous@anonymous.anonymous";
            this.$.jsoSignup.organization = "none";
            this.$.jsoSignup.password = "anonymous";
            this.$.jsoSignup._signup();
        },
        sessionInitiated: function (e) {
            var me = this;

            this.isLogged = true;
            this.selectedOption = 'home';

            /**START OPENCGA CHECK**/
            if (!this.userInfoInterval) {
                this.getUserInfo();//first call
                this.userInfoInterval = setInterval(function () {
                    me.getUserInfo();
                }, this.checkTimeInterval);
            }
            this.fire("login");
        },
        sessionFinished: function (e) {

            this.showJobs = false;
            this.selectedOption = 'home';
            this.isLogged = false;
            Cookies.expire('bioinfo_sid');
            Cookies.expire('bioinfo_user');

            /**END OPENCGA CHECK**/
            clearInterval(this.userInfoInterval);
            this.userInfoInterval = null;
            this.fire("logout");
        },
        getUserInfo: function () {
            var me = this;
            var lastActivity = null;
            if (this.userData != null) {
                lastActivity = this.userData.lastActivity;
            }
            var user = Cookies('bioinfo_user');
            if (!user) {
                console.log('cookie: bioinfo_user, is not set, session will be finished...');
                this.sessionFinished();
            } else {
                OpencgaManager.users.read({
                    id: user,
                    query: {
                        sid: Cookies('bioinfo_sid'),
                        lastActivity: lastActivity
                    },
                    request: {
                        success: function (response) {
                            if ((response.response[0].errorMsg === '' || response.response[0].errorMsg == null) && response.response[0].result.length > 0) {
                                me.userData = response.response[0].result[0];
                                me.userText = me.userData.name;
                                console.log("userData has been modified since last call");
                            }
                            if (response.response[0].errorMsg != null && response.response[0].errorMsg.indexOf('Invalid sessionId for user') !== -1) {
                                me.sessionFinished()
                            }
                        },
                        error: function () {
                            console.log('Server error, try again later.');
                        }
                    }
                });
            }
        },
        logout: function () {
            var me = this;
            var user = Cookies('bioinfo_user');
            if (!user) {
                console.log('cookie: bioinfo_user, is not set, session will be finished...');
                this.sessionFinished();
            } else {
                OpencgaManager.users.logout({
                    id: user,
                    query: {
                        sid: Cookies('bioinfo_sid')
                    },
                    request: {
                        success: function (response) {
                            console.log(response);
                        },
                        error: function () {
                            console.log('Server error, try again later.');
                        }
                    }
                });
            }
        },
        handleJobItemClick: function (e) {
            this.showJobs = false;
        }

    });
</script>