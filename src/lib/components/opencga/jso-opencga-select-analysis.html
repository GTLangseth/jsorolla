<link rel="import" href="jso-opencga-analysis.html">
<link rel="import" href="jso-opencga-folder.html">
<polymer-element name="jso-opencga-select-analysis" attributes="projectList output">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <style>
            :host {
                display: block;
                padding-left: 30px;
                padding-top: 10px;
            }

            label {
                display: inline-block;
                color: #666;
                margin-top: 10px;
            }

            label::after {
                content: ':'
            }

            .action {
                margin-top: 30px;
            }

            .message {
                margin-top: 20px;
            }
        </style>

        <form id="form" vertical layout>
            <label>Project</label>

            <div class="dropdown">
                <div tabindex="-1" class="button">
                    <jso-opencga-project-item project="{{selectedProject}}"></jso-opencga-project-item>
                </div>
                <ul>
                    <template repeat="{{project in projectList}}">
                        <li>
                            <jso-opencga-project-item
                                    project="{{project}}"
                                    data-selected="{{selectedProject == project}}"
                                    on-mousedown="{{handleProjectClick}}">
                            </jso-opencga-project-item>
                        </li>
                    </template>
                </ul>
            </div>

            <label>Study</label>

            <div class="dropdown">
                <div tabindex="-1" class="button">
                    <jso-opencga-study-item study="{{selectedStudy}}"></jso-opencga-study-item>
                </div>
                <ul>
                    <template repeat="{{study in selectedProject.studies}}">
                        <li>
                            <jso-opencga-study-item
                                    study="{{study}}"
                                    data-selected="{{selectedStudy == study}}"
                                    on-mousedown="{{handleStudyClick}}">
                            </jso-opencga-study-item>
                        </li>
                    </template>
                </ul>
            </div>

            <label>Analysis</label>
            <div class="dropdown">
                <div tabindex="-1" class="button">
                    <jso-opencga-analysis-item analysis="{{selectedAnalysis}}"></jso-opencga-analysis-item>
                </div>
                <ul>
                    <template repeat="{{analysis in analysisList}}">
                        <li>
                            <jso-opencga-analysis-item
                                    analysis="{{analysis}}"
                                    data-selected="{{selectedAnalysis == analysis}}"
                                    on-mousedown="{{handleAnalysisClick}}">
                            </jso-opencga-analysis-item>
                        </li>
                    </template>
                </ul>
            </div>
            <label>Folder</label>
            <div class="dropdown">
                <div tabindex="-1" class="button">
                    <jso-opencga-folder-item folder="{{selectedFolder}}"></jso-opencga-folder-item>
                </div>
                <ul>
                    <template repeat="{{folder in folderList}}">
                        <li>
                            <jso-opencga-folder-item
                                    folder="{{folder}}"
                                    data-selected="{{selectedFolder == folder}}"
                                    on-mousedown="{{handleFolderClick}}">
                            </jso-opencga-folder-item>
                        </li>
                    </template>
                </ul>
            </div>
        </form>
    </template>
    <script>
        Polymer({
            created: function () {
                this.fileFormat = '';
                this.bioFormat = '';
                this.description = '';

                this.selectedProject;
                this.selectedStudy;
                this.selectedAnalysis;

                this.fileName = 'Choose file...';
                this.message = '';
                this.output = { project: this.selectedStudy, study: this.selectedStudy, analysis: this.selectedAnalysis, folder: this.selectedFolder }
            },
            handleProjectClick: function (e) {
                this.selectedProject = e.target.project;
                this.selectedStudy = null;
            },
            handleStudyClick: function (e) {
                me = this;
                this.selectedAnalysis = null;
                this.selectedStudy = e.target.study;
                OpencgaManager.studies.analysis({
                    id: this.selectedStudy.id,
                    query: {
                        sid: Cookies('bioinfo_sid')
                    },
                    request: {
                        success: function (response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                me.analysisList = response.response[0].result
                            } else {
                                me.message = response.response[0].errorMsg;
                            }
                        },
                        error: function () {
                            alert('Server error, try again later.');
                        }
                    }
                });
                OpencgaManager.files.search({

                    query: {
                        sid: Cookies('bioinfo_sid'),
                        studyId: this.selectedStudy.id,
                        type: "folder"
                    },
                    request: {
                        success: function (response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                me.folderList = response.response[0].result
                            } else {
                                me.message = response.response[0].errorMsg;
                            }
                        },
                        error: function () {
                            alert('Server error, try again later.');
                        }
                    }
                });
            },
            handleAnalysisClick: function (e) {
                this.selectedAnalysis = e.target.analysis;
            },
            handleFolderClick: function (e) {
                this.selectedFolder = e.target.folder;
            }
        });
    </script>
</polymer-element>