<polymer-element name="jso-opencga-upload" attributes="folder study">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <style>
            :host {
                display: block;
                background-color: #fafafa;
            }

            label {
                display: inline-block;
                color: #666;
            }

            label::after {
                content: ':'
            }

            .action {
                margin-top: 5px;
            }

            .message {
                margin-top: 5px;
            }
            .filetext{
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        </style>

        <form id="form" vertical layout>
            <!--<label>Project</label>-->

            <!--<div class="dropdown">-->
                <!--<div tabindex="-1" class="button">-->
                    <!--<jso-opencga-project-item project="{{selectedProject}}"></jso-opencga-project-item>-->
                <!--</div>-->
                <!--<ul>-->
                    <!--<template repeat="{{project in projectList}}">-->
                        <!--<li>-->
                            <!--<jso-opencga-project-item-->
                                    <!--project="{{project}}"-->
                                    <!--data-selected="{{selectedProject == project}}"-->
                                    <!--on-mousedown="{{handleProjectClick}}">-->
                            <!--</jso-opencga-project-item>-->
                        <!--</li>-->
                    <!--</template>-->
                <!--</ul>-->
            <!--</div>-->

            <div hidden>
            <label>File format</label>
            <!--<input type="text" id="fileFormat" value="{{fileFormat}}" required pattern="[a-zA-Z0-9]+">-->
            <select value="{{fileFormat}}" required>
                <option value="PLAIN">PLAIN</option>
                <option value="GZIP">GZIP</option>
                <option value="BINARY">BINARY</option>
                <option value="BINARY">EXECUTABLE</option>
                <option value="EXECUTABLE">IMAGE</option>
            </select>


            <label>Bio format</label>
            <!--<input class="button" type="text" id="bioFormat" value="{{bioFormat}}" required pattern="[a-zA-Z0-9]+">-->
            <select value="{{bioFormat}}" required>
                <option value="VARIANT">VARIANT</option>
                <option value="ALIGNMENT">ALIGNMENT</option>
                <option value="SEQUENCE">SEQUENCE</option>
                <option value="MICROARRAY">MICROARRAY</option>
                <option value="ONECHANNEL">ONECHANNEL</option>
                <option value="TWOCHANNEL">TWOCHANNEL</option>
                <option value="AFFYMETRIX">AFFYMETRIX</option>
                <option value="AGILENT">AGILENT</option>
                <option value="GENEPIX">GENEPIX</option>
                <option value="DATAMATRIX">DATAMATRIX</option>
                <option value="SNP">SNP</option>
                <option value="IDLIST">IDLIST</option>
                <option value="GENE">GENE</option>
                <option value="TRANSCRIPT">TRANSCRIPT</option>
                <option value="PROTEIN">PROTEIN</option>
                <option value="FUNCTIONALTERM">FUNCTIONALTERM</option>
                <option value="RANKED">RANKED</option>
                <option value="ANNOTATION">ANNOTATION</option>
                <option value="GENEVSANNOTATION">GENEVSANNOTATION</option>
                <option value="EXTENDEDANNOTATION">EXTENDEDANNOTATION</option>
                <option value="OTHER">OTHER</option>
                <option value="NEWICK">NEWICK</option>
                <option value="BLAST">BLAST</option>
                <option value="INTERACTION">INTERACTION</option>
                <option value="GENOTYPE">GENOTYPE</option>
                <option value="PLINKASSOCIATION">PLINKASSOCIATION</option>
                <option value="VCF4">VCF4</option>
                <option value="NONE">NONE</option>
            </select>
            <label>Description</label>
            <input type="text" id="description" value="{{description}}" pattern="[a-zA-Z0-9\s]+">

            <br>
            </div>
            <div class="button action filetext" on-click="{{handleBrowseClick}}">{{fileName}}</div>
            <input type="file" hidden id="fileInput" required on-change="{{handleInputChange}}">

            <div class="button action" on-click="{{handleForm}}">Upload</div>
        </form>
        <template if="{{uploading}}">
            <font-awesome icon="spinner" animation="spin"></font-awesome>
        </template>
        <div class="message">{{message}}</div>
    </template>
    <script>
        Polymer({
            created: function () {
                this.fileFormat = 'PLAIN';
                this.bioFormat = 'NONE';
                this.description = '';


                this.fileName = 'Choose file...';
                this.message = '';

                this.uploading = false;
            },
            handleBrowseClick: function (e) {
                this.$.fileInput.click();
            },
            handleInputChange: function (e) {
                var inputFile = this.$.fileInput.files[0];
                this.fileName = inputFile.name
            },
            handleForm: function (e) {
                var me = this;
                this.message = '';
                if (this.uploading == false && this.$.form.checkValidity() && this.folder && this.study) {

                    this.uploading = true;

                    var inputFile = this.$.fileInput.files[0];
//                    var relativeFilePath = this.folder.path + inputFile.name.replace(/[^a-z0-9]/gi, '_');
                    var relativeFilePath = this.folder.path + inputFile.name;

                    var fileuploadWorker = new Worker(WORKERS_PATH + 'worker-fileupload.js');

                    me.message = '0%, uploading...';

                    fileuploadWorker.onmessage = function (e) {
                        var res = e.data;
                        console.log("@@@@@@@@@@@@@@@@ WORKER event message");
                        console.log(res);
                        var part = res.chunkId + 1;
                        me.message = Math.round((part / res.total) * 100) + '%, uploading part ' + part + ' of ' + res.total;
                        if (res.finished == true) {
                            me.message = 'Done';
                            me.uploading = false;
                            me.fire('file-uploaded');
                        }
                    };


                    fileuploadWorker.postMessage({
                        'host': OPENCGA_HOST,
                        'userId': Cookies("bioinfo_user"),
                        'sid': Cookies("bioinfo_sid"),

                        'studyId': this.study.id,
                        'file': inputFile,
                        'fileFormat': this.fileFormat,
                        'bioFormat': this.bioFormat,
                        'description': this.description,
                        'relativeFilePath': relativeFilePath,

                        'resume': true
                    });
                }
            }
        });
    </script>
</polymer-element>