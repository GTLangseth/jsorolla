<link rel="import" href="jso-bioformat.html">
<polymer-element name="jso-opencga-upload" attributes="folder study bioformat">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <style>
            :host {
                display: block;
                background-color: #f0f0f0;
            }
            .action {
                margin-top: 5px;
            }

            .message {
                margin-top: 5px;
            }

            .filetext {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .uploadbar {
                position: relative;
                height: 20px;
                border: 1px solid #d3d3d3;
                background-color: white;
                line-height: 20px;
            }

            .uploadprogress {
                position: absolute;
                top: 0px;
                left: 0px;
                height: 100%;
                width: 100%;
                background-color: #eaeaea;
            }

            .uploadtext {
                position: absolute;
                text-align: center;
                top: 0px;
                left: 0px;
                height: 100%;
                width: 100%;
            }

            jso-bioformat {
                box-sizing: border-box;
                overflow-y: auto;
                border: 1px solid #d3d3d3;
                background-color: #FFF;
                height: 170px;
            }
        </style>

        <form id="form" vertical layout>
            <!--<label>Project</label>-->

            <!--<div class="dropdown">-->
            <!--<div tabindex="-1" class="button">-->
            <!--<jso-opencga-project-item project="{{selectedProject}}"></jso-opencga-project-item>-->
            <!--</div>-->
            <!--<ul>-->
            <!--<template repeat="{{project in projectList}}">-->
            <!--<li>-->
            <!--<jso-opencga-project-item-->
            <!--project="{{project}}"-->
            <!--data-selected="{{selectedProject == project}}"-->
            <!--on-mousedown="{{handleProjectClick}}">-->
            <!--</jso-opencga-project-item>-->
            <!--</li>-->
            <!--</template>-->
            <!--</ul>-->
            <!--</div>-->

            <!--<div hidden>-->
            <div>
                <label>Select format:</label>
                <jso-bioformat id="bioformat" bioformat="{{bioformat}}"></jso-bioformat>
            </div>
            <div hidden>
                <!--<label>File format</label>-->
                <!--&lt;!&ndash;<input type="text" id="fileFormat" value="{{fileFormat}}" required pattern="[a-zA-Z0-9]+">&ndash;&gt;-->
                <!--<select value="{{fileFormat}}" required>-->
                <!--<option value="PLAIN">PLAIN</option>-->
                <!--<option value="GZIP">GZIP</option>-->
                <!--<option value="BINARY">BINARY</option>-->
                <!--<option value="BINARY">EXECUTABLE</option>-->
                <!--<option value="EXECUTABLE">IMAGE</option>-->
                <!--</select>-->


                <!--<label>Bio format</label>-->
                <!--&lt;!&ndash;<input class="button" type="text" id="bioFormat" value="{{bioFormat}}" required pattern="[a-zA-Z0-9]+">&ndash;&gt;-->
                <!--<select value="{{bioFormat}}" required>-->
                <!--<option value="VARIANT">VARIANT</option>-->
                <!--<option value="ALIGNMENT">ALIGNMENT</option>-->
                <!--<option value="SEQUENCE">SEQUENCE</option>-->
                <!--<option value="MICROARRAY">MICROARRAY</option>-->
                <!--<option value="ONECHANNEL">ONECHANNEL</option>-->
                <!--<option value="TWOCHANNEL">TWOCHANNEL</option>-->
                <!--<option value="AFFYMETRIX">AFFYMETRIX</option>-->
                <!--<option value="AGILENT">AGILENT</option>-->
                <!--<option value="GENEPIX">GENEPIX</option>-->
                <!--<option value="DATAMATRIX">DATAMATRIX</option>-->
                <!--<option value="SNP">SNP</option>-->
                <!--<option value="IDLIST">IDLIST</option>-->
                <!--<option value="GENE">GENE</option>-->
                <!--<option value="TRANSCRIPT">TRANSCRIPT</option>-->
                <!--<option value="PROTEIN">PROTEIN</option>-->
                <!--<option value="FUNCTIONALTERM">FUNCTIONALTERM</option>-->
                <!--<option value="RANKED">RANKED</option>-->
                <!--<option value="ANNOTATION">ANNOTATION</option>-->
                <!--<option value="GENEVSANNOTATION">GENEVSANNOTATION</option>-->
                <!--<option value="EXTENDEDANNOTATION">EXTENDEDANNOTATION</option>-->
                <!--<option value="OTHER">OTHER</option>-->
                <!--<option value="NEWICK">NEWICK</option>-->
                <!--<option value="BLAST">BLAST</option>-->
                <!--<option value="INTERACTION">INTERACTION</option>-->
                <!--<option value="GENOTYPE">GENOTYPE</option>-->
                <!--<option value="PLINKASSOCIATION">PLINKASSOCIATION</option>-->
                <!--<option value="VCF4">VCF4</option>-->
                <!--<option value="NONE">NONE</option>-->
                <!--</select>-->
                <label>Description:</label>
                <input type="text" id="description" value="{{description}}" pattern="[a-zA-Z0-9\s]+">

                <br>
            </div>
            <div class="button action filetext" on-click="{{handleBrowseClick}}" pattern="[a-zA-Z0-9_-]+">{{fileName}}</div>
            <input type="file" hidden id="fileInput" required on-change="{{handleInputChange}}">

            <div class="button action" on-click="{{handleForm}}">Upload</div>
        </form>
        <template if="{{uploading}}">
            <div flex class="uploadbar" style="margin-top: 10px;">
                <div style="width:{{percentProgress}}%;" class="uploadprogress"></div>
                <div class="uploadtext">
                    <font-awesome icon="spinner" animation="spin"></font-awesome>
                    {{percentProgress}}% {{message}}
                </div>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            created: function () {
                this.fileFormat = 'PLAIN';
                this.bioformat = 'NONE';
                this.description = '';


                this.fileName = 'Choose file...';
                this.message = '';

                this.uploading = false;

                this.percentProgress = 0;

            },
            handleBrowseClick: function (e) {
                this.$.fileInput.click();
            },
            handleInputChange: function (e) {
                var inputFile = this.$.fileInput.files[0];
                this.fileName = inputFile.name
            },
            handleForm: function () {

                if(  !(/^([a-zA-Z0-9._-]+)$/.test(this.fileName))  ){
                    alert("Sorry, some characters in your input file are not allowed. We only permit letters, numbers, dash(- or _) and point(.).");
                    return;
                }

                var me = this;
                OpencgaManager.files.filesByFolder({
                    id: me.folder.id,
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        success: function (response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                var filesList = response.response[0].result;
                                me.fileName = me.$.fileInput.files[0].name;
                                for (var i = 0; i < filesList.length; i++) {
                                    var file = filesList[i];
                                    if (file.name == me.fileName) {
                                        me.fileName = me.fileName + Math.floor(Math.random() * (999 - 100 + 1));
                                        alert("File already exists. It will be uploaded as " + me.fileName + ".");
                                        break;
                                    }
                                }
                                me.relativeFilePath = me.folder.path + me.fileName;
                                me.uploadFile();

                            }
                        },
                        error: function () {
                            me.message = 'Server error, try again later.';
                        }
                    }
                });
            },
            uploadFile: function () {
                var me = this;
                this.message = '';
                var bioformat = this.$.bioformat.getSelected();
                if (bioformat == "") {
                    alert("Error: Please select a format");
                    return;
                }
                if (this.uploading == false && this.$.form.checkValidity() && this.folder && this.study) {

                    this.uploading = true;
                    this._upload(function (chunk, total) {
                        me.percentProgress = Math.round((chunk.id / total) * 100);
                        if (chunk.last) {
                            me.percentProgress = 100;
                            me.message = 'Done';
                            me.uploading = false;
                            me.fire('file-uploaded');
                        }
                    });

                }
            },
            _upload: function (callbackProgress) {
                var me = this;
                var url = OpencgaManager.files.upload({
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        url: true
                    }
                });
                var inputFile = this.$.fileInput.files[0];
                var fileName = this.fileName;
                var userId = Cookies("bioinfo_user");
                var studyId = this.study.id;
                var relativeFilePath = this.relativeFilePath;
                var fileFormat = this.fileFormat;
                var bioFormat = this.bioformat;
                var description = this.description;

                var resume = true;
                var resumeInfo = {};
                var chunkMap = {};
                var chunkId = 0;
                var blob = inputFile;
                var BYTES_PER_CHUNK = 2 * 1024 * 1024;
                var SIZE = blob.size;
                var NUM_CHUNKS = Math.max(Math.ceil(SIZE / BYTES_PER_CHUNK), 1);
                var start;
                var end;


                var getResumeInfo = function (formData) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', url, false);//false = sync call
                    xhr.send(formData);
                    var response = JSON.parse(xhr.responseText);
                    return response.response[0];
                };
                var checkChunk = function (id, size, resumeInfo) {
                    if (typeof resumeInfo[id] === 'undefined') {
                        return false;
                    } else if (resumeInfo[id].size != size /*|| resumeInfo[id].hash != hash*/) {
                        return false;
                    }
                    return true;
                };
                var processChunk = function (c) {
                    var chunkBlob = blob.slice(c.start, c.end);

                    if (checkChunk(c.id, chunkBlob.size, resumeInfo) == false) {
                        var formData = new FormData();
                        formData.append('chunk_content', chunkBlob);
                        formData.append('chunk_id', c.id);
                        formData.append('chunk_size', chunkBlob.size);
                        /*formData.append('chunk_hash', hash);*/
                        formData.append("filename", fileName);
                        formData.append('userId', userId);
                        formData.append('studyId', studyId);
                        formData.append('relativeFilePath', relativeFilePath);
                        /*formData.append('chunk_gzip', );*/
                        if (c.last) {
                            formData.append("last_chunk", true);
                            formData.append("total_size", SIZE);
                            formData.append("fileFormat", fileFormat);
                            formData.append("bioFormat", bioFormat);
                            formData.append("description", description);
                        }
                        uploadChunk(formData, c, function () {
                            callbackProgress(c, NUM_CHUNKS);
                            if (!c.last) {
                                processChunk(chunkMap[(c.id + 1)]);
                            } else {

                            }
                        });
                    } else {
                        callbackProgress(c, NUM_CHUNKS);
                        if (!c.last) {
                            processChunk(chunkMap[(c.id + 1)]);
                        } else {

                        }
                    }

                };
                var uploadChunk = function (formData, chunk, callback) {
                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', url, true);
                    xhr.upload.onprogress = function (e) {
                        if (e.lengthComputable) {
                            var value = parseFloat(Math.round((e.loaded / e.total) * 100));
                            console.log(parseFloat(value) + '%');
                        }
                    };
                    xhr.onloadend = function (e) {
//                        console.log('All Done!');
                        chunk.done = true;
                        callback();
                    };
                    xhr.send(formData);
                };

                /**/
                /**/

                if (resume) {
                    var resumeFormData = new FormData();
                    resumeFormData.append('resume_upload', resume);
                    resumeFormData.append('filename', fileName);
                    resumeFormData.append('userId', userId);
                    resumeFormData.append('studyId', studyId);
                    resumeFormData.append('relativeFilePath', relativeFilePath);
                    resumeInfo = getResumeInfo(resumeFormData);
                }

                start = 0;
                end = BYTES_PER_CHUNK;
                while (start < SIZE) {
                    var last = false;
                    if (chunkId == (NUM_CHUNKS - 1)) {
                        last = true;
                    }
                    chunkMap[chunkId] = {
                        id: chunkId,
                        start: start,
                        end: end,
                        done: false,
                        last: last
                    };
                    start = end;
                    end = start + BYTES_PER_CHUNK;
                    chunkId++;
                }
                processChunk(chunkMap[0]);

            }
        });
    </script>
</polymer-element>