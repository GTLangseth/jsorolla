<polymer-element name="jso-signup">
<template>
    <link rel="stylesheet" href="../jso-style.css">
    <style>
        :host {
            display: block;
            position: absolute;
            box-sizing: border-box;
            background-color: #FFFFFF;
            padding: 30px 100px;

            z-index: 50000;
            top: 90px;

            left: 0;
            right: 0;
            margin-left: auto;
            margin-right: auto;

            width: 500px;
            border: 0px solid #c6d0da;
            border-width: 1px;
            /*border-top-width: 1px;*/
            transition: all 0.2s;
            box-shadow: 2px 6px 15px 8px rgba(0, 0, 0, 0.30);
        }

        .title {
            text-align: center;
            font-size: 25px;
            color: #666;
        }

        .icon {
            color: #445D76;
            font-size: 50px;
        }

        label {
            display: inline-block;
            color: #666;
            margin-top: 10px;
        }

        label::after {
            content: ':'
        }

        div.button {
            margin-top: 30px;
            padding:10px !important;
            font-size:16px;
        }

        .message {
            margin-top: 20px;
        }
    </style>
    <div class="title">
        <div>
            Create a new user
        </div>
        <div class="icon">
            <font-awesome icon="pencil-square-o"></font-awesome>
        </div>
    </div>
    <form id="form" vertical layout on-keypress="{{handleFormKey}}">
        <label>User ID</label> <input type="text" id="user" value="{{user}}" required pattern="[a-zA-Z0-9]+">
        <label>Name</label> <input type="text" id="name" value="{{name}}" required pattern=[a-zA-Z0-9\s]+>
        <label>e-mail</label> <input type="email" id="email" value="{{email}}" required>
        <label>Organization</label> <input type="text" id="organization" value="{{organization}}" required
                                           pattern=[a-zA-Z0-9\s]+>
        <label>Password</label> <input type="password" id="password" value="{{password}}" required
                                       pattern="[a-zA-Z0-9]+">
        <label>Check password</label> <input type="password" id="check" value="{{check}}" required
                                             pattern="[a-zA-Z0-9]+">

        <div class="button action" on-click="{{handleForm}}">Sign up</div>
    </form>
    <div class="message">{{message}}</div>
</template>

<script>
    Polymer({
        created: function () {
            this.user;
            this.email;
            this.name;
            this.password;
            this.check;
            this.sid;
            this.projectId;
        },
        handleFormKey: function (e) {
            if (e.which == 13) {
                this.handleForm();
            }
        },
        handleForm: function (e) {
            var me = this;
            this.message = '';

            if (this.$.form.checkValidity() && (this.password === this.check)) {
                OpencgaManager.users.create({
                    query: {
                        userId: this.user,
                        name: this.name,
                        email: this.email,
                        organization: this.organization,
                        password: CryptoJS.SHA1(this.password).toString()
                    },
                    request: {
                        success: function (response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                var userId = response.response[0].result[0].id;
                                me.message = userId + ' created';
                                me.login()

                            } else {
                                me.message = response.response[0].errorMsg;
                                //Delete cookies
                                Cookies.expire('bioinfo_sid');
                                Cookies.expire('bioinfo_user');
                            }
                        },
                        error: function () {
                            me.message = 'Server error, try again later.';
                        }
                    }
                });
            }
        },
        login: function (e) {
            var me = this;
            this.message = '';


            OpencgaManager.users.login({
                id: this.user,
                query: {
                    password: CryptoJS.SHA1(this.password).toString()
                },
                request: {
                    success: function (response) {
                        console.log(response);
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                            me.sid = response.response[0].result[0].sessionId;
                            me.createProject(me.userId, me.sid);
                        } else {
                            me.message = response.response[0].errorMsg;
                            //Delete all cookies
                            Cookies.expire('bioinfo_sid');
                            Cookies.expire('bioinfo_user');
                        }
                    },
                    error: function () {
                        me.message = 'Server error, try again later.';
                    }
                }
            });
        },
        createProject: function (userId, sid) {
            var me = this;
            this.message = '';

            OpencgaManager.projects.create({
                query: {
                    userId: me.user,
                    sid: me.sid,
                    name: "defaultPr",
                    alias: "defaultPr",
                    description: "default project",
                    organization: this.organization
                },
                request: {
                    success: function (response) {
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
//                            me.message = 'Project created sucessfully.';
                            me.projectId = response.response[0].result[0].id;
                            me.createStudy()

                        } else {
                            me.message = response.response[0].errorMsg;
                        }
                    },
                    error: function () {
                        alert('Server error, try again later.');
                    }
                }
            });
        },
        createStudy: function (e) {
            var me = this;
            this.message = '';
            OpencgaManager.studies.create({
                query: {
                    sid: me.sid,
                    name: "defaultSt",
                    alias: "defaultSt",
                    description: "default",
                    organization: "default",
//                    type: "default",
                    projectId: me.projectId

                },
                request: {
                    success: function (response) {
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
//                            me.message = 'Study created sucessfully.';
                            me.studyId = response.response[0].result[0].id;
//                            me.createAnalysis();

                        } else {
                            me.message = response.response[0].errorMsg;
                        }
                    },
                    error: function () {
                        alert('Server error, try again later.');
                    }
                }
            });
        },
//        createAnalysis: function (e) {
//            var me = this;
//            this.message = '';
//            OpencgaManager.analysis.create({
//                query: {
//                    sid: me.sid,
//                    name: "default",
//                    alias: "default",
//                    description: "default",
//                    studyId: me.studyId
//
//                },
//                request: {
//                    success: function (response) {
//                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
//                            me.message = 'Analysis created sucessfully.';
//                        } else {
//                            me.message = response.response[0].errorMsg;
//                        }
//                    },
//                    error: function () {
//                        alert('Server error, try again later.');
//                    }
//                }
//            });
//        }
    });
</script>
</polymer-element>