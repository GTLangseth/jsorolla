<link rel="import" href="jso-study-select.html">
<dom-module id="jso-upload-variant-file">
    <style>
        :host {
            display: block;
            position: fixed;
            box-sizing: border-box;
            top: 0;
            z-index: 10;
        }

        .back {
            position: fixed;
            z-index: 1;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .front {
            position: fixed;
            box-sizing: border-box;
            z-index: 2;
            background-color: inherit;

            padding: 30px 100px;

            left: 0;
            right: 0;
            top: 100px;
            margin: 0px auto 0px auto;

            width: 500px;
            box-shadow: 0px 0px 12px 6px rgba(0, 0, 0, 0.30);
        }

        .title {
            text-align: center;
            font-size: 25px;
        }

        .icon {
            font-size: 50px;
        }

        .message {
            margin-top: 20px;
        }

        .close {
            position: absolute;
            margin: 15px;
            font-size: 18px;
            top: 0;
            right: 0;
        }

        .close:hover {
            color: orangered;
        }

    </style>
    <template>
        <div class="back"></div>
        <div class="front">
            <div class="close" on-click="handleClose">
                <i class="fa fa-times"></i>
            </div>
            <div class="title">
                <div>
                    Upload variant file
                </div>
                <div class="icon color-2">
                    <i class="fa fa-cloud-upload"></i>
                </div>
            </div>

            <jso-study-select id="studySelect" projects="{{projects}}">

            </jso-study-select>

            <br>

            <form id="form">
                <div class="jso-btn jso-btn-shdw" on-click="handleBrowseClick" pattern="[a-zA-Z0-9_-]+">
                    <span>{{fileName}}<span>
                </div>
                <input type="file" hidden id="fileInput" required on-change="handleInputChange"
                       disabled$="{{uploading}}">

                <br>

                <div class="jso-btn jso-btn-shdw" on-click="handleForm">Upload</div>
                <div class="">{{percentProgress}}</div>
            </form>
        </div>
    </template>

</dom-module>
<script>
    Polymer({
        is: "jso-upload-variant-file",
        properties: {
            uploading: {
                type: Boolean,
                value: false
            },
            fileName: {
                type: String,
                value: 'Choose file...'
            },
            percentProgress: {
                type: Number,
                value: ''
            },
            projects: {
                type: Array,
                notify: true
            }
        },
        handleBrowseClick: function (e) {
            this.$.fileInput.click();
        },
        handleInputChange: function () {
            if (this.uploading == false) {
                var inputFile = this.$.fileInput.files[0];
                this.fileName = inputFile.name
            }
        },
        handleForm: function () {
            var me = this;
            if (this.$.studySelect.selectedStudy == null) {
                alert("Please select a study");
                return;
            }
            var config = {
                inputFile: this.$.fileInput.files[0],
                fileName: this.fileName,
                userId: Cookies("bioinfo_user"),
                sid: Cookies("bioinfo_sid"),
                studyId: this.$.studySelect.selectedStudy,
                relativeFilePath: '' + this.fileName,
                fileFormat: 'PLAIN',
                bioFormat: 'VARIANT',
                description: '',
                callbackProgress: function (chunk, total, response) {
                    me.percentProgress = Math.round((chunk.id / total) * 100);
                    if (chunk.last) {
                        me.percentProgress = 100;
                        me.uploading = false;

                        var uploadedFile = response.response[0].result[0];
                        me.indexFile(uploadedFile);
                    }
                }
            };
            OpencgaManager.files.upload2(config);
        },
        indexFile: function (file) {
            console.log(file.id);
            OpencgaManager.files.index({
                id: file.id,
                query: {
                    sid: Cookies('bioinfo_sid'),
                    storageEngine: "mongodb"
                },
                request: {
                    success: function (response) {
                        if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                            console.log("index");
                            console.log(response);
                        } else {
//                                me.message = response.response[0].errorMsg;
                        }
                    },
                    error: function () {
                        alert('Server error, try again later.');
                    }
                }
            });
        },
        handleClose: function (e) {
            this.fire("close");
        }
    });
</script>