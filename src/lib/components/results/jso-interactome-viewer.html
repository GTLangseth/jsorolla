<dom-module id="jso-interactome-viewer" attributes="content intermediates seedList jobResult">
    <template>
        <link rel="stylesheet" href="../sortable-table.css">
        <style>
            :host {
                display: block;
            }

            jso-network-viewer {
                height: 800px;
                border: 1px solid #d3d3d3;

            }


        </style>
        <template is="dom-if" if="{{jobResult.networkViewer}}">
            <div horizontal layout>
                <div>
                    <input type="text" value="{{sessionName}}">
                </div>
                <div class="button action" style="margin-left:5px" on-click="{{handleSaveSessionToCellMaps}}">
                    Save network as Cell Maps session
                </div>
            </div>
            <div horizontal layout>
                <label class="jso">
                    {{saveMessage}}
                </label>
                <template is="dom-if" if="{{saveMessageOk}}">
                    <div class="button action" on-click="{{handleOpenCellMapsSessionManager}}">
                        Open Cell Maps session Manager
                    </div>
                </template>
            </div>
            <br>
        </template>
        <jso-network-viewer
                id="viewer"
                lite="true"
                ></jso-network-viewer>
        <label class="jso">Legend: nodes from your list are rounded and coloured in dark grey, whereas the external nodes added as intermediate are squares with light grey color.
            <template is="dom-if" if="{{seedListExists}}">
            Nodes in ellipse shape are from the seed list.
            </template>
        </label>
        <br>
        <label class="jso">You can move the canvas using CTRL+CLICK or using the <b>Move</b> mode
            <font-awesome icon="arrows"></font-awesome>
        </label>

    </template>
    <script>
        Polymer({
            created: function () {
                this.sessionName = "";
                this.saveMessage = "";
                this.saveMessageOk = false;
                this.seedListExists = false;
            },
            domReady: function () {
                this.$.viewer.$.nodeRender.setAttribute('hidden', '');
                this.$.viewer.$.edgeRender.setAttribute('hidden', '');
            },
            contentChanged: function () {
                var me = this;
                this.intermediates = this.intermediates.split("|");
                this.seedList = this.seedList.split("|");
                var adapter = new SIFNetworkDataAdapter({
                    dataSource: new StringDataSource(this.content),
                    handlers: {
                        'data:load': function (event) {
                            //me.processData(event.graph);
                            me.$.viewer.setGraph(event.graph);
                            me.$.viewer.setLayout("Force directed");

                            me.$.viewer.setGraph(event.graph);
                            me.$.viewer.setVertexDefaultDisplayProperty("color", "#c0c0c0")
                            me.$.viewer.setEdgeDefaultDisplayProperty("shape", "undirected")
                            for (var i = 0; i < me.intermediates.length; i++) {
                                var intermediate = me.intermediates[i];
                                var vertex = me.$.viewer.graph.getVertexById(intermediate);
                                if(vertex == null)
                                    continue;
                                vertex.renderer.set("shape", "square");
                                vertex.renderer.set("width", 20);
                                vertex.renderer.set("color", "#eaeaea");

                            }
                            for (var i = 0; i < me.seedList.length; i++) {
                                var seed = me.seedList[i];
                                var vertex = me.$.viewer.graph.getVertexById(seed);
                                if(vertex == null)
                                    continue;
                                me.seedListExists = true;
                                vertex.renderer.set("shape", "ellipse");
                                vertex.renderer.set("width", 30);
                                vertex.renderer.set("height", 20);
                                vertex.renderer.set("color", "#c0c0c0");

                            }
                            var file = "";
                            for (var i = 0; i < me.filesList.length; i++) {
                                file = me.filesList[i];
                                if (file.name.indexOf("interactors") > 0)
                                    break;
                            }
                            if(file != ""){
                                Utils.getFileContent(function (attrContent) {
                                    new AttributeNetworkDataAdapter({
//                                ignoreColumns: ?,
                                        dataSource: new StringDataSource(attrContent),
                                        handlers: {
                                            'data:load': function (event) {
                                                var attributeManager1 = event.attributeManager;
                                                me.$.viewer.importVertexAttributeManager(attributeManager1);

                                            },
                                            'error:parse': function (event) {
                                                me.message = event.errorMsg;
                                            }
                                        }
                                    });
                                }, file.id);

                            }

//                            me.$.output.querySelector("#" + divId).appendChild(networkViewer);

                        },
                        'error:parse': function (event) {
                            console.log("ERRORRRR");
                        }
                    }
                });

            },
            handleSaveSessionToCellMaps: function (e) {
                var saved = this.jobResult.networkViewer.$.sessionManager.saveSession(this.$.viewer, this.sessionName + ' - ' + this.jobResult.jobItem.name);
                if (saved) {
                    this.saveMessage = "Saved as " + this.sessionName + ", you can go back to Cell Maps and load the network using the session manager inside File menu.";
                    this.sessionName = '';
                    this.saveMessageOk = true;
                } else {
                    this.saveMessage = this.sessionName + 'already exists.';
                    this.saveMessageOk = false;
                }
            },
            handleOpenCellMapsSessionManager: function () {
                this.jobResult.selectedOption = "";
                this.jobResult.networkViewer.selectedMenu = "session-manager";
            }

        })
    </script>
</dom-module>

