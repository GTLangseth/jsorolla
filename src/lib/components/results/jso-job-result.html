<polymer-element name="jso-job-result" attributes="jobItem">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <link rel="stylesheet" href="../sortable-table.css">
        <style>
            :host {
                display: block;
                box-sizing: border-box;
                position: relative;
            }

            /*sortable-table {*/
            /*width: 100px;*/
            /*}*/

            .output {
                margin: 10px;
                /*width: 1000px;*/
                background-color: white;
                border-radius: 5px;
                padding: 20px;
            }

            .data {
                margin-left: 20px;
            }

            .level-0 {
                /*border: 1px solid grey;*/
                padding: 20px;

            }

            .level-0 > .headerTitle {
                font-size: 15pt;
                font-weight: bold;
                padding: 5px;
            }

            .level-1 {
                margin: 20px 20px 20px 40px;
            }

            .level-1 > .headerTitle {
                font-size: 13pt;
                font-weight: bold;
                /*background-color: blue;*/
            }

            .level-2 {
                margin: 20px 20px 20px 40px;
            }

            .level-2 > .headerTitle {
                font-size: 12pt;
                /*background-color: blue;*/
            }
        </style>

        <div id="output" class="output" horizontal layout center-justified></div>

    </template>
    <script>
        Polymer({
            created: function () {
                this.createdElements = {};
            },
            jobItemChanged: function (oldV, newV) {
                var me = this;

                while (this.$.output.firstChild) {
                    this.$.output.removeChild(this.$.output.firstChild);
                }
                me.pvalue = 0.05;

                OpencgaManager.files.filesByFolder({
                    id: me.jobItem.outDirId,
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        success: function (response) {

                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                me.filesList = response.response[0].result;
                                me.getFileContent(function (content) {
                                    var root = me.$.output;
                                    me.parseXML(content, root);
                                }, "result.xml");
                            }
                        },
                        error: function () {
                            me.message = 'Server error, try again later.';
                        }
                    }
                })
            },
            getFileContent: function (callback, fileName) {
                var me = this;
                var fileId = -1;
                for (var result in this.filesList) {
                    if (this.filesList[result].name == fileName) {
                        fileId = this.filesList[result].id
                        break;
                    }
                }
                OpencgaManager.files.content({
                    id: fileId,
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        success: function (response) {
//                    var content = response.response[0]
                            /** I pass localDiv as parameter because I loose the div to render in a loop **/
                            callback(response)
                        },
                        error: function () {
                            this.message = 'Server error, try again later.';
                        }
                    }
                })
            },
            prettyString: function (str) {
                return str.replace(/\s/g, "_").replace(/\(/g, "_").replace(/\)/g, "_");
            },
            createElement: function (parent, htmlType, htmlContent) {
                var el = document.createElement(htmlType);
                var node = document.createTextNode(htmlContent);
                el.appendChild(node);
                parent.appendChild(el);
            },
            parseXML: function (xml) {
                var me = this;
                if (window.DOMParser) {
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(xml, "text/xml");
                }
                else {
                    var xmlDoc = new ActiveXObject("Microsoft.XMLDOM");
                    xmlDoc.async = false;
                    xmlDoc.loadXML(xml);
                }
                var output = xmlDoc.getElementsByTagName("output")[0].children

//                me.createStructure(output);
                var elementsJSON = me.parseOutput(output);

                var divsJSON = me._renderJSON(elementsJSON);
                me.$.output.appendChild(divsJSON);
            },
            parseOutput: function (output) {
                var elements = [];

                for (var i = 0; i < output.length; i++) {
                    var elemXML = output[i];
                    this._parseElem(elemXML, elements);
                }
                return elements;
            },
            _renderJSON: function (elements) {
                var mainDiv = document.createElement("div");
                for (var i = 0; i < elements.length; i++) {
                    var elem = elements[i];
                    var divElem = this._renderJsonElement(elem, 0);
                    mainDiv.appendChild(divElem);

                }
                return mainDiv;
            },
            _renderJsonElement: function (element, level) {

                var mainDiv = document.createElement("div");
                var titleDiv = document.createElement("div");
                var dataDiv = document.createElement("div");
                var childDiv = document.createElement("div");


                mainDiv.classList.add("level-" + level);

                titleDiv.classList.add("headerTitle");
                titleDiv.innerHTML = element.group;

                for (var i = 0; i < element.data.length; i++) {
                    var dataElement = element.data[i];
                    var dataElementDiv = document.createElement("div");

                    dataElementDiv = this._renderValue(dataElement);

                    dataDiv.appendChild(dataElementDiv);
                }

                dataDiv.classList.add("data");

                for (var i = 0; i < element.children.length; i++) {
                    var childElement = element.children[i];
                    var childElementDiv = this._renderJsonElement(childElement, level + 1);

                    childDiv.appendChild(childElementDiv);
                }

                childDiv.classList.add("children");

                mainDiv.appendChild(titleDiv);
                mainDiv.appendChild(dataDiv);
                mainDiv.appendChild(childDiv);

                return mainDiv;
            },
            _getFileId: function (fileName) {
                var fileId = -1;
                for (var result in this.filesList) {
                    if (this.filesList[result].name == fileName) {
                        fileId = this.filesList[result].id
                        break;
                    }
                }
                return fileId;
            },
            _renderValue: function (element) {

                var me = this;
                var res = document.createElement("div");
                switch (element.type) {
                    case "IMAGE":

                        if (element.tags.indexOf("NETWORKMINER_JSON") >= 0) {
                            var divHC = document.createElement("div");
                            divHC.setAttribute("id", "nm-json-highChart");

                            this.getFileContent(function (content) {
                                me.parseHighCharts(content, divHC.getAttribute("id"));

                            }, element.value);
                            res.appendChild(divHC);
                            break;
                        }

                        var fileId = this._getFileId(element.value);
                        res = document.createElement("img");

                        var imageUrl = OpencgaManager.files.content({
                            id: fileId,
                            query: {
                                sid: Cookies("bioinfo_sid")
                            },
                            request: {

                                url: true
                            }
                        })
                        res.setAttribute("src", imageUrl);
                        break;
                    case "MESSAGE":
                        var label = document.createElement("label");
                        label.innerHTML = element.title;
                        var div = document.createElement("div");
                        div.innerHTML = element.value;

                        res.setAttribute("horizontal", "");
                        res.setAttribute("layout", "");

                        res.appendChild(label);
                        res.appendChild(div);
                        break;
                    case "FILE":
                        var label = document.createElement("label");
                        label.innerHTML = element.title;
                        res.appendChild(label);

                        var fileId = this._getFileId(element.value);

                        var fileURL = OpencgaManager.files.content({
                            id: fileId,
                            query: {
                                sid: Cookies("bioinfo_sid")
                            },
                            request: {

                                url: true
                            }
                        })

                        var a = document.createElement("a");
                        a.innerHTML = element.value;
                        a.setAttribute("href", fileURL);

                        res.appendChild(a);


                        if (element.tags.indexOf("NETWORKMINERRANKED_TABLE") >= 0 || element.tags.indexOf("NETWORKMINERNOTRANKED_TABLE") >= 0) {
                            this.getFileContent(function (content) {
                                var data = content.split("\n");

                                for (var i = 1; i < data.length; i++) {
                                    dataArray.push(data[i].split("\t"))
                                }


                            }, element.value);

                            var sortableTable = document.createElement('sortable-table');
                            sortableTable.setAttribute("id", "tableId");
                            var dataArray = new Array();
                            sortableTable.columns = ["Input", "Id", "Type", "Rank", "Betweenness", "Clustering", "Connections", "GOs", "KEEGs"];
                            sortableTable.data = dataArray;
                            sortableTable.pageSize = "10";
                            sortableTable.footerTemplate = "simplePager";

                            res.appendChild(sortableTable);

                        }

                        if (element.tags.indexOf("INTERACTOME_VIEWER") >= 0) {
                            var networkViewer = document.createElement('jso-network-viewer');
                            networkViewer.setAttribute("id", "networkId");

                            this.getFileContent(function (content) {
                                var adapter = new SIFNetworkDataAdapter({
                                    dataSource: new StringDataSource(content),
                                    handlers: {
                                        'data:load': function (event) {
                                            //me.processData(event.graph);
                                            networkViewer.setGraph(event.graph);
                                            networkViewer.setLayout("Force directed");
                                            me.$.output.querySelector("#" + divId).appendChild(networkViewer);
                                        },
                                        'error:parse': function (event) {
                                            console.log("ERRORRRR");
                                        }
                                    }
                                });
                            }, element.value);


                            res.appendChild(networkViewer);
                        }


                }

                return res;

            },
            parseHighCharts: function (content, divId) {
                var json = JSON.parse(content);
                var chartWidth = 600;

                /** Create HTML elements **/
                var elSizeAvg = document.createElement("div");
                elSizeAvg.id = divId + "_avg";
                this.$.output.querySelector("#" + divId).appendChild(elSizeAvg);

                var elSizeScore = document.createElement("div");
                elSizeScore.id = divId + "_score";
                this.$.output.querySelector("#" + divId).appendChild(elSizeScore);

                /** Create data for charts **/
                var sizeAvgList = new Array();
                var sizeAvgListSig = new Array();

                var sizeScoreList = new Array();
                var sizeScoreListSig = new Array();

                for (var idx = 0; idx < json.length; idx++) {
                    var j = json[idx];
                    var nodesLength = j.nodes.length;
                    var rawValue = j.rawValue;
                    var score = j.score;
                    var itemsSizeAvg = new Array();
                    var itemsSizeScore = new Array();

                    itemsSizeAvg.push(nodesLength);
                    itemsSizeAvg.push(rawValue);

                    itemsSizeScore.push(nodesLength);
                    itemsSizeScore.push(score);

                    if (!j.significant) {
                        sizeAvgList.push(itemsSizeAvg);
                        sizeScoreList.push(itemsSizeScore);
                    }
                    else {
                        sizeAvgListSig.push(itemsSizeAvg);
                        sizeScoreListSig.push(itemsSizeScore);
                    }
                }
                new Highcharts.Chart({
                    chart: {
                        renderTo: this.$.output.querySelector("#" + elSizeAvg.id),
                        type: 'scatter',
                        zoomType: 'xy',
                        width: chartWidth
                    },
                    title: {
                        text: 'Size vs. Avg. node per component'
                    },
                    xAxis: {
                        title: {
                            enabled: true,
                            text: 'Size'
                        },
                        startOnTick: true,
                        endOnTick: true,
                        showLastLabel: true
                    },
                    yAxis: {
                        title: {
                            text: 'Avg. node per component'
                        }
                    },
                    plotOptions: {
                        scatter: {
                            marker: {
                                radius: 5,
                                states: {
                                    hover: {
                                        enabled: true,
                                        lineColor: 'rgb(100,100,100)'
                                    }
                                }
                            },
                            states: {
                                hover: {
                                    marker: {
                                        enabled: false
                                    }
                                }
                            },
                            tooltip: {
                                headerFormat: '<b>{series.name}</b><br>',
                                pointFormat: '{point.x} , {point.y} '
                            }
                        }
                    },
                    series: [
                        {
                            name: 'Size / Avg. node per component',
                            color: 'rgba(119, 152, 191, .5)',
                            data: sizeAvgList
                        },
                        {
                            name: 'Selected',
                            color: 'rgba(223, 83, 83, .5)',
                            data: sizeAvgListSig

                        }
                    ]
                });
                new Highcharts.Chart({
                    chart: {
                        renderTo: this.$.output.querySelector("#" + elSizeScore.id),
                        type: 'scatter',
                        zoomType: 'xy',
                        width: chartWidth
                    },
                    title: {
                        text: 'Size vs. Score'
                    },
                    xAxis: {
                        title: {
                            enabled: true,
                            text: 'Size'
                        },
                        startOnTick: true,
                        endOnTick: true,
                        showLastLabel: true
                    },
                    yAxis: {
                        title: {
                            text: 'Score'
                        }
                    },
                    plotOptions: {
                        scatter: {
                            marker: {
                                radius: 5,
                                states: {
                                    hover: {
                                        enabled: true,
                                        lineColor: 'rgb(100,100,100)'
                                    }
                                }
                            },
                            states: {
                                hover: {
                                    marker: {
                                        enabled: false
                                    }
                                }
                            },
                            tooltip: {
                                headerFormat: '<b>{series.name}</b><br>',
                                pointFormat: '{point.x} , {point.y} '
                            }
                        }
                    },
                    series: [
                        {
                            name: 'Size / Score',
                            color: 'rgba(119, 152, 191, .5)',
                            data: sizeScoreList
                        },
                        {
                            name: 'Selected',
                            color: 'rgba(223, 83, 83, .5)',
                            data: sizeScoreListSig

                        }
                    ]
                });


            }
            ,
            _parseElem: function (elemXML, elements) {
                var groups = elemXML.getAttribute("group").split(".");
                if (groups.length == 1) { // Final Group
                    var group = groups[0];

                    var nameInput = elemXML.getAttribute("name");
                    var titleInput = elemXML.getAttribute("title");
                    var typeInput = elemXML.getAttribute("type");
                    var groupInput = elemXML.getAttribute("group").split(".");
                    var tagsInput = elemXML.getAttribute("tags");
                    var valueInput = elemXML.innerHTML;

                    var value = {
                        name: nameInput,
                        title: titleInput,
                        type: typeInput,
                        tags: tagsInput,
                        value: valueInput
                    }

                    if (this._containsGroup(elements, group)) {
                        this._addValueToGroup(elements, group, value);

                    } else {
                        elements.push({
                            group: group,
                            data: [value],
                            children: []
                        });
                    }
                } else { // nested Group
                    var mainGroup = groups[0];
                    var newGroups = groups.slice(0);
                    newGroups.shift();

                    var newElem = {};
                    if (this._containsGroup(elements, mainGroup)) {
                        newElem = this._getGroup(elements, mainGroup);
                    }
                    else {
                        newElem.group = mainGroup;
                        newElem.data = [];
                        newElem.children = [];
                        elements.push(newElem);
                    }
                    var newGroupJoin = newGroups.join(".");
                    var newNode = elemXML.cloneNode(true);

                    newNode.setAttribute("group", newGroupJoin);
                    this._parseElem(newNode, newElem.children);

                }
            }
            ,
            _getGroup: function (elements, group) {
                for (var i = 0; i < elements.length; i++) {
                    var elem = elements[i];
                    if (elem.group == group) {
                        return elem;
                    }

                }
                return {};
            }
            ,
            _containsGroup: function (elements, group) {
                for (var i = 0; i < elements.length; i++) {
                    var elem = elements[i];
                    if (elem.group == group) {
                        return true;
                    }

                }
                return false;
            }
            ,
            _addValueToGroup: function (elements, group, value) {
                for (var i = 0; i < elements.length; i++) {
                    var elem = elements[i];
                    if (elem.group == group) {
                        elem.data.push(value);
                    }

                }
            }

        })
    </script>
</polymer-element>