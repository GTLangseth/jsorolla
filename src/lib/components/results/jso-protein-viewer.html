<polymer-element name="jso-protein-viewer" attributes="nodes">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <link rel="stylesheet" href="../sortable-table.css">
        <style>

            jso-network-viewer {
                height: 800px;
                border: 1px solid #d3d3d3;
            }

            /*TODO temporal fix*/
            jso-network-viewer::shadow jso-nv-layout {
                height: calc(100% - 96px);
            }
        </style>
        <div id="networkWidget">
            <div>
                <div style="margin-bottom: 5px" flex horizontal layout>
                    <label>Select number of nodes in the top list of the differential expression result</label>
                    <input type="text" style="margin-right: 2px" value="{{networkNodesTop}}" size="4">
                </div>
                <div style="margin-bottom: 5px" flex horizontal layout>
                    <label>Select number of nodes in the bottom list of the differential expression result</label>
                    <input type="text" style="margin-right: 2px" value="{{networkNodesBottom}}" size="4">
                </div>
                <div class="button action"
                     style="width: 110px; margin-top: 5px; margin-bottom: 5px; "
                     on-click="{{nodesChanged}}">Draw network
                </div>
            </div>
            <jso-network-viewer id="networkViewer" hideBar="true"></jso-network-viewer>
        </div>

    </template>
    <script>
        Polymer({
            created: function () {
                this.ids = [];
                this.networkNodesTop = 10;
                this.networkNodesBottom = 10;

            },
            domReady: function () {
                this.$.networkViewer.hideNodeSimpleRendering = true;
                this.$.networkViewer.hideEdgeSimpleRendering = true;
            },

            nodesChanged: function (oldV, newV) {
                var me = this;
                this.$.networkViewer.startOver();
                if (this.networkNodesTop == "" || isNaN(this.networkNodesTop))
                    this.networkNodesTop = 0;
                if (this.networkNodesBottom == "" || isNaN(this.networkNodesBottom))
                    this.networkNodesBottom = 0;
                var nodes = this.nodes.slice(0, this.networkNodesTop);
                nodes = nodes.concat(this.nodes.slice(this.nodes.length - this.networkNodesBottom, this.nodes.length));
                if (nodes.length == 0)
                    return;
                var nodesMap = {};
                for (var i = 0; i < nodes.length; i++) {
                    var node = nodes[i];
                    nodesMap[node] = true;
                }

                var intactImport = this.$.networkViewer.$.intactImport;
                var cellbaseAttributeImport = this.$.networkViewer.$.cellbaseAttributeImport;
                var xrefDatabase = "hgnc_symbol";
                var xrefDatabaseId = xrefDatabase+"id";
                console.log(nodes)
                intactImport.getGraph('hsapiens', nodes, function (graph) {
                    me.$.networkViewer.setGraph(graph);
                    me.$.networkViewer.setLayout('Force directed');

                    cellbaseAttributeImport.uncheckAllDatabases();
                    cellbaseAttributeImport.checkDatabase(xrefDatabase);

                    cellbaseAttributeImport.retrieveData('id', 'hsapiens', function () {
                        me.$.networkViewer.selectVertexDefaultLabelAttribute(xrefDatabaseId);
                        cellbaseAttributeImport.uncheckAllDatabases();

                        for (var i = 0; i < me.$.networkViewer.vAttr.data.length; i++) {
                            var row = me.$.networkViewer.vAttr.data[i];
                            var val = row[xrefDatabaseId];
                            if (!val || val == '') {
                                row[xrefDatabaseId] = row['id'];
                            }
                            else {
                                var vals = val.split(",");
                                var newVals = [];
                                for (var j = 0; j < vals.length; j++) {
                                    var v = vals[j];
                                    if (nodesMap[v] === true) {
                                        newVals.push(v);
                                    }
                                }
                                row[xrefDatabaseId] = newVals.join(',')
                            }
                            if (nodesMap[row[xrefDatabaseId]] == true) {
                                var vertex = me.$.networkViewer.graph.getVertexById(row['id']);
                                vertex.renderer.set("color", '' +
                                '#f99494');
                            }
                        }

//                        for (var i = 0; i < nodes.length; i++) {
//                            var node = nodes[i];
//                            me.$.networkViewer.selectVerticesByAttribute(e.detail.columnName, e.detail.value);
//                        }

                    });
                });
//                debugger
//                for (var i = 0; i < nodes.length; i++) {
//                    var node = nodes[i];
//                    this.$.networkViewer.createVertex(0, 0, node);
//                    var vertex = this.$.networkViewer.graph.getVertexById(node);
////                    vertex.renderer.set("size", 20);
//                    vertex.renderer.set("color", "#eaeaea");
//                }
//                this.$.networkViewer.setLayout("Force directed");

            }
        })
    </script>
</polymer-element>

