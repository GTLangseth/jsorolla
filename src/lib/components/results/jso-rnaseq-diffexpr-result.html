<polymer-element name="jso-rnaseq-diffexpr-result" attributes="jobItem">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <link rel="stylesheet" href="../sortable-table.css">
        <style>
            :host {
                display: block;
                /*position: relative;*/
                background-color: white;
            }

            .message > label {
                margin-right: 10px;
            }

            .message > label:after {
                content: ':';
            }

            .message > .messageValue {
                font-size: 9pt;
                font-weight: bold;
                font-style: italic;
                color: #55f;
                line-height: 21px;

            }

            .file > label {
                margin-right: 10px;
            }

            .file > a {
                font-size: 9pt;
                font-weight: bold;
                font-style: italic;
                color: #55f;
            }

            sortable-table::shadow thead tr th {
                /*width: 1000px;*/
                white-space: inherit;
                overflow: auto;
                text-overflow: inherit;

            }

            .output {
                margin: 10px;
                /*width: 1000px;*/
                background-color: white;
                border-radius: 5px;
                padding: 20px;
            }
        </style>

        <div id="output" class="output">
            <h1> RNASeq Differential expression</h1>

            <div>
                <jso-job-info-widget jobItem="{{jobItem}}"></jso-job-info-widget>

                <h3>Input parameters</h3>

                <div class="message" horizontal="" layout="">
                    <label>Data file</label>

                    <div class="messageValue">{{dataFile}}</div>
                </div>
                <template if="{{method != ''}}">
                    <div class="message" horizontal="" layout="">
                        <label>Method</label>

                        <div class="messageValue">{{method}}</div>
                    </div>
                </template>
                <div class="message" horizontal="" layout="">
                    <label>Mu:ltiple-test correction</label>

                    <div class="messageValue">{{pvmet}}</div>
                </div>
                <div class="message" horizontal="" layout="">
                     <label>P value</label>

                    <div class="messageValue">{{pval}}</div>
                </div>
            </div>
            <div>
                <h3>Significative results</h3>

                <h3>Voom graphics</h3>
                <img src="{{voom_MDS}}">
                <img src="{{voom_mean_var}}">


                <div class="file"><label>File</label>
                    <a href="{{fileUrl}}" target="_blank">diffexp_Sig_results.txt</a>
                </div>


                <!--<sortable-table id="diffexp_Sig_results"-->
                                <!--data="{{data}}"-->
                                <!--columns="{{columns}}"-->
                                <!--footerTemplate="{{footerTemplate}}"-->
                                <!--pageSize="{{pageSize}}"-->
                                <!--flex>-->
                <!--</sortable-table>-->

                <h3>HeatMap</h3>
                <img src="{{diffexp_heatmap}}">

                <h3>Redirections</h3>

                <div style="margin-left: 20px">
                    <h4>Single enrichment analysis</h4>
                    <jso-redirection titleRed="Top list vs Genome" fileName="diffexp_toplist_results.txt"
                                     fileUrl="{{diffexp_toplist_results_url}}"
                                     buttonLabel="Send to Single enrichment" buttonWidth="200px"
                                     args="{{diffexp_toplist_results_sea_args}}" id="">

                    </jso-redirection>

                    <jso-redirection titleRed="Bottom list vs Genome" fileName="diffexp_bottomlist_results.txt"
                                     fileUrl="{{diffexp_bottomlist_results_url}}"
                                     buttonLabel="Send to Single enrichment" buttonWidth="200px"
                                     args="{{diffexp_bottomlist_results_sea_args}}" id="">

                    </jso-redirection>
                    <jso-redirection titleRed="Top list vs Bottom list" fileName="" fileUrl=""
                                     buttonLabel="Send to Single enrichment" buttonWidth="200px"
                                     args="{{toplist_vs_bottomlist_sea_args}}" id="">

                    </jso-redirection>

                    <h4>Gene set enrichment analysis</h4>
                    <jso-redirection titleRed="T statistic results" fileName="diffexp_t_results.txt"
                                     fileUrl="{{diffexp_t_results_url}}"
                                     buttonLabel="Send to Gene set enrichment" buttonWidth="200px"
                                     args="{{diffexp_t_results_gsea_args}}" id="">

                    </jso-redirection>

                    <h4>Network enrichment analysis</h4>
                    <jso-redirection titleRed="Top list vs Interactome" fileName="diffexp_toplist_results.txt"
                                     fileUrl="{{diffexp_toplist_results_url}}"
                                     buttonLabel="Send to Network enrichment" buttonWidth="200px"
                                     args="{{diffexp_toplist_results_nea_args}}" id="">

                    </jso-redirection>
                    <jso-redirection titleRed="Bottom list vs Genome" fileName="diffexp_bottomlist_results.txt"
                                     fileUrl="{{diffexp_bottomlist_results_url}}"
                                     buttonLabel="Send to Network enrichment" buttonWidth="200px"
                                     args="{{diffexp_bottomlist_results_nea_args}}" id="">

                    </jso-redirection>
                    <jso-redirection titleRed="Top list vs Bottom list" fileName="" fileUrl=""
                                     buttonLabel="Send to Network enrichment" buttonWidth="200px"
                                     args="{{toplist_vs_bottomlist_nea_args}}" id="">

                    </jso-redirection>

                    <h4>Gene set network enrichment analysis</h4>
                    <jso-redirection titleRed="T statistic results" fileName="diffexp_t_results.txt"
                                     fileUrl="{{diffexp_t_results_url}}"
                                     buttonLabel="Send to Gene set network enrichment" buttonWidth="200px"
                                     args="{{diffexp_t_results_gsnea_args}}" id="">

                    </jso-redirection>

                    <h4>Clustering</h4>
                    <jso-redirection titleRed="Significative data results" fileName="diffexp_sigData_results.txt"
                                     fileUrl="{{diffexp_sigData_results_url}}"
                                     buttonLabel="Send to Clustering" buttonWidth="200px"
                                     args="{{diffexp_sigData_results_args}}" id="">

                    </jso-redirection>
                </div>

                <h3>Network viewer</h3>
                <jso-protein-viewer nodes="{{nodes}}"></jso-protein-viewer>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            created: function () {
                this.dataFile = "none";
                this.glFile = "none";
                this.method = "";
                this.toplist_vs_bottomlist_sea_args = {};
                this.toplist_vs_bottomlist_nea_args = {};

                this.nodes = [];

            },
            parseCommandLine: function () {
                this.clearFields();
                var fields = this.jobItem.commandLine.split(" ");
                for (var i = 0; i < fields.length; i++) {

                    if (fields[i] == "--datafile") {
                        var fileName = fields[i + 1].split("/");
                        this.dataFile = fileName[fileName.length - 1];
                    }
                    if (fields[i] == "--norm") {
                        this.method = fields[i + 1];
                    }
                    if (fields[i] == "--pvmet") {
                        this.pvmet = fields[i + 1];
                    }
                    if (fields[i] == "--pval") {
                        this.pval = fields[i + 1];
                    }
                }

            },
            clearFields: function () {
                this.dataFile = "";
                this.method = "";
                this.pvmet = "";
                this.pval = "";
            },
            jobItemChanged: function (oldV, newV) {
                this.parseCommandLine();
                /** get url **/
                var me = this;

                OpencgaManager.files.filesByFolder({
                    id: me.jobItem.outDirId,
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        success: function (response) {

                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                var fileList = response.response[0].result;
                                for (var i = 0; i < fileList.length; i++) {
                                    var fileName = fileList[i].name;
                                    console.log(fileName)
                                    if (fileName == "diffexp_Sig_results.txt") {
                                        me.fileUrl = Utils.getUrl(fileList[i].id);
                                        Utils.getFileContent(function (content) {
                                            me.parseTable(content);
                                        }, fileList[i].id);
                                    }
                                    if (fileName == "diffexp_heatmap.jpg") {
                                        me.diffexp_heatmap = Utils.getUrl(fileList[i].id);
                                    }
                                    if (fileName == "voom_MDS.jpg") {
                                        me.voom_MDS = Utils.getUrl(fileList[i].id);
                                    }
                                    if (fileName == "voom_mean-var.jpg") {
                                        me.voom_mean_var = Utils.getUrl(fileList[i].id);
                                    }
                                    if (fileName == "diffexp_toplist_results.txt") {
                                        me.diffexp_toplist_results_url = Utils.getUrl(fileList[i].id);
                                        me.diffexp_toplist_results_sea_args = {
                                            tool: "fatigo",
                                            comparisonRadio: "list2genome",
                                            inputFile: fileList[i]
                                        };
                                        me.toplist_vs_bottomlist_sea_args["tool"] = "fatigo";
                                        me.toplist_vs_bottomlist_sea_args["comparisonRadio"] = "list2list";
                                        me.toplist_vs_bottomlist_sea_args["inputFile"] = fileList[i];

                                        me.diffexp_toplist_results_nea_args = {
                                            tool: "snow",
                                            inputFile: fileList[i],
                                            type:"genes"
                                        };
                                        me.toplist_vs_bottomlist_nea_args["tool"] = "snow";
                                        me.toplist_vs_bottomlist_nea_args["inputFile"] = fileList[i];
                                        me.toplist_vs_bottomlist_nea_args["mode"] = "two_list";
                                        me.toplist_vs_bottomlist_nea_args["type"] = "genes";


                                    }
                                    if (fileName == "diffexp_bottomlist_results.txt") {
                                        me.diffexp_bottomlist_results_url = Utils.getUrl(fileList[i].id);
                                        me.diffexp_bottomlist_results_sea_args = {
                                            tool: "fatigo",
                                            comparisonRadio: "list2genome",
                                            inputFile: fileList[i]
                                        };
                                        me.toplist_vs_bottomlist_sea_args["inputFile2"] = fileList[i];

                                        me.diffexp_bottomlist_results_nea_args = {
                                            tool: "snow",
                                            inputFile: fileList[i],
                                            type: "genes"
                                        };
                                        me.toplist_vs_bottomlist_nea_args["inputFile2"] = fileList[i];
                                    }
                                    if (fileName == "diffexp_sigData_results.txt") {
                                        me.diffexp_sigData_results_url = Utils.getUrl(fileList[i].id);
                                        me.diffexp_sigData_results_args = {
                                            tool: "clustering",
                                            inputFile: fileList[i]
                                        };
                                    }
                                    if (fileName == "diffexp_t_results.txt") {
                                        me.diffexp_t_results_url = Utils.getUrl(fileList[i].id);
                                        me.diffexp_t_results_gsea_args = {
                                            tool: "fatiscan",
                                            inputFile: fileList[i]
                                        };
                                        me.diffexp_t_results_gsnea_args = {
                                            tool: "network-miner",
                                            inputFile: fileList[i]
                                        };
                                    }


                                }
                            }
                        },
                        error: function () {
                            me.message = 'Server error, try again later.';
                        }
                    }
                });
            },
//            getUrl: function (fileId) {
//                return OpencgaManager.files.content({
//                    id: fileId,
//                    query: {
//                        sid: Cookies("bioinfo_sid")
//                    },
//                    request: {
//                        url: true
//                    }
//                });
//            },
            parseTable: function (content) {
                this.data = [];
                this.columns = [];
                var data = content.split("\n");
                /** get header **/
                var processColumns = true;
                var idxHeader = 0;
                for (var i = 0; i < data.length; i++) {
                    if (data[i] == "") continue;
                    if (data[i].indexOf("#") == 0) {
                        idxHeader = i;
                        continue;
                    }
                    /** process columns **/
                    if (processColumns) {
                        processColumns = false;
                        var aux = data[idxHeader].split("\t");
                        for (var j = 0; j < aux.length; j++) {
                            this.columns.push({name: aux[j]})
                        }
                    }
                    var localData = data[i].split("\t");
                    this.nodes.push(localData[0]);
                    var obj = new Object();
                    for (var j = 0; j < localData.length; j++) {
                        var value = localData[j];
                        if (isNaN(value))
                            obj[this.columns[j]["name"]] = value;
                        else {
                            if (!this.isInt(value))
                                obj[this.columns[j]["name"]] = parseFloat(value).toFixed(3);
                            else
                                obj[this.columns[j]["name"]] = parseInt(value);
                        }
                    }
                    this.data.push(obj);
                }

                this.pageSize = "10";
                this.footerTemplate = "simplePager";

            },
            isInt: function (n) {
                return n % 1 === 0;
            }

//            getFileContent: function (callback, fileId) {
//                OpencgaManager.files.content({
//                    id: fileId,
//                    query: {
//                        sid: Cookies("bioinfo_sid")
//                    },
//                    request: {
//                        success: function (response) {
//                            callback(response)
//                        },
//                        error: function () {
//                            this.message = 'Server error, try again later.';
//                        }
//                    }
//                })
//            }
        })
    </script>
</polymer-element>


