<polymer-element name="jso-snow-result" attributes="jobItem">
<template>
    <link rel="stylesheet" href="../jso-style.css">
    <link rel="stylesheet" href="../sortable-table.css">
    <style>
        :host {
            display: block;
            /*position: relative;*/
            background-color: white;
        }

        sortable-table {
            width: 1000px;
        }

    </style>
    <!--<span>{{jobItem.id}}</span>-->
    <!--<span>{{jobItem.outDir}}</span>-->

    <div id="output">
        <div id="inputParameters">
            <h2>Input parameters</h2>
            <ul>
                <li>Species: {{species}}</li>
                <li>Side for kolmogorov test: {{side}}</li>
                <li>Id type: {{type}}</li>
                <li>Group interaction: {{group}}</li>
                <li>Number of randoms: {{randoms}}</li>
                <li>Max number of external proteins introduced: {{intermediate}}</li>
            </ul>
        </div>
        <div id="NetworkParametersEvaluation">
            <h2>Network parameters evaluation</h2>

            <h3>Minimal Connected Network topological evaluation</h3>
            <ul>
                <li>Number of components with more than 1 node: {{comp_more_than_1_node}}</li>
                <li>Number of components [95% confidence interval]: {{components_number}}</li>
            </ul>
            <h4>Betweenness</h4>
            <ul>
                <li>Relative betweenness: List1 > Random pval: {{sn_random_kol_param_bet}}</li>
                <li>Plot {{sn_random_relBetbp}}</li>
            </ul>
            <h4>Connections</h4>
            <ul>
                <li>Connections: List1 > Random pval: {{sn_random_kol_param_conn}}</li>
                <li>Plot {{sn_random_connbp}}</li>
            </ul>
            <h4>Clustering Coeff</h4>
            <ul>
                <li>Clustering: List1 < Random pval: {{sn_random_kol_param_clu}}</li>
                <li>Plot {{sn_random_clustbp}}</li>
            </ul>

            <h4>Files</h4>
            <ul>
                <li>Component values: {{sn_nodeFile1_components_param}}</li>
                <li>Topological values: {{sn_nodeFile1_topo_param}}</li>
                <li>External proteins introduced to the network: {{sn_external1_topo_param}}</li>
            </ul>
            <h3>Role of list within interactome of reference</h3>
            <h4>Betweenness</h4>
            <ul>
                <li>Relative betweenness: List > Interactome pval: {{list_inter_kol_param_bet}}</li>
                <li>Plot {{list_inter_relBetbp}}</li>
            </ul>
            <h4>Connections</h4>
            <ul>
                <li>Connections: List1 > interactome pval:{{list_inter_kol_param_conn}}</li>
                <li>Plot {{list_inter_connbp}}</li>
            </ul>
            <h4>Clustering Coeff</h4>
            <ul>
                <li>Clustering: List1 < interactome pval: {{list_inter_kol_param_clu}}</li>
                <li>Plot {{list_inter_clustbp}}</li>
            </ul>
            <h4>Files</h4>
            <ul>
                <li>Topological values of list 1 within interactome: {{list_1_topo}}</li>
            </ul>
        </div>
        <div id="NetworkViewerList1">
            <h2>Network viewer list 1</h2>
            <ul>
                <li>Minimun Connected Network interactions: {{svg_viewer1_param}}</li>
            </ul>
            <jso-network-viewer id="networkViewer"></jso-network-viewer>
        </div>
        <div id="InteractorsList1">
            <h2>Interactors list 1</h2>
            <ul>
                <li>Minimun Connected Network interactors: {{mcn_interactors_list1}}</li>
            </ul>
            <sortable-table id="st" pageSize="10" footerTemplate="simplePager"></sortable-table>
        </div>
    </div>

</template>
<script>
Polymer({
    created: function () {
    },
    jobItemChanged: function (oldV, newV) {
        var me = this;

        OpencgaManager.files.filesByFolder({
            id: me.jobItem.outDirId,
            query: {
                sid: Cookies("bioinfo_sid")
            },
            request: {
                success: function (response) {

                    if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                        me.filesList = response.response[0].result;
                        me.getFileContent(function (content) {
                            var root = me.$.output;
                            me.parseXML(content, root);
                        }, "result.xml");
                    }
                },
                error: function () {
                    me.message = 'Server error, try again later.';
                }
            }
        })
    },
    getFileContent: function (callback, fileName) {
        var me = this;
        var fileId = -1;
        for (var result in this.filesList) {
            if (this.filesList[result].name == fileName) {
                fileId = this.filesList[result].id
                break;
            }
        }
        OpencgaManager.files.content({
            id: fileId,
            query: {
                sid: Cookies("bioinfo_sid")
            },
            request: {
                success: function (response) {
//                    var content = response.response[0]
                    /** I pass localDiv as parameter because I loose the div to render in a loop **/
                    callback(response)
                },
                error: function () {
                    this.message = 'Server error, try again later.';
                }
            }
        })
    },
    parseXML: function (xml, root) {
        var me = this;
        if (window.DOMParser) {
            var parser = new DOMParser();
            var xmlDoc = parser.parseFromString(xml, "text/xml");

            /** Parse XML **/
            var output = xmlDoc.getElementsByTagName("output")[0].children
            output.array().forEach(function (childNode) {
                var nameInput = childNode.getAttribute("name");
                var titleInput = childNode.getAttribute("title");
                var typeInput = childNode.getAttribute("type");
                var groupInput = childNode.getAttribute("group");
                var tagsInput = childNode.getAttribute("tags");
                var valueInput = childNode.firstChild.nodeValue;

                if (nameInput == "interactome_param")  me.species = valueInput;
                if (nameInput == "side_param")  me.side = valueInput;
                if (nameInput == "type_param")  me.type = valueInput;
                if (nameInput == "group_param")  me.group = valueInput;
                if (nameInput == "randoms_param")  me.randoms = valueInput;
                if (nameInput == "intermediate_param")  me.intermediate = valueInput;

                if (nameInput == "comp_more_than_1_node")  me.comp_more_than_1_node = valueInput;
                if (nameInput == "components_number")  me.components_number = valueInput;
                if (nameInput == "sn_random_kol_param_bet")  me.sn_random_kol_param_bet = valueInput;
                if (nameInput == "sn_random_kol_param_conn")  me.sn_random_kol_param_conn = valueInput;
                if (nameInput == "sn_random_kol_param_clu")  me.sn_random_kol_param_clu = valueInput;
                if (nameInput == "sn_random_relBetbp")  me.sn_random_relBetbp = valueInput;
                if (nameInput == "sn_random_connbp")  me.sn_random_connbp = valueInput;
                if (nameInput == "sn_random_clustbp")  me.sn_random_clustbp = valueInput;
                if (nameInput == "sn_nodeFile1_components_param")  me.sn_nodeFile1_components_param = valueInput;
                if (nameInput == "sn_nodeFile1_topo_param")  me.sn_nodeFile1_topo_param = valueInput;
                if (nameInput == "sn_external1_topo_param")  me.sn_external1_topo_param = valueInput;

                if (nameInput == "list_inter_kol_param_bet")  me.list_inter_kol_param_bet = valueInput;
                if (nameInput == "list_inter_kol_param_conn")  me.list_inter_kol_param_conn = valueInput;
                if (nameInput == "list_inter_kol_param_clu")  me.list_inter_kol_param_clu = valueInput;

                if (nameInput == "list_inter_relBetbp")  me.list_inter_relBetbp = valueInput;
                if (nameInput == "list_inter_connbp")  me.list_inter_connbp = valueInput;
                if (nameInput == "list_inter_relBetbp")  me.list_inter_relBetbp = valueInput;

                if (nameInput == "list_1_topo")  me.list_1_topo = valueInput;

                if (nameInput == "svg_viewer1_param") {
                    me.svg_viewer1_param = valueInput;
                    me.getFileContent(function (content) {
                        if (tagsInput.indexOf("INTERACTOME_VIEWER") >= 0) {
                            var adapter = new SIFNetworkDataAdapter({
                                dataSource: new StringDataSource(content),
                                handlers: {
                                    'data:load': function (event) {
                                        me.$.networkViewer.setGraph(event.graph);
                                        me.$.networkViewer.setLayout("Force directed");
                                    },
                                    'error:parse': function (event) {
                                        console.log("ERRORRRR");
                                    }
                                }
                            });
                        }
                    }, valueInput);
                }
                if (nameInput == "mcn_interactors_list1") {
                    me.mcn_interactors_list1 = valueInput;
                    me.getFileContent(function (content) {
                        var sortableTable = me.$.st;
                        var data = content.split("\n");
                        var dataArray = new Array();
                        for (var i = 1; i < data.length; i++) {
                            if(data[i]=="") continue;
                            dataArray.push(data[i].split("\t"))
                        }
                        sortableTable.columns = ["Input", "Id", "Type", "Rank", "Betweenness", "Clustering", "Connections", "GOs", "KEEGs"];
                        sortableTable.data = dataArray;
                    }, valueInput);
                }


//                me.getFileContent(function (content) {
//                    me.parseImage(content, tagsInput, divId);
//                }, valueInput);
//                me.getFileContent(function (content) {
//                    me.parseTable(content, tagsInput, divId);
//                }, valueInput);

//                me.species
            });

        }

    },
    createHtmlElement: function (htmlType, id) {
        var el = document.createElement(htmlType);
        el.id = id;
//        var node = document.createTextNode(htmlContent);
//        header.appendChild(node);
        this.$.output.appendChild(el);
    },
    createHeader: function (father, htmlType, htmlContent) {
        var el = document.createElement(htmlType);
        var node = document.createTextNode(htmlContent);
        el.appendChild(node);
        father.appendChild(el);
//        this.$.output.appendChild(father);
    },
    parseTable: function (content, tags, divId) {
        var me = this;
        if (tags.indexOf("NETWORKMINERRANKED_TABLE") > 0) {
            var data = content.split("\n");
//            var header = data[0].split("\t")

            var sortableTable = document.createElement('sortable-table');
            sortableTable.setAttribute("id", "tableId");
            var dataArray = new Array();
            for (var i = 1; i < data.length; i++) {
                dataArray.push(data[i].split("\t"))
            }

            sortableTable.columns = ["Input", "Id", "Type", "Rank", "Betweenness", "Clustering", "Connections", "GOs", "KEEGs"];
            sortableTable.data = dataArray;
            sortableTable.pageSize = "10"
            sortableTable.footerTemplate = "simplePager"

//           var sortableTable = '<sortable-table id="table">'
//                                        data="{{!showSelected ? attributeManager.data : attributeManager.selected }}"
//                                        columns="{{attributeManager.columns}}"
//                                        rowselection="{{!showSelected}}"
//                                        multiselect="{{multiSelect}}"
//                                        selected="{{ !showSelected ? attributeManager.selected : [] }}"
//                                        page="{{page}}"
//                                        pageSize="{{pageSize}}">
//                            <template id="inputTemplate">
//                                <td class="edit">
//                                    <input type="text" value="{{row[column.name]}}">
//                                </td>
//                            </template>
//            debugger
            this.$.output.querySelector("#" + divId).appendChild(sortableTable);
        }
        if (tags.indexOf("INTERACTOME_VIEWER") >= 0) {
            var networkViewer = document.createElement('jso-network-viewer');
            networkViewer.setAttribute("id", "networkId");
            var adapter = new SIFNetworkDataAdapter({
                dataSource: new StringDataSource(content),
                handlers: {
                    'data:load': function (event) {
                        //me.processData(event.graph);
                        networkViewer.setGraph(event.graph);
                        networkViewer.setLayout("Force directed");
                        me.$.output.querySelector("#" + divId).appendChild(networkViewer);
                    },
                    'error:parse': function (event) {
                        console.log("ERRORRRR");
                    }
                }
            });

        }

    },
    parseImage: function (content, tags, divId) {


        if (tags.indexOf("NETWORKMINER_JSON") >= 0) {
            var json = JSON.parse(content);

            /** Create HTML elements **/
            var elSizeAvg = document.createElement("div");
            elSizeAvg.id = divId + "_avg";
            this.$.output.querySelector("#" + divId).appendChild(elSizeAvg);

            var elSizeScore = document.createElement("div");
            elSizeScore.id = divId + "_score";
            this.$.output.querySelector("#" + divId).appendChild(elSizeScore);

            /** Create data for charts **/
            var sizeAvgList = new Array();
            var sizeAvgListSig = new Array();

            var sizeScoreList = new Array();
            var sizeScoreListSig = new Array();

            for (var idx = 0; idx < json.length; idx++) {
                var j = json[idx];
                var nodesLength = j.nodes.length;
                var rawValue = j.rawValue;
                var score = j.score;
                var itemsSizeAvg = new Array();
                var itemsSizeScore = new Array();

                itemsSizeAvg.push(nodesLength);
                itemsSizeAvg.push(rawValue);

                itemsSizeScore.push(nodesLength);
                itemsSizeScore.push(score);

                if (!j.significant) {
                    sizeAvgList.push(itemsSizeAvg);
                    sizeScoreList.push(itemsSizeScore);
                }
                else {
                    sizeAvgListSig.push(itemsSizeAvg);
                    sizeScoreListSig.push(itemsSizeScore);
                }
            }
            new Highcharts.Chart({
                chart: {
                    renderTo: this.$.output.querySelector("#" + elSizeAvg.id),
                    type: 'scatter',
                    zoomType: 'xy',
                    width: 800
                },
                title: {
                    text: 'Size vs. Avg. node per component'
                },
                xAxis: {
                    title: {
                        enabled: true,
                        text: 'Size'
                    },
                    startOnTick: true,
                    endOnTick: true,
                    showLastLabel: true
                },
                yAxis: {
                    title: {
                        text: 'Avg. node per component'
                    }
                },
                plotOptions: {
                    scatter: {
                        marker: {
                            radius: 5,
                            states: {
                                hover: {
                                    enabled: true,
                                    lineColor: 'rgb(100,100,100)'
                                }
                            }
                        },
                        states: {
                            hover: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },
                        tooltip: {
                            headerFormat: '<b>{series.name}</b><br>',
                            pointFormat: '{point.x} , {point.y} '
                        }
                    }
                },
                series: [
                    {
                        name: 'Size / Avg. node per component',
                        color: 'rgba(119, 152, 191, .5)',
                        data: sizeAvgList
                    },
                    {
                        name: 'Selected',
                        color: 'rgba(223, 83, 83, .5)',
                        data: sizeAvgListSig

                    }
                ]
            });
            new Highcharts.Chart({
                chart: {
                    renderTo: this.$.output.querySelector("#" + elSizeScore.id),
                    type: 'scatter',
                    zoomType: 'xy',
                    width: 800
                },
                title: {
                    text: 'Size vs. Score'
                },
                xAxis: {
                    title: {
                        enabled: true,
                        text: 'Size'
                    },
                    startOnTick: true,
                    endOnTick: true,
                    showLastLabel: true
                },
                yAxis: {
                    title: {
                        text: 'Score'
                    }
                },
                plotOptions: {
                    scatter: {
                        marker: {
                            radius: 5,
                            states: {
                                hover: {
                                    enabled: true,
                                    lineColor: 'rgb(100,100,100)'
                                }
                            }
                        },
                        states: {
                            hover: {
                                marker: {
                                    enabled: false
                                }
                            }
                        },
                        tooltip: {
                            headerFormat: '<b>{series.name}</b><br>',
                            pointFormat: '{point.x} , {point.y} '
                        }
                    }
                },
                series: [
                    {
                        name: 'Size / Score',
                        color: 'rgba(119, 152, 191, .5)',
                        data: sizeScoreList
                    },
                    {
                        name: 'Selected',
                        color: 'rgba(223, 83, 83, .5)',
                        data: sizeScoreListSig

                    }
                ]
            });


        }
    }

});
</script>
</polymer-element>


