<link rel="import" href="jso-variant-effect-grid.html">
<polymer-element name="jso-variant-browser" attributes="jobItem samples url fileId studyId">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <link rel="stylesheet" href="../sortable-table.css">
        <link rel="stylesheet" href="../../../../styles/css/style.css">
        <style>
            :host {
                display: block;
                /*position: absolute;*/
                box-sizing: border-box;
                height: 100%;

            }

            #grid {
                height: 400px;
            }

            #dataGridElement {
                border-radius: 5px;
                padding: 5px;
                padding-left: 10px;
                padding-right: 10px;
                margin: 20px 20px 20px 0px;
                background-color: #FFFFFF;
            }

            sortable-table {
                height: 307px;
                /*max-width: 100%;*/
                border: 1px solid #d3d3d3;
                overflow-x: auto;
            }

            sortable-table::shadow > table > tbody > * {
                font-size: 11px;

            }

            sortable-table::shadow > table > thead > * {
                font-size: 12px;

            }

            .defaultPager > input {
                width: 40px;
            }

            .bootstrap::shadow > table > tfoot > tr > td > .defaultPager > span > input::-webkit-inner-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }

            .bootstrap::shadow > table > tfoot > tr > td > .defaultPager {
                max-height: 15px;
                font-size: 11px;
            }

            .bootstrap::shadow .btn-sm {
                padding: 1px 4px;
            }

            .bootstrap::shadow > table > tbody > tr > td {
                padding: 3px;
            }

            sortable-table::shadow .column-variant {
                width: 70px;
            }

            /*sortable-table::shadow .column-start {*/
            /*width: 80px;*/
            /*}*/

            sortable-table::shadow .column-alleles {
                width: 70px;
            }

            sortable-table::shadow .column-snpId {
                width: 70px;
            }

            sortable-table::shadow .column-genes {
                width: 70px;
            }

            sortable-table::shadow .column-sift {
                width: 70px;
            }

            sortable-table::shadow .column-polyphen {
                width: 70px;
            }

            #genomeViewer {
                /*max-height: 500px;*/
                border: 1px solid #d3d3d3;
                overflow-y: auto;
                overflow-x: hidden;
                transition: height 0.15s;

            }

            paper-tabs::shadow #selectionBar {
                background-color: #314559;
            }

            paper-tabs paper-tab::shadow #ink {
                color: #435f7a;
            }

        </style>

        <div vertical layout flex>
            <div id="grid">
                <sortable-table class="bootstrap"
                                id="dataGrid"
                                footerTemplate="defaultPager"
                                pageSize="10"
                                columns="{{ columns }}"
                                loading="true"
                                rowSelection="true"
                                args="{{args}}">
                    <template id="samplesHeaderTemplate">
                        <th class="column-samples" style="padding:0px;">
                            <div vertical layout class="mainDiv">
                                <div horizontal layout center-justified class="totalName bb">Samples</div>
                                <div id="headerSamples" horizontal layout>
                                    <template repeat="{{sample in args.samples}}">
                                        <div horizontal layout flex center-justified>{{sample}}</div>
                                    </template>

                                </div>
                            </div>
                        </th>
                    </template>
                    <template id="samplesCellTemplate">
                        <style>
                        </style>
                        <td horizontal layout>
                            <template repeat="{{sample in args.samples}}">
                                <div horizontal layout center-justified flex>{{value[sample].GT}}</div>
                            </template>
                        </td>
                    </template>


                    <template id="mafHeaderTemplate">
                        <style>
                            .column-total {
                                width: 240px;
                            }

                            .br {
                                border-right-color: rgb(221, 221, 221);
                                border-right-style: solid;
                                border-right-width: 1px;
                            }

                            .bl {
                                border-left-color: rgb(221, 221, 221);
                                border-left-style: solid;
                                border-left-width: 1px;
                            }

                            .bt {
                                border-top-color: rgb(221, 221, 221);
                                border-top-style: solid;
                                border-top-width: 1px;
                            }

                            .bb {
                                border-bottom-color: rgb(221, 221, 221);
                                border-bottom-style: solid;
                                border-bottom-width: 1px;
                            }

                            .genotypesDiv {
                                width: 120px;
                            }

                            .freqDiv {
                                width: 120px;
                            }

                            .value {
                                width: 40px;
                            }
                        </style>
                        <th class="column-total" style="padding:0px;">
                            <div vertical layout class="mainDiv">
                                <div horizontal layout center-justified class="totalName bb">Total</div>
                                <div horizontal layout>
                                    <div vertical layout class="genotypesDiv br">
                                        <div horizontal layout center-justified class="bb">Genotypes</div>
                                        <div horizontal layout>
                                            <div horizontal layout center-justified flex class="br">0/0</div>
                                            <div horizontal layout center-justified flex class="br">0/1</div>
                                            <div horizontal layout center-justified flex>1/1</div>
                                        </div>
                                    </div>
                                    <div vertical layout class="freqDiv">
                                        <div horizontal layout center-justified class="bb">Freq.</div>
                                        <div horizontal layout>
                                            <div horizontal layout center-justified flex class="br">0 freq</div>
                                            <div horizontal layout center-justified flex class="br">1 freq</div>
                                            <div horizontal layout center-justified flex>MAF</div>
                                        </div>

                                    </div>

                                </div>
                            </div>
                        </th>
                    </template>
                    <template id="mafStaticHT">
                        <style>
                            .column-total {
                                width: 240px;
                            }

                            .br {
                                border-right-color: rgb(221, 221, 221);
                                border-right-style: solid;
                                border-right-width: 1px;
                            }

                            .bl {
                                border-left-color: rgb(221, 221, 221);
                                border-left-style: solid;
                                border-left-width: 1px;
                            }

                            .bt {
                                border-top-color: rgb(221, 221, 221);
                                border-top-style: solid;
                                border-top-width: 1px;
                            }

                            .bb {
                                border-bottom-color: rgb(221, 221, 221);
                                border-bottom-style: solid;
                                border-bottom-width: 1px;
                            }

                            .genotypesDiv {
                                width: 120px;
                            }

                            .freqDiv {
                                width: 120px;
                            }

                            .value {
                                width: 40px;
                            }
                        </style>
                        <th class="column-total" style="padding:0px;">
                            <div vertical layout class="mainDiv">
                                <div horizontal layout center-justified class="totalName bb">{{ column.title }}
                                </div>
                                <div horizontal layout>
                                    <div vertical layout class="genotypesDiv br">
                                        <div horizontal layout center-justified class="bb">Genotypes</div>
                                        <div horizontal layout>
                                            <div horizontal layout center-justified flex class="br">0/0</div>
                                            <div horizontal layout center-justified flex class="br">0/1</div>
                                            <div horizontal layout center-justified flex>1/1</div>
                                        </div>
                                    </div>
                                    <div vertical layout class="freqDiv">
                                        <div horizontal layout center-justified class="bb">Freq.</div>
                                        <div horizontal layout>
                                            <div horizontal layout center-justified flex class="br">0 freq</div>
                                            <div horizontal layout center-justified flex class="br">1 freq</div>
                                            <div horizontal layout center-justified flex>MAF</div>
                                        </div>

                                    </div>

                                </div>
                            </div>
                        </th>
                    </template>
                    <template id="mafStaticCT">
                        <style>
                            .row-total {
                                width: 240px;
                            }
                        </style>
                        <td>
                            <div horizontal layout class="row-total">
                                <!--<div flex horizontal layout center-justified flex>{{ value.stats.gt00 || "." }}</div>-->
                                <div flex horizontal layout center-justified flex>{{ value.stats.gt00 }}</div>
                                <div flex horizontal layout center-justified flex>{{ value.stats.gt01 || "." }}
                                </div>
                                <div flex horizontal layout center-justified flex>{{ value.stats.gt11 || "." }}
                                </div>
                                <div flex horizontal layout center-justified flex>{{ value.stats.refmaf || "." }}
                                </div>
                                <div flex horizontal layout center-justified flex>{{ value.stats.altmaf || "." }}
                                </div>
                                <div flex horizontal layout center-justified flex>{{ value.stats.maf || "." }}</div>
                            </div>
                        </td>
                    </template>

                    <jso-sortable-table-ajax id="jsoSortableTableAjax"
                                             role="datasource"
                                             url="{{url}}"
                                             start=0
                                             length=10
                                             parseFunction="{{parseFunction}}">
                    </jso-sortable-table-ajax>

                </sortable-table>
            </div>
            <div id="tools" flex>
                <paper-tabs selected="{{selectedTab}}" scrollable="true">
                    <paper-tab>Genomic Context</paper-tab>
                    <paper-tab>Effect & Annotation</paper-tab>
                    <paper-tab>Summary</paper-tab>
                </paper-tabs>

                <div id="tool" vertical layout flex>
                    <div hidden?="{{ selectedTab != 0}}" id="genomeViewer"></div>
                    <jso-variant-effect-grid hidden?="{{ selectedTab != 1}}"
                                             variant="{{ variantEffect }}"></jso-variant-effect-grid>
                    <div hidden?="{{ selectedTab != 2}}">SUMMARY</div>
                </div>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            parseFunction: null,
            species: 'Homo sapiens',
            jobItem: null,
            args: null,
            selectedTab: 1,
            variantEffect: null,
            ready: function () {
                var me = this;


                this.columns = [
                    {
                        name: 'variant',
                        title: "Variant",
                        formula: function (row) {
                            return row.chromosome + ":" + row.start;

                        }
                    },
                    {
                        name: 'alleles',
                        title: 'Alleles',
                        formula: function (row) {
                            return row.reference + ">" + row.alternate;
                        }
                    },
                    {name: 'snpId', title: 'SNP Id'},
                    {
                        name: 'samples',
                        title: 'Samples',
                        cellTemplate: 'samplesCellTemplate',
                        headerTemplate: 'samplesHeaderTemplate',
                        formula: function (row) {
                            return row.sourceEntries[me.studyId + "_" + me.fileId].samplesData;
                        }
                    },
                    {name: 'genes', title: 'Genes'},
                    {name: 'sift', title: 'SIFT'},
                    {
                        name: 'polyphen', title: 'POLYPHEN'
                    },
                    {
                        name: 'phenotype', title: 'Phenotype'
                    }
                    ,
                ];

                this.parseFunction = function (data) {

                    if (data.length == 0) {
                        return;
                    }

                    for (var i = 0; i < data.length; i++) {
                        var variant = data[i];
                        me._getEffect(variant);
                        me._getPolyphenSift(variant);
                    }

                    me._getPhenotypes(data);
                    me._getGenes(data);
                    me._getSNPId(data);

//                    for (var i = 0; i < data.length; i++) {
//                        var row = data[i];
//
//                        for (var key in row.sourceEntries) {
//
//                            var gt00 = entry.stats.genotypesCount["0/0"];
//                            if ("0|0" in entry.stats.genotypesCount) {
//                                if (gt00 != null) {
//                                    gt00 += entry.stats.genotypesCount["0|0"];
//                                } else {
//                                    gt00 = entry.stats.genotypesCount["0|0"];
//                                }
//                            }
//
//                            var gt01 = entry.stats.genotypesCount["0/1"];
//                            if ("0|1" in entry.stats.genotypesCount) {
//                                if (gt01 != null) {
//                                    gt01 += entry.stats.genotypesCount["0|1"];
//                                } else {
//                                    gt01 = entry.stats.genotypesCount["0|1"];
//                                }
//                            }
//                            var gt11 = entry.stats.genotypesCount["1/1"];
//                            if ("0|1" in entry.stats.genotypesCount) {
//                                if (gt11 != null) {
//                                    gt11 += entry.stats.genotypesCount["1|1"];
//                                } else {
//                                    gt11 = entry.stats.genotypesCount["1|1"];
//                                }
//                            }
//                        }
//                    }
                    return data;
                }
            }
            ,
            created: function () {
                this.selectedSpecies = DEFAULT_SPECIES;
                this.region = new Region();
                this.region.load("1:1004608-1004608");
            },
            observe: {
                '$.dataGrid.selected': "handleDataGridSelected",
                '$.dataGrid.data': "handleDataGridChanged"
            }
            ,
            samplesChanged: function (oldValue, newValue) {
                var me = this;
                this.args = {
                    samples: Object.keys(newValue)
                }
            }
            ,
            urlChanged: function (oldValue, newValue) {
                console.log("Form URL " + this.url);
            }
            ,
            selectedTabChanged: function (oldValue, newValue) {
                console.log(newValue);
            },
            handleDataGridChanged: function (oldValue, newValue) {
            },
            _getSNPId: function (records) {
                var speciesCode = Utils.getSpeciesCode(this.species);

                var regs = [];
                for (var i = 0; i < records.length; i++) {
                    var variant = records[i];
                    var chr = variant.chromosome;
                    regs.push(chr + ":" + variant.start + "-" + variant.end);
                }

                if (regs.length > 0) {
                    var query = regs.join(",");
                    CellBaseManager.get({
                        species: speciesCode,
                        category: 'genomic',
                        subCategory: 'region',
                        resource: 'snp',
                        query: query,
                        async: false,
                        params: {
                            include: 'id'
                        },
                        success: function (response) {
                            try {
                                var snpData = response.response;
                                for (var j = 0; j < snpData.length; j++) {
                                    var snpRow = snpData[j];
                                    if (snpRow.numResults > 0) {
                                        var snps = snpRow.result;
                                        var newSNPs = [];
                                        for (var k = 0; k < snps.length; k++) {
                                            var snp = snps[k];
                                            newSNPs.push(snp.id);
                                        }
                                        if (newSNPs.length > 0) {
                                            records[j].snpId = newSNPs.join(",");
                                        }
                                    }
                                }
                            } catch (e) {
                            }
                        }
                    });
                }
            },
            _getGenes: function (records) {
                var speciesCode = Utils.getSpeciesCode(this.species);

                var regs = [];
                for (var i = 0; i < records.length; i++) {
                    var variant = records[i];
                    var chr = variant.chromosome;
                    regs.push(chr + ":" + variant.start + "-" + ((variant.start == variant.end) ? (variant.start + 1) : variant.end));
                }

                if (regs.length > 0) {
                    var query = regs.join(",");
                    CellBaseManager.get({
                        species: speciesCode,
                        category: 'genomic',
                        subCategory: 'region',
                        resource: 'gene',
                        query: query,
                        async: false,
                        params: {
                            include: 'name'
                        },
                        success: function (response) {
                            try {
                                var genesData = response.response;
                                for (var j = 0; j < genesData.length; j++) {
                                    var geneRow = genesData[j];
                                    if (geneRow.numResults > 0) {
                                        var genes = geneRow.result;
                                        var newGenes = [];
                                        for (var k = 0; k < genes.length; k++) {
                                            var gene = genes[k];
                                            newGenes.push(gene.name);
                                        }
                                        if (newGenes.length > 0) {
                                            records[j].genes = newGenes.join(",");
                                        }
                                    }
                                }
                            } catch (e) {
                            }
                        }
                    });
                }
            },
            _getEffect: function (record) {
                var req = record.chromosome + ":" + record.start + ":" + record.reference + ":" + record.alternate;
                var url = "http://ws.bioinfo.cipf.es/cellbase/rest/latest/hsa/genomic/variant/" + req + "/consequence_type?of=json";
                console.log(url);

                $.ajax({
                    url: url,
                    dataType: 'json',
                    async: false,
                    success: function (response, textStatus, jqXHR) {
                        if (response) {
                            for (var j = 0; j < response.length; j++) {
                                var elem = response[j];

                                if (elem.aaPosition != -1 && elem.transcriptId != "" && elem.aminoacidChange.length >= 3 && record.transcriptId === undefined && record.aaPos === undefined && record.aaChange === undefined) {
                                    record.transcript = elem.transcriptId;
                                    record.aaPos = elem.aaPosition;
                                    record.aaChange = elem.aminoacidChange;
                                }
                            }
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('Error loading Effect');
                    }
                });
            },
            _getPolyphenSift: function (variant) {

                if (variant.aaPos != undefined && variant.aaPos >= 0) {
                    var change = variant.aaChange.split("/")[1];
                    var url = "http://ws-beta.bioinfo.cipf.es/cellbase/rest/v3/hsapiens/feature/transcript/" + variant.transcript + "/function_prediction?aaPosition=" + variant.aaPos + "&aaChange=" + change;
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        async: false,
                        success: function (response, textStatus, jqXHR) {
                            var res = response.response[0];
                            if (res.numResults > 0) {
                                if (res.result[0].aaPositions[variant.aaPos]) {
                                    res = res.result[0].aaPositions[variant.aaPos][change];
                                    if (res !== undefined) {
                                        if (res.ps != null) {
                                            variant.polyphen = res.ps
                                        }
                                        if (res.ss != null) {
                                            variant.sift = res.ss;
                                        }
                                    }
                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log('Error loading PolyPhen/SIFT');
                        }
                    });
                }
            },
            _getPhenotypes: function (records) {
                var regs = [];
                for (var i = 0; i < records.length; i++) {
                    var variant = records[i];
                    var chr = variant.chromosome;
                    regs.push(chr + ":" + variant.start + "-" + variant.end);
                }
                if (regs.length > 0) {
                    var url = "http://ws-beta.bioinfo.cipf.es/cellbase/rest/v3/hsapiens/genomic/region/" + regs.join(",") + "/phenotype?include=phenotype";
                    $.ajax({
                        url: url,
                        dataType: 'json',
                        async: false,
                        success: function (response, textStatus, jqXHR) {
                            if (response != undefined && response.response.length > 0 && response.response.length == records.length) {
                                for (var i = 0; i < response.response.length; i++) {
                                    var elem = response.response[i];
                                    var phenotypes = [];
                                    for (var k = 0; k < elem.numResults; k++) {
                                        phenotypes.push(elem.result[k].phenotype);
                                    }
                                    records[i].phenotype = phenotypes.join(",");
                                }
                            }
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log('Error loading Phenotypes');
                        }
                    });
                }
            },
            handleDataGridSelected: function (oldValue, newValue) {
                console.log(newValue);
                var reg = newValue.chromosome + ":" + newValue.start + "-" + newValue.end;
                var region = new Region(reg);
                this.genomeViewer.setRegion(region);

                // update Effect
                var variant = newValue.chromosome + ":" + newValue.start + ":" + newValue.reference + ":" + newValue.alternate;
                this.variantEffect = variant;

            },
            domReady: function () {
                this.createGenomeViewer();
                this.genomeViewer.draw();
                this.genomeViewer.toggleAutoHeight(true);
            }
            , createGenomeViewer: function () {
                this.genomeViewer = new GenomeViewer({
                    cellBaseHost: 'https://www.ebi.ac.uk/cellbase/webservices/rest',
                    cellBaseVersion: 'v3',
                    target: this.$.genomeViewer,
//                    width: 500,
                    width: this.$.dataGrid.getBoundingClientRect().width - 15,
                    region: this.region,
//                    version: this.version,
                    availableSpecies: AVAILABLE_SPECIES,
                    species: this.selectedSpecies,
                    sidePanel: false,
                    resizable: true,
                    resizable: false,
                    drawOverviewTrackListPanel: true,
//        quickSearchResultFn:quickSearchResultFn,
//        quickSearchDisplayKey:,
                    karyotypePanelConfig: {
                        hidden: true,
                        collapsed: false,
                        collapsible: true
                    },
                    chromosomePanelConfig: {
                        hidden: true,
                        collapsed: false,
                        collapsible: true
                    },
                    regionPanelConfig: {
                        hidden: false,
                        collapsed: false,
                        collapsible: true
                    },
                    drawStatusBar: true,
//            drawNavigationBar: false,
                    navigationBarConfig: {
                        componentsConfig: {
                            menuButton: false,
                            leftSideButton: false,
                            restoreDefaultRegionButton: false,
                            regionHistoryButton: false,
                            speciesButton: false,
                            chromosomesButton: false,
                            karyotypeButton: false,
                            chromosomeButton: false,

//                regionButton:false,
//                zoomControl:false,
//                windowSizeControl:false,
//                positionControl:false,
//                moveControl:false,
//                autoheightButton:false,
//                compactButton:false,
                            searchControl: false
                        }
                    }

//        chromosomeList:[]
//            trackListTitle: ''
//            drawNavigationBar = true;
//            drawKaryotypePanel: false,
//            drawChromosomePanel: false,
//            drawOverviewTrackListPanel: false

                });
                var renderer = new FeatureRenderer(FEATURE_TYPES.gene);
                renderer.on({
                    'feature:click': function (event) {
                        // feature click event example
                        console.log(event)
                    }
                });
                var gene = new FeatureTrack({
//        title: 'Gene overview',
                    minHistogramRegionSize: 20000000,
                    maxLabelRegionSize: 10000000,
                    height: 100,

                    renderer: renderer,

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "gene",
                        params: {
                            exclude: 'transcripts,chunkIds'
                        },
                        species: this.genomeViewer.species,
                        cacheConfig: {
                            defaultChunkSize: 100000
                        }
                    })
                });

                this.genomeViewer.addOverviewTrack(gene);


                this.sequence = new SequenceTrack({
                    height: 30,
                    visibleRegionSize: 200,

                    renderer: new SequenceRenderer(),

                    dataAdapter: new SequenceAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "sequence",
                        species: this.genomeViewer.species
                    })
                });

                this.genomeViewer.addTrack(this.sequence);

                this.gene = new GeneTrack({
                    title: 'Gene',
                    minHistogramRegionSize: 20000000,
                    maxLabelRegionSize: 10000000,
                    minTranscriptRegionSize: 200000,
                    height: 140,

                    renderer: new GeneRenderer({
                        handlers: {
                            'feature:click': function (e) {
                                console.log(e)
                            }
                        }
                    }),

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "gene",
                        species: this.genomeViewer.species,
                        params: {
                            exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence,chunkIds'
                        },
                        cacheConfig: {
                            defaultChunkSize: 100000
                        }
                    })
                });
                this.genomeViewer.addTrack(this.gene);
                this.snp = new FeatureTrack({
                    title: 'SNP',
                    featureType: 'SNP',
                    minHistogramRegionSize: 10000,
                    maxLabelRegionSize: 3000,
                    height: 100,

                    renderer: new FeatureRenderer(FEATURE_TYPES.snp),

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "snp",
                        params: {
                            exclude: 'transcriptVariations,xrefs,samples'
                        },
                        species: this.genomeViewer.species,
                        cacheConfig: {
                            defaultChunkSize: 10000
                        }
                    })
                });
                this.genomeViewer.addTrack(this.snp);
                return this.genomeViewer;
            }

        })
    </script>
</polymer-element>