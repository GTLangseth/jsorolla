<polymer-element name="jso-variant-effect-grid" attributes="variant">
    <template>
        <link rel="stylesheet" href="../jso-style.css">
        <link rel="stylesheet" href="../sortable-table.css">
        <style>
            :host {
                display: block;
                position: relative;
                background-color: white;
            }

            sortable-table {
            }

            sortable-table::shadow .column-pos {
                width: 100px;
            }

            sortable-table::shadow .column-snpId {
                width: 70px;
            }

            sortable-table::shadow .column-consequenceTypeObo {
                width: 160px;
            }

            sortable-table::shadow .column-aaChange {
                width: 160px;
            }

            sortable-table::shadow .column-gene {
                width: 190px;
            }

            sortable-table::shadow .column-transcriptId {
                width: 115px;
            }

        </style>
        <sortable-table class="bootstrap"
                        id="effectGrid"
                        footerTemplate="defaultPager"
                        pageSize="10"
                        columns="{{ columns }}"
                        loading="true"
                        data="{{data}}">

            <template id="consequenceTypeTemplate">
                <td>
                    <a href="http://www.sequenceontology.org/browser/current_svn/term/{{value}}" target="_blank">{{value}}</a>
                </td>
            </template>
            <template id="snpIdTemplate">
                <td>
                    <a href="http://www.ncbi.nlm.nih.gov/projects/SNP/snp_ref.cgi?searchType=adhoc_search&type=rs&rs={{value}}"
                       target="_blank">{{value}}</a>

                </td>
            </template>
            <template id="aaTemplate">
                <td>{{value.aminoacidChange} - {{value.codonChange}} ({{ value.aaPosiion}})</td>
            </template>
            <template id="geneTemplate">
                <td>{{value.geneName}} (<a href="http://www.ensembl.org/Homo_sapiens/Location/View?g={{value.geneId}}"
                                           target="_blank">{{value.geneId}}</a>)
                </td>
            </template>
            <template id="transcriptTemplate">
                <td>
                    <a href="http://www.ensembl.org/Homo_sapiens/Location/View?t={{value}}"
                       target="_blank">{{value}}</a>
                </td>
            </template>
        </sortable-table>

    </template>
    <script>
        Polymer({
            variant: null,
            columns: null,
            data: null,
            created: function () {
            },
            ready: function () {
                this.columns = [
                    {
                        name: 'pos',
                        title: "Position",
                        formula: function (row) {
                            var res = row.featureChromosome + ":" + row.position + ((row.featureStrand == 1) ? " (+)" : " (-)");
                            return res;
                        }
                    },
                    {
                        name: "snpId",
                        title: "SNP Id",
                        cellTemplate: 'snpIdTemplate'
                    },
                    {
                        name: "consequenceTypeObo",
                        title: "Consequence Type",
                        cellTemplate: 'consequenceTypeTemplate'
                    },
                    {
                        name: "aaChange",
                        title: "AminoacidChange",
                        cellTemplate: 'aaTemplate',
                        formula: function (row) {
                            return row;
                        }
                    },
                    {
                        name: "gene",
                        title: "Gene (EnsemblId)",
                        cellTemplate: 'geneTemplate',
                        formula: function (row) {
                            console.log(row.geneName);
                            return row;
                        }
                    },
                    {
                        name: "transcriptId",
                        title: "TranscriptId",
                        cellTemplate: 'transcriptTemplate'
                    },

                    {name: "featureId", title: "Feature Id"},
                    {name: "featureName", title: "Feature Name"},
                    {name: "featureType", title: "Feature Type"},
                    {name: "featureBiotype", title: "Feature Biotype"},
//                    {name: "polyphenScore", title: "Polyphen Score"},
//                    {name: "polyphenEfect", title: "Polyphen Efect"},
//                    {name: "siftScore", title: "Sift Score"},
//                    {name: "siftEffect", title: "Sift Effect"}
                ];
//                this.data = [];
            },
            variantChanged: function (oldValue, newValue) {

                var me = this;

                this.data = [];
                if (newValue != '') {

                    CellBaseManager.get({
                        species: 'hsa',
                        host: 'http://ws.bioinfo.cipf.es/cellbase/rest',
                        version: 'latest',
                        category: 'genomic',
                        subCategory: 'variant',
                        resource: 'consequence_type',
                        query: newValue,
                        async: false,
                        params: {
                            of: 'json'
                        },
                        success: function (response) {
                            try {
                                me.data = me._filterEffectData(response);
                            } catch (e) {

                            }
                        }
                    });
                }

            },
            _filterEffectData: function (data) {
                var _this = this;
                var res = [];

                var regulatory = {};

                for (var i = 0; i < data.length; i++) {
                    var elem = data[i];
                    if (elem.consequenceTypeObo == "coding_sequence_variant" || elem.consequenceTypeObo == "exon_variant" || elem.consequenceTypeObo == "intron_variant") {
                        continue;
                    } else if (elem.consequenceTypeObo == "regulatory_region_variant") {
                        if (!(elem.featureId in regulatory)) {
                            regulatory[elem.featureId] = elem;
                        }
                        continue;
                    }
                    res.push(elem);
                }

                for (var elem in regulatory) {
                    res.push(regulatory[elem]);
                }
                return res;
            }
        });
    </script>
</polymer-element>


