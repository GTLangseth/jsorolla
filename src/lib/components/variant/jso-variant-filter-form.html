<link rel="import" href="../cellbase/jso-cellbase-search-field.html">
<dom-module id="jso-variant-filter-form">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            width: 250px;
        }

        #filter_form {
            overflow-y: auto;
            height: 100%;
            margin: 0px;
        }

        .title {
            font-size: 22px;
            border-bottom: thin solid #edebe3;
            margin: 7px 5px;
        }

        #bar {
            padding: 0 3px 5px 3px;
        }

        #bar > .jso-btn {
            margin: 0px 2px;
        }

        .input_container {
            margin: 0px;
            width: 175px;
            right: auto;
            top: 0px;
            left: 5px;
            padding: 4px 6px 3px 20px;
        }

        .input_container label {
            padding-bottom: 5px;
            padding-left: 1px;
        }

        #headerTitle {
            background: #e4e7e9;
            font-size: 16px;
            line-height: 22px;
            margin: 10px;
            padding: 5px;
        }

        .segregation.sampleName {
            width: 70px;
        }

        input.segregation,
        .segregationValue {
            margin-left: 3px;
        }

        input#consequence_type {
            width: 30px;
        }

        #consequenceTypes {
            height: 250px;
            overflow-y: auto;
        }

        textarea {
            resize: none;
            width: 100%;
        }

        jso-tooltip::shadow #messageInfo::shadow {
            height: 300px;
            width: 500px;
            background-color: #e2e9e9;
            border: 1px solid #e2e9e9;
            color: black;
            font-style: normal;
        }

        jso-tooltip::shadow .closeInfo::shadow {
            margin-left: 490px;
        }

        #filterHistoryTable > div:hover {
            background-color: #8ba7a7;
            border: 1px solid #8ba7a7;
        }

        .tit {
            margin-top: 10px;
            border-bottom: 1px solid #445D76;
            font-weight: bold;
        }

        .name {
            width: 300px;
        }

        .num {
            width: 100px;
        }

        .clear-but {
            width: 100px;
            background-color: #f0f4f4 !important;
        }
    </style>
    <template>
        <div id="filter_form">
            <!--<div class="title">-->
            <!--Filters-->
            <!--</div>-->
            <div id="bar" class="horizontal layout center-justified">
                <jso-tooltip id="filterHistoryTooltip" class="jso-btn jso-btn-shdw" title="Filters History" icon="filter">
                    <div class="jso-btn jso-btn-shdw clear-but" title="Clear Filters History" on-click="clearFiltersHistory">
                        Clear
                    </div>
                    <div class="horizontal layout flex">
                        <span class="tit num"> Date </span>
                        <span class="name tit"> Name </span>
                        <span class="tit num"> Found</span>
                    </div>
                    <div id="filterHistoryTable">
                        <template is="dom-repeat" items="{{historyFilters}}">
                            <div class="horizontal layout flex" on-click="loadFilter" data-filter="{{item.filter}}" title="{{item.name}}">
                                <span class="num">{{item.date}} </span>
                                <span id="filter-name" class="name">{{item.name}} </span>
                                <span class="num">{{item.found}}</span>
                            </div>
                        </template>
                    </div>
                </jso-tooltip>
                <div class="jso-btn jso-btn-shdw flex" on-click="clearForm">Clear</div>
                <div class="jso-btn jso-btn-shdw flex" on-click="submitForm">Search</div>
            </div>
            <div class="jso-formbox">
                <div class="jso-formtitle">
                    Segregation
                </div>
                <div class="jso-formcontent">
                    <div id="segregationHeader" class="horizontal layout">
                        <div class="segregation sampleName"></div>
                        <div class="segregation segregationValue flex">0/0</div>
                        <div class="segregation segregationValue flex">0/1</div>
                        <div class="segregation segregationValue flex">1/1</div>
                        <div class="segregation segregationValue flex">. / .</div>
                    </div>
                    <div id="segregation" class="vertical layout">
                        <template is="dom-repeat" items="{{samples}}">
                            <div class="horizontal layout">
                                <div class="segregation sampleName">{{item.name}}</div>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="0/0,0|0">
                                    <span></span>
                                </label>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="0/1,0|1,1/0,1|0">
                                    <span></span>
                                </label>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="1/1,1|1">
                                    <span></span>
                                </label>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item.name}}" value="-1/-1,-1|-1">
                                    <span></span>
                                </label>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div class="jso-formbox">
                <div class="jso-formtitle">
                    Position
                </div>
                <div class="jso-formcontent">
                    <label class="jso">Chromosomal location:</label>
                    <textarea class="jso" id="region" name="region" placeholder="1:1-1000000,2:1-1000000" value="{{regionValue::change}}" rows="3" required>
                    </textarea>

                    <label class="jso">Gene:</label>
                    <textarea class="jso" id="gene" name="gene" placeholder="BRCA2,PPL" value="{{geneValue::change}}" rows="3" required>
                    </textarea>

                    <!--<jso-cellbase-search-field style="margin-top:5px;" placeholder="Search gene"-->
                    <!--on-featureselected="handleFeatureSelected"></jso-cellbase-search-field>-->

                    <!--<label class="jso" style="margin-top:5px;">Bed File</label>-->

                    <!--<div class="jso-btn jso-btn-shdw" on-click="handleBrowseClick">{{fileName}}</div>-->
                    <!--<input type="file" hidden id="fileInput" on-change="handleInputChange">-->

                </div>
            </div>

            <div class="jso-formbox">
                <div class="jso-formtitle">
                    SNPId
                </div>
                <div id="type_op" class="jso-formcontent">
                    <label class="jso">SNPId:</label>
                    <textarea class="jso" id="snpId" name="snpId" placeholder="rs9988179,rs140361978" value="{{snpIdValue::change}}" rows="3" required>
                    </textarea>
                </div>
            </div>

            <div class="jso-formbox">
                <div class="jso-formtitle">
                    Type
                </div>
                <div id="type_op" class="jso-formcontent">
                    <div style="margin-left:5px" class="horizontal layout">
                        <label class="jso-control">
                            <input value="SNV" type="checkbox">
                            <span>SNV</span>
                        </label>
                        <label class="jso-control" style="margin-left:14px">
                            <input value="MNV" type="checkbox">
                            <span>MNV</span>
                        </label>
                    </div>
                    <div style="margin-left:5px" class="horizontal layout">
                        <label class="jso-control">
                            <input value="INDEL" type="checkbox">
                            <span>INDEL</span>
                        </label>
                        <label class="jso-control" style="margin-left:2px">
                            <input value="SV" type="checkbox">
                            <span>SV</span>
                        </label>
                    </div>
                    <div style="margin-left:5px" class="horizontal layout">
                        <label class="jso-control">
                            <input value="CNV" type="checkbox">
                            <span>CNV</span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="jso-formbox">
                <div class="jso-formtitle">
                    Population Freqs.
                </div>
                <div class="jso-formcontent vertical layout">

                    <label class="jso" style="font-weight: bold">ESP 6500</label>

                    <div class="">
                        <label class="jso">European american MAF</label>
                        <input id="esp6500_eur_amer" type="text" />
                    </div>
                    <div class="">
                        <label class="jso">African american MAF</label>
                        <input id="esp6500_afr_amer" type="text" />
                    </div>

                    <br>
                    <label class="jso" style="font-weight: bold">1000 Genomes population phase 1</label>
                    <div class="">
                        <label class="jso">All populations MAF</label>
                        <input id="1000GENOMES_all" type="text" />
                    </div>
                    <div class="">
                        <label class="jso">African MAF</label>
                        <input id="1000GENOMES_afr" type="text" />
                    </div>
                    <div class="">
                        <label class="jso">American MAF</label>
                        <input id="1000GENOMES_amr" type="text" />
                    </div>
                    <div class="">
                        <label class="jso">Asian MAF</label>
                        <input id="1000GENOMES_asn" type="text" />
                    </div>
                    <div class="">
                        <label class="jso">European MAF</label>
                        <input id="1000GENOMES_eur" type="text" />
                    </div>
                </div>
            </div>

            <div class="jso-formbox">

                <div class="jso-formtitle">
                    Protein Substitution Scores
                </div>

                <div class="jso-formcontent vertical layout">

                    <label class="jso">SIFT</label>

                    <div>
                        <select name="sift_op" id="sift_op">
                            <!-- <option value="==">==</option>
                            <option value="!=">!=</option> -->
                            <option value="<" selected>
                                <</option>
                                    <option value="<=">
                                        <=</option>
                                            <option value=">">></option>
                                            <option value=">=">>=</option>
                        </select>
                        <input type="text" id="sift" name="sift" />

                        <label class="jso">Polyphen</label>
                    </div>
                    <div>
                        <select name="polyphen_op" id="polyphen_op">
                            <!-- <option value="==">==</option>
                            <option value="!=">!=</option> -->
                            <option value="<" selected>
                                <</option>
                                    <option value="<=">
                                        <=</option>
                                            <option value=">">></option>
                                            <option value=">=">>=</option>
                        </select>
                        <input type="text" id="polyphen" name="polyphen" />
                    </div>
                </div>
            </div>
        </div>

        <div class="jso-formbox">
            <div class="jso-formtitle">
                Conservation
            </div>
            <div class="jso-formcontent vertical layout">

                <div>
                    <label class="jso">PhyloP</label>

                    <div>
                        <select name="phylop_op" id="phylop_op">
                            <!-- <option value="==">==</option>
                            <option value="!=">!=</option> -->
                            <option value="<" selected>
                                <</option>
                                    <option value="<=">
                                        <=</option>
                                            <option value=">">></option>
                                            <option value=">=">>=</option>
                        </select>
                        <input type="text" id="phylop" name="phylop" flex/>
                    </div>
                </div>

                <div>
                    <label class="jso">PhastCons</label>
                    <div>
                        <select name="phastcons_op" id="phastcons_op">
                            <!-- <option value="==">==</option>
                            <option value="!=">!=</option> -->
                            <option value="<" selected>
                                <</option>
                                    <option value="<=">
                                        <=</option>
                                            <option value=">">></option>
                                            <option value=">=">>=</option>
                        </select>
                        <input type="text" id="phastcons" name="phastcons" flex/>
                    </div>
                </div>
            </div>
        </div>


        <div class="jso-formbox">
            <div class="jso-formtitle">
                Consequence Type
            </div>
            <div id="consequenceTypes" class="jso-formcontent">
                <template is="dom-repeat" items="{{consequenceTypes}}">
                    <label class="jso-control">
                        <input value="{{item.value}}" data-name$="{{item.name}}" type="checkbox" name="consequence_type">
                        <span>{{item.name}}</span>
                    </label>
                </template>
                <div class="input_container vertical layout">
                </div>
            </div>


        </div>


        <!-- OLD COMMENTED -->

        <!--<div class="form_block positionBlock">-->
        <!--<div id="headerTitle">Position</div>-->
        <!--<div class="input_container" vertical layout>-->
        <!--<label class="input_label">Chromosomal Location</label>-->
        <!--<textarea id="region" name="region" placeholder="1:1-1000000,2:1-1000000"-->
        <!--value="{{ regionValue }}" rows="3"-->
        <!--required?="{{ (regionValue == '') }}">-->
        <!--</textarea>-->
        <!--</div>-->
        <!--&lt;!&ndash;<div class="input_container" vertical layout>&ndash;&gt;-->
        <!--&lt;!&ndash;<label class="input_label">SNP id</label>&ndash;&gt;-->
        <!--&lt;!&ndash;<textarea id="region" name="region" value="{{ regionValue }}" rows="3"&ndash;&gt;-->
        <!--&lt;!&ndash;required?="{{ (regionValue == '') }}">&ndash;&gt;-->
        <!--&lt;!&ndash;</textarea>&ndash;&gt;-->
        <!--&lt;!&ndash;</div>&ndash;&gt;-->
        <!--<div class="input_container" vertical layout>-->
        <!--<label class="input_label">Gene</label>-->
        <!--<textarea id="gene" name="gene" placeholder="BRCA2,PPL"-->
        <!--value="{{ geneValue }}" rows="3"-->
        <!--required?="{{ (geneValue == '') }}"></textarea>-->

        <!--<div horizontal layout class="searchGene" end-justified>-->
        <!--<input id="searchField" list="searchDataList" placeholder="Search gene" type="text"-->
        <!--style="width: 90px;">-->
        <!--<datalist id="searchDataList"></datalist>-->
        <!--<div id="quickSearchButton" class="button" style="border-left: none;">-->
        <!--<font-awesome icon="search"></font-awesome>-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <!--<div class="input_container" vertical layout>-->
        <!--<label class="input_label">Bed File</label>-->

        <!--<div class="button action filetext" on-click="{{handleBrowseClick}}">{{fileName}}</div>-->
        <!--<input type="file" hidden id="fileInput" on-change="{{handleInputChange}}">-->
        <!--</div>-->
        <!--</div>-->

        <!--<div class="form_block">-->
        <!--<div id="headerTitle">Consequence Type</div>-->
        <!--<div id="consequenceTypes" class="input_container" vertical layout>-->
        <!--</div>-->
        <!--</div>-->

        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "jso-variant-filter-form",
        properties: {
            //            geneValue: null,
            //            snpValue: '',
            //            floatDecimals: 3,
            //            expanded: false,
            //            parseFunction: null,
            url: {
                type: String,
                notify: true,
                value: ''
            },
            file: {
                type: Object,
                observer: 'fileChanged'
            },
            study: {
                type: Object,
                value: function() {
                    return {};
                }
            },
            samples: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                }
            },
            samplesView: {
                type: Array,
                notify: true,
                value: function() {
                    return []
                }
            },
            regionValue: {
                type: String,
                notify: true,
                value: ''
            },
            geneValue: {
                type: String,
                notify: true,
                value: ''
            },
            snpIdValue: {
                type: String,
                notify: true,
                value: ''
            },
            fileName: {
                type: String,
                notify: true,
                value: 'Choose file...'
            },
            consequenceTypes: {
                type: Array,
                value: function() {
                    return CONSEQUENCE_TYPES;
                }
            },
            historyFilters: {
                type: Array,
                value: function() {
                    return [];
                },
            },
            hash: {
                type: Object,
                value: function() {
                    return {};
                },
            },
            fileId: {
                type: Number,
                value: 0
            },
            numTotalResults: {
                type: Object,
                observer: "resultsChanged"
            }
        },
        ready: function() {
            if (localStorage.bioinfo_bierApp_filter_history) {
                this.hash = JSON.parse(localStorage.bioinfo_bierApp_filter_history);
                if (Array.isArray(this.hash)) {
                    localStorage.bioinfo_bierApp_filter_history = "";
                    this.hash = {};
                }
            }
        },

        fileChanged: function(neo, old) {
            if (neo) {
                this.historyFilters = JSON.parse(localStorage.bioinfo_bierApp_filter_history)[neo.id];
                this.set('fileId', neo.id);
                this.clearForm();
            }
        },

        resultsChanged: function(neo, old) {
        },

        handleFeatureSelected: function(e) {
            var item = e.detail;
            if (item) {
                var values = this.$.gene.value.split(',').filter(function(el) {
                    return el.length != 0
                });
                values.push(item.name);
                values = values.filter(function(item, index, inputArray) {
                    return inputArray.indexOf(item) == index;
                });
                this.$.gene.value = values.join(",");
            }
        },
        clearForm: function() {
            /* samples */
            for (var i = 0; i < this.samples.length; i++) {
                var sampleName = this.samples[i].name;
                var els = this.$.segregation.querySelectorAll("input[name='" + sampleName + "']:checked");
                for (var j = 0; j < els.length; j++) {
                    var el = els[j];
                    el.checked = false;
                }
            }

            // Region
            this.$.region.value = "";

            // Gen
            this.$.gene.value = "";

            // SNPId
            this.$.snpId.value = "";

            // Type
            var types = this.$.type_op.querySelectorAll("input:checked");
            for (var i = 0; i < types.length; i++) {
                var type = types[i];
                type.checked = false;
            }

            // Freqs
            this.$.esp6500_eur_amer.value = "";
            this.$.esp6500_afr_amer.value = "";
            this.$["1000GENOMES_all"].value = "";
            this.$["1000GENOMES_afr"].value = "";
            this.$["1000GENOMES_amr"].value = "";
            this.$["1000GENOMES_asn"].value = "";
            this.$["1000GENOMES_eur"].value = "";

            // Sift
            this.$.sift.value = "";
            this.$.sift_op.value = "<";
            // Polyphen
            this.$.polyphen.value = "";
            this.$.polyphen_op.value = "<";
            // Phylop
            this.$.phylop.value = "";
            this.$.phylop_op.value = "<";
            // Phastcons
            this.$.phastcons.value = "";
            this.$.phastcons_op.value = "<";

            /* Consequence Types */
            var els = this.$.consequenceTypes.querySelectorAll("input[name='consequence_type']:checked");
            for (var i = 0; i < els.length; i++) {
                var el = els[i];
                el.checked = false;
            }
            // var els = this.$.consequenceTypes.querySelectorAll("textarea");

        },
        submitForm: function() {
            var query = {};
            var regions = [];
            // Region
            if (this.regionValue) {
                regions = this.regionValue.split(",");
            }
            var regionQuery = regions.join(",");
            query["region"] = regionQuery;

            // SNPId
            var ids = [];
            if (this.snpIdValue) {
                ids = this.snpIdValue.split(",");
            }
            var idsQuery = ids.join(",");
            query["ids"] = idsQuery;

            // Genes
            if (this.geneValue) {
                var gene = this.geneValue.toUpperCase();
                CellBaseManager.get({
                    species: 'hsapiens',
                    category: 'feature',
                    subCategory: 'gene',
                    query: gene,
                    resource: "info",
                    async: false,
                    params: {
                        include: 'chromosome,start,end'
                    },
                    success: function(data) {
                        for (var i = 0; i < data.response.length; i++) {
                            var queryResult = data.response[i];
                            var region = new Region(queryResult.result[0]);
                            regions.push(region.toString());
                        }
                    }
                });
            }
            var geneQuery = this.geneValue.toUpperCase();
            if (geneQuery != '') {
                query["gene"] = geneQuery;
            }

            // // Genotypes

            var genotypes = [];
            //
            for (var i = 0; i < this.samples.length; i++) {
                var sampleName = this.samples[i].name;
                var els = this.$.segregation.querySelectorAll("input[name='" + sampleName + "']:checked");

                var gtValues = [];
                for (var j = 0; j < els.length; j++) {
                    var el = els[j];
                    gtValues.push(el.value);
                }
                if (gtValues.length > 0) {
                    var aux = sampleName + ":" + gtValues.join(",");
                    genotypes.push(aux);
                }
            }

            if (genotypes.length > 0) {
                query.genotype = genotypes.join(";").replace(new RegExp("\/", "gi"), "%2f");
            }

            // Consequence Types
            var cts = [];
            var els = this.$.consequenceTypes.querySelectorAll("input[name='consequence_type']:checked");
            for (var i = 0; i < els.length; i++) {
                var ctInput = els[i];
                cts.push(ctInput.value);
            }
            if (cts.length > 0) {
                query["annot-ct"] = cts.join(",");
            }

            // Protein Substitution Scores
            var sift = parseFloat(this.$.sift.value);
            if (sift) {
                sift = this.$.sift_op.value + sift;
                query["sift"] = sift;
            }

            var polyphen = parseFloat(this.$.polyphen.value);
            if (polyphen) {
                polyphen = this.$.polyphen_op.value + polyphen;
                query["polyphen"] = polyphen;
            }

            var phylop = parseFloat(this.$.phylop.value);
            var phastcons = parseFloat(this.$.phastcons.value);
            if (phylop || phastcons) {
                var conservation = [];
                if (phastcons) {
                    conservation.push("phastCons" + this.$.phastcons_op.value + phastcons);
                }
                if (phylop) {
                    conservation.push("phylop" + this.$.phylop_op.value + phylop);
                }
                query["conservation"] = conservation.join(",");
            }

            // Type
            var types = this.$.type_op.querySelectorAll("input:checked");
            var typesAux = [];
            if (types != "") {
                for (var i = 0; i < types.length; i++) {
                    typesAux.push(types[i].value);
                }
                query["type"] = typesAux;
            }

            // Samples
            var sampleNames = [];
            for (var i = 0; i < this.samples.length; i++) {
                var sample = this.samples[i];
                sampleNames.push(sample.name);

            }

            var sampleQuery = sampleNames.join(",");
            query.returnedSamples = sampleQuery;

            console.log(query);
            this.search(query);
            // this.clearForm();

            /* Filter History */
            var me=this;
            setTimeout(function() {
                var filterHistory = [];
                if (me.fileId in me.hash) {
                    filterHistory = me.hash[me.fileId];
                }
                me.set("historyFilters", filterHistory);

                var newFilter = JSON.stringify(query);
                var _load = -1;
                for (var i = 0; i < me.historyFilters.length && _load == -1; i++) { // Check if the fitler has been selected from the history
                    var elem = me.historyFilters[i];
                    if (elem != null) {
                        var oldFilter = JSON.stringify(me.historyFilters[i].filter);
                        if (newFilter == oldFilter) {
                            _load = i;
                        }
                    }
                }

                if (_load == -1) { // This filter is new (has not been selected from the history)
                    if (query.segregation != null || query.region != "" || query.gene != null || query.ids != "" || query.type != null || query.sift != null || query.polyphen != null || query.conservation != null || query["annot-ct"] != null) {
                        var dateAux = new Date();
                        var minAux = dateAux.getMinutes();
                        if (minAux < 10) {
                            minAux = "0" + minAux;
                        }
                        var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;
                        name = me.loadForm(query);
                        var found = me.numTotalResults;
                        var hf = {};
                        hf = {
                            date: date,
                            name: name,
                            filter: query,
                            found: found
                        };

                        var filters = new FilterHistory(5, filterHistory);
                        filters.unshift(hf);
                        me.set("historyFilters", filters);
                        me.hash[me.fileId] = me.historyFilters;

                        localStorage.bioinfo_bierApp_filter_history = JSON.stringify(me.hash);
                    }
                } else { // HistoryFilter contains this filter. We need to change the date and push to top
                    var pos = _load;

                    var filters = new FilterHistory(5, me.historyFilters);
                    var filter = filters[pos];
                    var dateAux = new Date();
                    var minAux = dateAux.getMinutes();
                    if (minAux < 10) {
                        minAux = "0" + minAux;
                    }
                    var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;

                    filter.date = date;

                    var aux = filters[pos];
                    filters[pos] = filters[0];
                    filters[0] = aux;

                    me.set("historyFilters", filters);
                    me.hash[this.fileId] = me.historyFilters;

                    localStorage.bioinfo_bierApp_filter_history = JSON.stringify(me.hash);

                }
            }, 100);
        },

        search: function(query) {
            query.sid = Cookies("bioinfo_sid");
            query.skipCount = false;
            query.sort = true;
            //TODO fsalavert: fix
            //            query.sessionId = Cookies("bioinfo_sid");
            var url = OpencgaManager.studies.variants({
                id: this.study.id,
                query: query,
                request: {
                    url: true
                }
            });

            this.url = url;
            console.log(url);

        },
        handleBrowseClick: function(e) {
            this.$.fileInput.click();

        },
        handleInputChange: function(e) {
            var me = this;
            var inputFile = this.$.fileInput.files[0];
            this.fileName = inputFile.name;

            var bedRegions = [];

            if (this.regionValue) {
                bedRegions = this.regionValue.split(",");
            }

            if (inputFile != null) {

                var reader = new FileReader();

                reader.onload = function(e) {
                    var data = e.target.result;
                    var lines = data.split("\n");
                    for (var i = 0; i < lines.length; i++) {
                        var line = lines[i];
                        if (line.indexOf("#") < 0 && line != '') {
                            var fields = line.split("\t");
                            var chr = fields[0];
                            var start = parseInt(fields[1]);
                            var end = parseInt(fields[2]);

                            if (start <= end) {
                                var r = chr + ":" + start + "-" + end;
                                bedRegions.push(r);
                            }
                        }
                    }

                    me.regionValue = bedRegions.join(",");
                    inputFile = null;
                    me.fileName = "Choose file...";

                };
                reader.readAsText(inputFile);

            }
        },
        loadForm: function(hf) {
            var filterName = [];

            // Samples
            if (hf.genotype != "" && hf.genotype != null) {
                var gtName = {};
                var sample_op = this.$.segregation.querySelectorAll("input");
                var gts = hf.genotype.split(";");
                for (var i = 0; i < gts.length; i++) {
                    var gt = gts[i].split(":");
                    var sampleName = gt[0];
                    var sample = gt[1].split(",");
                    for (var j = 0; j < sample_op.length; j++) {
                        if (sample_op[j].name.search(sampleName) >= 0) {
                            for (var k = 1; k < sample.length; k++) {
                                if (sample_op[j].value.indexOf(sample[k]) >= 0) {
                                    sample_op[j].checked = true;
                                    if (gtName[sampleName] == null) {
                                        gtName[sampleName] = [];
                                    }
                                    gtName[sampleName].push(sample[k]);
                                }
                            }
                        }
                    }
                }
                filterName.push("Genotype: " + JSON.stringify(gtName) + ") ");
            }

            // Region
            if (hf.region != "" && hf.region != null) {
                this.$.region.value = hf.region;
                filterName.push("Chromosomal Location: (" + hf.region + ") ");
            }

            // Genes
            if (hf.gene != "" && hf.gene != null) {
                this.$.gene.value = hf.gene;
                filterName.push("Genes: (" + hf.gene + ") ");
            }

            // SNPId
            if (hf.ids != "" && hf.ids != null) {
                this.$.snpId.value = hf.ids;
                filterName.push("SNPId: (" + hf.ids + ") ");
            }

            // Types
            if (hf.type != "" && hf.type != null) {
                var type_op = this.$.type_op.querySelectorAll("input");
                for (var i = 0; i < hf.type.length; i++) {
                    var type = hf.type[i];
                    for (var j = 0; j < type_op.length; j++) {
                        if (type_op[j].value.search(type) >= 0) {
                            type_op[j].checked = true;
                        }
                    }
                }
                filterName.push("Type: " + hf.type.join(",") + " ");
            }

            // Sift
            if (hf.sift != "" && hf.sift != null) {
                this.$.sift.value = "";
                var aux = hf.sift.split();
                this.$.sift_op.value = aux[0];
                for (var i = 1; i < aux.length; i++) {
                    this.$.sift.value += aux[i];
                }
                filterName.push("Sift" + hf.sift + " ");
            }
            // Polyphen
            if (hf.polyphen != "" && hf.polyphen != null) {
                this.$.polyphen.value = "";
                var aux = hf.polyphen.split();
                this.$.polyphen_op.value = aux[0];
                for (var i = 1; i < aux.length; i++) {
                    this.$.polyphen.value += aux[i];
                }
                filterName.push("Polyphen" + hf.polyphen + " ");
            }
            // Phylop y Phastcons
            if (hf.conservation != "" && hf.conservation != null) {
                this.$.phylop.value = "";
                this.$.phastcons.value = "";
                var aux = hf.conservation.split(",");
                if (aux[0].search("phastCons") >= 0) {
                    var p = aux[0].split("");
                    this.$.phastcons_op.value = p[9];
                    for (var i = 10; i < p.length; i++) {
                        this.$.phastcons.value += p[i];
                    }
                    if (aux[1]) {
                        var p = aux[1].split("");
                        this.$.phylop_op.value = p[6];
                        for (var i = 7; i < p.length; i++) {
                            this.$.phylop.value += p[i];
                        }
                    }
                }
                if (aux[0].search("phylop") >= 0) {
                    var p = aux[0].split("");
                    this.$.phylop_op.value = p[6];
                    for (var i = 7; i < p.length; i++) {
                        this.$.phylop.value += p[i];
                    }
                }
                filterName.push(aux[0] + " AND " + aux[1] + " ");
            }

            // Consequence Types
            if (hf["annot-ct"] != "" && hf["annot-ct"] != null) {
                var ctName = [];
                var cts = hf["annot-ct"].split(",");
                var ct_op = this.$.consequenceTypes.querySelectorAll("input[name='consequence_type']");
                for (var i = 0; i < cts.length; i++) {
                    var ct = cts[i];
                    for (var j = 0; j < ct_op.length; j++) {
                        if (ct_op[j].value.search(ct) >= 0) {
                            ct_op[j].checked = true;
                            ctName.push(ct_op[j].dataset.name);
                        }
                    }
                }
                filterName.push("Consequence Types: " + ctName.join(",") + " ");
            }

            return filterName.join(" AND ");
        },
        loadFilter: function(e) {
            e.stopPropagation();
            this.clearForm();
            this.loadForm(e.currentTarget.dataFilter);
            this.$.filterHistoryTooltip.handleClose(e);
            this.submitForm();

        },
        clearFiltersHistory: function(e) {
            e.stopPropagation();
            this.historyFilters = [];
            delete(this.hash[this.fileId]);
            localStorage.bioinfo_bierApp_filter_history = JSON.stringify(this.hash);

        }
    });
</script>
