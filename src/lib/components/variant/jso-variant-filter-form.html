<link rel="import" href="../cellbase/jso-cellbase-search-field.html">
<dom-module id="jso-variant-filter-form">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            width: 250px;
        }

        #filter_form {
            overflow-y: auto;
            height: 100%;
            margin: 0px;
        }

        .title {
            font-size: 22px;
            border-bottom: thin solid #edebe3;
            margin: 7px 5px;
        }

        #bar {
            padding: 0 3px 5px 3px;
        }

        #bar > .jso-btn {
            margin: 0px 2px;
        }

        .input_container {
            margin: 0px;
            width: 175px;
            right: auto;
            top: 0px;
            left: 5px;
            padding: 4px 6px 3px 20px;
        }

        .input_container label {
            padding-bottom: 5px;
            padding-left: 1px;
        }

        #headerTitle {
            background: #e4e7e9;
            font-size: 16px;
            line-height: 22px;

            margin: 10px;
            padding: 5px;
        }

        .segregation.sampleName {
            width: 70px;
        }

        input.segregation, .segregationValue {
            margin-left: 3px;
        }

        input#consequence_type {
            width: 30px;
        }

        #consequenceTypes {
            height: 250px;
            overflow-y: auto;
        }

        textarea {
            resize: none;
            width: 100%;
        }

    </style>
    <template>
        <div id="filter_form">
            <!--<div class="title">-->
            <!--Filters-->
            <!--</div>-->
            <div id="bar" class="horizontal layout center-justified">
                <div class="jso-btn jso-btn-shdw flex" on-click="clearForm">Clear</div>
                <div class="jso-btn jso-btn-shdw flex" on-click="submitForm">Search</div>
            </div>
            <div class="jso-formbox">
                <div class="jso-formtitle">
                    Segregation
                </div>
                <div class="jso-formcontent">
                    <div id="segregationHeader" class="horizontal layout">
                        <div class="segregation sampleName"></div>
                        <div class="segregation segregationValue flex">0/0</div>
                        <div class="segregation segregationValue flex">0/1</div>
                        <div class="segregation segregationValue flex">1/1</div>
                        <div class="segregation segregationValue flex">. / .</div>
                    </div>
                    <div id="segregation" class="vertical layout">
                        <template is="x-repeat" items="{{samples}}">
                            <div class="horizontal layout">
                                <div class="segregation sampleName">{{item}}</div>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item}}" value="0/0,0|0">
                                    <span></span>
                                </label>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item}}" value="0/1,0|1,1/0,1|0">
                                    <span></span>
                                </label>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item}}" value="1/1,1|1">
                                    <span></span>
                                </label>
                                <label class="jso-control flex">
                                    <input type="checkbox" name="{{item}}" value="-1/-1,-1|-1">
                                    <span></span>
                                </label>
                            </div>
                        </template>
                    </div>
                </div>
            </div>


            <!--<div class="jso-formbox">-->
            <!--<div class="jso-formtitle">-->
            <!--MAF-->
            <!--</div>-->
            <!--<div class="jso-formcontent">-->
            <!--</div>-->
            <!--</div>-->

            <div class="jso-formbox">
                <div class="jso-formtitle">
                    Position
                </div>
                <div class="jso-formcontent">
                    <label class="jso">Chromosomal location:</label>
                    <textarea class="jso" id="region" name="region" placeholder="1:1-1000000,2:1-1000000"
                              value="{{regionValue::change}}" rows="3" required>
                    </textarea>

                    <label class="jso">Gene:</label>
                    <textarea class="jso" id="gene" name="gene" placeholder="BRCA2,PPL"
                              value="{{geneValue::change}}" rows="3" required>
                    </textarea>


                    <jso-cellbase-search-field style="margin-top:5px;" placeholder="Search gene"
                                               on-featureselected="handleFeatureSelected"></jso-cellbase-search-field>

                    <label class="jso" style="margin-top:5px;">Bed File</label>

                    <div class="jso-btn jso-btn-shdw" on-click="handleBrowseClick">{{fileName}}</div>
                    <input type="file" hidden id="fileInput" on-change="handleInputChange">

                </div>


            </div>


            <div class="jso-formbox">
                <div class="jso-formtitle">
                    Consequence Type
                </div>
                <div id="consequenceTypes" class="jso-formcontent">
                    <template is="x-repeat" items="{{consequenceTypes}}">
                        <label class="jso-control">
                            <input value="{{item.value}}" type="checkbox" name="consequence_type">
                            <span>{{item.name}}</span>
                        </label>
                    </template>
                    <div class="input_container vertical layout">
                    </div>
                </div>


            </div>


            <!-- OLD COMMENTED -->

            <!--<div class="form_block positionBlock">-->
            <!--<div id="headerTitle">Position</div>-->
            <!--<div class="input_container" vertical layout>-->
            <!--<label class="input_label">Chromosomal Location</label>-->
            <!--<textarea id="region" name="region" placeholder="1:1-1000000,2:1-1000000"-->
            <!--value="{{ regionValue }}" rows="3"-->
            <!--required?="{{ (regionValue == '') }}">-->
            <!--</textarea>-->
            <!--</div>-->
            <!--&lt;!&ndash;<div class="input_container" vertical layout>&ndash;&gt;-->
            <!--&lt;!&ndash;<label class="input_label">SNP id</label>&ndash;&gt;-->
            <!--&lt;!&ndash;<textarea id="region" name="region" value="{{ regionValue }}" rows="3"&ndash;&gt;-->
            <!--&lt;!&ndash;required?="{{ (regionValue == '') }}">&ndash;&gt;-->
            <!--&lt;!&ndash;</textarea>&ndash;&gt;-->
            <!--&lt;!&ndash;</div>&ndash;&gt;-->
            <!--<div class="input_container" vertical layout>-->
            <!--<label class="input_label">Gene</label>-->
            <!--<textarea id="gene" name="gene" placeholder="BRCA2,PPL"-->
            <!--value="{{ geneValue }}" rows="3"-->
            <!--required?="{{ (geneValue == '') }}"></textarea>-->

            <!--<div horizontal layout class="searchGene" end-justified>-->
            <!--<input id="searchField" list="searchDataList" placeholder="Search gene" type="text"-->
            <!--style="width: 90px;">-->
            <!--<datalist id="searchDataList"></datalist>-->
            <!--<div id="quickSearchButton" class="button" style="border-left: none;">-->
            <!--<font-awesome icon="search"></font-awesome>-->
            <!--</div>-->
            <!--</div>-->
            <!--</div>-->
            <!--<div class="input_container" vertical layout>-->
            <!--<label class="input_label">Bed File</label>-->

            <!--<div class="button action filetext" on-click="{{handleBrowseClick}}">{{fileName}}</div>-->
            <!--<input type="file" hidden id="fileInput" on-change="{{handleInputChange}}">-->
            <!--</div>-->
            <!--</div>-->

            <!--<div class="form_block">-->
            <!--<div id="headerTitle">Consequence Type</div>-->
            <!--<div id="consequenceTypes" class="input_container" vertical layout>-->
            <!--</div>-->
            <!--</div>-->

        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: "jso-variant-filter-form",
        properties: {
//            geneValue: null,
//            snpValue: '',
//            floatDecimals: 3,
//            expanded: false,
//            parseFunction: null,
            url: {
                type: String,
                notify: true,
                value: ''
            },
            file: {
                type: Object,
                observer: 'fileChanged'
            },
            samples: {
                type: Array,
                notify: true,
                observe: 'samplesChanged',
                value: function () {
                    return [];
                }
            },
            samplesPosition: {
                type: Array,
                value: function () {
                    return {};
                }
            },
            regionValue: {
                type: String,
                notify: true,
                value: ''
            },
            geneValue: {
                type: String,
                notify: true,
                value: ''
            },
            fileName: {
                type: String,
                notify: true,
                value: 'Choose file...'
            },
            consequenceTypes: {
                type: Array,
                value: function () {
                    return CONSEQUENCE_TYPES;
                }
            }
        },
        fileChanged: function (neo, old) {
            if (neo) {
                this.samples = this.file.attributes.variantSource.samples;
                this.samplesPosition = this.file.attributes.variantSource.samplesPosition;
//                this.clearForm();
//                this.submitForm();
            }
        },
        handleFeatureSelected: function (e) {
            var item = e.detail;
            if (item) {
                var values = this.$.gene.value.split(',').filter(function (el) {
                    return el.length != 0
                });
                values.push(item.name);
                values = values.filter(function (item, index, inputArray) {
                    return inputArray.indexOf(item) == index;
                });
                this.$.gene.value = values.join(",");
            }
        },
        clearForm: function () {
            /* samples */
            for (var i = 0; i < this.samples.length; i++) {
                var sample = this.samples[i];
                var els = this.$.segregation.querySelectorAll("input[name='" + sample + "']:checked");
                for (var j = 0; j < els.length; j++) {
                    var el = els[j];
                    el.checked = false;
                }
            }
            /* Consequence Types */
            var els = this.$.consequenceTypes.querySelectorAll("input[name='consequence_type']:checked");
            for (var i = 0; i < els.length; i++) {
                var el = els[i];
                el.checked = false;
            }
        },
        submitForm: function () {
            var query = {};
            var regions = [];

            if (this.regionValue) {
                regions = this.regionValue.split(",");
            }

//            if (this.geneValue) {
//                var gene = this.geneValue.toUpperCase();
//                CellBaseManager.get({
//                    species: 'hsapiens',
//                    category: 'feature',
//                    subCategory: 'gene',
//                    query: gene,
//                    resource: "info",
//                    async: false,
//                    params: {
//                        include: 'chromosome,start,end'
//                    },
//                    success: function (data) {
//                        for (var i = 0; i < data.response.length; i++) {
//                            var queryResult = data.response[i];
//                            var region = new Region(queryResult.result[0]);
//                            regions.push(region.toString());
//                        }
//                    }
//                });
//            }

            // Genotypes
            var genotypes = [];

            for (var i = 0; i < this.samples.length; i++) {
                var sample = this.samples[i];
                var els = this.$.segregation.querySelectorAll("input[name='" + sample + "']:checked");
                var gtValues = [];
                for (var j = 0; j < els.length; j++) {
                    var el = els[j];
                    gtValues.push(el.value);
                }
                if (gtValues.length > 0) {
                    var aux = this.samplesPosition[sample] + ":" + gtValues.join(",");
                    genotypes.push(aux);
                }
            }


//                for (var sample in me.samples) {
////                        console.log(sample);
//                    var checkboxName = "GT_" + sample;
//                    var selectedCheckboxes = this.shadowRoot.querySelectorAll("input[name='" + checkboxName + "']:checked");
//                    var gtValues = [];
//                    for (var i = 0; i < selectedCheckboxes.length; i++) {
//                        var obj = selectedCheckboxes[i];
//                        gtValues.push(obj.value);
//                    }
//                    if (gtValues.length > 0) {
//                        var aux = me.samples[sample] + ":" + gtValues.join(",");
//                        genotypes.push(aux);
//                    }
//                }

            if (genotypes.length > 0) {
//                query.genotype = genotypes.join(";"); //.replace(new RegExp("\/", "gi"), "%2f");
                query.genotype = genotypes.join(";").replace(new RegExp("\/", "gi"), "%2f");
            }

            // Consequence Types
            var cts = [];
            var els = this.$.consequenceTypes.querySelectorAll("input[name='consequence_type']:checked");
            for (var i = 0; i < els.length; i++) {
                var ctInput = els[i];
                cts.push(ctInput.value);
            }
            if (cts.length > 0) {
                query["annot-ct"] = cts.join(",");
            }

            var regionQuery = regions.join(",");
//            if (regionQuery != '') {
            query.region = regionQuery;
//            }

            var geneQuery = this.geneValue.toUpperCase();
            if (geneQuery != '') {
                query.gene = geneQuery;
            }

//                    if (this.fileName != '') {
//
//                        var inputFile = this.$.fileInput.files[0];
//
//                        var file = new FileDataSource({
//                            file: inputFile
//                        });
//
//                        file.on("success", function (data) {
//
//
//
//                        });
//                        file.fetch(true);
//
//
//                    } else {
//                    }


            console.log(query);
            this.search(query);
        },

        search: function (query) {
//            if (query.region != null && query.region.length > 0) {
            query.sid = Cookies("bioinfo_sid");

            //TODO fix
            query.sessionId = Cookies("bioinfo_sid");

            var url = OpencgaManager.files.fetch({
                id: this.file.id,
                query: query,
                request: {
                    url: true
                }
            });
            this.url = url;
            console.log(url);
//            }

        },
        handleBrowseClick: function (e) {
            this.$.fileInput.click();
        },
        handleInputChange: function (e) {
            var inputFile = this.$.fileInput.files[0];
            this.fileName = inputFile.name
        }
    });
</script>
