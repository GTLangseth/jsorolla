<link rel="import" href="../table/jso-table.html">
<dom-module id="jso-variant-grid">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
        }

        .title {
            font-size: 22px;
            border-bottom: thin solid #edebe3;
            /*margin: 7px 5px;*/
        }

        jso-table {
            overflow-y: auto;
            border: 1px solid #d3d3d3;
        }

        jso-table::shadow #list {
            height: 300px;
            overflow-x: auto
        }

        jso-table::shadow {
            font-size: 11px;
        }
    </style>
    <template>

        <jso-table id="table" enable-resize enable-export$="{{enableExport}}" enable-paging enable-remote enable-select enable-loading request="{{request}}" on-rowclick="handleRowClick"></jso-table>
    </template>

</dom-module>
<script>
    Polymer({
        is: "jso-variant-grid",
        properties: {
            url: {
                type: String,
                notify: true,
                value: '',
                observer: 'urlChanged'
            },
            study: {
                type: Object,
                value: function() {
                    return {};
                },
                observer: 'studyChanged'
            },
            samples: {
                type: Array,
                notify: true,
                value: function() {
                    return [];
                },
                observer: 'samplesChanged'
            },
            request: {
                type: Object
            },
            numTotalResults: {
                type: Number,
                notify: true
            },
            enableExport: {
                type: Boolean,
                reflectToAttribute: true,
                value: false
            }
        },
        _columns: [{
            name: 'variant',
            title: "Variant",
            width: 100,
            formula: function(row) {
                return row.chromosome + ":" + row.start;
            }
        }, {
            name: 'alleles',
            title: 'Alleles',
            width: 100,
            formula: function(row) {
                return row.reference + ">" + row.alternate;
            }
        }, {
            name: 'snpId',
            title: 'SNP Id',
            width: 80,
            defaultValue: '.',
            // formula: function(row) {
            //     return row.id;
            // }
        }, {
            name: 'genes',
            title: 'Genes',
            width: 150,
            defaultValue: '.'
        }, {
            name: 'type',
            title: 'Type',
            width: 50,
            defaultValue: '.'
        }, {
            name: 'samples',
            title: 'Samples',
            width: 100
        }, {
            name: 'ct',
            title: 'Conseq. Type',
            width: 300
        }, {
            name: 'sift',
            title: 'SIFT',
            width: 50,
            defaultValue: '.',
        }, {
            name: 'polyphen',
            title: 'Polyphen',
            width: 50,
            defaultValue: '.'
        }, {
            name: 'phylop',
            title: 'phyloP',
            width: 50,
            defaultValue: '.'
        }, {
            name: 'phastCons',
            title: 'PhastCons',
            width: 57,
            defaultValue: '.'
        }, {
            name: '1000GENOMES_phase_1',
            title: '1000G MAF(phase 1)',
            defaultValue: '.',
            width: 250,
            columns: [{
                name: "ALL",
                title: "ALL",
                width: 50,
                formula: function(row) {
                    if (row['1000GENOMES_phase_1'] && row['1000GENOMES_phase_1'].ALL) {
                        return row['1000GENOMES_phase_1'].ALL;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "AMR",
                title: "AMR",
                width: 50,
                formula: function(row) {
                    if (row['1000GENOMES_phase_1'] && row['1000GENOMES_phase_1'].AMR) {
                        return row['1000GENOMES_phase_1'].AMR;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "ASN",
                title: "ASN",
                width: 50,
                formula: function(row) {
                    if (row['1000GENOMES_phase_1'] && row['1000GENOMES_phase_1'].ASN) {
                        return row['1000GENOMES_phase_1'].ASN;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "AFR",
                title: "AFR",
                width: 50,
                formula: function(row) {
                    if (row['1000GENOMES_phase_1'] && row['1000GENOMES_phase_1'].AFR) {
                        return row['1000GENOMES_phase_1'].AFR;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "EUR",
                title: "EUR",
                width: 50,
                formula: function(row) {
                    if (row['1000GENOMES_phase_1'] && row['1000GENOMES_phase_1'].EUR) {
                        return row['1000GENOMES_phase_1'].EUR;
                    } else {
                        return ".";
                    }
                }
            }]
        }, {
            name: '1000G_PHASE_3',
            title: '1000G MAF(phase 3)',
            defaultValue: '.',
            width: 300,
            columns: [{
                name: "ALL",
                title: "ALL",
                width: 50,
                formula: function(row) {
                    if (row['1000G_PHASE_3'] && row['1000G_PHASE_3'].ALL) {
                        return row['1000G_PHASE_3'].ALL;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "AMR",
                title: "AMR",
                width: 50,
                formula: function(row) {
                    if (row['1000G_PHASE_3'] && row['1000G_PHASE_3'].AMR) {
                        return row['1000G_PHASE_3'].AMR;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "SAS",
                title: "SAS",
                width: 50,
                formula: function(row) {
                    if (row['1000G_PHASE_3'] && row['1000G_PHASE_3'].SAS) {
                        return row['1000G_PHASE_3'].SAS;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "EAS",
                title: "EAS",
                width: 50,
                formula: function(row) {
                    if (row['1000G_PHASE_3'] && row['1000G_PHASE_3'].EAS) {
                        return row['1000G_PHASE_3'].EAS;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "AFR",
                title: "AFR",
                width: 50,
                formula: function(row) {
                    if (row['1000G_PHASE_3'] && row['1000G_PHASE_3'].AFR) {
                        return row['1000G_PHASE_3'].AFR;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "EUR",
                title: "EUR",
                width: 50,
                formula: function(row) {
                    if (row['1000G_PHASE_3'] && row['1000G_PHASE_3'].EUR) {
                        return row['1000G_PHASE_3'].EUR;
                    } else {
                        return ".";
                    }
                }
            }]
        }, {
            name: 'ESP_6500',
            title: 'ESP 650',
            defaultValue: '.',
            width: 100,
            columns: [{
                name: "EA",
                title: "Eur.Ame.",
                width: 50,
                formula: function(row) {
                    if (row['ESP_6500'] && row['ESP_6500'].EA) {
                        return row['ESP_6500'].EA;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "AA",
                title: "Afr.Ame",
                width: 50,
                formula: function(row) {
                    if (row['ESP_6500'] && row['ESP_6500'].AA) {
                        return row['ESP_6500'].AA;
                    } else {
                        return ".";
                    }
                }
            }]

        }, {
            name: 'phenotype',
            title: 'Phenotype',
            defaultValue: '.',
            width: 600,
            columns: [{
                name: "clinvar",
                title: "Clinvar",
                width: 200,
                formula: function(row) {
                    if (row.phenotype && row.phenotype.clinvar) {
                        return row.phenotype.clinvar;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "cosmic",
                title: "Cosmic",
                width: 200,
                formula: function(row) {
                    if (row.phenotype && row.phenotype.cosmic) {
                        return row.phenotype.cosmic;
                    } else {
                        return ".";
                    }
                }
            }, {
                name: "gwas",
                title: "GWAS",
                width: 200,
                formula: function(row) {
                    if (row.phenotype && row.phenotype.cosmic) {
                        return row.phenotype.cosmic;
                    } else {
                        return ".";
                    }
                }
            }]
        }],
        studyChanged: function(neo, old) {
            if (neo && neo.id != null) {
                this.$.table.clear();
                this._updateColumns();
            }
        },
        samplesChanged: function(neo, old) {
            this.$.table.clear();
            this._updateColumns();
        },
        _updateColumns: function() {
            var sampleColumns = [];
            var colWidth = 80;

            if (this.study.type == "CASE_CONTROL") {
                this._columns.splice(5, 1);
                this.$.table.columns = this._columns;
                return;
            }

            for (var i = 0; i < this.samples.length; i++) {
                var sample = this.samples[i].name;
                var f = "return row.studies[0].samplesData[" + i + "][0]";

                sampleColumns.push({
                    name: sample,
                    title: sample,
                    width: colWidth,
                    formula: new Function("row", f),
                });
            }
            this._columns[5].columns = sampleColumns;
            this._columns[5].width = sampleColumns.length * colWidth;

            this.$.table.columns = this._columns;
        },
        handleRowClick: function(e) {
            console.log(e.detail.row);
        },
        urlChanged: function(neo, old) {
            var me = this;
            if (neo == null || neo == "") {
                return;
            }
            this.request = {
                url: this.url,
                auxTotalCount: -1,
                parse: function(response) {
                    return me._parse(response);
                },
                parseTotal: function(response) {
                    var total = me._parseTotal(response);

                    me.numTotalResults = total;

                    if (this.auxTotalCount == -1) {
                        this.auxTotalCount = total;

                        this.url = this.url.replace("&skipCount=false", "");

                    } else {
                        me.numTotalResults = this.auxTotalCount;
                        total = me.numTotalResults;
                    }

                    me.set('numTotalResults', -1);
                    me.set('numTotalResults', total);
                    return total;
                },
            };
        },
        _parse: function(response) {
            var me = this;
            if (response.response != null) {
                var data = response.response[0].result;
                console.log(data);

                for (var i = 0; i < data.length; i++) {
                    var variant = data[i];

                    if (variant.annotation) {
                        var annotation = variant.annotation;

                        // consequenceTypes
                        if (annotation.consequenceTypes != null) {
                            var ctsAux = {};
                            var siftAux = null;
                            var polyphenAux = null;
                            var genesAux = {};

                            for (var j = 0; j < annotation.consequenceTypes.length; j++) {
                                var ct = annotation.consequenceTypes[j];
                                if (ct.sequenceOntologyTerms) {
                                    for (var k = 0; k < ct.sequenceOntologyTerms.length; k++) {
                                        var so = ct.sequenceOntologyTerms[k].name;
                                        ctsAux[so] = so;
                                    }
                                }

                                // SIFT & Polyphen
                                if (ct.proteinVariantAnnotation) {
                                    if (ct.proteinVariantAnnotation.substitutionScores && (siftAux == null || polyphenAux == null)) {
                                        if (ct.proteinVariantAnnotation.substitutionScores[0] && ct.proteinVariantAnnotation.substitutionScores[1]) {
                                            polyphenAux = ct.proteinVariantAnnotation.substitutionScores[0].score;
                                            siftAux = ct.proteinVariantAnnotation.substitutionScores[1].score;
                                        }
                                    }
                                }

                                // genes
                                if (ct.geneName) {
                                    var gn = ct.geneName;
                                    genesAux[gn] = gn;
                                }
                            }

                            var cts = Object.keys(ctsAux);
                            if (cts.length > 0) {
                                variant.ct = cts.join(",");
                            }
                            var genes = Object.keys(genesAux);
                            if (genes.length > 0) {
                                variant.genes = genes.join(",");
                            }

                            variant.sift = siftAux;
                            variant.polyphen = polyphenAux;
                        }

                        // Conservation
                        if (annotation.conservation != null) {
                            var phylopAux = null;
                            var phastConsAux = null;
                            for (var j = 0; j < annotation.conservation.length; j++) {
                                var cons = annotation.conservation[j];
                                if (cons.source.toLowerCase() == "phastcons") {
                                    phastConsAux = cons.score.toFixed(3);
                                } else if (cons.source.toLowerCase() == "phylop") {
                                    phylopAux = cons.score.toFixed(3);
                                }
                            }
                            variant.phylop = phylopAux;
                            variant.phastCons = phastConsAux;

                        }

                        // Population Frequencies
                        if (annotation.populationFrequencies != null) {
                            variant['ESP_6500'] = {};
                            variant['1000GENOMES_phase_1'] = {};
                            variant['1000G_PHASE_3'] = {};
                            for (var j = 0; j < annotation.populationFrequencies.length; j++) {
                                var freq = annotation.populationFrequencies[j];
                                if (freq.study == "ESP_6500") {
                                    if (freq.population == "European_American") {
                                        variant['ESP_6500'].EA = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "African_American") {
                                        variant['ESP_6500'].AA = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    }

                                } else if (freq.study == "1000GENOMES_phase_1") {
                                    if (freq.population == "AFR") {
                                        variant['1000GENOMES_phase_1'].AFR = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "AMR") {
                                        variant['1000GENOMES_phase_1'].AMR = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "ASN") {
                                        variant['1000GENOMES_phase_1'].ASN = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "EUR") {
                                        variant['1000GENOMES_phase_1'].EUR = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "ALL") {
                                        variant['1000GENOMES_phase_1'].ALL = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    }

                                } else if (freq.study == "1000G_PHASE_3") {
                                    if (freq.population == "1000G_PHASE_3_ALL") {
                                        variant['1000G_PHASE_3'].ALL = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "1000G_PHASE_3_SAS") {
                                        variant['1000G_PHASE_3'].SAS = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "1000G_PHASE_3_EAS") {
                                        variant['1000G_PHASE_3'].EAS = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "1000G_PHASE_3_AMR") {
                                        variant['1000G_PHASE_3'].AMR = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "1000G_PHASE_3_AFR") {
                                        variant['1000G_PHASE_3'].AFR = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    } else if (freq.population == "1000G_PHASE_3_EUR") {
                                        variant['1000G_PHASE_3'].EUR = (Math.min(freq.refAlleleFreq, freq.altAlleleFreq)).toFixed(3);
                                    }
                                }
                            }
                        }

                        // Phenotype
                        if (annotation.variantTraitAssociation != null) {
                            var phenClinvarAux = {};
                            var phenCosmicAux = {};
                            var vta = annotation.variantTraitAssociation;
                            // Clinvar
                            if (vta.clinvar != null) {
                                for (var k = 0; k < vta.clinvar.length; k++) {
                                    var phen = vta.clinvar[k].traits;
                                    for (var l = 0; l < phen.length; l++) {
                                        var p = phen[l].toLowerCase();
                                        if (p != "not specified" && p != "allhighlypenetrant") {
                                            phenClinvarAux[p] = p;
                                        }
                                    }
                                }
                            }
                            // Cosmic
                            if (vta.cosmic != null) {
                                for (var k = 0; k < vta.cosmic.length; k++) {
                                    var phen = vta.cosmic[0].primaryHistology.toLowerCase();
                                    phenCosmicAux[phen] = phen;
                                }
                            }

                            // GWAS

                            variant.phenotype = {};
                            var phenCosmic = Object.keys(phenCosmicAux);
                            if (phenCosmic.length > 0) {
                                variant.phenotype.cosmic = phenCosmic.join(",");
                            }
                            var phenClinvar = Object.keys(phenClinvarAux);
                            if (phenClinvar.length > 0) {
                                variant.phenotype.clinvar = phenClinvar.join(",");
                            }
                        }

                        // SNPid
                        if (annotation.xrefs != null) {
                            var snpIdAux = null;
                            for (var j = 0; j < annotation.xrefs.length; j++) {
                                if (annotation.xrefs[j].source == "dbSNP") {
                                    snpIdAux = annotation.xrefs[j].id;
                                }
                            }
                            if (snpIdAux != null) {
                                variant.snpId = snpIdAux;
                            }
                        }

                    }

                    // Type
                    if (variant.type) {
                        var typeAux = variant.type;
                        variant.type = typeAux;
                    }

                }

            } else {
                data = [];
            }
            return data;
        },
        _parseTotal: function(response) {
            if (response.response != null) {
                var total = response.response[0].numTotalResults;
            } else {
                total = 0;
            }
            return total;
        }
    });
</script>
