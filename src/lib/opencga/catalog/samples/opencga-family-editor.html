<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="opencga-family-editor">

    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div class="panel">
            <table class="table hover">
                <thead>
                <tr class="active">
                    <th>Sample ID</th>
                    <th>Affected</th>
                    <th>Deceased</th>
                    <th>Family Role</th>
                </tr>
                </thead>
                <tbody>
                <template is="dom-repeat" items="{{samples}}" as="sample">
                    <tr>
                        <td>{{sample.name}}</td>
                        <td>
                            <input id="{{prefix}}{{sample.name}}Affected" data-sample="{{sample.name}}" type="checkbox" on-change="selectAffected">
                        </td>
                        <td>
                            <input id="{{prefix}}{{sample.name}}Deceased" data-sample="{{sample.name}}" type="checkbox" on-change="selectDeceased">
                        </td>
                        <td>
                            <div class="dropdown">
                                <select class="form-control" id="{{prefix}}{{sample.name}}Role" data-sample="{{sample.name}}" on-change="selectRole">
                                    <option value="none">Select a role...</option>
                                    <option value="father">Father</option>
                                    <option value="mother">Mother</option>
                                    <option value="son">Son</option>
                                    <option value="daughter">Daughter</option>
                                    <option value="undefined">Unspecified Sex Child</option>
                                </select>
                            </div>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>

            <div style="padding: 5px 10px">
                <input id="{{prefix}}ParentalConsanguinity" type="checkbox" on-change="selectParentalConsanguinity">
                <label style="padding: 0px 5px">Parental Consanguinity</label>
            </div>
            <div style="padding: 5px 10px">
                <input id="{{prefix}}SampleNames" type="checkbox" on-change="selectShowSampleNames">
                <label style="padding: 0px 5px">Show Sample Names</label>
            </div>

            <div style="padding: 20px 0px">
                <h5>Pedigree</h5>
                <div id="{{prefix}}PedigreeView" style="padding: 0px 20px;font-size: 10px"></div>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'opencga-family-editor',
            properties: {
                opencgaClient: {
                    type: Object
                },
                studyId: {
                    type: Object
//                    observer: 'renderFromServer'
                },
                samples: {
                    type: Array,
//                    notify: true,
                    observer: '_updateSamples'
                },
                prefix: {
                    type: String
                },
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "family" + Utils.randomString(6);
                }

                this._affected = {};
                this._deceased = {};
                this.pedigreeSettings = {children: []};
                this.pedigree = {children: []};
            },
            selectAffected: function (e) {
                e.preventDefault();
                let sampleName = e.currentTarget.dataSample;
                this._affected[sampleName] = e.currentTarget.checked;
                this.pedigreeRender();
            },
            selectDeceased: function (e) {
                e.preventDefault();
                let sampleName = e.currentTarget.dataSample;
                this._deceased[sampleName] = e.currentTarget.checked;
                this.pedigreeRender();
            },
            selectParentalConsanguinity: function (e) {
                this.pedigree.parentalConsanguinity = e.currentTarget.checked;
                this.pedigreeRender();
            },
            selectShowSampleNames: function (e) {
                this.pedigreeSettings.selectShowSampleNames = e.currentTarget.checked;
                this.pedigreeRender();
            },
            selectRole: function (e) {
                e.preventDefault();
                let role = this.$$("#" + this.prefix + e.target.dataSample + "Role").value;
                this._samples = this.samples;

                let sampleName = e.target.dataSample;
                if (role !== "none") {
                    this._removeSampleFromPedigree(sampleName);
                }

                for (let i = 0; i < this._samples.length; i++) {
                    if (this._samples[i].name === sampleName) {
                        this._samples[i].role = role;
                        switch (role) {
                            case "father":
                            case "Father":
                                if (typeof this.pedigree.father !== "undefined") {
                                    $("#" + this.prefix + this.pedigree.father.name + "Role").val('none');
                                }
                                this.pedigree.father = {name: sampleName, gender: "male"};
                                break;
                            case "mother":
                            case "Mother":
                                if (typeof this.pedigree.mother !== "undefined") {
                                    $("#" + this.prefix + this.pedigree.mother.name + "Role").val('none');
                                }
                                this.pedigree.mother = {name: sampleName, gender: "female"};
                                break;
                            case "son":
                            case "Son":
                                this.pedigree.children.push({name: sampleName, gender: "male"});
                                break;
                            case "daughter":
                            case "Daughter":
                                this.pedigree.children.push({name: sampleName, gender: "female"});
                                break;
                            case "undefined":
                                this.pedigree.children.push({name: sampleName, gender: "undefined"});
                                break;
                            case "none":
                                // Remove sample from pedigree
                                this._removeSampleFromPedigree(sampleName);
                                break;
                        }
                        break;
                    }
                }
                this.pedigreeRender();
            },
            _createPedigree: function () {
                // Complete the pedigree with the affected and deceased status
                if (typeof this.pedigree.father !== "undefined") {
                    this.pedigree.father.affected = this._affected[this.pedigree.father.name];
                    this.pedigree.father.deceased = this._deceased[this.pedigree.father.name];
                }
                if (typeof this.pedigree.mother !== "undefined") {
                    this.pedigree.mother.affected = this._affected[this.pedigree.mother.name];
                    this.pedigree.mother.deceased = this._deceased[this.pedigree.mother.name];
                }
                if (typeof this.pedigree.children !== "undefined") {
                    for (let child of this.pedigree.children) {
                        child.affected = this._affected[child.name];
                        child.deceased = this._deceased[child.name];
                    }
                }
                return this.pedigree;
            },
            pedigreeRender: function () {
                let ped = this._createPedigree();

                if (typeof this.svg !== "undefined") {
                    Polymer.dom(this.root).querySelector("#" + this.prefix + "PedigreeView").removeChild(this.svg);
                }

                let pedigree = new Pedigree();
                this.svg = pedigree.createSvg(ped, this.pedigreeSettings);
                let querySelector = Polymer.dom(this.root).querySelector("#" + this.prefix + "PedigreeView");
                querySelector.appendChild(this.svg);
            },
            _updateSamples: function () {
                if (typeof this.samples !== "undefined" && this.samples !== null) {
                    this.pedigreeRender();

                    this.sampleNameIdMap = {};
                    for (let sample of this.samples) {
                        this.sampleNameIdMap[sample.name] = sample.id;
                    }

                    this.sampleRelativeMap = {};
                    for (let sampleIdx in this.samples) {
                        this.sampleRelativeMap[this.samples[sampleIdx].name] = [];
                        for (let relativeIdx in this.samples) {
                            if (sampleIdx !== relativeIdx) {
                                this.sampleRelativeMap[this.samples[sampleIdx].name].push(this.samples[relativeIdx].name);
                            }
                        }
                    }
                }
            },
            _removeSampleFromPedigree: function (sampleName) {
                // Remove from pedigree the sample
                if (typeof this.pedigree.father !== "undefined" && this.pedigree.father.name === sampleName) {
                    this.pedigree.father = undefined;
                }
                if (typeof this.pedigree.mother !== "undefined" && this.pedigree.mother.name === sampleName) {
                    this.pedigree.mother = undefined;
                }
                if (typeof this.pedigree.children !== "undefined") {
                    let indexToRemove = -1;
                    for (let i = 0; i < this.pedigree.children.length; i++) {
                        if (this.pedigree.children[i].name === sampleName) {
                            indexToRemove = i;
                            break;
                        }
                    }
                    if (indexToRemove !== -1) {
                        this.pedigree.children.splice(indexToRemove, 1);
                    }
                }
            },
            _isFatherFilter: function (item) {
                let relatives = this.sampleRelativeMap[item.name];
                debugger
                return relatives.includes(item.name);
            },
            _isMotherFilter: function (item) {
                let relatives = this.sampleRelativeMap[item.name];

                return relatives.includes(item.name);
            }


        });

    </script>
</dom-module>