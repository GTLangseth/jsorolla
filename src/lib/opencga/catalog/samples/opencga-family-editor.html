<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<dom-module id="opencga-family-editor">

    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div class="panel">
            <table class="table hover">
                <thead>
                <tr class="active">
                    <th>Sample ID</th>
                    <th>Affected</th>
                    <th>Gender</th>
                    <th>Father</th>
                    <th>Mother</th>
                </tr>
                </thead>
                <tbody>
                <template is="dom-repeat" items="{{samples}}" as="sample">
                    <tr>
                        <td>{{sample.name}}</td>
                        <td><input type="checkbox"></td>
                        <td>{{sample.gender}}</td>
                        <td>
                            <div class="dropdown">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span id="{{prefix}}{{sample.name}}fatherButton" class="selection">Select...</span> <span class="caret"></span>
                                </button>
                                <ul id="{{prefix}}{{sample.name}}father" class="dropdown-menu" on-click="selectSample">
                                    <template is="dom-repeat" items="{{samples}}">
                                        <template is="dom-if" if="[[showParent(sample, item,'male')]]">
                                            <li><a>{{item.name}}</a></li>
                                        </template>
                                    </template>
                                </ul>
                            </div>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <span id="{{prefix}}{{sample.name}}motherButton" class="selection">Select...</span> <span class="caret"></span>
                                </button>
                                <ul id="{{prefix}}{{sample.name}}mother" class="dropdown-menu" on-click="selectSample">
                                    <template is="dom-repeat" items="{{samples}}">
                                        <template is="dom-if" if="[[showParent(sample, item,'female')]]">
                                            <li><a>{{item.name}}</a></li>
                                        </template>
                                    </template>
                                </ul>
                            </div>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>


            <h3>Pedigree will be shown here...</h3>
        </div>

    </template>

    <script>
        Polymer({
            is: 'opencga-family-editor',
            properties: {
                opencgaClient: {
                    type: Object
                },
                studyId: {
                    type: Object
//                    observer: 'renderFromServer'
                },
                samples: {
                    type: Array,
                    notify: true,
                    observer: '_updateSamples'
                },
                prefix: {
                    type: String
                },
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "sample" + Utils.randomString(6);
                }



            },
            showParent: function(sample, item, gender) { // Show only those samples whose gender is given by the argument
                return sample.name != item.name;
                // return (sample.name != item.name) && item.gender == gender
            },

            selectSample: function (e) {
                console.log(e);
                debugger;
                e.preventDefault();
                $("#"+e.currentTarget.id+"Button").text(e.target.innerHTML);



            },

            _updateSamples: function () {
                if (typeof this.samples != "undefined" && this.samples != null) {
                    this.sampleRelativeMap = {};
                    for (let sampleIdx in this.samples) {
                        this.sampleRelativeMap[this.samples[sampleIdx].name] = [];
                        for (let relativeIdx in this.samples) {
                            if (sampleIdx != relativeIdx) {
                                this.sampleRelativeMap[this.samples[sampleIdx].name].push(this.samples[relativeIdx].name);
                            }
                        }
                    }
                }
            },
            _isFatherFilter: function (item) {
                let relatives = this.sampleRelativeMap[item.name];
                debugger
                return relatives.includes(item.name);
            },
            _isMotherFilter: function (item) {
                let relatives = this.sampleRelativeMap[item.name];

                return relatives.includes(item.name);
            }


        });

    </script>
</dom-module>