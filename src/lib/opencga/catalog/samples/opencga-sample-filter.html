<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="opencga-sample-filter">
    <template>
        <style is="custom-style" include="jso-styles">
            label {
                padding-top: 10px;
            }
        </style>

        <br>
        <div style="width: 60%;margin: 0 auto">
            <button type="button" class="btn btn-primary" style="width: 100%" on-click="onSearch">
                <i class="fa fa-search" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                Search
            </button>
        </div>
        <br>


        <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">

            <!-- Sample Selection -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleSelectionHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}SampleSelection" aria-expanded="true" aria-controls="{{prefix}}SampleSelection">
                            Sample Selection
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Sample selection">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}SampleSelection" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleSelectionHeading">
                    <div class="panel-body">
                        <div class="form-group">
                            <form>
                                <label>Select</label>
                                <br>
                                <input type="radio" name="selectionButtons" id="allRadio" value="all" class$="{{prefix}}FilterRadio" checked on-change="calculateFilters" style="padding-left: 20px"> All<br>
                                <input type="radio" name="selectionButtons" id="recentlyRadio" value="recently" class$="{{prefix}}FilterRadio" on-change="calculateFilters" style="padding-left: 20px"> Recently Uploaded<br>
                                <input type="radio" name="selectionButtons" id="rangeRadio" value="range" class$="{{prefix}}FilterRadio" on-change="calculateFilters" style="padding-left: 20px"> Range
                            </form>

                            <div class="panel-body">
                                <span>From</span>
                                <div class="input-group date" id="{{prefix}}datetimePickerFrom">
                                    <input type="text" class="form-control"/>
                                    <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                                </div>
                                <span>To</span>
                                <div class="input-group date" id="{{prefix}}datetimePickerTo">
                                    <input type="text" class="form-control"/>
                                    <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                                </div>
                            </div>

                            <label>Other filters</label>
                            <br>
                            <input type="checkbox" name="selectionButtons" id="controls" value="controls" class$="{{prefix}}FilterRadio" on-change="calculateFilters" style="padding-left: 20px"> Controls<br>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sample and Individual Name -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleIndividualHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}SampleIndividual" aria-expanded="true" aria-controls="{{prefix}}SampleIndividual">
                            Sample
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Sample selection">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>

                <div id="{{prefix}}SampleIndividual" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleIndividualHeading">
                    <div class="panel-body">
                        <div class="form-group">
                            <label>Sample name</label>
                            <input type="text" id="{{prefix}}SampleName" class="form-control" placeholder="HG01879, HG01880, HG01881..." on-keyup="calculateFilters">

                            <label>Individual name</label>
                            <input type="text" id="{{prefix}}IndividualName" class="form-control" placeholder="Smith, Grant ..." on-keyup="calculateFilters">

                            <label>Family name</label>
                            <input type="text" id="{{prefix}}FamilyName" class="form-control" placeholder="Smith, Grant ..." on-keyup="calculateFilters">
                        </div>
                    </div>
                </div>
            </div>


            <!--Sample characteristics-->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleGeneralFilterHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}SampleGeneralFilter" aria-expanded="true" aria-controls="{{prefix}}SampleGeneralFilter">
                            Sample Characteristics
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Generic sample filters">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}SampleGeneralFilter" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}SampleGeneralFilterHeading">
                    <div class="panel-body">
                        <input type="checkbox" id="changeMOdeChekbox" value="compact" checked on-change="_changeMode"> Compact<br>
                    </div>

                    <template is="dom-if" if="{{compact}}">
                        <div class="panel-body">
                            <div class="form-group">
                                <label for="variableSetSelect">Variable Set</label>
                                <select class="form-control" id="variableSetSelect" style="width: 100%" on-change="selectedVariableSet">
                                    <template is="dom-repeat" items="{{variableSets}}">
                                        <option data-variable="{{item}}">{{item.name}}</option>
                                    </template>
                                </select>
                            </div>

                            <label for="variableSetSelect">Select a Variable</label>
                            <div class="form-group has-feedback">
                                <input type="text" id="{{prefix}}VariableNameText" class="form-control" placeholder="Search variable"
                                       on-keyup="renderVariableTemplate" value="{{searchVariable::input}}">
                                <i class="fa fa-search form-control-feedback" aria-hidden="true"></i>
                            </div>
                            <ul class="list-unstyled" style="max-height: 150px; overflow-y: auto; padding: 5px;">
                                <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" filter="_filterVariable" sort="_sortVariables">

                                    <template is="dom-if" if="{{isVisible(variable,config)}}">
                                        <li style="cursor: pointer;" data-toggle="modal" data-target="#{{prefix}}ModalFilters" on-click="variableSelected" data-variable="{{variable}}">
                                            {{variable.title}}
                                        </li>
                                    </template>
                                </template>
                            </ul>
                        </div>
                    </template>

                    <template is="dom-if" if="{{!compact}}">
                        <div class="form-group has-feedback panel-body">
                            <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" sort="_sortVariables">
                                <template is="dom-if" if="{{isVisible(variable,config)}}">
                                    <br>
                                    <label for="{{prefix}}{{variable.name}}">{{variable.title}}:</label>
                                    <template is="dom-if" if="{{checkVarType(variable, 'TEXT')}}">
                                        <!-- TEXT type: include an input text and add suitable regular expression for text-->
                                        <!-- http://stackoverflow.com/questions/14237686/disabling-controls-in-bootstrap-->
                                        <input type="text" class="form-control" id="{{prefix}}{{variable.name}}" placeholder="{{variable.name}} name" pattern="{{variable.attributes.pattern}}" aria-describedby="basic-addon1">
                                    </template>

                                    <template is="dom-if" if="{{checkVarType(variable, 'NUMERIC')}}">
                                        <!-- NUMERIC type: include an input text and add suitable regular expression for numbers -->
                                        <input type="text" class="form-control" id="{{prefix}}{{variable.name}}" placeholder="{{variable.name}} number" pattern="^[0-9]+$">
                                    </template>

                                    <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 0, 1)}}">
                                        <!-- CATEGORICAL type, no value: values to be filled in this code -->
                                        <!-- Dropdown related to years : fill in with values contained in {{years}} -->
                                        <template is="dom-if" if="{{checkType(variable.name,'Year')}}">
                                            <select class="form-control" id="{{prefix}}{{variable.name}}" on-change="checkYears">
                                                <!--<option></option>-->
                                                <template is="dom-repeat" items="{{years}}">
                                                    <option value="{{item}}">{{item}}</option>
                                                </template>
                                            </select>
                                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                        </template>

                                    </template>

                                    <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 1, 2)}}">
                                        <!-- CATEGORICAL type, single value: check box -->
                                        <div class="col-sm-9">
                                            <input type="checkbox" id="{{prefix}}{{variable.name}}" style="padding-left: 20px">
                                        </div>
                                    </template>

                                    <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 2, 3)}}">
                                        <!-- CATEGORICAL type, 2 values: radio buttons for selection -->
                                        <template is="dom-repeat" items="{{variable.allowedValues}}" as="value">
                                            <div class="form-check form-check-inline">
                                                <label class="form-check-label">
                                                    <input id="{{prefix}}{{variable.name}}{{value}}" class="form-check-input" type="radio" name="{{variable.name}}Options"> {{value}} <br>
                                                </label>
                                            </div>
                                        </template>
                                    </template>

                                    <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 3, 500)}}">
                                        <!-- CATEGORICAL type: dropdown: at least three elements in variable.allowedValues -->
                                        <select class="form-control" id="{{prefix}}{{variable.name}}">
                                            <!--<option></option>-->
                                            <template is="dom-repeat" items="{{variable.allowedValues}}">
                                                <option value="{{item}}">{{item}}</option>
                                            </template>
                                        </select>
                                    </template>

                                    <template is="dom-if" if="{{checkVarType(variable, 'BOOLEAN')}}">
                                        <!-- BOOLEAN type, 2 values: radio buttons for selection: yes or no -->
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input id="{{prefix}}{{variable.name}}yes" class="form-check-input" type="radio" name="{{variable.name}}Options"> yes <br>
                                                <input id="{{prefix}}{{variable.name}}no" class="form-check-input" type="radio" name="{{variable.name}}Options"> no <br>
                                            </label>
                                        </div>
                                    </template>
                                    <!-- Close dom-if for visibility -->
                                </template>
                                <!-- Close dom-repeat for variables -->
                            </template>
                        </div>
                        <!-- Close dom-if for extended -->
                    </template>
                </div>
            </div>
        </div>

        <div class="modal fade" tabindex="-1" role="dialog" id="{{prefix}}ModalFilters">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Filter by {{ variable.name }}</h4>
                    </div>
                    <div class="modal-body">
                        <!--CATEGORICAL-->
                        <template is="dom-if" if="{{_isCategorical}}">
                            <div class="row">
                                <template is="dom-repeat" items="{{variable.allowedValues}}" as="allowedValue">
                                    <div class="col-md-4">
                                        <div class="checkbox" style="margin: 0">
                                            <label class="category-filter-label js-label-toggle">
                                                <input name="{{prefix}}Categorical" type="checkbox" value="{{allowedValue}}"> {{allowedValue}}
                                            </label>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </template>
                        <!--TEXT-->
                        <template is="dom-if" if="{{_isText}}">
                            <div class="form-group">
                                <input type="text" name="{{prefix}}Text" class="form-control" />
                            </div>
                        </template>
                        <!--NUMERIC-->
                        <template is="dom-if" if="{{_isNumerical}}">
                            <div class="form-group">
                                <input type="text" name="{{prefix}}Numerical" class="form-control" />
                            </div>
                        </template>
                        <!--BOOLEAN-->
                        <template is="dom-if" if="{{_isBoolean}}">
                            <input type="checkbox" checked>
                        </template>
                        <!--OBJECT-->
                        <template is="dom-if" if="{{_isObject}}">
                            Not implemented
                        </template>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default add-right-margin" data-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" on-click="updateCompactFilter" data-dismiss="modal">Update filter</button>
                    </div>
                </div>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'opencga-sample-filter',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Object,
                    observer: 'updateVariableSets'
                },
                samples: {
                    type: Array,
                    notify: true
                },
                prefix: {
                    type: String
                },
                query: {
                    type: Object,
                    notify: true
                },
                config: {
                    type: Object
                },
                search: {
                    type: Object,
                    notify: true
                },
                variableSets: {
                    type: Array
                },
                variables: {
                    type: Array,
                    observer: 'variablesChanged'
                },
                minYear: {
                    type: Number,
                    value: 1920
                },
                compact: {
                    type: Boolean,
                    value: true
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = Utils.randomString(6);
                }
                let _years = [];
                let fullDate = new Date()
                let limitYear = fullDate.getFullYear();
                for (let year = this.minYear; year<=limitYear; year++)
                {_years.push(year);}
                // This change triggers the polymer dom-repeat
                this.years = _years;
            },
            attached: function () {
                $("#" + this.prefix + "datetimePickerFrom").datetimepicker({
                    format: 'DD/MM/YYYY'
                });
                $("#" + this.prefix + "datetimePickerTo").datetimepicker({
                    format: 'DD/MM/YYYY',
                    useCurrent: false //Important! See issue #1075
                });
                $("#" + this.prefix + "datetimePickerFrom").on("dp.change", function (e) {
                    $("#" + this.prefix + "datetimePickerTo").data("DateTimePicker").minDate(e.date);
                });
                $("#" + this.prefix + "datetimePickerTo").on("dp.change", function (e) {
                    $("#" + this.prefix + "datetimePickerFrom").data("DateTimePicker").maxDate(e.date);
                });
            },
            onSearch: function () {
                this.search = this.query;
            },
            calculateFilters: function () {
                let _query = {};

                _query.name = $("#" + this.prefix + "SampleName").val();

                this.query = _query;
            },
            updateVariableSets: function () {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                    .then(function (response) {
                        _this.variableSets = response.response[0].result[0].variableSets;
                        if (_this.variableSets.length > 0) {
                            _this.variables = _this.variableSets[0].variables; // setting first one by default
                            _this.filteredVariables = {
                                variableSet: _this.variableSets[0].id,
                                variables: []
                            };
                        } else {
                            _this.variableSets = [{name : "none"}];
                        }
                    })
                    .catch(function () {
                        console.log("Could not obtain the variable sets of the study " + _this.study);
                    });
            },
            renderVariableTemplate: function() {
                let myTemplate = this.$$("[id='" + this.prefix + "VariableTemplate']");
                if (myTemplate !== null) {
                    myTemplate.render();
                }
            },
            variableSelected: function(e) {
                this.variable = e.target.dataVariable;
                if (this.variable === undefined || Object.getOwnPropertyNames(this.variable).length === 0) {
                    return;
                }
                this._isCategorical = false;
                this._isText = false;
                this._isNumerical = false;
                this._isBoolean = false;
                this._isObject = false;
                if (this.variable.type.toLowerCase() === "categorical") {
                    this._isCategorical = true;
                } else if (this.variable.type.toLowerCase() === "text") {
                    this._isText = true;
                } else if (this.variable.type.toLowerCase() === "numeric") {
                    this._isNumerical = true;
                } else if (this.variable.type.toLowerCase() === "boolean") {
                    this._isBoolean = true;
                } else if (this.variable.type.toLowerCase() === "object") {
                    this._isObject = true;
                }
                $(e.target.dataTarget).modal('show');
            },
            updateCompactFilter: function(e) {
                let myFilter = {};
                if (this.variable.type.toLowerCase() === "categorical") {
                    let allValues = [];
                    let selected = $("input[name='" + this.prefix + "Categorical']:checked");
                    for (let i = 0; i < selected.length; i++) {
                        allValues.push(selected[i].value);
                    }
                    myFilter = {
                        name: this.variable.name,
                        value: allValues.join()
                    };
                } else if (this.variable.type.toLowerCase() === "text") {
                    let value = this.$$("input[name='" + this.prefix + "Text']");
                    myFilter = {
                        name: this.variable.name,
                        value: value.value
                    };
                    value.value = "";
                } else if (this.variable.type.toLowerCase() === "numeric") {
                    let value = this.$$("input[name='" + this.prefix + "Numerical']");
                    myFilter = {
                        name: this.variable.name,
                        value: value.value
                    };
                    value.value = "";
                } else if (this.variable.type.toLowerCase() === "boolean") {
                    this._isBoolean = true;
                } else if (this.variable.type.toLowerCase() === "object") {
                    this._isObject = true;
                }
                this.query[myFilter.name] = myFilter.value;
                this.query = Object.assign({}, this.query);
                this.fire('opencga-filter-added', myFilter);
            },
            variablesChanged: function () {
                this._areVariablesEmpty = (this.variables.length === 0);
            },
            checkVarType: function (myVar, type) {
                return (myVar.type === type);
            },
            checkCatType: function (myVar, type, lowerLimit, upperLimit) {
                return (myVar.type === type && myVar.allowedValues.length >= lowerLimit && myVar.allowedValues.length < upperLimit);
            },
            checkYears: function(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                $("#" + this.prefix + "_errorDiv_birthYear").html("");
                $("#" + this.prefix + "_errorDiv_testYear").html("");
                let currentElement = $("#"+e.target.id);
                let identifier = e.target.id;
                let pairElement = '';
                let divSuffix = '';
                let message = '';
                if(identifier.search('birthYear')!=-1) // Birth year element raises the event -> check Test year
                {
                    pairElement = $("#" + this.prefix + "testYear");
                    divSuffix = "birthYear";
                    message = "Year of Birth must be prior to year of Test";
                }
                else { // Year of test element raises the event -> swap elements and check the birth year
                    currentElement = $("#" + this.prefix + "birthYear");
                    pairElement = $("#"+e.target.id);
                    divSuffix = "testYear";
                    message = "Year of Test must be posterior to year of Birth";
                }
                if(pairElement.find("option:selected")!='' && (parseInt(currentElement.find("option:selected").text())>parseInt(pairElement.find("option:selected").text())))
                { // Year of birth cannot be lower than Year of test
                    $("#" + this.prefix + "_errorDiv_"+divSuffix).html(message);
                }
            },
            checkType: function (str1, str2) {
                if (str1.search(str2) != -1)
                {return true;}
                else
                {return false;}
            },
            _filterVariable: function(variable) {
                for (let i = 0; i < this.filteredVariables.variables.length; i++) {
                    if (variable.name === this.filteredVariables.variables[i].name) {
                        return false;
                    }
                }
                if (this.searchVariable !== undefined && variable.name.toLowerCase().indexOf(this.searchVariable.toLowerCase()) === -1) {
                    return false;
                }
                return true;
            },
            _sortVariables: function(a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            },
            _changeMode: function (e) {
                this.compact = !this.compact;
            },
            isVisible: function (myVar,conf){
                let excludeArray = conf.variableSet.exclude
                for (let index in excludeArray) {
                    if (excludeArray[index].webComponent == this.localName) {
                        return (!($.inArray(myVar.name, excludeArray[index].variables) != -1));
                    } else {return true;}
                }
            },
        });
    </script>
</dom-module>