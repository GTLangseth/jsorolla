<!--
  ~ Copyright 2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<dom-module id="opencga-variable-comparator">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div style="padding: 10px;" hidden$="{{!showComponent}}">

            <select id="{{prefix}}SelectedEntry">
                <option value="samples">Samples</option>
                <option value="individuals">Individuals</option>
                <option value="cohorts">Cohorts</option>
            </select>

            <div id="{{prefix}}chart" style="width: 100%"></div>
        </div>

    </template>
    <script>
        Polymer({
            is: 'opencga-variable-comparator',
            properties: {
                opencgaClient: {
                    type: Object
                },
                studyId: {
                    type: Number
                },
                variableSet: {
                    type: Object
                },
                selectedVariables: {
                    // Array of variable names
                    type: Array,
                    observer: 'selectedVariablesChanged'
                }
            },

            ready: function() {
                this.showComponent = false;

                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = Utils.randomString(6);
                }
            },

            selectedVariablesChanged: function(variables) {
                if (variables.length === 2) {

                    let myArray = [];
                    // Look for the variables in the variable set to validate everything
                    this.variableSet.variables.forEach(function(variable) {
                        if (variables.indexOf(variable.name) > -1) {
                            // Validate the type as well
                            if (variable.type === "CATEGORICAL" || variable.type === "NUMERIC") {
                                myArray.push(variable)
                            }
                        }
                    });

                    if (myArray.length === 2) {
                        this._renderData(myArray);
                    }

                } else {
                    this.showComponent = false;
                }
            },

            _renderData: function(myArray) {

                let selectComponent = $("#" + this.prefix + "SelectedEntry")[0];
                let selection = selectComponent.options[selectComponent.selectedIndex].value;

                let success = function(data) {
                    if (myArray[0].type === "CATEGORICAL" && myArray[1].type === "CATEGORICAL") {
                        this._drawCategoricalCategorical(myArray[0], myArray[1], data.response[0]);
                    } else if (myArray[0].type === "NUMERIC" && myArray[1].type === "NUMERIC") {
                        this._drawContinuousContinuous(myArray[0], myArray[1], data.response[0]);
                    } else {
                        // CATEGORICAL AND NUMERIC
                        if (myArray[0].type === "CATEGORICAL") {
                            this._drawCategoricalContinuous(myArray[0], myArray[1], data.response[0]);
                        } else {
                            this._drawCategoricalContinuous(myArray[1], myArray[0], data.response[0]);
                        }
                    }
                    this.showComponent = true;
                }.bind(this);

                let params = {
                    studyId: this.studyId,
                    variableSetId: this.variableSet.id,
                    // TODO: Add annotation set name
                    include: "annotationSets"
                };

                if (selection === "samples") {
                    this.opencgaClient.samples().search(params).then(success);
                } else if (selection === "individuals") {
                    this.opencgaClient.individuals().search(params).then(success);
                } else if (selection === "cohorts") {
                    // TODO: Think about this
//                    this.opencgaClient.cohorts().search(params).then(success);
                }

            },

            _drawCategoricalContinuous: function(categorical, continuous, data) {
                let myHash = {};
                categorical.allowedValues.forEach(function(value) {
                    myHash[value] = [];
                });

                // This is used to sort numbers for highcharts
                let compareNumbers = function(a, b) {
                    return a - b;
                }

                data.result.forEach(function(entry) {
                    // TODO: Loop only over the corresponding annotation set
                    let annotationSet = entry.annotationSets[0];
                    let value1 = -1;
                    let value2 = -1;
                    annotationSet.annotations.forEach(function(annotation) {
                        if (annotation.name === categorical.name) {
                            value1 = annotation.value;
                        }
                        if (annotation.name === continuous.name) {
                            value2 = annotation.value;
                        }
                    });

                    if (value1 !== -1 && value2 !== -1) {
                        myHash[value1].push(value2);
                    }
                });

                let myData = [];
                categorical.allowedValues.forEach(function(value) {
                    myData.push(myHash[value].sort(compareNumbers));
                });

                $('#' + this.prefix + 'chart').highcharts({

                    chart: {
                        type: 'boxplot'
                    },

                    title: {
                        text: 'Highcharts Box Plot Example'
                    },

                    legend: {
                        enabled: false
                    },

                    xAxis: {
                        categories: categorical.allowedValues,
                        title: {
                            text: 'Experiment No.'
                        }
                    },

                    yAxis: {
                        title: {
                            text: 'Observations'
                        },
                        plotLines: [{
                            value: 932,
                            color: 'red',
                            width: 1,
                            label: {
                                text: 'Theoretical mean: 932',
                                align: 'center',
                                style: {
                                    color: 'gray'
                                }
                            }
                        }]
                    },

                    series: [{
                        name: 'Observations',
                        data: myData,
                        tooltip: {
                            headerFormat: '<em>Experiment No {point.key}</em><br/>'
                        }
                    }
//                    , {
//                        name: 'Outlier',
//                        color: Highcharts.getOptions().colors[0],
//                        type: 'scatter',
//                        data: [ // x, y positions where 0 is the first category
//                            [0, 644],
//                            [4, 718],
//                            [4, 951],
//                            [4, 969]
//                        ],
//                        marker: {
//                            fillColor: 'white',
//                            lineWidth: 1,
//                            lineColor: Highcharts.getOptions().colors[0]
//                        },
//                        tooltip: {
//                            pointFormat: 'Observation: {point.y}'
//                        }
//                    }
                    ]

                });
            },

            _drawCategoricalCategorical: function(v1, v2) {
                $('#' + this.prefix + 'chart').highcharts({

                    chart: {
                        type: 'heatmap',
                        marginTop: 40,
                        marginBottom: 80,
                        plotBorderWidth: 1
                    },


                    title: {
                        text: 'Sales per employee per weekday'
                    },

                    xAxis: {
                        categories: ['Alexander', 'Marie', 'Maximilian', 'Sophia', 'Lukas', 'Maria', 'Leon', 'Anna', 'Tim', 'Laura']
                    },

                    yAxis: {
                        categories: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'],
                        title: null
                    },

                    colorAxis: {
                        min: 0,
                        minColor: '#FFFFFF',
                        maxColor: Highcharts.getOptions().colors[0]
                    },

                    legend: {
                        align: 'right',
                        layout: 'vertical',
                        margin: 0,
                        verticalAlign: 'top',
                        y: 25,
                        symbolHeight: 280
                    },

                    tooltip: {
                        formatter: function () {
                            return '<b>' + this.series.xAxis.categories[this.point.x] + '</b> sold <br><b>' +
                                    this.point.value + '</b> items on <br><b>' + this.series.yAxis.categories[this.point.y] + '</b>';
                        }
                    },

                    series: [{
                        name: 'Sales per employee',
                        borderWidth: 1,
                        data: [[0, 0, 10], [0, 1, 19], [0, 2, 8], [0, 3, 24], [0, 4, 67], [1, 0, 92], [1, 1, 58], [1, 2, 78], [1, 3, 117], [1, 4, 48], [2, 0, 35], [2, 1, 15], [2, 2, 123], [2, 3, 64], [2, 4, 52], [3, 0, 72], [3, 1, 132], [3, 2, 114], [3, 3, 19], [3, 4, 16], [4, 0, 38], [4, 1, 5], [4, 2, 8], [4, 3, 117], [4, 4, 115], [5, 0, 88], [5, 1, 32], [5, 2, 12], [5, 3, 6], [5, 4, 120], [6, 0, 13], [6, 1, 44], [6, 2, 88], [6, 3, 98], [6, 4, 96], [7, 0, 31], [7, 1, 1], [7, 2, 82], [7, 3, 32], [7, 4, 30], [8, 0, 85], [8, 1, 97], [8, 2, 123], [8, 3, 64], [8, 4, 84], [9, 0, 47], [9, 1, 114], [9, 2, 31], [9, 3, 48], [9, 4, 91]],
                        dataLabels: {
                            enabled: true,
                            color: '#000000'
                        }
                    }]

                });
            },

            _drawContinuousContinuous: function(v1, v2, data) {
                let myData = [];
                data.result.forEach(function(entry) {
                    // TODO: Loop only over the corresponding annotation set
                    let annotationSet = entry.annotationSets[0];
                    let value1 = -1;
                    let value2 = -1;
                    annotationSet.annotations.forEach(function(annotation) {
                        if (annotation.name === v1.name) {
                            value1 = annotation.value;
                        }
                        if (annotation.name === v2.name) {
                            value2 = annotation.value;
                        }
                    });

                    if (value1 !== -1 && value2 !== -1) {
                        myData.push([value1, value2]);
                    }
                });

                $('#' + this.prefix + 'chart').highcharts({
                    chart: {
                        type: 'scatter',
                        zoomType: 'xy'
                    },
                    title: {
                        text: v1.name + " vs " + v2.name
                    },
                    subtitle: {
                        text: myData.length + " out of " + data.numResults + " annotations"
                    },
                    xAxis: {
                        title: {
                            enabled: true,
                            text: v1.name
                        },
                        startOnTick: true,
                        endOnTick: true,
                        showLastLabel: true
                    },
                    yAxis: {
                        title: {
                            text: v2.name
                        }
                    },
                    plotOptions: {
                        scatter: {
                            marker: {
                                radius: 5,
                                states: {
                                    hover: {
                                        enabled: true,
                                        lineColor: 'rgb(100,100,100)'
                                    }
                                }
                            },
                            states: {
                                hover: {
                                    marker: {
                                        enabled: false
                                    }
                                }
                            },
                            tooltip: {
                                headerFormat: '<b>{series.name}</b><br>',
                                pointFormat: '{point.x} - {point.y}'
                            }
                        }
                    },
                    series: [{
                        name: v1.name + " vs " + v2.name,
                        color: 'rgba(119, 152, 191, .5)',
                        data: myData
                    }]
                });
            }

        });
    </script>
</dom-module>
