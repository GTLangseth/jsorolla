<link rel="import" href="../opencga/variant/variant-browser-grid.html">

<dom-module id="opencga-protein-view">
    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style>
            .variant-tab-title {
                font-size: 150%;
                font-weight: bold;
            }
            div.block {
                overflow:hidden;
                width: 100%
            }
            .align-left {
                width:25%;
                display:block;
                float:left;
                text-align:left;
            }
            .align-right {
                width:75%;
                display:block;
                float:left;
                text-align:left;
            }
        </style>

        <div>
            <div style="float: right;padding: 10px 5px 10px 5px">
                <button type="button" class="btn btn-primary" on-click="showBrowser">
                    <i class="fa fa-hand-o-left" aria-hidden="true"></i> Variant Browser</button>
            </div>

            <h2>{{protein}}</h2>

            <div class="row" style="padding: 5px 0px 25px 0px">
                <div class="col-md-5">
                    <h3>Summary</h3>
                    <div class="block">
                        <label class="align-left">Name</label>
                        <div class="align-right">
                            <template is="dom-repeat" items="{{proteinObj.name}}">
                                {{item}}<br>
                            </template>
                        </div> <br>
                    </div>
                    <div class="block">
                        <label class="align-left">Recommended Name</label>
                        <div class="align-right">{{proteinObj.protein.recommendedName.fullName.value}}
                        </div> <br>
                    </div>
                    <div class="block">
                        <label class="align-left">Accession</label>
                        <div class="align-right">
                            <template is="dom-repeat" items="{{proteinObj.accession}}">
                                {{item}}
                                <template is="dom-if" if="{{!checkLastItem(proteinObj.accession, item)}}">
                                    ,
                                </template>
                            </template>
                        </div> <br>
                    </div>
                    <div class="block">
                        <label class="align-left">Gene</label>
                        <div class="align-right">
                            <template is="dom-repeat" items="{{proteinObj.gene}}" as="gene">
                                <template is="dom-repeat" items="{{gene.name}}" filter="checkPrimary">
                                    {{item.value}}<br>
                                </template>
                            </template>
                        </div> <br>
                    </div>
                    <div class="block">
                        <label class="align-left">Keywords</label>
                        <div class="align-right">
                            <template is="dom-repeat" items="{{proteinObj.keyword}}">
                                {{item.value}}
                                <template is="dom-if" if="{{!checkLastItem(proteinObj.keyword, item)}}">
                                    ,
                                </template>
                            </template>
                        </div> <br>
                    </div>
                    <div class="block">
                        <label class="align-left">Sequence</label>
                        <div class="align-right">
                            <textarea class="form-control" rows="3" readonly>{{proteinObj.sequence.value}}</textarea>
                        </div> <br>
                    </div>
                    <div class="block">
                        <label class="align-left">Sequence Length</label>
                        <div class="align-right">{{proteinObj.sequence.length}}
                        </div> <br>
                    </div>
                </div>

                <!--<div class="col-md-7">-->
                    <!--ChemDoodle goes here!!-->
                <!--</div>-->
            </div>

            <!--SVG-->
            <div id="{{prefix}}ProteinSvgDiv">
            </div>
        </div><br>

        <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#{{prefix}}Variants" role="tab" data-toggle="tab" class="variant-tab-title">Variants</a></li>
        </ul>

        <div class="tab-content" style="height: 1024px">
            <div role="tabpanel" class="tab-pane active" id="{{prefix}}Variants">
                <div class="btn-group btn-group" role="group" aria-label="..." style="padding: 15px;float: right">
                    <button type="button" class="btn btn-default btn-warning" on-click="updateQuery">All</button>
                    <button type="button" class="btn btn-default btn-warning" on-click="updateQuery">Missense</button>
                    <button type="button" class="btn btn-default btn-warning" on-click="updateQuery">LoF</button>
                </div>

                <br>
                <br>
                <variant-browser-grid project="{{project}}" study="{{study}}" opencga-client="{{opencgaClient}}"
                                      population-frequencies="{{populationFrequencies}}" protein-substitution-scores="{{proteinSubstitutionScores}}"
                                      consequence-types="{{consequenceTypes}}" search="{{query}}" query="{{query}}" variant="{{variant}}"
                                      on-selectvariant="onSelectVariant" style="font-size: 12px" summary="{{summary}}">
                </variant-browser-grid>

                <div hidden$="{{checkVariant(variant)}}">
                    <br>
                    <h3>Please select a variant to view variant's detailed annotation</h3>
                </div>

                <!-- Bottom tabs with specific variant information -->
                <div style="padding-top: 20px; height: 400px" hidden$="{{!checkVariant(variant)}}">
                    <h3>Advanced Annotation for Variant: {{variant}}</h3>
                    <cellbase-variantannotation-view data="{{variant}}" prefix="{{prefix}}" cellbase-client="{{cellbaseClient}}" hash-fragment-credentials="{{hashFragmentCredentials}}"
                                                     style="font-size: 12px" population-frequencies="{{populationFrequencies}}" protein-substitution-scores="{{proteinSubstitutionScores}}"
                                                     consequence-types="{{consequenceTypes}}"></cellbase-variantannotation-view>
                </div>
            </div>

        </div>

        </div>
    </template>
    <script>
        Polymer({
            is: 'opencga-protein-view',
            properties: {
                cellbaseClient: {
                    type: Object
                },
                opencgaClient: {
                    type: Object
                },
                project: {
                    type: Object
                },
                study: {
                    type: Object
                },
                protein: {
                    type: String,
                    observer: "_proteinChanged"
                },
                populationFrequencies: {
                    type: Array
                },
                proteinSubstitutionScores: {
                    type: Object
                },
                consequenceTypes: {
                    type: Object
                },
                variant: {
                    type: String,
                    value: ""
                },
                config: {
                    type: Object
                },
                summary: {
                    type: Boolean
                }
            },
            observers: [
                'projectStudyObtained(project, study)'
            ],
            ready: function () {
                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "protein" + Utils.randomString(6);
                }
            },
            projectStudyObtained: function (project, study) {
                if (typeof this.project !== "undefined" && this.project.alias !== "" && typeof this.study !== "undefined" && this.study.alias !== "") {
                    this.hashFragmentCredentials = {
                        project: this.project.alias,
                        study: this.study.alias
                    }
                }
            },
            checkPrimary: function (item) {
                if (item.type == "primary") {
                    return true;
                }
            },
            checkLastItem: function (array, item) {
                if (array[array.length-1] === item) {
                    return true;
                }
            },
            _proteinChanged: function () {
                // Remove the previously added SVG
                let svg = Polymer.dom(this.root).querySelector("svg");
                if (svg !== null) {
                    let proteinSvgDiv = Polymer.dom(this.root).querySelector("#" + this.prefix + "ProteinSvgDiv");
                    proteinSvgDiv.removeChild(svg);
                }

                let query = {};
                let _this = this;
                if (this.cellbaseClient instanceof CellBaseClient && typeof this.protein !== "undefined" && this.protein !== "") {
                    query["annot-xref"] = this.protein; // Query object that is passed to Variant browser grid
                    _this.cellbaseClient.getProteinClient(this.protein, 'info', {}, {})
                        .then(function (response) {
                            _this.proteinObj = response.response[0].result[0];

                            if (typeof _this.proteinObj !== "undefined" && typeof _this.project !== "undefined" && typeof _this.study !== "undefined" && typeof _this.study.alias !== "undefined") {
                                let params = {
//                                    "annot-xref": _this.protein,
                                    // TODO remove below gene and give proper query param
                                    gene: _this.proteinObj.gene[0].name[0].value,
                                    "annot-ct": "missense_variant,transcript_ablation,splice_acceptor_variant,splice_donor_variant,stop_gained,frameshift_variant,stop_lost,start_lost," +
                                    "transcript_amplification,inframe_insertion,inframe_deletion",
                                    studies: _this.project.alias + ":" + _this.study.alias, returnedStudies: _this.project.alias + ":" + _this.study.alias,
                                    summary: _this.summary,
                                    exclude: "studies.samplesData,studies.files"};
                                _this.opencgaClient.variants().query(params)
                                    .then(function (variants) {
                                        let lollipop = new Lollipop();
                                        let svgSettings = {
                                            width: _this.proteinObj.sequence.length,
                                            height: 140,
                                            proteinPositioningInterval: 3,
                                            color: _this.config.color
                                        };
                                        let svg = lollipop.createSvg(_this.proteinObj, variants.response[0].result, svgSettings);
                                        let querySelector = Polymer.dom(_this.root).querySelector("#" + _this.prefix + "ProteinSvgDiv");
                                        querySelector.appendChild(svg);
                                    }).catch(function (e) {
                                    console.log(e);
                                });
                            }
                        });
                    _this.query = query;
                }
            },
            updateQuery: function (e) {
                let query = this.query;
                switch (e.target.textContent) {
                    case "Missense":
                        query["annot-ct"] = "missense_variant";
                        break;
                    case "LoF":
                        query["annot-ct"] = "transcript_ablation,splice_acceptor_variant,splice_donor_variant,stop_gained,frameshift_variant," +
                            "stop_lost,start_lost,transcript_amplification,inframe_insertion,inframe_deletion";
                        break;
                    default:
                        if (typeof query["annot-ct"] !== "undefined") {
                            delete query["annot-ct"];
                        }
                        break;
                }
                this.query = Object.assign({}, query);
            },
            checkVariant: function(variant) {
                return variant.split(':').length > 2;
            },
            showBrowser: function () {
                let hash = window.location.hash.split('/');
                let newHash = '#browser/' + hash[1] + '/' + hash[2];
                window.location.hash = newHash;
            },
            onSelectVariant: function(e) {
                this.variant = e.detail.id;
//                this.V = e.detail.variant;
//                this.display3D();
            }
        });
    </script>
</dom-module>