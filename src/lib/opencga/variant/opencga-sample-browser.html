<dom-module id="opencga-sample-browser">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div>
            <!--Different views: List, File, Cohort -->
            <div class="btn-group sample-browser-menu">
                <a class="btn btn-default" href="#sampleGridView">
                    <i class="fa fa-list" title="List of Samples"></i>
                </a>
                <a class="btn btn-default" href="#fileTreeView">
                    <i class="fa fa-folder-open" title="View by Files"></i>
                </a>
                <a class="btn btn-default" href="#">
                    <i class="fa fa-sitemap" title="View by Cohorts"></i>
                </a>
            </div>

            <!--Sample Grid-->
            <div style="padding: 10px;" id="sampleGridView" class="hide-content">
                <table id="sampleGrid" data-search="true" data-show-columns="true" data-pagination="true" data-page-list="[10, 25, 50]"
                       data-show-pagination-switch="true" data-show-export="true">

                </table>
            </div>
            <!--File Tree-->
            <div id="fileTreeView" class="collapse hide-content">
                Tree
                <div id="fileTree"></div>

            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'opencga-sample-browser',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: String,
                    observer: 'fetchSamples'
                },
                samples: {
                    type: Array,
                    value: [],
                    notify: true
                }
            },
            ready: function () {
                this.cols = [
                    [
                        {
                            field: 'state',
                            checkbox: true
                        },
                        {
                            title: 'Name',
                            field: 'name',
                            sortable: true
                        },
                        {
                            title: 'Source',
                            field: 'source'
                        },
                        {
                            title: 'Creation Date',
                            formatter: this.dateFormatter,
                            sortable: true
                        }
                    ]
                ];
            },
            attached: function() {
                $(".sample-browser-menu a").on('click', function(e) {
                    e.preventDefault(); // stops link form loading
                    $('.hide-content').hide(); // hides all content divs
                    $($(this).attr('href')).show(); //get the href and use it find which div to show
                });
            },
            fetchSamples: function () {
                let _this = this;
                if (this.opencgaClient instanceof OpenCGAClient && typeof this.study !== "undefined") {

                    // Bootstrap grid
                    this._url = 'http://' + this.opencgaClient.getConfig().host + '/webservices/rest/v1/studies/' + this.study + '/samples';
                    let _numTotal = -1;
                    $('#sampleGrid').bootstrapTable('destroy');
                    $('#sampleGrid').bootstrapTable({
                        url: this._url,
                        method: 'get',
                        sidePagination: 'server',
                        queryParams: function (params) {
                            return {
                                limit: params.limit,
                                skip: params.offset,
                                sid: _this.opencgaClient._config.sessionId
                            };
                        },
                        responseHandler: function (res) {
                            if (_numTotal == -1) {
                                _numTotal = res.response[0].numTotalResults;
                            }
                            return {total: _numTotal, rows: res.response[0].result}
                        },
                        columns: this.cols
                    });
                    $('#sampleGrid').bootstrapTable('showLoading');

                    // Getting the selected samples through onCheck event of bootstrap table and passing to the filter
                    $('#sampleGrid').on('check.bs.table uncheck.bs.table check-all.bs.table uncheck-all.bs.table ' +
                            'check-some.bs.table uncheck-some.bs.table' , function () {
                        _this.samples = _this.getSampleName();
                    });

                    // Bootstrap Tree View
                    let studyFiles = [];
                    this.opencgaClient.studies().files(this.study).then(function (response) {
                        studyFiles = response.response[0].result;
                        $('#fileTree').treeview({
                            data: _this.getTree(studyFiles)
                        });
                    });
                }
            },
            getSampleName: function () {
                return $.map($('#sampleGrid').bootstrapTable('getSelections'), function (row) {
                    return row.name
                });
            },
            dateFormatter: function (value, row, index) {
                return row.status.date;
                // TODO convert date to UTC string
            },
            getTree: function (studyFiles) {
                let data = [];
                for (let i=0; i<studyFiles.length; i++) {
                    let obj = {};
                    obj.text = studyFiles[i].name;
                    // TODO Two level heirarchy is achieved and yet the data load is so heavy. Need to find a way to load data dynamically
//                    let nodes = [];
//                    for (let j=0; j<studyFiles[i].sampleIds.length; j++) {
//                        let child = {};
//                        child.text = studyFiles[i].sampleIds[j];
//                        nodes.push(child);
//                    }
//                    obj.nodes = nodes;
                    data.push(obj);
                }
                return data;
            }
        });
    </script>
</dom-module>
