<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<dom-module id="variant-analysis-samples">
    <template>
        <style is="custom-style" include="jso-styles">
            .top-space {
                padding-top: 12px;
            }
        </style>

        <!-- This is where main application is rendered -->

        <div>
            <div class="col-md-12">
                <h3>Create Analysis</h3>
                <br>
            </div>
            <div class="col-md-2">
                <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">
                    <!--Sample name-->
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="{{prefix}}SampleGeneralFilterHeading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                                   href="#{{prefix}}General" aria-expanded="true" aria-controls="{{prefix}}General">
                                    Sample Characteristics
                                    <div style="float: right" class="tooltip-div">
                                        <a data-toggle="tooltip" title="Generic sample filters">
                                            <i class="fa fa-info-circle" aria-hidden="true"></i>
                                        </a>
                                    </div>
                                </a>
                            </h4>
                        </div>
                        <div id="{{prefix}}SampleGeneralFilter" class="panel-collapse" role="tabpanel" aria-labelledby="{{prefix}}SampleGeneralFilterHeading">
                            <div class="form-group has-feedback panel-body">
                                <label>Hospital:</label>
                                <input type="text" class="form-control" placeholder="Username" aria-describedby="basic-addon1">

                                <label class="top-space">Sample name:</label>
                                <textarea id="{{prefix}}NameTextarea" class="form-control clearable" rows="3"
                                          placeholder="HG01879, HG01880, HG01881..."
                                          name="name" on-keyup="calculateFilters"></textarea>

                                <label class="top-space">Clinical record number:</label>
                                <textarea id="{{prefix}}IndividualTextarea" class="form-control clearable" rows="3"
                                          placeholder="Smith, Grant ..."
                                          name="individual" on-keyup="calculateFilters"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-10">
                <div id="{{prefix}}toolbar">
                    <button type="button" class="btn btn-warning" data-toggle="popover" data-placement="bottom" on-click="_shareLink">
                        <i class="fa fa-upload" aria-hidden="true"></i> Recently uploaded
                    </button>

                    <button type="button" class="btn btn-warning" data-toggle="popover" data-placement="bottom" on-click="_shareLink">
                        <i class="fa fa-users" aria-hidden="true"></i> All Samples
                    </button>

                    <button type="button" class="btn btn-warning" data-toggle="popover" data-placement="bottom" on-click="_shareLink">
                        <i class="fa fa-users" aria-hidden="true"></i> Controls
                    </button>
                </div>

                <table id="{{prefix}}SampleSelector" data-search="true" data-show-columns="true" data-pagination="true" data-page-size="5" data-page-list="[5, 10, 25]"
                       data-checkbox-header="false" data-maintain-selected="true" style="cursor: pointer;">
                    <thead style="background-color: #eee"></thead>
                </table>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'variant-analysis-samples',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Object,
                    observer: 'renderFromServer'
                },
                samples: {
                    type: Array,
                    notify: true
                },
                prefix: {
                    type: String
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = Utils.randomString(6);
                }

                // Columns that will be represented
                this._columns = [
                    [
                        {
                            title: 'Name',
                            field: 'name',
                            sortable: true
                        },
                        {
                            title: 'Proband',
                            field: 'proband',
                            formatter: this.probandFormatter
                        },
                        {
                            title: 'Gender',
                            field: 'gender'
                        },
                        {
                            title: 'Father',
                            field: 'father'
                        },
                        {
                            title: 'Mother',
                            field: 'mother'
                        }
                    ]
                ];

                this.renderFromServer();
            },
            renderFromServer: function () {
                let filters = this.search;

//                console.log(this.opencgaClient)
//                console.log(this.studyId)
//debugger
                this._samples = [];
                let _this = this;
                if (typeof this.opencgaClient != "undefined" && this.opencgaClient instanceof OpenCGAClient && this.study.id > 0) {

                    if (this.opencgaClient.getConfig().host.startsWith("https://")) {
                        this._url = this.opencgaClient.getConfig().host;
                    } else {
                        this._url = 'http://' + this.opencgaClient.getConfig().host;
                    }

                    this._url = this._url + '/webservices/rest/v1/samples/search';
                    $('#' + this.prefix + "SampleSelector").bootstrapTable('destroy');
                    $('#' + this.prefix + "SampleSelector").bootstrapTable({
                        url: this._url,
                        sidePagination: 'server',
                        queryParams: function (params) {
                            let auxParams = {
                                studyId: _this.study.id,
                                sid: Cookies.get(_this.opencgaClient.getConfig().cookieSessionId),
                                order: params.order,
                                sort: params.sort,
                                limit: params.limit,
                                skip: params.offset
                            };
//                            if (params.search !== undefined && params.search.length > 0) {
//                                auxParams["name"] = "~" + params.search;
//                            }
                            return $.extend({}, filters, auxParams);
                        },
                        responseHandler: function (response) {
                            if (!_this.hasOwnProperty("numTotalResults")) {
                                _this.numTotalResults = 0;
                            }
                            if (_this.numTotalResults !== response.response[0].numTotalResults
                                && response.response[0].numTotalResults > response.queryOptions.limit) {
                                _this.numTotalResults = response.response[0].numTotalResults;
                            }

                            return {
                                total: _this.numTotalResults,
                                rows: response.response[0].result
                            }
                        },
                        columns: this._columns,

                        onClickRow: function (row, element) {
                            let index = element[0].getAttribute("data-index");
                            if (row.state) {
                                $('#samplestable').bootstrapTable('uncheck', index);
                            } else {
                                $('#samplestable').bootstrapTable('check', index);
                            }
                        },

                        onCheck: function (row, elem) {
                            _this.push("_samples", row);
                            _this.set('samples', _this._samples.slice());

                            // Map each sample to its associated individual
                            if (typeof row.individual !== "undefined" && typeof row.individual.id !== "undefined"
                                && row.individual.id != "-1") {
                                if (typeof _this.individuals[row.individual.id] === "undefined") {
                                    _this.individuals[row.individual.id] = [row];
                                } else {
                                    _this.individuals[row.individual.id].push(row);
                                }
                            }
                        },

                        onUncheck: function (row, elem) {
                            let sampleToDeleteIdx;
                            for (let sampleIdx in _this.samples) {
                                if (row.name == _this.samples[sampleIdx].name) {
                                    sampleToDeleteIdx = sampleIdx;
                                    break;
                                }
                            }
                            if (typeof row.individual !== "undefined" && typeof row.individual.id !== "undefined"
                                && row.individual.id != "-1") {
                                if (row.individual.id in  _this.individuals) {
                                    let samples = _this.individuals[row.individual.id];
                                    for (let i in samples) {
                                        if (row.name == samples[i].name) {
                                            samples.splice(i, 1);
                                            break;
                                        }
                                    }
                                    _this.individuals[row.individual.id] = samples;
                                }
                            }

                            _this.splice('_samples', sampleToDeleteIdx, 1);
                            _this.set('samples', _this.samples.slice());
                        }
                    });

//                    this.opencgaClient.studies().info(this.study.id)
//                        .then(function (response) {
//                            _this.variableSets = response.response[0].result[0].variableSets;
//                        })
//                        .catch(function () {
//                            console.log("Could not obtain the variable sets of the study " + _this.study.id);
//                        });
                } else {
                    // Delete table
                    $('#fileTable').bootstrapTable('destroy');
                    this.numTotalResults = 0;
                }
            },
            probandFormatter: function () {
                return '<input type="checkbox">';
            },
        });
    </script>
</dom-module>