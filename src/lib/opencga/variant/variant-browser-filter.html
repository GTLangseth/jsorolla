<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../../../../../../src/components/opencga-sample-browser.html">
<link rel="import" href="opencga-family-selector.html">
<link rel="import" href="opencga-analysis-selector.html">

<dom-module id="variant-browser-filter">
    <template>
        <style is="custom-style" include="jso-styles">
            .popFreqName {
                font-size: 12px;
                color: #797979;
            }

            .custom-sized-input {
                max-width: 60px;
                height: 20px;
            }

            span + span {
                margin-left: 10px;
            }

            .ct-scroll {
                max-height: 450px;
                overflow-y: scroll;
            }

            .ct-tree-view,
            .ct-tree-view * {
                padding: 0;
                margin: 0;
                list-style: none;
            }

            .ct-tree-view li ul {
                margin: 0 0 0 22px;
            }

            .ct-tree-view * {
                vertical-align: middle;
            }

            .ct-tree-view {
                font-size: 14px;
            }

            .ct-tree-view input[type="checkbox"] {
                cursor: pointer;
            }

            .ct-item {
                white-space: nowrap;
                display:inline
            }

            div.block {
                overflow:hidden;
            }

            div.block label {
                width:80px;
                display:block;
                float:left;
                text-align:left;
                font-weight: normal;
            }

            select + select {
                margin-left: 10px;
            }

            select + input {
                margin-left: 10px;
            }

            .subsection {
                padding: 5px 0px 5px 0px;
                font-weight: bold;
            }
        </style>

        <div>
            <br>
            <div style="width: 60%;margin: 0 auto">
                <button type="button" class="btn btn-primary" style="width: 100%" on-click="onSearch">
                    <i class="fa fa-search" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                    Search
                </button>
            </div>
            <br>

            <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">

                <template is="dom-if" if="{{isAnalysisMode}}">

                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="{{prefix}}SampleAnalysisHeading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}AnalysisSelector"
                                   aria-expanded="true" aria-controls="{{prefix}}AnalysisSelector">
                                    Analysis
                                </a>
                            </h4>
                        </div>

                        <div id="{{prefix}}AnalysisSelector" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleFilterHeading">
                            <div class="panel-body">
                                <label><i class="fa fa-sitemap" aria-hidden="true"></i>Select analysis:</label>
                                <br>
                                <button data-toggle="modal" role="button" data-placement="bottom" data-target$="#{{prefix}}AnalysisBrowser">
                                    Browse...
                                </button>
                                <div id="analysisSelectedDiv" style="display:none">
                                    <label>Analysis selected:</label>
                                    <input type="text" class$="custom-sized-input {{prefix}}FilterTextInput" placeholder="AN-28" aria-describedby="basic-addon1" disabled>
                                </div>

                                <div class="dropdown" id="segregationDropdownDiv" style="display: none">
                                    <button class="btn btn-default btn-sm dropdown-toggle" type="button" id="segregationDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        {{segregation}}
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="segregationDropdown" on-click="selectSegregation">
                                        <template is="dom-repeat" items="{{config.segregation}}">
                                            <li><a>{{item}}</a></li>
                                        </template>
                                    </ul>
                                </div>

                            </div>
                        </div>
                    </div>
                </template>


                <!--Exclusive for Prioritization-->
                <template is="dom-if" if="{{isPrioritizationMode}}">
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="{{prefix}}SampleFilterHeading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}SampleFilter"
                                   aria-expanded="true" aria-controls="{{prefix}}SampleFilter">
                                    Analysis
                                </a>
                            </h4>
                        </div>
                        <div id="{{prefix}}SampleFilter" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleFilterHeading">
                            <div class="panel-body">

                                <form>
                                    <label>Select Analysis: </label>
                                    <br>
                                    <input type="radio" name="analysisRadioButtons" id="familyRadio" value="family" class$="{{prefix}}FilterRadio" checked on-change="selectAnalysisType" style="padding-left: 20px"> Family<br>
                                    <input type="radio" name="analysisRadioButtons" id="cancerRadio" value="cancer" class$="{{prefix}}FilterRadio" on-change="selectAnalysisType" style="padding-left: 20px"> Cancer<br>
                                </form>
                                <br>

                                <template is="dom-if" if="{{isFamilyAnalysis}}">
                                    <label><i class="fa fa-sitemap" aria-hidden="true"></i> Family Analysis</label>
                                    <br>
                                    <span>Select samples: &nbsp;
                                        <button data-toggle="modal" role="button" data-placement="bottom" data-target$="#{{prefix}}SampleBrowser" on-click="refreshSegregationTable">
                                            Browse...
                                        </button>
                                    </span>
                                    <br>
                                    <br>
                                    <div class="dropdown">
                                        <span>Inheritance mode: &nbsp;
                                        <button class="btn btn-default btn-sm dropdown-toggle" type="button" id="segregationPrioritizationDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                            {{segregation}}
                                            <span class="caret"></span>
                                        </button>
                                        <ul class="dropdown-menu" aria-labelledby="segregationPrioritizationDropdown" on-click="selectSegregation">
                                            <!--                  <li><a>Autosomal Dominant</a></li>
                                                              <li><a>Autosomal Recessive</a></li>
                                                              <li><a>Compound Heterozygotous</a></li>
                                                              <li><a>Recessive X-linked</a></li>-->
                                            <template is="dom-repeat" items="{{config.segregation}}">
                                                <li><a>{{item}}</a></li>
                                            </template>
                                        </ul>
                                        </span>
                                    </div>

                                    <!--<span>Sample Genotypes:</span>-->
                                    <table class="table table-hover" id="segregationTable">
                                        <thead>
                                        <tr>
                                            <th>Sample</th>
                                            <th>0/0</th>
                                            <th>0/1</th>
                                            <th>1/1</th>
                                            <th>./.</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <template is="dom-repeat" items="{{samples}}" as="sample">
                                            <tr id="{{item.name}}" on-click="sampleGenotypeSelected">
                                                <td class$="{{item.status}}">{{sample.name}}&nbsp;({{sample.memberCode}})</td>
                                                <td><input type="checkbox" value="0/0" data-id="{{sample.name}}" on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"></td>
                                                <td><input type="checkbox" value="0/1" data-id="{{sample.name}}" on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"></td>
                                                <td><input type="checkbox" value="1/1" data-id="{{sample.name}}" on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"></td>
                                                <td><input type="checkbox" value="./." data-id="{{sample.name}}" on-change="updateQueryFilters" class$="genotypes {{prefix}}FilterCheckBox"></td>
                                            </tr>
                                        </template>
                                        </tbody>
                                    </table>
                                </template>

                                <template is="dom-if" if="{{isCancerAnalysis}}">
                                    <label><i class="fa fa-user-times" aria-hidden="true"></i> Cancer Analysis</label>
                                    <br>
                                    Not ready yet.
                                </template>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Studies filter -->
                <template is="dom-if" if="{{isBrowserMode}}">
                    <template is="dom-if" if="{{moreStudiesPresent(studies) && cohorts}}">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="{{prefix}}StudiesHeading">
                                <h4 class="panel-title">
                                    <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                                       href="#{{prefix}}Studies" aria-expanded="true" aria-controls="{{prefix}}Studies">
                                        Study
                                        <div style="float: right" class="tooltip-div">
                                            <a data-toggle="tooltip" title="Use this filter to find variants which are: 1) also present in all of the selected studies below, 2) not present in any of the studies selected below or 3) present in at least one of the studies selected below"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                        </div>
                                    </a>
                                </h4>
                            </div>
                            <div id="{{prefix}}Studies" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}StudiesHeading">
                                <div class="panel-body">
                                    <template is="dom-if" if="{{cohorts}}">
                                        <span class="subsection">Cohort MAF filter</span>
                                        <template is="dom-repeat" items="{{cohorts}}" as="cohort">
                                            <div class="horizontal layout" style="padding: 4px 0px 4px 0px">
                                                <span>{{cohort}}</span>
                                                <span>
                                                <select name="{{cohort}}Operator" id="{{prefix}}{{study.id}}{{cohort}}Operator" on-change="updateQueryFilters"  class$="{{prefix}}FilterSelect">
                                                    <option value="<" selected><</option>
                                                    <option value="<="><=</option>
                                                    <option value=">">></option>
                                                    <option value=">=">>=</option>
                                                </select>
                                            </span>
                                                <span>
                                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" name="{{study.id}}_{{cohort}}" id="{{prefix}}{{study.id}}{{cohort}}" on-keyup="updateQueryFilters">
                                            </span>
                                            </div>
                                        </template>
                                        <br>
                                    </template>

                                    <template is="dom-if" if="{{moreStudiesPresent(studies)}}">
                                        <span class="subsection">Studies filter</span>
                                        <select class$="form-control {{prefix}}FilterSelect" id="includeOtherStudy" style="width: 50%;" on-change="updateQueryFilters">
                                            <option value="in" selected>In</option>
                                            <option value="not in">Not In</option>
                                            <option value="atleast">At least</option>
                                        </select>
                                        <div id="differentStudies">
                                            <template is="dom-repeat" items="{{differentStudies}}">
                                                <input type="checkbox" value="{{item.alias}}" data-id="{{item.id}}" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> {{item.alias}}<br>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </template>

                <br>
                <!-- Region filter -->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}PositionHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                               href="#{{prefix}}Position" aria-expanded="true" aria-controls="{{prefix}}Position">
                                Genomic
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Introduce a region interval and/or gene/variant ids.
                                    The filter will allow variants which fall within provided genomic intervals OR match the ids provided">
                                        <i class="fa fa-info-circle" aria-hidden="true"></i>
                                    </a>
                                </div>
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}Position" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}PositionHeading">
                        <div class="panel-body">
                            <span class="subsection">Location</span>
                            <textarea id="{{prefix}}LocationTextarea" class$="form-control clearable {{prefix}}FilterTextInput"
                                      rows="3" placeholder="2, 12:27916206, 1:100-1000000" name="location" on-keyup="updateQueryFilters"></textarea>

                            <br>
                            <span class="subsection">Feature IDs (gene, SNP, ClinVar, ...)</span>
                            <textarea id="{{prefix}}FeatureTextarea" class$="form-control clearable {{prefix}}FilterTextInput"
                                      rows="3" placeholder="BRCA2, ENSG00000139618, ENST00000544455, rs28897700" name="geneSnp" on-keyup="updateQueryFilters"></textarea>

                            <!--<br>-->
                            <!--<span class="subsection">Gene Panels</span>-->
                            <!--<input type="checkbox" value="" class$="{{prefix}}FilterCheckBox"> With / Without dbSNP rs IDs<br>-->
                        </div>
                    </div>
                </div>

                <!--Variant Type filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}TypeHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}Type" aria-expanded="false" aria-controls="{{prefix}}Type">
                                Type
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}Type" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}TypeHeading">
                        <div class="panel-body">
                            <div>
                                <input type="checkbox" value="SNV,SNP" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> SNV<br>
                                <input type="checkbox" value="MNV" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> MNV<br>
                                <input type="checkbox" value="CNV" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> CNV<br>
                                <input type="checkbox" value="SV" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> SV<br>
                                <input type="checkbox" value="INDEL" on-change="updateQueryFilters" class$="{{prefix}}FilterCheckBox"> INDEL
                            </div>
                        </div>
                    </div>
                </div>

                <!--Population Frequency filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}PopulationFrequencyHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                               href="#{{prefix}}PopulationFrequency" aria-expanded="false" aria-controls="{{prefix}}PopulationFrequency">
                                Population Frequency
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}PopulationFrequency" class="panel-collapse collapse" role="tabpanel"
                         aria-labelledby="{{prefix}}PopulationFrequencyHeading">
                        <div class="panel-body">

                            <!-- This code create the population frequencies menu filter form populationFrequencies from config.js -->
                            <template is="dom-repeat" items="{{populationFrequencies.studies}}" as="study">
                                <label style="font-weight: bold;"><i class="fa fa-plus" on-click="handleCollapseAction" data-id="{{prefix}}{{study.id}}" style="cursor: pointer;"></i>&nbsp;{{study.title}}</label>

                                <!-- If there is not submenu we just display a button -->
                                <template is="dom-if" if="{{study.populations}}">
                                    <div id="{{prefix}}{{study.id}}" hidden>
                                        <template is="dom-repeat" items="{{study.populations}}" as="popFreq">
                                            <label class="popFreqName">{{popFreq.title}}</label>
                                            <div class="horizontal layout">
                                                <span>MAF</span>
                                                <span>
                                                    <select name="{{popFreq.id}}Operator" id="{{prefix}}{{study.id}}{{popFreq.id}}Operator" on-change="updateQueryFilters"  class$="{{prefix}}FilterSelect">
                                                        <option value="<" selected><</option>
                                                        <option value="<="><=</option>
                                                        <option value=">">></option>
                                                        <option value=">=">>=</option>
                                                    </select>
                                                </span>
                                                <span>
                                                    <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" name="{{study.id}}_{{popFreq.id}}" id="{{prefix}}{{study.id}}{{popFreq.id}}" on-keyup="updateQueryFilters">
                                                </span>
                                            </div>
                                        </template>
                                    </div>
                                    <br>
                                </template>
                            </template>
                        </div>
                    </div>
                </div>

                <!--Protein Substitution Scores filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}}ProteinSubstitutionScoreHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}ProteinSubstitutionScore"
                               aria-expanded="false" aria-controls="{{prefix}}ProteinSubstitutionScore">
                                Deleteriousness
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}ProteinSubstitutionScore" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}ProteinSubstitutionScoreHeading">
                        <div class="panel-body">
                            <b>Protein Substitution Score</b>
                            <div style="padding-top: 10px">
                                <label style="font-weight: normal;">SIFT</label><br>
                                <select class="options" name="Sift" id="{{prefix}}SiftValues" style="width: 90px" on-change="checkScore" class$="{{prefix}}FilterSelect">
                                    <option value="score" selected>Score...</option>
                                    <option value="tolerated">Tolerated</option>
                                    <option value="deleterious">Deleterious</option>
                                </select>
                                <select name="siftOperator" id="{{prefix}}SiftOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}SiftInput" name="Sift" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Select None in the drop-down list on the left to enable the input of a specific SIFT score threshold. SIFT score takes values in the range [0, infinite[, the lower the values, the more damaging the prediction"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div><br>
                            <div>
                                <label style="font-weight: normal;">Polyphen</label><br>
                                <select class="options" name="Polyphen" id="{{prefix}}PolyphenValues" style="width: 90px" on-change="checkScore" class$="{{prefix}}FilterSelect">
                                    <option value="score" selected>Score...</option>
                                    <option value="benign">Benign</option>
                                    <option value="unknown">Unknown</option>
                                    <option value="possibly damaging">Possibly damaging</option>
                                    <option value="probably damaging">Probably damaging</option>
                                    <option value="possibly damaging,probably damaging">Possibly & Probably damaging</option>
                                </select>
                                <select name="polyphenOperator" id="{{prefix}}PolyphenOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}PolyphenInput" name="Polyphen" on-keyup="updateQueryFilters">

                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Select None in the drop-down list on the left to enable the input of a specific Polyphen score threshold. Polyphen score takes values in the range [0, 1[, the closer to 2, the more damaging the prediction"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                            <br>
                            <form>
                                <label style="font-weight: normal;">Logical Operator</label>
                                <input type="radio" name="pss" id="pssOrRadio" value="or" class$="{{prefix}}FilterRadio" checked disabled on-change="updateQueryFilters" style="margin-left: 10px"> OR<br>
                                <input type="radio" name="pss" id="pssAndRadio" value="and" class$="{{prefix}}FilterRadio" disabled on-change="updateQueryFilters" style="margin-left: 102px"> AND<br>
                            </form>
                            <br>

                            <b>CADD</b>
                            <div class="block" style="padding-top: 10px">
                                <label>Raw</label>
                                <select name="caddRawOperator" id="{{prefix}}CaddRawOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}CaddRawInput" name="caddRaw" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Raw values have relative meaning, with higher values indicating that a variant is more likely to be simulated (or not observed) and therefore more likely to have deleterious effects. If discovering causal variants within an individual, or small groups, of exomes or genomes te use of the scaled CADD score is recommended."><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                            <div class="block">
                                <label>Scaled</label>
                                <select name="caddRScaledOperator" id="{{prefix}}CaddScaledOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}CaddScaledInput" name="caddScaled" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="A scaled C-score of greater of equal 10 indicates that the substitution is predicted to be within the 10% most deleterious substitutions that you can do to the human genome, a score of greater or equal 20 indicates the 1% most deleterious and so on. If you would like to apply a cutoff on deleteriousness, it is suggested by the CADD authors to put a cutoff somewhere between 10 and 20. Maybe at 15, as this also happens to be the median value for all possible canonical splice site changes and non-synonymous variants"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--Conservation Scores filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}conservationFilterHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}ConservationFilter" aria-expanded="false" aria-controls="{{prefix}}ConservationFilter">
                                Conservation
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}ConservationFilter" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}conservationFilterHeading">
                        <div class="panel-body">
                            <div class="block">
                                <label>PhyloP</label>
                                <select name="phylopOperator" id="{{prefix}}PhylopOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}PhylopInput" name="phylop" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Positive PhyloP scores measure conservation which is slower evolution than expected, at sites that are predicted to be conserved. Negative PhyloP scores measure acceleration, which is faster evolution than expected, at sites that are predicted to be fast-evolving. Absolute values of phyloP scores represent -log p-values under a null hypothesis of neutral evolution"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                            <div class="block">
                                <label>PhastCons</label>
                                <select name="phastconsOperator" id="{{prefix}}PhastconsOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}PhastconsInput" name="phastCons" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="PhastCons estimates the probability that each nucleotide belongs to a conserved element. The phastCons scores represent probabilities of negative selection and range between 0 and 1."><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                            <div class="block">
                                <label>Gerp</label>
                                <select name="gerpOperator" id="{{prefix}}GerpOperator" on-change="updateQueryFilters" class$="{{prefix}}FilterSelect">
                                    <option value="<" selected><</option>
                                    <option value="<="><=</option>
                                    <option value=">">></option>
                                    <option value=">=">>=</option>
                                </select>
                                <input type="text" value="" class$="custom-sized-input {{prefix}}FilterTextInput" id="{{prefix}}GerpInput" name="gerp" on-keyup="updateQueryFilters">
                                <div style="float: right" class="tooltip-div">
                                    <a data-toggle="tooltip" title="Positive scores represent a substitution deficit (i.e., fewer substitutions than the average neutral site) and thus indicate that a site may be under evolutionary constraint. Negative scores indicate that a site is probably evolving neutrally. Some authors suggest that a score threshold of 2 provides high sensitivity while still strongly enriching for truly constrained sites"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                </div>
                            </div>
                            <form style="padding-top: 10px">
                                <label style="font-weight: normal;">Logical Operator</label>
                                <input type="radio" name="conservation" id="conservationOrRadio" value="or" class$="{{prefix}}FilterRadio" checked disabled on-change="updateQueryFilters" style="margin-left: 10px"> OR<br>
                                <input type="radio" name="conservation" id="conservationAndRadio" value="and" class$="{{prefix}}FilterRadio" disabled on-change="updateQueryFilters" style="margin-left: 102px"> AND<br>
                            </form>

                        </div>
                    </div>
                </div>

                <!--Consequence Type filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}ConsequenceTypeHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}ConsequenceType" aria-expanded="false" aria-controls="{{prefix}}ConsequenceType">
                                Consequence Type
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}ConsequenceType" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}consequenceTypeHeading">
                        <div class="panel-body ct-scroll">
                            <div class="ct-tree-view ct-item">
                                <ul id="consequenceTypeFilter">
                                    <template is="dom-repeat" items="{{consequenceTypes.categories}}" as="category">
                                        <li id="{{category.title}}">
                                            <!--First check if there is a title for that category-->
                                            <template is="dom-if" if="{{checkTitle(category)}}">
                                                <!--If it is a category, only title is shown as it doesn't have any SO term associated with it-->
                                                <template is="dom-if" if="{{category.isCategory}}">
                                                    <input type="checkbox" on-change="updateConsequenceTypeFilter" class$="{{prefix}}FilterCheckBox"> {{category.title}}
                                                </template>
                                                <!--If it is not a category, SO terms should be shown along with its actual title-->
                                                <template is="dom-if" if="{{!category.isCategory}}">
                                                    <input type="checkbox" on-change="updateConsequenceTypeFilter" data-id="{{category.name}}" class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                    <span title="{{item.description}}">
                                                        {{category.title}} (<a href="http://www.sequenceontology.org/browser/current_svn/term/{{category.id}}" target="_blank">{{category.id}}</a>)</span>
                                                </template>
                                            </template>
                                            <!--Title is optional. Consequence type name is taken in case title is not given-->
                                            <template is="dom-if" if="{{!checkTitle(category)}}">
                                                <!--If it is a category, only name is shown as it doesn't have any SO term associated with it-->
                                                <template is="dom-if" if="{{category.isCategory}}">
                                                    <input type="checkbox" on-change="updateConsequenceTypeFilter" class$="{{prefix}}FilterCheckBox"> {{category.name}}
                                                </template>
                                                <!--If it is not a category, SO terms should be shown along with its actual name-->
                                                <template is="dom-if" if="{{!category.isCategory}}">
                                                    <input type="checkbox" on-change="updateConsequenceTypeFilter" data-id="{{category.name}}" class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                    <span title="{{item.description}}">
                                                        {{category.name}} (<a href="http://www.sequenceontology.org/browser/current_svn/term/{{category.id}}" target="_blank">{{category.id}}</a>)</span>
                                                </template>
                                            </template>
                                            <ul>
                                                <template is="dom-repeat" items="{{category.terms}}">
                                                    <li><input type="checkbox" data-id="{{item.name}}" on-change="updateConsequenceTypeFilter" class$="soTermCheckBox {{prefix}}FilterCheckBox">
                                                        <span title="{{item.description}}">
                                                    {{item.name}} (<a href="http://www.sequenceontology.org/browser/current_svn/term/{{item.id}}" target="_blank">{{item.id}}</a>)</span></li>
                                                </template>
                                            </ul>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gene Ontology filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}GeneOntologyHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}GeneOntology" aria-expanded="false" aria-controls="{{prefix}}GeneOntology">
                                Gene Ontology
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}GeneOntology" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}GeneOntologyHeading">
                        <div class="panel-body">
                            <textarea id="{{prefix}}GeneOntologyTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="3"
                                      name="geneOntology" placeholder="GO:0000001, GO:0001177" on-keyup="updateQueryFilters"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Human Phenotype Ontology filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}HumanPhenotypeOntologyHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}HumanPhenotypeOntology" aria-expanded="false"
                               aria-controls="{{prefix}}HumanPhenotypeOntology">
                                Human Phenotype Ontology
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}HumanPhenotypeOntology" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}HumanPhenotypeOntologyHeading">
                        <div class="panel-body">
                            <textarea id="{{prefix}}HumanPhenotypeOntologyTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="3"
                                      name="hpo" placeholder="HP:0000001, HP:3000079" on-keyup="updateQueryFilters"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Human Phenotype Ontology filter-->
                <div class="panel panel-default">
                    <div class="panel-heading" role="tab" id="{{prefix}}TraitsHeading">
                        <h4 class="panel-title">
                            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}Traits" aria-expanded="false"
                               aria-controls="{{prefix}}HumanPhenotypeOntology">
                                Traits (New!)
                            </a>
                        </h4>
                    </div>
                    <div id="{{prefix}}Traits" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}TraitsHeading">
                        <div class="panel-body">
                            <textarea id="{{prefix}}TraitsTextarea" class$="form-control clearable {{prefix}}FilterTextInput" rows="3"
                                      name="traits" placeholder="Full text search, e.g. *melanoma*" on-keyup="updateQueryFilters"></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal dialog for Sample Browser in prioritization-->
        <div class="modal fade" id="{{prefix}}SampleBrowser" tabindex="-1" role="dialog"
             aria-labelledby="sampleBrowserLabel">
            <div class="modal-dialog modal-lg" role="document" style="width: 1024px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}SampleBrowserLabel">Family Selector</h4>
                    </div>
                    <div class="modal-body" style="height: 500px">
                        <opencga-family-selector opencga-client="{{opencgaClient}}" study-id="{{study.id}}" samples="{{samples}}" prefix="{{prefix}}"></opencga-family-selector>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal dialog for Analysis Browser-->
        <div class="modal fade" id="{{prefix}}AnalysisBrowser" tabindex="-1" role="dialog"
             aria-labelledby="sampleBrowserLabel">
            <div class="modal-dialog modal-lg" role="document" style="width: 1024px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}AnalysisBrowserLabel">Analysis Selector</h4>
                    </div>
                    <div class="modal-body" style="height: 500px">
                        <opencga-analysis-selector></opencga-analysis-selector>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" on-click="showSegregation">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'variant-browser-filter',
            properties: {
                project: {
                    type: Object
                },
                study: {
                    type: Object,
                    observer: 'updateDifferentStudies'
                },
                studies: {
                    type: Array,
                    observer: 'updateDifferentStudies'
                },
                opencgaClient: {
                    type: Object
                },
                cellbaseClient: {
                    type: Object
                },
                config: {
                    type: Object
                },
                populationFrequencies: {
                    type: Object
                },
                consequenceTypes: {
                    type: Object
                },
                mode: {
                    type: String,
                    value: "browser",
                    observer: '_updateMode'
                },
                query: {
                    type: Object,
                    notify: true,
                    observer: 'onQueryUpdate'
                },
                search: {
                    type: Object,
                    notify: true
                },
                samples: {
                    type: Array,
                    notify: true,
                    observer: "sampleChanged"
                },
                segregation: {
                    type: String,
                    value: "Select Segregation",
                    observer: "segregate"
                },
                prefix: {
                    type: String
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "browser" + Utils.randomString(6);
                }

                this.sampleGenotypesObj = {};
                this.query = {};

                this.isFamilyAnalysis = true;

            },
            onSearch: function () {
                this.search = this.query;
            },
            onQueryUpdate: function () {
                if (this._reset) {
                    console.log("onQueryUpdate: calling to 'renderQueryFilters()'")
                    this.renderQueryFilters();
                } else {
                    this._reset = true;
                }
            },
            handleCollapseAction: function (e) {
                let id = e.target.dataId;
                let elem = $('#' + id)[0];
                elem.hidden = !elem.hidden;
                if (elem.hidden) {
                    e.target.className = "fa fa-plus";
                } else {
                    e.target.className = "fa fa-minus";
                }
            },
            checkTitle: function(consequenceType) {
                return typeof consequenceType.title !== "undefined" && consequenceType.title != null;
            },
            moreStudiesPresent: function (studies) {
                if (typeof studies !== "undefined") {
                    return studies.length > 1;
                } else {
                    return false;
                }
            },
            updateDifferentStudies: function () {
                let differentStudies = [];
                if (typeof this.study !== "undefined" && typeof this.studies !== "undefined") {
                    for (let i = 0; i < this.studies.length; i++) {
                        if (this.study.alias != this.studies[i].alias) {
                            differentStudies.push(this.studies[i]);
                        }
                    }
                    this.differentStudies = differentStudies;

                    // Update cohorts from config, this updates the Cohort filter MAF
                    if (typeof this.config.cohorts !== "undefined") {
                        this.cohorts = this.config.cohorts[this.study.alias];
                    }
                }
            },
            updateConsequenceTypeFilter: function(e) {
                let soTerms = [];
                if (e.target.parentNode.id != "") {
                    $("#" + e.target.parentNode.id).children('ul').children('li').children('input').prop("checked", e.target.checked);
                }
                let selected = $('.soTermCheckBox:checked');
                for (let i = 0; i < selected.length; i++) {
                    soTerms.push(selected[i].dataId);
                }
                this.set('ct', soTerms);
                this.updateQueryFilters();
            },
            checkScore: function (e) {
                if (e.target.value == "score") {
                    $("#" + this.prefix + e.target.name +"Input").prop("disabled", false);
                    $("#" + this.prefix + e.target.name +"Operator").prop("disabled", false);
                } else {
                    $("#" + this.prefix + e.target.name + "Input").val("");
                    $("#" + this.prefix + e.target.name + "Operator").val("<");
                    $("#" + this.prefix + e.target.name + "Input").prop("disabled", true);
                    $("#" + this.prefix + e.target.name + "Operator").prop("disabled", true);
                }
                this.updateQueryFilters();
            },
            clear: function() {
                // This will trigger the event that call to renderQueryFilters
                this.query = {};

                // This refresh the variant main grid
                this.search = {};
            },
            renderQueryFilters: function () {
                // Empty everything before rendering
                this._clearHtmlDom();

                // Studies
                if (typeof this.query.studies !== "undefined") {
                    if (this.$$("#includeOtherStudy") != null && this.$$("#differentStudies") != null) {
                        let studies = this.query.studies.split(new RegExp("[,;]"));
                        if (studies.length > 1) { // Checking if other studies apart from the current study are present
                            let checkBoxes = this.$$("#differentStudies").querySelectorAll("input:checked");
                            for (let i = 0; i < studies.length; i++) {
                                let study = studies[i].split(':')[1];
                                for (let j = 0; j < checkBoxes.length; j++) {
                                    if (checkBoxes[j].value == study) {
                                        checkBoxes[j].checked = true;
                                    }
                                }
                            }
                        }
                    }
                }

                // Position
                if (typeof this.query.region !== "undefined") {
                    this.$$("#" + this.prefix + "LocationTextarea").value = this.query.region;
                }

                // XRefs, Gene and Variant Ids
                if (typeof this.query["annot-xref"] !== "undefined") {
                    this.$$("#" + this.prefix + "FeatureTextarea").value = this.query["annot-xref"];
                } else if (typeof this.query.gene !== "undefined") {
                    this.$$("#" + this.prefix + "FeatureTextarea").value = this.query.gene;
                } else if (typeof this.query.ids !== "undefined") {
                    this.$$("#" + this.prefix + "FeatureTextarea").value = this.query.ids;
                }

                // Type
                if (typeof this.query.type !== "undefined") {
                    let types = this.query.type.split(",");
                    let checkBoxes = this.$$("#" + this.prefix + "Type").querySelectorAll("input");
                    for (let i = 0; i < types.length; i++) {
                        for (let j = 0; j < checkBoxes.length; j++) {
                            if (checkBoxes[j].value == types[i]) {
                                checkBoxes[j].checked = true;
                            }
                        }
                    }
                }

                // Population Freqs
                let pfArray = [];
                if (typeof this.query["annot-population-maf"] !== "undefined") {
                    pfArray = this.query["annot-population-maf"].split(new RegExp("[,;]"));
                }
                if (typeof this.populationFrequencies !== "undefined" && typeof this.populationFrequencies.studies !== "undefined" && this.populationFrequencies.studies.length > 0) {
                    for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                        let study = this.populationFrequencies.studies[i].id;
                        for (let j = 0; j < this.populationFrequencies.studies[i].populations.length; j++) {
                            let population = this.populationFrequencies.studies[i].populations[j].id;
                            if (pfArray.length > 0) {
                                for (let k = 0; k < pfArray.length; k++) {
                                    let pf = pfArray[k];
                                    if (pf.startsWith(study + ":" + population)) {
                                        this.$$("#" + this.prefix + study + population).value = pf.split(/[<=>]+/)[1];
                                        this.$$("#" + this.prefix + study + population + "Operator").value = pf.split(/[-A-Za-z0-9._:]+/)[1];
                                        break;
                                    }
                                }
                            }
                        }
                    }
                }

                // Protein Substitution scores
                if (typeof this.query["protein_substitution"] !== "undefined") {
                    let pss = this.query["protein_substitution"].split(new RegExp("[,;]"));
                    if (pss.length > 0) {
                        for (let i = 0; i < pss.length; i++) {
                            if (pss[i].startsWith("sift")) {
                                let value = pss[i].split("sift")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
                                    this.$$("#" + this.prefix + "SiftInput").value = value.split(/[<=>]+/)[1];
                                    this.$$("#" + this.prefix + "SiftOperator").value = value.split(/[-0-9.]+/)[0];
                                } else {
                                    this.$$("#" + this.prefix + "SiftValues").value = value.split('==')[1];
                                }
                                this.$$("#" + this.prefix + "SiftInput").disabled = !(value.startsWith("<") || value.startsWith(">"));
                                this.$$("#" + this.prefix + "SiftOperator").disabled = !(value.startsWith("<") || value.startsWith(">"));
                            } else if (pss[i].startsWith("polyphen")) {
                                let value = pss[i].split("polyphen")[1];
                                if (value.startsWith("<") || value.startsWith(">")) {
                                    this.$$("#" + this.prefix + "PolyphenInput").value = value.split(/[<=>]+/)[1];
                                    this.$$("#" + this.prefix + "PolyphenOperator").value = value.split(/[-0-9.]+/)[0];
                                } else {
                                    this.$$("#" + this.prefix + "PolyphenValues").value = value.split('==')[1];
                                }
                                this.$$("#" + this.prefix + "PolyphenInput").disabled = !(value.startsWith("<") || value.startsWith(">"));
                                this.$$("#" + this.prefix + "PolyphenOperator").disabled = !(value.startsWith("<") || value.startsWith(">"));
                            }
                        }
                    }
                }

                // Cadd scores
                if (typeof this.query["annot-functional-score"] !== "undefined") {
                    let fields = this.query["annot-functional-score"].split(new RegExp("[,;]"));
                    for (let i = 0; i < fields.length; i++) {
                        let source = fields[i].split(/[<=>]+/)[0];
                        switch(source) {
                            case "cadd_raw":
                                this.$$("#" + this.prefix + "CaddRawInput").value = fields[i].split(/[<=>]+/)[1];
                                this.$$("#" + this.prefix + "CaddRawOperator").value = fields[i].split(/[-A-Za-z0-9_]+/)[1];
                                break;
                            case "cadd_scaled":
                                this.$$("#" + this.prefix + "CaddScaledInput").value = fields[i].split(/[<=>]+/)[1];
                                this.$$("#" + this.prefix + "CaddScaledOperator").value = fields[i].split(/[-A-Za-z0-9_]+/)[1];
                                break;
                        }
                    }
                }

                // Conservation
                if (typeof this.query.conservation !== "undefined") {
                    let fields = this.query.conservation.split(new RegExp("[,;]"));
                    for (let i = 0; i < fields.length; i++) {
                        let source = fields[i].split(/[<=>]+/)[0];
                        switch(source) {
                            case "phylop":
                                this.$$("#" + this.prefix + "PhylopInput").value = fields[i].split(/[<=>]+/)[1];
                                this.$$("#" + this.prefix + "PhylopOperator").value = fields[i].split(/[-A-Za-z0-9]+/)[1];
                                break;
                            case "phastCons":
                                this.$$("#" + this.prefix + "PhastconsInput").value = fields[i].split(/[<=>]+/)[1];
                                this.$$("#" + this.prefix + "PhastconsOperator").value = fields[i].split(/[-A-Za-z0-9]+/)[1];
                                break;
                            case "gerp":
                                this.$$("#" + this.prefix + "GerpInput").value = fields[i].split(/[<=>]+/)[1];
                                this.$$("#" + this.prefix + "GerpOperator").value = fields[i].split(/[-A-Za-z0-9]+/)[1];
                                break;
                        }
                    }
                }

                // Consequence Type
                if (typeof this.query["annot-ct"] !== "undefined") {
                    let types = this.query["annot-ct"].split(",");
                    let checkBoxes = this.$$("#consequenceTypeFilter").querySelectorAll("li input");
                    for (let i = 0; i < types.length; i++) {
                        for (let j = 0; j < checkBoxes.length; j++) {
                            if (checkBoxes[j].dataId == types[i]) {
                                checkBoxes[j].checked = true;
                            }
                        }
                    }
                } else {
                    this.set('ct', []); // Clearing the consequence type that is taken by this.query
                }

                // Gene Ontology and Human Phenotype Ontology
                if (typeof this.query["annot-go"] !== "undefined") {
                    this.$$("#" + this.prefix + "GeneOntologyTextarea").value = this.query["annot-go"];
                }
                if (typeof this.query["annot-hpo"] !== "undefined") {
                    this.$$("#" + this.prefix + "HumanPhenotypeOntologyTextarea").value = this.query["annot-hpo"];
                }
            },
            updateQueryFilters: function () {
                let _filters = {};

                // Adding sample genotypes filter
                if (typeof this.sampleGenotypes !== "undefined" && this.sampleGenotypes != "") {
                    _filters.genotype = this.sampleGenotypes;
                }

                // Add Cohort stats MAF filter: [{study.alias}]{cohort}:[<|>|<=|>=]{number}
                let cohortFreq = [];
                if (typeof this.cohorts !== "undefined" && this.cohorts.length > 0) {
                    for (let i = 0; i < this.cohorts.length; i++) {
                        let cohort = this.cohorts[i];
                        if (this.$$("#" + this.prefix + this.study.id + cohort).value != "" || this.$$("#" + this.prefix + this.study.id + cohort + "Operator").value != "<") {
                            let operator = this.$$("#" + this.prefix + this.study.id + cohort + "Operator").value;
                            let study = this.study.alias;
                            // to be removed!!
                            if (study == "BRIDGE") {
                                study = "bridge";
                            }
                            let pf = study + ":" + cohort + operator + this.$$("#" + this.prefix + this.study.id + cohort).value;
                            cohortFreq.push(pf);
                        }
//                        }
                    }
                }
                if (cohortFreq.length > 0) {
                    _filters["maf"] = cohortFreq.join(';');
                }

                // Studies
                let studies = [];
                if (typeof this.$$("#includeOtherStudy") !== "undefined" && this.$$("#includeOtherStudy") != null) {
                    let selectedStudies = this.$$("#differentStudies").querySelectorAll("input:checked");
                    if (selectedStudies.length > 0) {
                        // Always add the study that we are browsing currently
                        studies.push(this.project.alias + ':' + this.study.alias);
                        for (let i = 0; i < selectedStudies.length; i++) {
                            studies.push(this.project.alias + ':' + selectedStudies[i].value);
                        }
                    }

                    switch (this.$$("#includeOtherStudy").value) {
                        case "in":
                            _filters.studies = studies.join(';');
                            break;
                        case "atleast":
                            _filters.studies = studies.join(',');
                            break;
                        case "not in":
                            let notInStudies = [];
                            for (let j = 0; j < studies.length; j++) {
                                notInStudies.push("!" + studies[j]);
                            }
                            _filters.studies = notInStudies.join(";");
                            break;
                    }
                }

                // Regions
                if (this.$$("#" + this.prefix + "LocationTextarea").value != "") {
                    _filters.region = this.$$("#" + this.prefix + "LocationTextarea").value;
                }

                // Features: Gene, SNP ID
                if (this.$$("#" + this.prefix + "FeatureTextarea").value != "") {
//                    if (this.$$("#" + this.prefix + "FeatureTextarea").value.startsWith("rs") || this.$$("#" + this.prefix + "FeatureTextarea").value.split(':').length > 2) {
//                        _filters.ids = this.$$("#" + this.prefix + "FeatureTextarea").value;
//                    } else {
//                        _filters.gene = this.$$("#" + this.prefix + "FeatureTextarea").value;
//                    }
                    _filters["annot-xref"] = this.$$("#" + this.prefix + "FeatureTextarea").value;
                }

                // Type
                let types = this.$$("#" + this.prefix + "Type").querySelectorAll("input:checked");
                let typesAux = [];
                if (types.length > 0) {
                    for (let i = 0; i < types.length; i++) {
                        typesAux.push(types[i].value);
                    }
                    _filters.type = typesAux.join(',');
                }

                // Population Frequencies
                // Population minor allele frequency: {study}:{population}[<|>|<=|>=]{number}
                let popFreq = [];
                if (typeof this.populationFrequencies !== "undefined" && typeof this.populationFrequencies.studies !== "undefined" && this.populationFrequencies.studies.length > 0) {
                    for (let i = 0; i < this.populationFrequencies.studies.length; i++) {
                        let study = this.populationFrequencies.studies[i].id;
                        for (let j = 0; j < this.populationFrequencies.studies[i].populations.length; j++) {
                            let population = this.populationFrequencies.studies[i].populations[j].id;
                            if (this.$$("#" + this.prefix + study + population).value != "" || this.$$("#" + this.prefix + study + population + "Operator").value != "<") {
                                let operator = this.$$("#" + this.prefix + study + population + "Operator").value;
                                let pf = study + ":" + population + operator + this.$$("#" + this.prefix + study + population).value;
                                popFreq.push(pf);
                            }
                        }
                    }
                }
                if (popFreq.length > 0) {
                    _filters["annot-population-maf"] = popFreq.join(';');
                }

                // Protein Substitution scores
                let pss = [];
                let sift = "";
                if (this.$$("#" + this.prefix + "SiftValues").value == "score" && this.$$("#" + this.prefix + "SiftInput").value != "" || this.$$("#" + this.prefix + "SiftOperator").value != "<") {
                    sift = "sift" + this.$$("#" + this.prefix + "SiftOperator").value + this.$$("#" + this.prefix + "SiftInput").value;
                    pss.push(sift);
                } else if (this.$$("#" + this.prefix + "SiftValues").value != "score") {
                    sift = "sift" + "==" + this.$$("#" + this.prefix + "SiftValues").value;
                    pss.push(sift);
                }
                let polyphen = "";
                if (this.$$("#" + this.prefix + "PolyphenValues").value == "score" && this.$$("#" + this.prefix + "PolyphenInput").value != "" || this.$$("#" + this.prefix + "PolyphenOperator").value != "<") {
                    polyphen = "polyphen" + this.$$("#" + this.prefix + "PolyphenOperator").value + this.$$("#" + this.prefix + "PolyphenInput").value;
                    pss.push(polyphen);
                } else if (this.$$("#" + this.prefix + "PolyphenValues").value != "score") {
                    let value = this.$$("#" + this.prefix + "PolyphenValues").value;
                    let polyphenValues = value.split(',');
                    for (let i = 0; i < polyphenValues.length; i++) {
                        polyphen = "polyphen" + "==" + polyphenValues[i];
                        pss.push(polyphen);
                    }
                }
                if ((this.$$("#" + this.prefix + "SiftInput").value != "" && this.$$("#" + this.prefix + "PolyphenInput").value != "") ||
                    (this.$$("#" + this.prefix + "SiftValues").value != "score" && this.$$("#" + this.prefix + "PolyphenInput").value != "") ||
                    ((this.$$("#" + this.prefix + "SiftInput").value) != "" && this.$$("#" + this.prefix + "PolyphenValues").value != "score") ||
                    (this.$$("#" + this.prefix + "SiftValues").value != "score" && this.$$("#" + this.prefix + "PolyphenValues").value != "score")) {
                    $("input:radio[name=pss]").attr('disabled', false);
                }
                if (pss.length > 0) {
                    let filter = $('input:radio[name=pss]:checked').val();
                    if (filter == "and") {
                        _filters.protein_substitution = pss.join(';');
                    } else {
                        _filters.protein_substitution = pss.join(',');
                    }
                }

                // Conservation
                let conserArr = [];
                if (this.$$("#" + this.prefix + "PhylopInput").value != "" || this.$$("#" + this.prefix + "PhylopOperator").value != "<") {
                    let phylop = "phylop" + this.$$("#" + this.prefix + "PhylopOperator").value + this.$$("#" + this.prefix + "PhylopInput").value;
                    conserArr.push(phylop);
                }
                if (this.$$("#" + this.prefix + "PhastconsInput").value != "" || this.$$("#" + this.prefix + "PhastconsOperator").value != "<") {
                    let phastCons = "phastCons" + this.$$("#" + this.prefix + "PhastconsOperator").value + this.$$("#" + this.prefix + "PhastconsInput").value;
                    conserArr.push(phastCons);
                }
                if (this.$$("#" + this.prefix + "GerpInput").value != "" || this.$$("#" + this.prefix + "GerpOperator").value != "<") {
                    let gerp = "gerp" + this.$$("#" + this.prefix + "GerpOperator").value + this.$$("#" + this.prefix + "GerpInput").value;
                    conserArr.push(gerp);
                }
                if ((this.$$("#" + this.prefix + "PhylopInput").value != "" && this.$$("#" + this.prefix + "PhastconsInput").value != "") ||
                    (this.$$("#" + this.prefix + "PhylopInput").value != "" && this.$$("#" + this.prefix + "GerpInput").value != "") ||
                    (this.$$("#" + this.prefix + "PhastconsInput").value != "" && this.$$("#" + this.prefix + "GerpInput").value != "")) {
                    $("input:radio[name=conservation]").attr('disabled', false);
                }

                if (conserArr.length > 0) {
                    let filter = $('input:radio[name=conservation]:checked').val();
                    if (filter == "and") {
                        _filters.conservation = conserArr.join(';');
                    } else {
                        _filters.conservation = conserArr.join(',');
                    }
                }

                // Consequence Type
                if (typeof this.ct !== "undefined" && this.ct.length > 0) {
                    _filters["annot-ct"]= this.ct.join(',');
                }

                // Gene Ontology and Human Phenotype Ontology
                if (this.$$("#" + this.prefix + "GeneOntologyTextarea").value != "") {
                    _filters["annot-go"] = this.$$("#" + this.prefix + "GeneOntologyTextarea").value;
                }
                if (this.$$("#" + this.prefix + "HumanPhenotypeOntologyTextarea").value != "") {
                    _filters["annot-hpo"] = this.$$("#" + this.prefix + "HumanPhenotypeOntologyTextarea").value;
                }
                if (this.$$("#" + this.prefix + "TraitsTextarea").value != "") {
                    _filters["traits"] = this.$$("#" + this.prefix + "TraitsTextarea").value;
                }

                // Cadd scores
                let cadd = [];
                if (this.$$("#" + this.prefix + "CaddRawInput").value != "" || this.$$("#" + this.prefix + "CaddRawOperator").value != "<") {
                    let raw = "cadd_raw" + this.$$("#" + this.prefix + "CaddRawOperator").value + this.$$("#" + this.prefix + "CaddRawInput").value;
                    cadd.push(raw);
                }
                if (this.$$("#" + this.prefix + "CaddScaledInput").value != "" || this.$$("#" + this.prefix + "CaddScaledOperator").value != "<") {
                    let scaled = "cadd_scaled" + this.$$("#" + this.prefix + "CaddScaledOperator").value + this.$$("#" + this.prefix + "CaddScaledInput").value;
                    cadd.push(scaled);
                }
                if (cadd.length > 0) {
                    _filters["annot-functional-score"] = cadd.join(',');
                }

                // To prevent to call renderQueryFilters we set this to false
                this._reset = false;
                this.query = _filters;
                this._reset = true;
            },
            // Exclusive for prioritization
            refreshSegregationTable: function () {
//                this.samples = [];
            },
            selectAnalysisType: function (e) {
                e.preventDefault();
                this.analysisType = e.target.value;
                this.isFamilyAnalysis = this.isCancerAnalysis = false;
                if (this.analysisType === "family") {
                    this.isFamilyAnalysis = true;
                } else {
                    this.isCancerAnalysis = true;
                }
            },
            selectSegregation: function (e) {
                e.preventDefault();
                this.segregation = e.target.innerHTML;
            },
            sampleGenotypeSelected: function (e) {
                // TODO coordinate manual selection and event driven selection
//                if (this.sampleGenotypes != "") {
//                    let genotypes = this.sampleGenotypes.split(';');
//                    this.sampleGenotypesObj = genotypes.reduce(function(result, item) {
//                        debugger
//                        let items = item.split(':');
//                        result[items[0]] = {};
//                        result[items[0]][items[1]] = true;
//                        return result;
//                    }, {});
//                }

                if (typeof e !== "undefined") {
                    if (typeof this.sampleGenotypesObj[e.target.dataId] === "undefined") {
                        this.sampleGenotypesObj[e.target.dataId] = {};
                    }
                    this.sampleGenotypesObj[e.target.dataId][e.target.defaultValue] = e.target.checked;

                    let arr = [];
                    for (let sampleName in this.sampleGenotypesObj) {
                        let gts = [];
                        for (let sampleGT in this.sampleGenotypesObj[sampleName]) {
                            if (this.sampleGenotypesObj[sampleName][sampleGT] == true) {
                                gts.push(sampleGT.replace('/', '|'));
                            }
                        }
                        if (gts.length > 0) {
                            arr.push(sampleName + ':' + gts.join(','));
                        }
                    }
                    this.sampleGenotypes = arr.join(';');
                    if (arr.length > 0) {
                        this._filters.genoType = arr.join(';');
                    } else {
                        delete this._filters.genoType;
                    }
                    this._filtersCount = Object.keys(this._filters).length;
//                    debugger
                }
            },
            sampleChanged: function () {
                this.segregation = "Select Segregation";
            },
            segregate: function () {
                let cell;
                let samples = this.samples;

                if (typeof samples !== "undefined" && samples != "" && samples.length >= 3) {
                    if (this.segregation == "Autosomal Dominant") {
                        for (let i = 0; i < samples.length; i++) {
                            let index = i + 1;
                            if (samples[i].status == "unaffected") {
                                cell = $("#segregationTable tr:eq(" + index + ") td:eq(1)")[0].children[0];
                                $(cell).prop("checked", true);
                            } else if (samples[i].status == "affected") {
                                for (let j = 0; j < samples.length; j++) {
                                    if (i == j) {
                                        continue;
                                    }
                                    if (samples[j].status == "unaffected" && samples[j].memberCode == "D" || samples[j].memberCode == "S") {
                                        cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                        $(cell).prop("checked", true);
                                    } else if (samples[j].status == "affected" && samples[i].memberCode == "F") {
                                        if (i == 0 && j == 1) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        } else if (i == 0 && j != 1) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(3)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        }
                                    } else if (samples[j].status == "affected" && samples[i].memberCode == "M") {
                                        if (i == 1 && j == 0) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        } else if (i == 1 && j != 0) {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                            $(cell).prop("checked", true);
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(3)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        }
                                    } else if (samples[j].status == "affected" && samples[i].memberCode == "D" || samples[i].memberCode == "S") {
                                        cell = $("#segregationTable tr:eq(" + index + ") td:eq(2)")[0].children[0];
                                        $(cell).prop("checked", true);
                                        if (samples[j + 1].status == "affected" && samples[j + 1].memberCode == "M") {
                                            cell = $("#segregationTable tr:eq(" + index + ") td:eq(3)")[0].children[0];
                                            $(cell).prop("checked", true);
                                        }
                                    }
                                }
                            }
                        }
                        this.sampleGenotypeManual();
                    }
                }
            },
            sampleGenotypeManual: function () {
                let arr = [];
                if (this.samples != "" && this.samples.length > 1) {
                    for (let i = 0; i < this.samples.length; i++) {
                        let sample = this.samples[i].name;
                        let gts = [];
                        let children = $("#" + sample).children();
                        for (let j = 0; j < children.length; j++) {
                            let child = $("#" + sample).children()[j];
                            let input = $(child).children()[0];
                            let cb = $(input)[0];
                            if ($(cb).is(':checked')) {
                                gts.push($(cb).val().replace('/', '|'));
                            }
                        }
                        if (gts.length > 0) {
                            arr.push(sample + ':' + gts.join(','));
                        }
                    }
                }
                this.sampleGenotypes = arr.join(';');
            },
            _clearHtmlDom: function() {
                // Empty everything before rendering
                $("." + this.prefix + "FilterSelect").prop('selectedIndex', 0);
                $("." + this.prefix + "FilterSelect").prop("disabled", false);
                $("." + this.prefix + "FilterTextInput").val("");
                $("." + this.prefix + "FilterTextInput").prop("disabled", false);
                $("." + this.prefix + "FilterCheckBox").prop("checked", false);
                $("." + this.prefix + "FilterRadio").prop("checked", false);
                $("." + this.prefix + "FilterRadio").filter('[value="or"]').prop('checked', true);
                $("." + this.prefix + "FilterRadio").prop("disabled", true);
            },
            _updateMode: function () {
                switch (this.mode) {
                    case "browser":
                        this.isBrowserMode = true;
                        break;
                    case "prioritization":
                        this.isPrioritizationMode = true;
                        break;
                    case "analysis":
                    case "clinical":
                        this.isAnalysisMode = true;
                        break;
                    default:
                        this.isBrowserMode = true;
                        break;
                }
            },
            showSegregation: function(e){
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                $("#analysisSelectedDiv").show();
                $("#segregationDropdownDiv").show();

            }
        });
    </script>
</dom-module>
