<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../catalog/samples/opencga-sample-filter.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="../opencga-message-dialog.html">

<dom-module id="variant-clinical-selector">

    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style is="custom-style" include="jso-styles"></style>
        <!-- This is where main application is rendered -->


        <div class="panel">
            <div class="col-md-3">
                <!--
                The following code has to be defined properly -> this is only for demo purposes
                -->

                <br>
                <div style="width: 60%;margin: 0 auto">
                    <button type="button" class="btn btn-primary" style="width: 100%" on-click="onSearch">
                        <i class="fa fa-search" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                        Search
                    </button>
                </div>
                <br>
                <br>

                <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">

                    <!-- Sample Selection -->
                    <div class="panel panel-default">
                        <div class="panel-heading" role="tab" id="{{prefix}}SampleSelectionHeading">
                            <h4 class="panel-title">
                                <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                                   href="#{{prefix}}SampleSelection" aria-expanded="true" aria-controls="{{prefix}}SampleSelection">
                                    Analysis Selection
                                    <div style="float: right" class="tooltip-div">
                                        <a data-toggle="tooltip" title="Sample selection">
                                            <i class="fa fa-info-circle" aria-hidden="true"></i>
                                        </a>
                                    </div>
                                </a>
                            </h4>
                        </div>
                        <div id="{{prefix}}SampleSelection" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleSelectionHeading">
                            <div class="panel-body">
                                <div class="form-group">
                                    <form>
                                        <label>Select</label>
                                        <br>
                                        <input type="radio" name="selectionButtons" id="allRadio" value="all" class$="{{prefix}}FilterRadio" checked on-change="calculateFilters" style="padding-left: 20px"> All<br>
                                        <input type="radio" name="selectionButtons" id="recentlyRadio" value="recently" class$="{{prefix}}FilterRadio" on-change="calculateFilters" style="padding-left: 20px"> Recently Created<br>
                                        <input type="radio" name="selectionButtons" id="rangeRadio" value="range" class$="{{prefix}}FilterRadio" on-change="calculateFilters" style="padding-left: 20px"> Range
                                    </form>

                                    <div class="panel-body">
                                        <span>From</span>
                                        <div class="input-group date" id="{{prefix}}datetimePickerFrom">
                                            <input type="text" class="form-control"/>
                                            <span class="input-group-addon">
                                                <span class="glyphicon glyphicon-calendar"></span>
                                            </span>
                                        </div>
                                            <span>To</span>
                                            <div class="input-group date" id="{{prefix}}datetimePickerTo">
                                                <input type="text" class="form-control"/>
                                                <span class="input-group-addon">
                                        <span class="glyphicon glyphicon-calendar"></span>
                                    </span>
                                        </div>
                                    </div>

                                    <label>Other filters</label>
                                    <div class="panel-body">
                                        <label>Analysis ID</label>
                                        <input type="text" id="{{prefix}}analysisID" class="form-control" placeholder="AN-23, AN-50 ..." on-keyup="calculateFilters">

                                        <label>Samples ID</label>
                                        <input type="text" id="{{prefix}}sampleID" class="form-control" placeholder="HG01881,HG00101 ..." on-keyup="calculateFilters">

                                        <label>Analysis Type</label>
                                        <input type="text" id="{{prefix}}analysisType" class="form-control" placeholder="Duo, Family ..." on-keyup="calculateFilters">
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <div class="col-md-9">
                <br>
                <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}" filters="{{config.filters}}"
                                        filter-bioformat="VARIANT" alias="{{activeFilterAlias}}">
                </opencga-active-filters>
                <table id="{{prefix}}tableAnalysis" data-toolbar="#toolbar" data-search="true" data-show-columns="true"
                       data-pagination="true" data-page-size="5" data-page-list="[5, 10, 25]" data-checkbox-header="false" data-maintain-selected="true" style="cursor: pointer;">
                    <thead style="background-color: #eee"></thead>
                </table>

            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'variant-clinical-selector',
            properties: {
                opencgaClient: {
                    type: Object
                },
                analysisSelected: {
                    type: Object,
                    notify: true
                },
                study: {
                    type: Object
                },
                analysisModal: {
                    type: Boolean,
                    observer: "loadData"
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "anSelector" + Utils.randomString(6);
                }
                this.analysis = [];
                this.analysisSelected = {}
            },
            loadData: function(){

                if (this.opencgaClient instanceof OpenCGAClient) {
                    let params = {
                        study: this.study.alias
                    };

                    let _this = this;
                    let _analysisObj = [];
                    this.opencgaClient.clinical().search(params)
                        .then(function (response) {
                            let _analysis = response.response[0].result;
                            for (let i=0; i<_analysis.length; i++){
                                _analysisObj.push({
                                    analysisID: _analysis[i].name,
                                    analysisType: _analysis[i].type,
                                    analysisDate: _analysis[i].creationDate,
                                    analysis: _analysis[i]
                                })
                            }
                            _this.analysis = _analysisObj;
                            _this.renderAnalysisTable();
                        })
                        .catch(function (response) {
                            _this.settingsMessageModal = {
                                messageHeader: "Error",
                                messageBody: [response.error],
                                type: "danger",
                                height: "100px",
                                width: "500px"
                            };

                            _this.showMessageModal = true;
                        });
                }
            },
            renderAnalysisTable: function(){
                let _this=this;
                $("#" + this.prefix + "tableAnalysis").bootstrapTable('destroy');
                $("#" + this.prefix + "tableAnalysis").bootstrapTable({
                    columns: _this._getTableColumns(),
                    data: this.analysis,
                    onCheck: function (row, elem) {
                        let _family = row.analysis.family;

                        // To be modified -> take into account the case in which there are more than one sample per individual
                        // Children
                        let _samplesSelected = [];
                        for (let i=0; i<_family.children.length; i++){
                            _samplesSelected.push(_family.children[i].samples[0]);
                        }
                        // Father
                        _samplesSelected.push(_family.father.samples[0]);
                        // Mother
                        _samplesSelected.push(_family.mother.samples[0]);

                        _this.analysisSelected = {sampleList: _samplesSelected, analysisID: row.analysisID};
                    },
                });

            },
            _getTableColumns: function() {
                this._columns = [
                    [
                        {
                            field: 'state',
                            radio: true,
                            align: 'center',
                            valign: 'middle'
                        },
                        {
                            field: 'analysisID',
                            title: 'Analysis ID'
                        },
                        {
                            field: 'analysisType',
                            title: 'Analysis type'
                        },
                        {
                            field: 'analysisDate',
                            title: 'Date'
                        },
                        {
                            field: 'analysis',
                            visible: false,
                        }
                    ]
                ];
                return this._columns;
            }
        });

    </script>
</dom-module>