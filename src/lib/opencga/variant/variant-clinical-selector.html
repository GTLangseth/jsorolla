<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../catalog/samples/opencga-sample-filter.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="../opencga-message-dialog.html">
<link rel="import" href="../catalog/samples/opencga-analysis-filter.html">
<link rel="import" href="../opencga-message-dialog.html">

<dom-module id="variant-clinical-selector">
    <template>
        <style is="custom-style" include="jso-styles"></style>
        <!--<div class="panel">-->
            <div class="col-md-3">
                <opencga-analysis-filter opencga-client="{{opencgaClient}}" study="{{study}}" query="{{query}}" search="{{search}}"></opencga-analysis-filter>
            </div>
            <div class="col-md-9">
                <br>
                <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}" filters="{{config.filters}}"
                                        filter-bioformat="VARIANT" alias="{{activeFilterAlias}}">
                </opencga-active-filters>
                <h3>Analysis results</h3>
                <table id="{{prefix}}tableAnalysis" data-search="true" data-show-columns="true"
                       data-pagination="true" data-page-size="5" data-page-list="[5, 10, 25]" data-checkbox-header="false" data-maintain-selected="true" style="cursor: pointer;">
                    <thead style="background-color: #eee"></thead>
                </table>

                <div>
                    <h4>{{pedigreeTitle}}</h4>
                    <div id="{{prefix}}PedigreeView" style="padding: 5px 5px;font-size: 10px"></div>
                </div>

            </div>
        <!--</div>-->
    </template>
    <script>
        Polymer({
            is: 'variant-clinical-selector',
            properties: {
                opencgaClient: {
                    type: Object
                },
                analysisSelected: {
                    type: Object,
                    notify: true
                },
                study: {
                    type: Object
                },
                analysisModal: {
                    type: Boolean,
                    observer: "loadData"
                },
                showPedigree: {
                    type: Boolean
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "anSelector" + Utils.randomString(6);
                }
                this.resetVariables();
            },
            loadData: function(){
                this.resetVariables();
                if (this.opencgaClient instanceof OpenCGAClient) {
                    let params = {
                        study: this.study.alias
                    };
                    let _this = this;
                    let _analysisObj = [];
                    this.opencgaClient.clinical().search(params)
                        .then(function (response) {
                            let _analysis = response.response[0].result;
                            let _filterAttr = "";
                            for (let i=0; i<_analysis.length; i++){
                                _analysisObj.push({
                                    analysisID: _analysis[i].name,
                                    analysisType: _analysis[i].type,
                                    analysisDate: _this.dateFormatter(_analysis[i].creationDate),
                                    filter: _this.filterFormatter(_analysis[i].attributes.filter),
                                    analysis: _analysis[i]
                                })
                            }
                            _this.analysis = _analysisObj;
                            _this.renderAnalysisTable();
                        })
                        .catch(function (response) {
                            _this.settingsMessageModal = {
                                messageHeader: "Error",
                                messageBody: [response.error],
                                type: "danger",
                                height: "100px",
                                width: "500px"
                            };

                            _this.showMessageModal = true;
                        });
                }
            },
            resetVariables: function(){
                this.analysis = [];
                this.analysisSelected = {};
                this._affected = {};
                this._deceased = {};
                this.pedigreeSettings = {};
                this.pedigree = {children: []};
                this.pedigreeTitle = "";

                // If pedigree exists from a previous opened window, remove it
                let querySelector = Polymer.dom(this.root).querySelector("#" + this.prefix + "PedigreeView");
                if (typeof this.svg !== "undefined" && querySelector.hasChildNodes()) {
                    querySelector.removeChild(this.svg);

                }
                this.svg = undefined;
            },
            renderAnalysisTable: function(){
                let _this=this;
                $("#" + this.prefix + "tableAnalysis").bootstrapTable('destroy');
                $("#" + this.prefix + "tableAnalysis").bootstrapTable({
                    columns: _this._getTableColumns(),
                    data: this.analysis,
                    onCheck: function (row, elem) {
                        _this.resetVariables();
                        let _family = row.analysis.family;

                        // To be modified -> take into account the case in which there are more than one sample per individual
                        // Children
                        let _samplesSelected = [];
                        for (let i=0; i<_family.children.length; i++){
                            _samplesSelected.push(_family.children[i].samples[0]);
                        }
                        // Father
                        _samplesSelected.push(_family.father.samples[0]);
                        // Mother
                        _samplesSelected.push(_family.mother.samples[0]);

                        // Render pedigree
                        _this.pedigreeFromFamily(_family, row.analysisID);

                        _this.analysisSelected = {
                            sampleList: _samplesSelected,
                            analysisID: row.analysisID,
                            analysisType: row.analysisType,
                            analysisDate: row.analysisDate,
                            analysis: row.analysis,
                            pedigree: _this.svg
                        };
                    }
                });
            },
            dateFormatter: function(date) {
                return date.slice(6,8) + "/" + date.slice(4,6) + "/" + date.slice(0,4);
            },
            filterFormatter: function(filter) {
                return (filter === true) ? "YES" : "NO";
            },
            _createPedigree: function () {
                // Complete the pedigree with the affected and deceased status
                if (typeof this.pedigree.father !== "undefined") {
                    this.pedigree.father.affected = this._affected[this.pedigree.father.name];
                    this.pedigree.father.deceased = this._deceased[this.pedigree.father.name];
                }
                if (typeof this.pedigree.mother !== "undefined") {
                    this.pedigree.mother.affected = this._affected[this.pedigree.mother.name];
                    this.pedigree.mother.deceased = this._deceased[this.pedigree.mother.name];
                }
                if (typeof this.pedigree.children !== "undefined") {
                    for (let child of this.pedigree.children) {
                        child.affected = this._affected[child.name];
                        child.deceased = this._deceased[child.name];
                    }
                }
                return this.pedigree;
            },
            pedigreeRender: function () {
                let ped = this._createPedigree();

                let familyName = $("#" + this.prefix + "FamilyName").val();
                // Remove SVG before render new one
                if (typeof this.svg !== "undefined") {
                    Polymer.dom(this.root).querySelector("#" + this.prefix + "PedigreeView").removeChild(this.svg);
                }
                // Render new Pedigree
                let pedigree = new Pedigree(ped);
                this.svg = pedigree.render(this.pedigreeSettings);
                let querySelector = Polymer.dom(this.root).querySelector("#" + this.prefix + "PedigreeView");
                querySelector.appendChild(this.svg);
            },
            pedigreeFromFamily: function(family, _analysisID) {

                // Father
                this.pedigree.father = {name: family.father.samples[0].name, gender: "male"};
                // Mother
                this.pedigree.mother = {name: family.mother.samples[0].name, gender: "female"};
                // Children
                let _gender = "";
                for (let i=0; i<family.children.length; i++){
                    _gender = family.children[i].sex;
                    switch (_gender) {
                        case "MALE":
                            this.pedigree.children.push({name: family.children[i].samples[0].name, gender: "male"});
                            break;
                        case "FEMALE":
                            this.pedigree.children.push({name: family.children[i].samples[0].name, gender: "female"});
                            break;
                        case "UNKNOWN":
                            this.pedigree.children.push({name: family.children[i].samples[0].name, gender: "undefined"});
                            break;
                    }
                }
                // Show sample names
                this.pedigreeSettings.selectShowSampleNames = true;

                // Parental consanguinity
                this.pedigree.parentalConsanguinity = (family.parentalConsanguinity === true);

                if (this.showPedigree){
                    this.pedigreeTitle = "Pedigree for " + _analysisID;
                }
                this.pedigreeRender();
            },
            _getTableColumns: function() {
                this._columns = [
                    [
                        {
                            field: 'state',
                            radio: true,
                            align: 'center',
                            valign: 'middle'
                        },
                        {
                            field: 'analysisID',
                            title: 'Analysis ID'
                        },
                        {
                            field: 'analysisType',
                            title: 'Analysis type'
                        },
                        {
                            field: 'analysisDate',
                            title: 'Date'
                        },
                        {
                            field: 'filter',
                            title: 'Filter'
                        },
                        {
                            field: 'analysis',
                            visible: false
                        }
                    ]
                ];
                return this._columns;
            }
        });
    </script>
</dom-module>