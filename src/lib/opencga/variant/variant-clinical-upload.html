<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="variant-clinical-upload">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div class="col-md-4">
            <h3>Upload and check file</h3>
            <br>

            <form id="{{prefix}}uploadForm" class="form-horizontal" data-toggle="validator" role="form">



                <!-- GENERAL INFORMATION -->
                <h4>1. General information</h4>
                <br>
                <!-- SAMPLE ID -->
                <div class="form-group has-feedback">
                    <label for="{{prefix}}sampleID" class="col-sm-3 control-label">Sample ID</label>
                    <div class="col-sm-9">
                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}sampleID" name="sampleID" placeholder="ID or clinical record number" maxlength="75" required data-error="" pattern=".+">
                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                        <div class="help-block with-errors"></div>
                    </div>
                </div>
                <!-- CHROMOSOMAL GENDER -->
                <div class="form-group has-feedback">
                    <label for="{{prefix}}chromosomalGender" class="col-sm-3 control-label">Chromosomal Gender</label>
                    <div class="col-sm-9">
                        <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}chromosomalGender"
                                name="chromosomalGender" required>
                            <option></option>
                            <template is="dom-repeat" items="{{config.chromosomal_gender}}">
                                <option value="{{item}}">{{item}}</option>
                            </template>
                        </select>
                        <div class="help-block with-errors" id="{{prefix}}_errorDiv_chromosomalGender"></div>
                    </div>
                </div>
                <!-- YEAR OF BIRTH -->
                <div class="form-group has-feedback">
                    <label for="{{prefix}}birthYear" class="col-sm-3 control-label">Year of Birth</label>
                    <div class="col-sm-9">
                        <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}birthYear"
                                name="birthYear" required on-change="checkYears">
                            <option></option>
                            <template is="dom-repeat" items="{{yearsBirth}}">
                                <option value="{{item}}">{{item}}</option>
                            </template>
                        </select>
                        <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthYear"></div>
                    </div>
                </div>

                <!-- ETHNICITY -->
                <div class="form-group has-feedback">
                    <label for="{{prefix}}ethnicity" class="col-sm-3 control-label">Ethnicity</label>
                    <div class="col-sm-9">
                        <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}ethnicity"
                                name="ethnicity" required>
                            <option></option>
                            <template is="dom-repeat" items="{{config.ethnicity}}">
                                <option value="{{item.id}}">{{item.title}}</option>
                            </template>
                        </select>
                        <div class="help-block with-errors" id="{{prefix}}_errorDiv_ethnicity"></div>
                    </div>
                </div>

                <!-- BIRTH PLACE -->
                <div class="form-group has-feedback">
                    <label for="{{prefix}}birthPlace" class="col-sm-3 control-label">Birth Place</label>
                    <div class="col-sm-9">
                        <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}birthPlace"
                                name="birthPlace" required on-change="updateSelect">
                            <option></option>
                            <template is="dom-repeat" items="{{config.countries}}">
                                <option value="{{item}}">{{item}}</option>
                            </template>
                        </select>
                        <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthPlace"></div>
                    </div>
                </div>

                <!-- OTHER COUNTRY (TEXT INPUT if country selected is not in the list -->
                <div class="form-group has-feedback" id="otherCountryDiv" style="display:none">
                    <label for="{{prefix}}otherCountry" class="col-sm-3 control-label"></label>
                    <div class="col-sm-9">
                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}otherCountry" name="otherCountry" placeholder="Introduce country" maxlength="75" required data-error="Mandatory country. Only a-z characteres and spaces are allowed" pattern="^[A-Za-z]+((\\s)?([A-Za-z])+)+$">
                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                        <div class="help-block with-errors"></div>
                    </div>
                </div>

                <!-- BIRTH PLACE (PROVINCE) -->
                <div class="form-group has-feedback">
                    <label for="{{prefix}}birthPlaceRegion" class="col-sm-3 control-label">Birth Place (province)</label>
                    <div class="col-sm-9">
                        <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}birthPlaceRegion"
                                name="birthPlaceRegion" required>
                            <option></option>
                            <template is="dom-repeat" items="{{config.province}}">
                                <option value="{{item}}">{{item}}</option>
                            </template>

                        </select>
                        <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthPlaceRegion"></div>
                    </div>
                </div>

                <!-- HPO TERM (ONTOLOGY) -->
                <div class="form-group has-feedback">
                    <label for="{{prefix}}HPO" class="col-sm-3 control-label">HPO</label>
                    <div class="col-sm-9">
                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}HPO" name="HPO" placeholder="hpo term" maxlength="300" required data-error="An HPO term must be selected">
                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                        <div class="help-block with-errors"></div>
                    </div>
                </div>

                <!-- DIAGNOSIS (ONTOLOGY) -->

                <div class="form-group has-feedback">
                    <label for="{{prefix}}diagnosis" class="col-sm-3 control-label">Diagnosis</label>
                    <div class="col-sm-9">
                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}diagnosis" name="diagnosis" placeholder="diagnosis" maxlength="300" required data-error="A diagnosis term must be selected">
                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                        <div class="help-block with-errors"></div>
                    </div>
                </div>

                <h4>2. Test information</h4>
                <br>

                <!-- SPECIFIC FIELDS FROM VARIABLE SET -->
                <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" sort="_sortVariables">

                    <template is="dom-if" if="{{isVisible(variable,config)}}">
                        <div class="form-group has-feedback">

                            <label for="{{prefix}}{{variable.name}}" class="col-sm-3 control-label">{{variable.title}}</label>

                            <template is="dom-if" if="{{checkVarType(variable, 'TEXT')}}">
                                <!-- TEXT type: include an input text and add suitable regular expression for text-->
                                <!-- http://stackoverflow.com/questions/14237686/disabling-controls-in-bootstrap-->

                                <template is="dom-if" if="{{checkSubType(variable, 'STRING')}}">
                                    <!-- String subtype: include an input text and add suitable regular expression for text-->
                                    <div class="col-sm-9">
                                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                               placeholder="{{variable.defaultValue}}" maxlength="{{variable.attributes.maxLength}}" required
                                               data-error="{{variable.attributes.errorPattern}}" pattern="{{variable.attributes.pattern}}">
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkSubType(variable, 'TEXT')}}">
                                    <!-- String subtype: include a text area and add suitable regular expression for text-->
                                    <div class="col-sm-9">
                                        <textarea class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                  placeholder="{{variable.defaultValue}}" maxlength="{{variable.attributes.maxLength}}" required rows="5"
                                                  data-error="{{variable.attributes.errorPattern}}" pattern="{{variable.attributes.pattern}}"></textarea>
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>


                            </template>

                            <template is="dom-if" if="{{checkVarType(variable, 'NUMERIC')}}">
                                <!-- NUMERIC type: include an input text and add suitable regular expression for numbers -->
                                <div class="col-sm-9">
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                           placeholder="{{variable.name}} number" pattern="^[0-9]+$" maxlength="75" required data-error="Mandatory field. Only numbers are allowed ">
                                    <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                    <div class="help-block with-errors"></div>
                                </div>
                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 0, 1)}}">
                                <!-- CATEGORICAL type, no value: values to be filled in this code -->
                                <!-- Dropdown related to years : fill in with values contained in {{years}} -->
                                <template is="dom-if" if="{{checkType(variable.name,'Year')}}">
                                    <div class="col-sm-9">
                                        <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}" required on-change="checkYears">
                                            <option></option>
                                            <template is="dom-repeat" items="{{yearsTest}}">
                                                <option value="{{item}}">{{item}}</option>
                                            </template>
                                        </select>
                                        <div class="help-block with-errors" id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                    </div>
                                </template>

                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 1, 2)}}">
                                <!-- CATEGORICAL type, single value: check box -->
                                <div class="col-sm-9">
                                    <input class$="{{prefix}}CheckInput" type="checkbox" id="{{prefix}}{{variable.name}}" name="{{variable.name}}" value="{{variable.name}}" style="padding-left: 20px" required>
                                </div>
                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 2, 3)}}">
                                <!-- CATEGORICAL type, 2 values: radio buttons for selection -->
                                <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                                <div class="col-sm-9">
                                    <template is="dom-repeat" items="{{variable.allowedValues}}" as="value">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input id="{{prefix}}{{variable.name}}{{value}}" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}" value="{{value}}"> {{value}}
                                            </label>
                                        </div>
                                    </template>
                                    <div class="help-block with-errors"></div>
                                </div>
                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 3, 500)}}">
                                <!-- CATEGORICAL type: dropdown: at least three elements in variable.allowedValues -->
                                <div class="col-sm-9">
                                    <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}" required on-change="updateSelect">
                                        <option></option>
                                        <template is="dom-repeat" items="{{variable.allowedValues}}">
                                            <option value="{{item}}">{{item}}</option>
                                        </template>
                                    </select>
                                    <div class="help-block with-errors" id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                </div>
                            </template>

                            <template is="dom-if" if="{{checkVarType(variable, 'BOOLEAN')}}">
                                <!-- BOOLEAN type, 2 values: radio buttons for selection: yes or no -->
                                <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                                <div class="col-sm-9">
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label">
                                            <input id="{{prefix}}{{variable.name}}yes" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}" value="true"> yes
                                            <input id="{{prefix}}{{variable.name}}no" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}" value="false"> no
                                        </label>
                                    </div>
                                    <div class="help-block with-errors"></div>
                                </div>
                            </template>
                        </div>
                    </template>
                </template>
                <div class="form-group">
                    <label for="{{prefix}}inputFile" class="col-sm-3 control-label">VCF or gVCF file</label>
                    <div class="col-sm-9">
                        <input type="file" class="file" id="FileToUpload">
                        <div class="input-group">
                            <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}inputFile" name="inputFile">
                            <span class="input-group-btn">
                                    <button class="browse btn btn-primary" type="button">...</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="float: right;">
                    <div class="offset-sm-2 col-sm-10">
                        <button type="submit" class="btn btn-primary" on-click="submitForm">Upload and check sample</button>
                    </div>
                </div>
            </form>
        </div>

    </template>

    <script>
        Polymer({
            is: 'variant-clinical-upload',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Number,
                    observer: 'updateVariableSets'
                },
                config: {
                    type: Object
                },
                prefix: {
                    type: String
                },
                variableSets: {
                    type: Array
                },
                variables: {
                    type: Array,
                    observer: 'variablesChanged'
                },
                minYearBirth: {
                    type: Number,
                    value: 1920
                },
                minYearTest: {
                    type: Number,
                    value: 2005
                }
            },
            ready: function () {

                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = Utils.randomString(6);
                }
                let _years = [];
                let fullDate = new Date()
                let limitYear = fullDate.getFullYear();
                for (let year = this.minYearBirth; year<=limitYear; year++)
                {_years.push(year);}
                // This change triggers the polymer dom-repeat
                this.yearsBirth = _years;

                _years = [];
                for (year = this.minYearTest; year<=limitYear; year++)
                {_years.push(year);}
                // This change triggers the polymer dom-repeat
                this.yearsTest = _years;

                this._clearHtmlDom();
            },

            updateVariableSets: function () {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                    .then(function (response) {
                        _this.variableSets = response.response[0].result[0].variableSets;
                        if (_this.variableSets.length > 0) {
                            _this.variables = _this.variableSets[0].variables; // setting first one by default
                            _this.filteredVariables = {
                                variableSet: _this.variableSets[0].id,
                                variables: []
                            };
                        } else {
                            _this.variableSets = [{name : "none"}];
                        }
                    })
                    .catch(function () {
                        console.log("Could not obtain the variable sets of the study " + _this.study);
                    });



                for (let variable in this.variables)
                {
                    if(variable.attributes.prearranged == true)
                    {
                        $("#"+this.prefix+variable.name).prop('readonly',true);
                    }
                }



            },
            _sortVariables: function (a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            },
            variablesChanged: function () {
                this._areVariablesEmpty = (this.variables.length === 0);
            },
            checkCatType: function (myVar, type, lowerLimit, upperLimit) {
                return (myVar.type === type && myVar.allowedValues.length >= lowerLimit && myVar.allowedValues.length < upperLimit);
            },
            checkVarType: function (myVar, type) {
                return (myVar.type === type);
            },
            checkSubType: function (myVar, type) {
                return (myVar.attributes.subtype === type);
            },
            isVisible: function (myVar,conf){
                let excludeArray = conf.variableSet.exclude
                for (let index in excludeArray) {
                    if (excludeArray[index].webComponent == this.localName) {
                        return (!($.inArray(myVar.name, excludeArray[index].variables) != -1));
                    } else {return true;}
                }
            },
            checkType: function (str1, str2) {
                if (str1.search(str2) != -1)
                {return true;}
                else
                {return false;}

            },
            checkYears: function(e) {

                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                $("#" + this.prefix + "_errorDiv_birthYear").html("");
                $("#" + this.prefix + "_errorDiv_testYear").html("");

                let identifier = e.target.id;
                let message = '';
                let currentElement = $();
                let valueCE = '';
                let pairElement = $();
                let valuePE = '';

                if(identifier.search('birthYear')!=-1) // Birth year element raises the event -> check Test year
                {
                    // Check Year of Test
                    $("#" + this.prefix + "_errorDiv_age").html("");
                    currentElement = $("#"+e.target.id);
                    valueCE = currentElement.find("option:selected").text();
                    pairElement = $("#" + this.prefix + "testYear");
                    valuePE = pairElement.find("option:selected").text();

                    if(valuePE != '' && (parseInt(valueCE) > parseInt(valuePE)))
                    { // Year of birth cannot be lower than Year of test
                        message = "Year of Birth must be prior to year of Test. ";
                        $("#" + this.prefix + "_errorDiv_birthYear").html(message);
                    }
                    // Check Age
                    pairElement = $("#" + this.prefix + "age");
                    valuePE = pairElement.find("option:selected").text();
                    let fullDate = new Date();
                    if (valuePE != '' && !(parseInt(valuePE) >= (fullDate.getFullYear() - parseInt(valueCE) - 1) && parseInt(valuePE) <= fullDate.getFullYear() - parseInt(valueCE))) {
                        // If year of birth is 2015, person is 1 or 2 years old (assuming 2017 is current year)
                        $("#" + this.prefix + "_errorDiv_birthYear").html(message + "Year of Birth does not match age");
                    }

                }
                else { // Year of test element raises the event -> swap elements and check the birth year
                    currentElement = $("#" + this.prefix + "birthYear");
                    valueCE = currentElement.find("option:selected").text();
                    pairElement = $("#"+e.target.id);
                    valuePE = pairElement.find("option:selected").text();

                    if(valuePE != '' && (parseInt(valueCE) > parseInt(valuePE)))
                    { // Year of birth cannot be lower than Year of test
                        $("#" + this.prefix + "_errorDiv_testYear").html("Year of Test must be posterior to year of Birth");
                    }
                }




            },
            updateSelect: function(e){

                $("#" + this.prefix + "_errorDiv_testAge").html("");


                //console.log(this);
                //debugger;
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                //console.log(this);
                //debugger;
                let currentElementId = e.target.id;
                let currentElement = $("#" +  e.target.id);
                // Dropdown related to birthplace
                if (currentElementId == (this.prefix + 'birthPlace')){
                    if (currentElement.val() == 'Spain'){
                        $("#otherCountryDiv").hide();
                        $("#" + this.prefix + "otherCountry").prop("required",false);
                        $("#" + this.prefix + "birthPlaceRegion").prop("disabled",false);
                        $("#" + this.prefix + "birthPlaceRegion").prop("required",true);
                    }
                    else
                    {
                        $("#" + this.prefix + "birthPlaceRegion").prop("disabled",true);
                        $("#" + this.prefix + "birthPlaceRegion").prop("selectedIndex",0);
                        $("#" + this.prefix + "birthPlaceRegion").prop("value","unknown");
                        $("#" + this.prefix + "birthPlaceRegion").prop("required",false);
                        if (currentElement.val() == 'Other')
                        {// Display input text to introduce country
                            $("#otherCountryDiv").show();
                            $("#" + this.prefix + "otherCountry").prop("required",true);
                        }
                        else
                        {
                            $("#otherCountryDiv").hide();
                            $("#" + this.prefix + "otherCountry").prop("required",false);
                        }
                    }


                } else if (currentElementId == (this.prefix + 'testAge')){
                    // Dropdown related to age of Test -> check hat year of birth is correct

                    let pairElement = $("#" + this.prefix + "birthYear");
                    let valuePE = pairElement.find("option:selected").text();
                    if (valuePE !='') {
                        let birthYear = parseInt(valuePE);
                        let fullDate = new Date();
                        if (!(parseInt(currentElement.val()) >= (fullDate.getFullYear() - birthYear - 1) && parseInt(currentElement.val()) <= fullDate.getFullYear() - birthYear)) {
                            $("#" + this.prefix + "_errorDiv_testAge").html("Age selected does not match year of Birth");
                        }
                    }

                }
            },
            _clearHtmlDom: function() {

                // Empty everything before rendering
                $("." + this.prefix + "SelectInput").prop('selectedIndex', 0);
                $("." + this.prefix + "TextInput").val("");
                $("." + this.prefix + "CheckInput").prop("checked", false);
                $("." + this.prefix + "RadioInput").prop("checked", false);
                $("#" + this.prefix + "birthPlaceRegion").prop("disabled",true);
            },
            submitForm: function(e) {
                e.preventDefault();

                console.log(this);
                debugger;

                // Get values from form fields
                let fields = $("#"+ this.prefix + "uploadForm").serializeArray();

                let _variableSet = {};

                // fill-in variable set
                $(fields).each(function(index, field){
                    _variableSet[field.name] = field.value;
                });


                if (this.opencgaClient instanceof OpenCGAClient) {
                    /////////////////////////////////
                    // 1. Create individual
                    /////////////////////////////////
                    let params = {
                        study: this.study.alias,
                        body: {
                            "name": _variableSet.sampleID,
                            "family": "",
                            "fatherId": -1,
                            "motherId": -1,
                            "sex": "UNKNOWN",
                            "ethnicity": _variableSet.ethnicity,
                            "species": {
                                "taxonomyCode": "9606",
                                "scientificName": "Homo sapiens",
                                "commonName": "Homo sapiens"
                            },
                            "population": {
                                "name": _variableSet.birthPlace,
                                "subpopulation": _variableSet.birthPlaceRegion,
                                "description": ""
                            },
                            "karyotypicSex": _variableSet.chromosomalGender,
                            "lifeStatus": "UNKNOWN",
                            "affectationStatus": "UNKNOWN"
                        }
                    };


                     let _this = this;

                     this.opencgaClient.individuals().create(params, {"method": "POST"})
                     .then(function (response) {
                         console.log(response.response[0]);
                         _this.individualId = response.response[0].result[0].id;
                     })
                     .catch(function () {
                         console.log("Could not create individual for the study " + _this.study);
                     });


                    // Cannot see this.individualId from here


                    /////////////////////////////////
                    // 2. Upload VCF
                    /////////////////////////////////


                    params = {
                        study: this.study.alias,
                        type: "FILE",
                        file: $("#FileToUpload").prop('files')[0],
                        fileFormat: "VCF",
                        bioformat: "VARIANT",
                        relativeFilePath: "."
                    };

                    this.opencgaClient.files().upload(params)
                        .then(function (response) {
                            console.log(response);
                            _this.sampleId = response.response[0].result[0].sampleIds[0];
                            _this.fileId = response.response[0].result[0].id;
                    })
                        .catch(function() {
                            console.log("Could not upload VCF file for the study " + _this.study);
                    });

                    // Cannot see this.sampleId from here

                    /////////////////////////////////
                    // 3. Create Annotation set using previously obtained sampleId
                    /////////////////////////////////

                    // Create a JSON object from variable set fields

                    let jsonAnnotation = {};
                    $(this.variableSets[0].variables).each(function(index, currentVariable){
                        jsonAnnotation[currentVariable.name] = _variableSet[currentVariable.name];
                    });

                    params = {
                        study: this.study.alias,
                        variableSetId: this.variableSets[0].id,
                        body: {
                            "name": "annotation_individual_89", // hardcoded
                            "annotations": jsonAnnotation
                        }

                    };
                    // Replace 91 by this.sampleId
                    this.opencgaClient.samples().annotationsetsCreate(91, params, {"method": "POST"})
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function() {
                            console.log("Could not create annotation set for the sample " + _this.sampleId);
                        });

                    /////////////////////////////////
                    // 4. Link sample and individual
                    /////////////////////////////////

                    params = {
                        study: this.study.alias,
                        body: {
                            "individual.id": "89" // would be this.individualId
                        }
                    };
                    // this.sampleId en lugar de 48
                    this.opencgaClient.samples().update(91, params, {"method": "POST"})
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function() {
                            console.log("Could not link sample " + _this.sampleId + " and individual " + _this.individualId);
                        });


                    /////////////////////////////////
                    // 5. Index and annotation VCF file
                    /////////////////////////////////

                    params = {
                        //file: this.fileId,
                        file: "101", // hardcoded
                        study: this.study.alias,
                        //outDir: this.fileId + "_annotation",
                        outDir: "101_annotation", //hardcoded
                        calculateStats: true,
                        annotate: true
                    };
                    this.opencgaClient.variants().index(params)
                        .then(function (response) {
                            console.log(response);
                        })
                        .catch(function() {
                            console.log("Could not index file " + _this.fileId);
                        });

                }




                // Submit the form
                //$("#" + this.prefix + "uploadForm").submit();
                //console.log(this);
                //debugger;
            }
        });
    </script>
</dom-module>