<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="variant-clinical-upload">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div class="col-md-5">
            <h3>Upload and check file v2</h3>
            <br>

            <form class="form-horizontal" data-toggle="validator" role="form">
                <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" sort="_sortVariables">
                    <div class="form-group has-feedback">

                        <label for="{{prefix}}{{variable.name}}" class="col-sm-3 control-label">{{variable.title}}</label>

                        <template is="dom-if" if="{{checkVarType(variable, 'TEXT')}}">
                            <!-- TEXT type: include an input text and add suitable regular expression for text-->
                            <!-- http://stackoverflow.com/questions/14237686/disabling-controls-in-bootstrap-->
                            <div class="col-sm-9">
                                <!--                                <template is="dom-if" if="{{regular(variable.attributes.prearranged)}}">

                                                                    <input type="text" class="form-control" id="{{prefix}}{{variable.name}}"
                                                                           placeholder="{{variable.name}} name" pattern="{{variable.attributes.pattern}}" maxlength="75"
                                                                           required data-error="Mandatory field. Only a-z, - or ' characters and spaces are allowed ">
                                                                </template>-->
                                <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}"
                                       placeholder="{{variable.name}} name" pattern="{{variable.attributes.pattern}}" maxlength="75"
                                       required data-error="Mandatory field. Only a-z, - or ' characters and spaces are allowed " >
                                <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                <div class="help-block with-errors"></div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{checkVarType(variable, 'NUMERIC')}}">
                            <!-- NUMERIC type: include an input text and add suitable regular expression for numbers -->
                            <div class="col-sm-9">
                                <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" placeholder="{{variable.name}} number"
                                       pattern="^[0-9]+$" maxlength="75" required data-error="Mandatory field. Only numbers are allowed ">
                                <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                <div class="help-block with-errors"></div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 0, 1)}}">
                            <!-- CATEGORICAL type, no value: values to be filled in this code -->
                            <!-- Dropdown related to years : fill in with values contained in {{years}} -->
                            <template is="dom-if" if="{{checkType(variable.name,'Year')}}">
                                <div class="col-sm-9">
                                    <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}{{variable.name}}" required on-change="checkYears">
                                        <option></option>
                                        <template is="dom-repeat" items="{{years}}">
                                            <option value="{{item}}">{{item}}</option>
                                        </template>
                                    </select>
                                    <div class="help-block with-errors" id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                </div>
                            </template>

                        </template>

                        <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 1, 2)}}">
                            <!-- CATEGORICAL type, single value: check box -->
                            <div class="col-sm-9">
                                <input class$="{{prefix}}CheckInput" type="checkbox" id="{{prefix}}{{variable.name}}" style="padding-left: 20px" required>
                            </div>
                        </template>

                        <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 2, 3)}}">
                            <!-- CATEGORICAL type, 2 values: radio buttons for selection -->
                            <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                            <div class="col-sm-9">
                                <template is="dom-repeat" items="{{variable.allowedValues}}" as="value">
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label">
                                            <input id="{{prefix}}{{variable.name}}{{value}}" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}Options"> {{value}}
                                        </label>
                                    </div>
                                </template>
                                <div class="help-block with-errors"></div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 3, 500)}}">
                            <!-- CATEGORICAL type: dropdown: at least three elements in variable.allowedValues -->
                            <div class="col-sm-9">
                                <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}{{variable.name}}" required on-change="updateSelect">
                                    <option></option>
                                    <template is="dom-repeat" items="{{variable.allowedValues}}">
                                        <option value="{{item}}">{{item}}</option>
                                    </template>
                                </select>
                                <div class="help-block with-errors"></div>
                            </div>
                        </template>

                        <template is="dom-if" if="{{checkVarType(variable, 'BOOLEAN')}}">
                            <!-- BOOLEAN type, 2 values: radio buttons for selection: yes or no -->
                            <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                            <div class="col-sm-9">
                                <div class="form-check form-check-inline">
                                    <label class="form-check-label">
                                        <input id="{{prefix}}{{variable.name}}yes" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}Options"> yes
                                        <input id="{{prefix}}{{variable.name}}no" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}Options"> no
                                    </label>
                                </div>
                                <div class="help-block with-errors"></div>
                            </div>
                        </template>
                    </div>
                </template>
                <div class="form-group">
                    <label for="inputFile" class="col-sm-3 control-label">VCF or gVCF file</label>
                    <div class="col-sm-9">
                        <input type="file" class="file" id="FileToUpload">
                        <div class="input-group">
                            <input type="text" class$="form-control {{prefix}}TextInput" id="inputFile">
                            <span class="input-group-btn">
                                    <button class="browse btn btn-primary" type="button">...</button>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="form-group" style="float: right;">
                    <div class="offset-sm-2 col-sm-10">
                        <button type="submit" class="btn btn-primary">Upload and check sample</button>
                    </div>
                </div>
            </form>
        </div>

    </template>

    <script>
        Polymer({
            is: 'variant-clinical-upload',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Number,
                    observer: 'updateVariableSets'
                },
                config: {
                    type: Object
                },
                prefix: {
                    type: String
                },
                variableSets: {
                    type: Array
                },
                variables: {
                    type: Array,
                    observer: 'variablesChanged'
                },
                minYear: {
                    type: Number,
                    value: 1920
                }
            },
            ready: function () {

                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = Utils.randomString(6);
                }
                let _years = [];
                let fullDate = new Date()
                let limitYear = fullDate.getFullYear();
                for (let year = this.minYear; year<=limitYear; year++)
                {_years.push(year);}
                // This change triggers the polymer dom-repeat
                this.years = _years;

                this._clearHtmlDom();
            },

            updateVariableSets: function () {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                    .then(function (response) {
                        _this.variableSets = response.response[0].result[0].variableSets;
                        if (_this.variableSets.length > 0) {
                            _this.variables = _this.variableSets[0].variables; // setting first one by default
                            _this.filteredVariables = {
                                variableSet: _this.variableSets[0].id,
                                variables: []
                            };
                        } else {
                            _this.variableSets = [{name : "none"}];
                        }
                    })
                    .catch(function () {
                        console.log("Could not obtain the variable sets of the study " + _this.study);
                    });


                for (let variable in this.variables)
                {
                    if(variable.attributes.prearranged == true)
                    {
                        $("#"+this.prefix+variable.name).prop('readonly',true);
                    }
                }



            },
            _sortVariables: function (a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            },
            variablesChanged: function () {
                this._areVariablesEmpty = (this.variables.length === 0);
            },
            checkCatType: function (myVar, type, lowerLimit, upperLimit) {
                return (myVar.type === type && myVar.allowedValues.length >= lowerLimit && myVar.allowedValues.length < upperLimit);
            },
            checkVarType: function (myVar, type) {
                return (myVar.type === type);
            },
            checkType: function (str1, str2) {
                if (str1.search(str2) != -1)
                {return true;}
                else
                {return false;}

            },
            checkYears: function(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                $("#" + this.prefix + "_errorDiv_birthYear").html("");
                $("#" + this.prefix + "_errorDiv_testYear").html("");

                let currentElement = $("#"+e.target.id);
                let identifier = e.target.id;
                let pairElement = '';
                let divSuffix = '';
                let message = '';

                if(identifier.search('birthYear')!=-1) // Birth year element raises the event -> check Test year
                {
                    pairElement = $("#" + this.prefix + "testYear");
                    divSuffix = "birthYear";
                    message = "Year of Birth must be prior to year of Test";
                }
                else { // Year of test element raises the event -> swap elements and check the birth year
                    currentElement = $("#" + this.prefix + "birthYear");
                    pairElement = $("#"+e.target.id);
                    divSuffix = "testYear";
                    message = "Year of Test must be posterior to year of Birth";
                }

                if(pairElement.find("option:selected")!='' && (parseInt(currentElement.find("option:selected").text())>parseInt(pairElement.find("option:selected").text())))
                { // Year of birth cannot be lower than Year of test
                    $("#" + this.prefix + "_errorDiv_"+divSuffix).html(message);
                }


            },
            updateSelect: function(e){



                console.log(this);
                debugger;
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                let currentElementId = e.target.id;
                let currentElement = $("#" +  e.target.id);
                if (currentElementId == (this.prefix + 'birthPlace')){
                    if (currentElement.val() == 'Spain'){
                        $("#" + this.prefix + "birthPlaceRegion").prop("disabled",false);
                    }
                    else
                    {
                        $("#" + this.prefix + "birthPlaceRegion").prop("disabled",true);
                        $("#" + this.prefix + "birthPlaceRegion").prop("selectedIndex",0);
                    }


                }
            },
            _clearHtmlDom: function() {

                // Empty everything before rendering
                $("." + this.prefix + "SelectInput").prop('selectedIndex', 0);
                $("." + this.prefix + "TextInput").val("");
                $("." + this.prefix + "CheckInput").prop("checked", false);
                $("." + this.prefix + "RadioInput").prop("checked", false);
                $("#" + this.prefix + "birthPlaceRegion").prop("disabled",true);
            }
        });
    </script>
</dom-module>