<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="variant-clinical-upload">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div class="col-md-12">
            <h3 style="margin: 10px 5px 15px 40px">Upload and check file</h3>

            <div style="width: 60%; margin: 0px 0px 0px 90px">

                <form id="{{prefix}}uploadForm" class="form-horizontal" data-toggle="validator" role="form">

                    <!-- GENERAL INFORMATION -->
                    <!-- Individual ID -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}sampleID" class="col-xs-2 col-form-label">Individual ID</label>
                        <div class="col-xs-6">
                            <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}sampleID" name="sampleID" placeholder="ID or clinical record number" maxlength="75" required data-error="" pattern=".+">
                            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>
                    <!-- CHROMOSOMAL GENDER -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}chromosomalGender" class="col-xs-2 col-form-label">Chromosomal Gender</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}chromosomalGender"
                                    name="chromosomalGender" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.chromosomal_gender}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_chromosomalGender"></div>
                        </div>
                    </div>
                    <!-- YEAR OF BIRTH -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}birthYear" class="col-xs-2 col-form-label">Year of Birth</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}birthYear"
                                    name="birthYear" required on-change="checkYears">
                                <option></option>
                                <template is="dom-repeat" items="{{yearsBirth}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthYear"></div>
                        </div>
                    </div>

                    <!-- BIRTH PLACE -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}birthPlace" class="col-xs-2 col-form-label">Birth Place</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}birthPlace"
                                    name="birthPlace" required on-change="updateSelect">
                                <option></option>
                                <template is="dom-repeat" items="{{config.countries}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthPlace"></div>
                        </div>
                    </div>

                    <!-- OTHER COUNTRY (TEXT INPUT if country selected is not in the list -->
                    <div class="form-group row has-feedback" id="otherCountryDiv" style="display:none">
                        <label for="{{prefix}}otherCountry" class="col-xs-2 col-form-label"></label>
                        <div class="col-xs-3">
                            <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}otherCountry" name="otherCountry" placeholder="Introduce country" maxlength="75" required data-error="Mandatory country. Only a-z characteres and spaces are allowed" pattern="^[A-Za-z]+((\\s)?([A-Za-z])+)+$">
                            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>

                    <!-- BIRTH PLACE (PROVINCE) -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}birthPlaceRegion" class="col-xs-2 col-form-label">Birth Place (province)</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}birthPlaceRegion"
                                    name="birthPlaceRegion" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.province}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>

                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_birthPlaceRegion"></div>
                        </div>
                    </div>

                    <!-- ETHNICITY -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}ethnicity" class="col-xs-2 col-form-label">Ethnicity</label>
                        <div class="col-xs-3">
                            <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}ethnicity"
                                    name="ethnicity" required>
                                <option></option>
                                <template is="dom-repeat" items="{{config.ethnicity}}">
                                    <option value="{{item.id}}">{{item.title}}</option>
                                </template>
                            </select>
                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_ethnicity"></div>
                        </div>
                    </div>


                    <!-- HPO TERM (ONTOLOGY) -->
                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}HPO" class="col-xs-2 col-form-label">HPO</label>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <textarea class$="form-control {{prefix}}TextInput" id="{{prefix}}HPO" name="HPO"
                                          placeholder="HP:0000947" required data-error="An HPO term must be selected" rows="2" style="resize:none"></textarea>
                                <span class="input-group-addon btn btn-primary" data-toggle="modal" data-target$="#{{prefix}}hpoModal">
                                    <i class="fa fa-search" aria-hidden="true"></i>
                                </span>
                            </div>
                            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                            <div class="help-block with-errors"></div>
                        </div>
                    </div>

                    <!-- DIAGNOSIS (ONTOLOGY) -->

                    <div class="form-group row has-feedback">
                        <label for="{{prefix}}diagnosis" class="col-xs-2 col-form-label">Diagnosis</label>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <textarea class$="form-control {{prefix}}TextInput" id="{{prefix}}diagnosis" name="diagnosis"
                                          placeholder="ICD-10 term" required data-error="A diagnosis term must be selected" readonly rows="2" style="resize:none"></textarea>
                                <span class="input-group-addon btn btn-primary" data-toggle="modal" data-target$="#{{prefix}}icd" on-click="showICDEditor">
                                    <i class="fa fa-search" aria-hidden="true"></i>
                                </span>
                            </div>
                            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                            <div class="help-block with-errors"></div>

                        </div>
                    </div>

                    <!-- SPECIFIC FIELDS FROM VARIABLE SET -->
                    <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" sort="_sortVariables">

                        <template is="dom-if" if="{{isVisible(variable,config)}}">
                            <div class="form-group row has-feedback">

                                <label for="{{prefix}}{{variable.name}}" class="col-xs-2 col-form-label">{{variable.title}}</label>

                                <template is="dom-if" if="{{checkVarType(variable, 'TEXT')}}">
                                    <!-- TEXT type: include an input text and add suitable regular expression for text-->
                                    <!-- http://stackoverflow.com/questions/14237686/disabling-controls-in-bootstrap-->

                                    <template is="dom-if" if="{{checkSubType(variable, 'STRING')}}">
                                        <!-- String subtype: include an input text and add suitable regular expression for text-->
                                        <div class="col-xs-6">
                                            <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                   placeholder="{{variable.defaultValue}}" maxlength="{{variable.attributes.maxLength}}" required
                                                   data-error="{{variable.attributes.errorPattern}}" pattern="{{variable.attributes.pattern}}">
                                            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                            <div class="help-block with-errors"></div>
                                        </div>
                                    </template>

                                    <template is="dom-if" if="{{checkSubType(variable, 'TEXT')}}">
                                        <!-- String subtype: include a text area and add suitable regular expression for text-->
                                        <div class="col-xs-6">
                                            <textarea class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                                      placeholder="{{variable.defaultValue}}" maxlength="{{variable.attributes.maxLength}}" required rows="5"
                                                      data-error="{{variable.attributes.errorPattern}}" pattern="{{variable.attributes.pattern}}"></textarea>
                                            <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                            <div class="help-block with-errors"></div>
                                        </div>
                                    </template>


                                </template>

                                <template is="dom-if" if="{{checkVarType(variable, 'NUMERIC')}}">
                                    <!-- NUMERIC type: include an input text and add suitable regular expression for numbers -->
                                    <div class="col-xs-6">
                                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}"
                                               placeholder="{{variable.name}} number" pattern="^[0-9]+$" maxlength="75" required data-error="Mandatory field. Only numbers are allowed ">
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 0, 1)}}">
                                    <!-- CATEGORICAL type, no value: values to be filled in this code -->
                                    <!-- Dropdown related to years : fill in with values contained in {{years}} -->
                                    <template is="dom-if" if="{{checkType(variable.name,'Year')}}">
                                        <div class="col-xs-6">
                                            <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}" required on-change="checkYears">
                                                <option></option>
                                                <template is="dom-repeat" items="{{yearsTest}}">
                                                    <option value="{{item}}">{{item}}</option>
                                                </template>
                                            </select>
                                            <div class="help-block with-errors" id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                        </div>
                                    </template>

                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 1, 2)}}">
                                    <!-- CATEGORICAL type, single value: check box -->
                                    <div class="col-xs-6">
                                        <input class$="{{prefix}}CheckInput" type="checkbox" id="{{prefix}}{{variable.name}}" name="{{variable.name}}" value="{{variable.name}}" style="padding-left: 20px" required>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 2, 3)}}">
                                    <!-- CATEGORICAL type, 2 values: radio buttons for selection -->
                                    <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                                    <div class="col-xs-6">
                                        <template is="dom-repeat" items="{{variable.allowedValues}}" as="value">
                                            <div class="form-check form-check-inline">
                                                <label class="form-check-label">
                                                    <input id="{{prefix}}{{variable.name}}{{value}}" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}" value="{{value}}"> {{value}}
                                                </label>
                                            </div>
                                        </template>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 3, 500)}}">
                                    <!-- CATEGORICAL type: dropdown: at least three elements in variable.allowedValues -->
                                    <div class="col-xs-3">
                                        <select class$="form-control {{prefix}}SelectInput" id="{{prefix}}{{variable.name}}" name="{{variable.name}}" required on-change="updateSelect">
                                            <option></option>
                                            <template is="dom-repeat" items="{{variable.allowedValues}}">
                                                <option value="{{item}}">{{item}}</option>
                                            </template>
                                        </select>
                                        <div class="help-block with-errors" id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                    </div>
                                </template>

                                <template is="dom-if" if="{{checkVarType(variable, 'BOOLEAN')}}">
                                    <!-- BOOLEAN type, 2 values: radio buttons for selection: yes or no -->
                                    <!--<label class="col-sm-3 control-label">{{variable.name}}-{{variable.type}}</label>-->
                                    <div class="col-xs-6">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label">
                                                <input id="{{prefix}}{{variable.name}}yes" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}" value="true"> yes
                                                <input id="{{prefix}}{{variable.name}}no" class$="form-check-input {{prefix}}RadioInput" type="radio" name="{{variable.name}}" value="false"> no
                                            </label>
                                        </div>
                                        <div class="help-block with-errors"></div>
                                    </div>
                                </template>
                            </div>
                        </template>
                    </template>

                    <div class="form-group row">
                        <label for="uploadInputFileVCF" class="col-xs-2 col-form-label">VCF or gVCF file</label>
                        <div class="col-xs-6">
                            <div class="input-group">
                                <input type="text" class$="form-control {{prefix}}TextInput" id="uploadInputFileVCF" name="inputFile" readonly>
                                <span class="input-group-btn">
                                    <label class="btn btn-primary" for="{{prefix}}FileToUpload">
                                        <input id="{{prefix}}FileToUpload" type="file" style="display:none;" onchange="$('#uploadInputFileVCF')[0].value=$(this).val().replace('C:\\fakepath\\','');">
                                        ...
                                    </label>
                                </span>
                            </div>
                        </div>
                        <span class='label label-info' id="upload-file-info"></span>
                    </div>

    <!--                <div class="form-group">
                        <label for="{{prefix}}inputFile" class="col-sm-3 control-label">VCF or gVCF file</label>
                        <div class="col-sm-9">
                            <input type="file" class="file" id="FileToUpload">
                            <div class="input-group">
                                <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}inputFile" name="inputFile">
                                <span class="input-group-btn">
                                        <button class="browse btn btn-primary" type="button">...</button>
                                </span>
                            </div>
                        </div>
                    </div>-->

                    <div class="form-group" style="float: right; width: 55%;">
                        <button type="submit" class="btn btn-primary" on-click="submitForm">Upload and check sample</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal dialog for HPO terms-->
        <div class="modal fade" id="{{prefix}}hpoModal" tabindex="-1" role="dialog"
             aria-labelledby="hpoLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 500px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}HPOEditorLabel">HPO terms selector</h4>
                    </div>
                    <div class="modal-body" style="height: 200px">
                        <div class="col-sm-12" >
                            <label>Under progress.</label>
                            Introduce an HPO term (HP:0202564) in the upload form (HPO text input)
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal dialog for ICD-10 diagnosis selector-->
        <div class="modal fade" id="{{prefix}}icd" tabindex="-1" role="dialog"
             aria-labelledby="icdLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 1300px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}Icd10EditorLabel">Diagnosis selector (ICD-10 Terms)</h4>
                    </div>
                    <div class="modal-body" style="height: 500px">
                        <div class="col-sm-12" >
                            <label>Introduce an ICD-10 term or select it from tree</label>
                        </div>
                        <div class="col-sm-6" style="overflow-y: auto; height:400px;">
                            <input id="{{prefix}}autoInput" list="icd_browser" class$="form-control {{prefix}}TextInput" placeholder="ICD-10 term" >
                            <datalist id="icd_browser" style="height:auto; max-height:100px; overflow-x:hidden;">
                                <template is="dom-repeat" items="{{icdTerms}}">
                                    <option value="{{item}}">
                                </template>

                            </datalist>
                        </div>

                        <div class="col-sm-6" style="overflow-y: auto; height:400px;">
                            <div id="{{prefix}}ICDtree"></div>
                        </div>
                        <div>
                            <div class="col-sm-3"></div>
                            <div class="col-sm-6" id="{{prefix}}errorTermDiv"><label></label></div>
                            <div class="col-sm-3"></div>
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" on-click="selectICD">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal dialog for VCF upload-->
        <div class="modal fade" id="{{prefix}}uploadModal" tabindex="-1" role="dialog"
             aria-labelledby="uploadLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 500px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}uploadLabel">VCF upload</h4>
                    </div>
                    <div class="modal-body" style="height: 200px">
                        <div class="col-sm-12" >
                            <label>VCF has been uploaded. You can now proceed to Analysis</label>
                            VCF validation is under progress.
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'variant-clinical-upload',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Number,
                    observer: 'updateVariableSets'
                },
                config: {
                    type: Object
                },
                prefix: {
                    type: String
                },
                variableSets: {
                    type: Array
                },
                variables: {
                    type: Array,
                    observer: 'variablesChanged'
                },
                minYearBirth: {
                    type: Number,
                    value: 1920
                },
                minYearTest: {
                    type: Number,
                    value: 2005
                },
                clearDom: {
                    type: Object,
                    observer: "_clearHtmlDom"
                }
            },
            ready: function () {

                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "upload" + Utils.randomString(6);
                }
                let _years = [];
                let fullDate = new Date();
                let limitYear = fullDate.getFullYear();
                for (let year = this.minYearBirth; year<=limitYear; year++)
                {_years.push(year);}
                // This change triggers the polymer dom-repeat
                this.yearsBirth = _years;

                _years = [];
                for (year = this.minYearTest; year<=limitYear; year++)
                {_years.push(year);}
                // This change triggers the polymer dom-repeat
                this.yearsTest = _years;

                this._clearHtmlDom();
                //this.set('icd10Terms', ICD_10);



            },
            updateVariableSets: function () {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                    .then(function (response) {
                        _this.variableSets = response.response[0].result[0].variableSets;
                        if (_this.variableSets.length > 0) {
                            _this.variables = _this.variableSets[0].variables; // setting first one by default
                            _this.filteredVariables = {
                                variableSet: _this.variableSets[0].id,
                                variables: []
                            };
                        } else {
                            _this.variableSets = [{name : "none"}];
                        }
                    })
                    .catch(function () {
                        console.log("Could not obtain the variable sets of the study " + _this.study);
                    });



                for (let variable in this.variables)
                {
                    if(variable.attributes.prearranged == true)
                    {
                        $("#"+this.prefix+variable.name).prop('readonly',true);
                    }
                }



            },
            _sortVariables: function (a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            },
            variablesChanged: function () {
                this._areVariablesEmpty = (this.variables.length === 0);
            },
            checkCatType: function (myVar, type, lowerLimit, upperLimit) {
                return (myVar.type === type && myVar.allowedValues.length >= lowerLimit && myVar.allowedValues.length < upperLimit);
            },
            checkVarType: function (myVar, type) {
                return (myVar.type === type);
            },
            checkSubType: function (myVar, type) {
                return (myVar.attributes.subtype === type);
            },
            isVisible: function (myVar,conf){
                let excludeArray = conf.variableSet.exclude
                for (let index in excludeArray) {
                    if (excludeArray[index].webComponent == this.localName) {
                        return (!($.inArray(myVar.name, excludeArray[index].variables) != -1));
                    } else {return true;}
                }
            },
            checkType: function (str1, str2) {
                if (str1.search(str2) != -1)
                {return true;}
                else
                {return false;}

            },
            checkYears: function(e) {

                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                $("#" + this.prefix + "_errorDiv_birthYear").html("");
                $("#" + this.prefix + "_errorDiv_testYear").html("");

                let identifier = e.target.id;
                let message = '';
                let currentElement = $();
                let valueCE = '';
                let pairElement = $();
                let valuePE = '';

                if(identifier.search('birthYear')!=-1) // Birth year element raises the event -> check Test year
                {
                    // Check Year of Test
                    $("#" + this.prefix + "_errorDiv_age").html("");
                    currentElement = $("#"+e.target.id);
                    valueCE = currentElement.find("option:selected").text();
                    pairElement = $("#" + this.prefix + "testYear");
                    valuePE = pairElement.find("option:selected").text();

                    if(valuePE != '' && (parseInt(valueCE) > parseInt(valuePE)))
                    { // Year of birth cannot be lower than Year of test
                        message = "Year of Birth must be prior to year of Test. ";
                        $("#" + this.prefix + "_errorDiv_birthYear").html(message);
                    }
                    // Check Age
                    pairElement = $("#" + this.prefix + "age");
                    valuePE = pairElement.find("option:selected").text();
                    let fullDate = new Date();
                    if (valuePE != '' && !(parseInt(valuePE) >= (fullDate.getFullYear() - parseInt(valueCE) - 1) && parseInt(valuePE) <= fullDate.getFullYear() - parseInt(valueCE))) {
                        // If year of birth is 2015, person is 1 or 2 years old (assuming 2017 is current year)
                        $("#" + this.prefix + "_errorDiv_birthYear").html(message + "Year of Birth does not match age");
                    }

                }
                else { // Year of test element raises the event -> swap elements and check the birth year
                    currentElement = $("#" + this.prefix + "birthYear");
                    valueCE = currentElement.find("option:selected").text();
                    pairElement = $("#"+e.target.id);
                    valuePE = pairElement.find("option:selected").text();

                    if(valuePE != '' && (parseInt(valueCE) > parseInt(valuePE)))
                    { // Year of birth cannot be lower than Year of test
                        $("#" + this.prefix + "_errorDiv_testYear").html("Year of Test must be posterior to year of Birth");
                    }
                }




            },
            showICDEditor: function (e) {

                $("#" + this.prefix + "errorTermDiv").html("");
                this.$$("#" + this.prefix + "autoInput").value="";
                this.icdTerms = this.getICDterms();


                let _this = this;
                $("#" + this.prefix +"ICDtree").treeview({
                    data: ICD_10,
                    onNodeSelected: function(event, node) {
                        _this.$$("#" + _this.prefix + "autoInput").value=node.text;
                        //$("#" + _this.prefix + "autoInput").trigger("input"); // Necessary to avoid another matching nodes


                    },
                    onNodeUnselected: function(event, node) {
                        _this.$$("#" + _this.prefix + "autoInput").value="";


                    },


                });

                $("#" + this.prefix + "ICDtree").treeview('collapseAll', {silent: true});


                $("#" + this.prefix + "autoInput").on("input", function(){
                    $("#" + _this.prefix + "ICDtree").treeview('collapseAll', {silent: true});
                    $("#" + _this.prefix + "ICDtree").treeview('search', [ this.value, {
                        ignoreCase: true,     // case insensitive
                        exactMatch: false,    // like or equals
                        revealResults: true,  // reveal matching nodes
                    }]);
                });

            },

            getICDterms: function(){
                // In ICD_10 there are up to three nested levels

                let _auxTerms = [];
                for (let i=0; i < ICD_10.length; i++)
                {
                    _auxTerms.push(ICD_10[i].text);
                    for (let j=0; j < ICD_10[i].nodes.length; j++)
                    {
                        _auxTerms.push('   ' + ICD_10[i].nodes[j].text);
                        for (let k=0; k < ICD_10[i].nodes[j].nodes.length; k++)
                        {
                            _auxTerms.push('     ' + ICD_10[i].nodes[j].nodes[k].text);
                        }
                    }

                }

                return _auxTerms;

            },
            selectICD: function(e) {
                e.preventDefault();

                selectedTerm = this.$$("#" + this.prefix + "autoInput").value.replace(/^\s+/g, '');
                if (selectedTerm != "") { // Check that the term is correct (one of the list)
                    let _icdTermsNS = $.map(this.icdTerms, function(elem){return elem.replace(/^\s+/g, '')});
                    if ($.inArray(selectedTerm, _icdTermsNS)!= -1) {
                        this.$$("#" + this.prefix + "diagnosis").value = selectedTerm;
                        $("#" + this.prefix + "icd").modal('hide');
                    }
                    else
                    {
                        $("#" + this.prefix + "errorTermDiv").html("A proper ICD-10 term must be selected from the list or tree");
                    }
                }
                else {
                    this.$$("#" + this.prefix + "diagnosis").value = '';
                    $("#" + this.prefix + "icd").modal('hide');
                }

            },
            updateSelect: function(e){

                $("#" + this.prefix + "_errorDiv_testAge").html("");


                //console.log(this);
                //debugger;
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                //console.log(this);
                //debugger;
                let currentElementId = e.target.id;
                let currentElement = $("#" +  e.target.id);
                // Dropdown related to birthplace
                if (currentElementId == (this.prefix + 'birthPlace')){
                    if (currentElement.val() == 'Spain'){
                        $("#otherCountryDiv").hide();
                        $("#" + this.prefix + "otherCountry").prop("required",false);
                        $("#" + this.prefix + "birthPlaceRegion").prop("disabled",false);
                        $("#" + this.prefix + "birthPlaceRegion").prop("required",true);
                    }
                    else
                    {
                        $("#" + this.prefix + "birthPlaceRegion").prop("disabled",true);
                        $("#" + this.prefix + "birthPlaceRegion").prop("selectedIndex",0);
                        $("#" + this.prefix + "birthPlaceRegion").prop("value","unknown");
                        $("#" + this.prefix + "birthPlaceRegion").prop("required",false);
                        if (currentElement.val() == 'Other')
                        {// Display input text to introduce country
                            $("#otherCountryDiv").show();
                            $("#" + this.prefix + "otherCountry").prop("required",true);
                        }
                        else
                        {
                            $("#otherCountryDiv").hide();
                            $("#" + this.prefix + "otherCountry").prop("required",false);
                        }
                    }


                } else if (currentElementId == (this.prefix + 'testAge')){
                    // Dropdown related to age of Test -> check hat year of birth is correct

                    let pairElement = $("#" + this.prefix + "birthYear");
                    let valuePE = pairElement.find("option:selected").text();
                    if (valuePE !='') {
                        let birthYear = parseInt(valuePE);
                        let fullDate = new Date();
                        if (!(parseInt(currentElement.val()) >= (fullDate.getFullYear() - birthYear - 1) && parseInt(currentElement.val()) <= fullDate.getFullYear() - birthYear)) {
                            $("#" + this.prefix + "_errorDiv_testAge").html("Age selected does not match year of Birth");
                        }
                    }

                }
            },
            _clearHtmlDom: function() {

                $("#" + this.prefix + "uploadForm").validator('destroy');
                // Empty everything before rendering
                $("." + this.prefix + "SelectInput").prop('selectedIndex', 0);
                $("." + this.prefix + "TextInput").val("");
                $("." + this.prefix + "CheckInput").prop("checked", false);
                $("." + this.prefix + "RadioInput").prop("checked", false);
                $("#" + this.prefix + "birthPlaceRegion").prop("disabled",true);

                $("#" + this.prefix + "uploadForm").validator('update');
            },


            createAnnotationSet: function(sampleId, formFields){
                // Create an annotation set in openCGA for a sample
                let jsonAnnotation = {};
                $(this.variableSets[0].variables).each(function(index, currentVariable){
                    jsonAnnotation[currentVariable.name] = formFields[currentVariable.name];
                });

                let params = {
                    study: this.study.alias,
                    variableSetId: this.variableSets[0].id,
                    body: {
                        "name": "annotation_sample_" + sampleId, // hardcoded
                        "annotations": jsonAnnotation
                    }

                };
                let _this = this;
                _this.sampleId = sampleId;
                this.opencgaClient.samples().annotationsetsCreate(sampleId, params, {"method": "POST"})
                    .then(function (response) {
                        console.log(response);
                    })
                    .catch(function() {
                        console.log("Could not create annotation set for the sample " + _this.sampleId);
                    });



            },

            linkSampleIndividual: function(individualId, sampleId){
                // Link a sample and an individual in openCGA
                let params = {
                    study: this.study.alias,
                    body: {
                        "individual.id": individualId
                    }
                };
                let _this= this;
                _this.individualId = individualId;
                _this.sampleID = sampleId;
                this.opencgaClient.samples().update(sampleId, params, {"method": "POST"})
                    .then(function (response) {
                        console.log(response);
                    })
                    .catch(function() {
                        console.log("Could not link sample " + _this.sampleId + " and individual " + _this.individualId);
                    });
            },

            indexVCF: function(fileId){
                // Index and annotate a VCF file in openCGA
                let params = {
                    file: fileId,
                    study: this.study.alias,
                    outDir: fileId + "_index_annot",
                    calculateStats: true,
                    annotate: true
                };
                let _this = this;
                _this.fileId = fileId;
                this.opencgaClient.variants().index(params)
                    .then(function (response) {
                        console.log(response);
                    })
                    .catch(function() {
                        console.log("Could not index file " + _this.fileId);
                    });

                this.showUploadModal();

            },
            uploadVCF: function(individualId, formFields) {
                // Upload VCF file to openCGA
                if (this.opencgaClient instanceof OpenCGAClient) {
                    params = {
                        study: this.study.alias,
                        type: "FILE",
                        file: $("#" + this.prefix + "FileToUpload").prop('files')[0],
                        fileFormat: "VCF",
                        bioformat: "VARIANT",
                        relativeFilePath: "."
                    };

                    let _this = this;
                    _this.individualId = individualId;

                    this.opencgaClient.files().upload(params)
                        .then(function (response) {
                            console.log(response);
                            let _sampleId = response.response[0].result[0].sampleIds[0];
                            let _fileId = response.response[0].result[0].id;
                            // 3. Create an annotation set
                            _this.createAnnotationSet(_sampleId, formFields);
                            // 4. Link sample and individual
                            _this.linkSampleIndividual(_this.individualId, _sampleId);
                            // 5. Index and annotate VCF
                            _this.indexVCF(_fileId);

                        })
                        .catch(function () {
                            console.log("Could not upload VCF file for the study " + _this.study);
                        });
                }
            },
            openCGAsteps: function(formFields) {
                // The following steps are run to register the form in openCGA:
                // 1. Create the individual (returns an individualId)
                // 2. Upload VCF (returns a sampleId, since a Sample is created automatically and a fileId)
                // 3. Create an annotation set given the sampleId provided in step 2
                // 4. Link the sample (sampleId) and the individual (individualId)
                // 5. Index and annotate the VCF file (using fileId obtained in step 2)


                if (this.opencgaClient instanceof OpenCGAClient) {
                    // 1. Create individual
                    let params = {
                        study: this.study.alias,
                        body: {
                            "name": formFields.sampleID,
                            "family": "",
                            "fatherId": -1,
                            "motherId": -1,
                            "sex": "UNKNOWN",
                            "ethnicity": formFields.ethnicity,
                            "species": {
                                "taxonomyCode": "9606",
                                "scientificName": "Homo sapiens",
                                "commonName": "Homo sapiens"
                            },
                            "population": {
                                "name": formFields.birthPlace,
                                "subpopulation": formFields.birthPlaceRegion,
                                "description": ""
                            },
                            "karyotypicSex": formFields.chromosomalGender,
                            "lifeStatus": "UNKNOWN",
                            "affectationStatus": "UNKNOWN"
                        }
                    };



                    let _this = this;
                    this.opencgaClient.individuals().create(params, {"method": "POST"})
                        .then(function (response) {
                            let individualId = response.response[0].result[0].id;
                            // 2. Upload VCF
                            _this.uploadVCF(individualId, formFields);

                        })
                        .catch(function () {
                            console.log("Could not create individual for the study " + _this.study);
                        });

                }

            },

            submitForm: function(e) {
                e.preventDefault();


                // Get values from form fields
                let fields = $("#"+ this.prefix + "uploadForm").serializeArray();

                let formFields = {};

                // fill-in variable set
                $(fields).each(function(index, field){
                    formFields[field.name] = field.value;
                });

                // Register the form in openCGA through different steps
                this.openCGAsteps(formFields);



                // Submit the form
                //$("#" + this.prefix + "uploadForm").submit();
                //console.log(this);
                //debugger;
            },
            showUploadModal: function(){

                $("#" + this.prefix + "uploadModal").modal("show");
                this._clearHtmlDom();

            }


        });
    </script>
</dom-module>