<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../opencga-active-filters.html">

<dom-module id="variant-facet-view">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div>
            <br>
            <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}" alias="{{activeFilterAlias}}"></opencga-active-filters>
            <div class="panel panel-default col-sm-12">
                <!-- Facet Fields -->
                <div class="col-sm-12">
                    <div class="col-sm-8">
                        <h4>Fields</h4>
                        <div class="form-group row">
                            <div class="col-sm-3">
                                <select id="{{prefix}}FacetField" class$="form-control {{prefix}}FilterSelect">
                                    <option value="none" selected>Select a field...</option>
                                    <template is="dom-repeat" items="{{config.facetFields}}">
                                        <option value="{{item.value}}">{{item.name}}</option>
                                    </template>
                                </select>
                            </div>
                            <div class="col-sm-3">
                                <textarea class="form-control" rows="1" id="{{prefix}}IncludesTextarea" placeholder="Include valid values"></textarea>
                            </div>
                            <div class="col-sm-3">
                                <select id="{{prefix}}FacetFieldNested" class$="form-control {{prefix}}FilterSelect">
                                    <option value="none" selected>Nest within...</option>
                                    <template is="dom-repeat" items="{{config.facetFields}}">
                                        <option value="{{item.value}}">{{item.name}}</option>
                                    </template>
                                    <template is="dom-repeat" items="{{facetFieldsName}}" filter="_isValidField">
                                        <option value="{{item.value}}">{{item.name}}</option>
                                    </template>
                                </select>
                            </div>
                            <button type="button" class="btn btn-primary" on-click="addFacets" style="cursor: pointer">Add</button>
                        </div>
                    </div>

                    <div class="panel-body col-sm-4">
                        <template is="dom-repeat" items="{{facetFieldsName}}">
                        <span style="font-size: 14px">
                            <span title="Remove field">
                                <i class="fa fa-times fa-lg" aria-hidden="true" on-click="removeFacetFields" data-id="{{item.value}}" data-field="field" style="color: darkred;cursor: pointer"></i>
                            </span>&nbsp;{{item.name}}
                        </span>
                            <br>
                        </template>
                    </div>
                </div>

                <!-- Facet Range -->
                <div class="col-sm-12">
                    <div class="col-sm-8">
                        <h4>Ranges</h4>
                        <!-- Conservation & Deleteriousness -->
                        <h5><b><i class="fa fa-angle-double-right" aria-hidden="true"></i>&nbsp; Conservation & Deleteriousness</b></h5>
                        <div class="form-group row">
                            <div class="col-sm-3">
                                <select id="{{prefix}}FacetRangeField" class$="form-control {{prefix}}FilterSelect">
                                    <option value="none" selected>Select a field...</option>
                                    <template is="dom-repeat" items="{{config.facetRangeFields}}">
                                        <option value="{{item}}">{{item}}</option>
                                    </template>
                                </select>
                            </div>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon">Start</span>
                                    <input type="text" class="form-control" id="{{prefix}}FacetRangeStart" value="0">
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon">End</span>
                                    <input type="text" class="form-control" id="{{prefix}}FacetRangeEnd" value="1">
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon">Interval</span>
                                    <input type="text" class="form-control" id="{{prefix}}FacetRangeGap" value="0.1">
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" on-click="addFacets" style="cursor: pointer">Add
                            </button>
                        </div>

                        <!-- Population frequency -->
                        <h5><b><i class="fa fa-angle-double-right" aria-hidden="true"></i>&nbsp; Population frequency</b></h5>
                        <div class="form-group row">
                            <div class="col-sm-3">
                                <select id="{{prefix}}PopFreqRangeField" class$="form-control {{prefix}}FilterSelect">
                                    <option value="none" selected>Select a population...</option>
                                    <template is="dom-repeat" items="{{populationFrequencies.studies}}" as="study">
                                        <template is="dom-repeat" items="{{study.populations}}" as="population">
                                            <option value="{{study.id}}_{{population.id}}">{{study.id}}_{{population.id}}</option>
                                        </template>
                                    </template>
                                </select>
                            </div>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon">Start</span>
                                    <input type="text" class="form-control" id="{{prefix}}PopFreqRangeStart" value="0">
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon">End</span>
                                    <input type="text" class="form-control" id="{{prefix}}PopFreqRangeEnd" value="1">
                                </div>
                            </div>
                            <div class="col-sm-2">
                                <div class="input-group">
                                    <span class="input-group-addon">Interval</span>
                                    <input type="text" class="form-control" id="{{prefix}}PopFreqRangeGap" value="0.1">
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" on-click="addFacets" style="cursor: pointer">Add
                            </button>
                        </div>

                    </div>
                    <div class="panel-body col-sm-4">
                        <template is="dom-repeat" items="{{facetRangeFields}}">
                        <span style="font-size: 14px">
                            <span title="Remove field">
                              <i class="fa fa-times fa-lg" aria-hidden="true" on-click="removeFacetFields"
                                 data-id="{{item}}" data-field="range" style="color: darkred;cursor: pointer"></i>
                            </span>&nbsp;{{item}}
                        </span><br>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Chromosome -->
            <div class="panel panel-default col-sm-12">
                <div class="col-sm-8" style="margin-left: 10px">
                    <h4>Chromosome</h4>
                    <div class="form-group row">
                        <div class="col-sm-3">
                            <input type="text" class="form-control" id="{{prefix}}ChromosomeInput" placeholder="1,2,3...21,X,Y,MT">
                        </div>
                        <div class="col-sm-3">
                            <div class="input-group">
                                <span class="input-group-addon">Interval</span>
                                <select id="{{prefix}}ChromosomeRangeGap" class$="form-control {{prefix}}FilterSelect">
                                    <option value="1000000" selected>1000000</option>
                                    <option value="2000000">2000000</option>
                                    <option value="5000000">5000000</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary" on-click="addFacets" style="cursor: pointer">Add
                        </button>
                    </div>
                </div>
                <div class="panel-body col-sm-4">

                </div>
            </div>

            <div style="float: right; padding: 0px 0px 5px 5px">
                <button type="button" class="btn btn-primary btn-lg" on-click="loadPlots">Refresh</button>
            </div>

            <div style="float: right; padding: 0px 0px 5px 0px">
                <button type="button" class="btn btn-primary btn-lg" on-click="clearAll">Clear</button>
            </div>

            <!-- Facet Plots -->
            <h2>Results</h2>

            <!--<template is="dom-if" if="{{_loading}}">-->
                <div id="{{prefix}}Loading" hidden="{{!_loading}}">
                    <h4>Loading...</h4>
                </div>
            <!--</template>-->

            <!--<h4>Total Number of Variants : {{totalVariants}}</h4>-->
            <template is="dom-repeat" items="{{results}}" id="resultsDiv">
                <h3>{{item.title}}</h3>
                <div class="btn-group" style="float: right">
                    <label class="btn btn-primary">
                        <i class="fa fa-bar-chart" style="padding-right: 5px" title="Bar Chart"></i>
                    </label>
                    <label class="btn btn-primary" on-click="setPieChart">
                        <i class="fa fa-pie-chart" style="padding-right: 5px" title="Pie Chart"></i>
                    </label>
                    <label class="btn btn-primary">
                        <i class="fa fa-table" style="padding-right: 5px" title="Tabular View"></i>
                    </label>
                </div>
                <div id="{{prefix}}{{item.name}}Plot" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
                <br>
            </template>

        </div>
    </template>
    <script>
        Polymer({
            is: 'variant-facet-view',
            properties: {
                project: {
                    type: Object
                },
                study: {
                    type: Object
                },
                config: {
                    type: Object
                },
                opencgaClient: {
                    type: Object
                },
                cellbaseClient: {
                    type: Object
                },
                populationFrequencies: {
                    type: Object
                },
                query: {
                    type: Object
                },
                search: {
                    type: Object,
                    observer: 'fetchVariants'
                }
            },
            ready: function () {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "facet" + Utils.randomString(6);
                }

                this.activeFilterAlias = {
                    "annot-xref": "XRef",
                    "annot-biotype": "Biotype",
                    "annot-ct": "Consequence Types",
                    "annot-population-maf": "Population Frequency",
                    "annot-functional-score": "CADD",
                    "protein_substitution": "Protein Substitution",
                    "annot-go": "GO",
                    "annot-hpo": "HPO"
                };

                this.facetFields = [];
                this.facetFieldsName = [];
                this.facetRangeFields = [];
                this.facetRanges = [];

                this.results = [];
                this._loading = false;
                this.plotType = "column";
            },
            addFacets: function () {
                // Facets
                if (this.$$("#" + this.prefix + "FacetField").value != "none") {
                    // Check if the nested field is a valid value
                    if (this.$$("#" + this.prefix + "FacetFieldNested").value != "none"
                        && this.$$("#" + this.prefix + "FacetFieldNested").value != this.$$("#" + this.prefix + "FacetField").value) {
                        // Take it into account only if it is not present already in the selected values
                        if (this.facetFields.indexOf(this.$$("#" + this.prefix + "FacetField").value + ":" + this.$$("#" + this.prefix + "FacetFieldNested").value) == -1) {
                            // Check if 'includes' is present
                            if (this.$$("#" + this.prefix + "IncludesTextarea").value != "") {
                                this.push('facetFieldsName', {
                                    name: $("#" + this.prefix + "FacetFieldNested option:selected").text() + " >> " + $("#" + this.prefix + "FacetField option:selected").text()
                                    + " [ " + this.$$("#" + this.prefix + "IncludesTextarea").value + " ] ",
                                    value: this.$$("#" + this.prefix + "FacetFieldNested").value + ">>" + this.$$("#" + this.prefix + "FacetField").value + "["
                                    + this.$$("#" + this.prefix + "IncludesTextarea").value + "]"
                                });
                                this.push('facetFields', this.$$("#" + this.prefix + "FacetFieldNested").value + ">>" + this.$$("#" + this.prefix + "FacetField").value
                                + "[" + this.$$("#" + this.prefix + "IncludesTextarea").value + "]");
                            } else {
                                this.push('facetFieldsName', {
                                    name: $("#" + this.prefix + "FacetFieldNested option:selected").text() + " >> " + $("#" + this.prefix + "FacetField option:selected").text(),
                                    value: this.$$("#" + this.prefix + "FacetFieldNested").value + ">>" + this.$$("#" + this.prefix + "FacetField").value
                                });
                                this.push('facetFields', this.$$("#" + this.prefix + "FacetFieldNested").value + ">>" + this.$$("#" + this.prefix + "FacetField").value);
                            }
                        }
                    } else {
                        if (this.$$("#" + this.prefix + "IncludesTextarea").value !== "") {
                            this.push('facetFieldsName', {
                                name: $("#" + this.prefix + "FacetField option:selected").text() + " [ " + this.$$("#" + this.prefix + "IncludesTextarea").value + " ] ",
                                value: this.$$("#" + this.prefix + "FacetField").value + "[" + this.$$("#" + this.prefix + "IncludesTextarea").value + "]"
                            });
                            this.push('facetFields', this.$$("#" + this.prefix + "FacetField").value + "[" + this.$$("#" + this.prefix + "IncludesTextarea").value + "]");
                        } else {
                            this.push('facetFieldsName', {name: $("#" + this.prefix + "FacetField option:selected").text(), value: this.$$("#" + this.prefix + "FacetField").value});
                            this.push('facetFields', this.$$("#" + this.prefix + "FacetField").value);
                        }
                    }
                    this.$$("#" + this.prefix + "FacetField").value = "none";
                    this.$$("#" + this.prefix + "FacetFieldNested").value = "none";
                    this.$$("#" + this.prefix + "IncludesTextarea").value = ""
                }

                // Facets Range
                if (this.$$("#" + this.prefix + "FacetRangeField").value !== "none" && this.$$("#" + this.prefix + "FacetRangeStart").value !== ""
                    && this.$$("#" + this.prefix + "FacetRangeEnd").value !== "" && this.$$("#" + this.prefix + "FacetRangeGap").value !== ""
                    && !isNaN(this.$$("#" + this.prefix + "FacetRangeStart").value) && !isNaN(this.$$("#" + this.prefix + "FacetRangeEnd").value)
                    && !isNaN(this.$$("#" + this.prefix + "FacetRangeGap").value)) {
                    // if any of the field is already selected, remove the old value before pushing
                    for (let i = 0; i < this.facetRanges.length; i++) {
                        if (this.facetRanges[i].startsWith(this.$$("#" + this.prefix + "FacetRangeField").value)) {
                            this.splice('facetRanges', i, 1);
                            this.splice('facetRangeFields', i, 1);
                            break;
                        }
                    }
                    let value = this.$$("#" + this.prefix + "FacetRangeField").value.charAt(0).toUpperCase() + this.$$("#" + this.prefix + "FacetRangeField").value.slice(1);
                    this.push('facetRangeFields', value + "[" + this.$$("#" + this.prefix + "FacetRangeStart").value
                        + "," + this.$$("#" + this.prefix + "FacetRangeEnd").value + "], Interval :" + this.$$("#" + this.prefix + "FacetRangeGap").value);
                    this.push('facetRanges', this.$$("#" + this.prefix + "FacetRangeField").value + ":" + this.$$("#" + this.prefix + "FacetRangeStart").value
                        + ":" + this.$$("#" + this.prefix + "FacetRangeEnd").value + ":" + this.$$("#" + this.prefix + "FacetRangeGap").value);
                    this.$$("#" + this.prefix + "FacetRangeField").value = "none";
                    this.$$("#" + this.prefix + "FacetRangeStart").value = "0";
                    this.$$("#" + this.prefix + "FacetRangeEnd").value = "1";
                    this.$$("#" + this.prefix + "FacetRangeGap").value = "0.1";
                }

                // Population Frequency Range
                if (this.$$("#" + this.prefix + "PopFreqRangeField").value !== "none" && this.$$("#" + this.prefix + "PopFreqRangeStart").value !== ""
                    && this.$$("#" + this.prefix + "PopFreqRangeEnd").value !== "" && this.$$("#" + this.prefix + "PopFreqRangeGap").value !== ""
                    && !isNaN(this.$$("#" + this.prefix + "PopFreqRangeStart").value) && !isNaN(this.$$("#" + this.prefix + "PopFreqRangeEnd").value)
                    && !isNaN(this.$$("#" + this.prefix + "PopFreqRangeGap").value)) {
                    // if any of the field is already selected, remove the old value before pushing
                    for (let i = 0; i < this.facetRanges.length; i++) {
                        if (this.facetRanges[i].startsWith(this.$$("#" + this.prefix + "PopFreqRangeField").value)) {
                            this.splice('facetRanges', i, 1);
                            this.splice('facetRangeFields', i, 1);
                            break;
                        }
                    }
                    this.push('facetRangeFields', this.$$("#" + this.prefix + "PopFreqRangeField").value + "[" + this.$$("#" + this.prefix + "PopFreqRangeStart").value
                        + "," + this.$$("#" + this.prefix + "PopFreqRangeEnd").value + "], Interval :" + this.$$("#" + this.prefix + "PopFreqRangeGap").value);
                    this.push('facetRanges', "popFreq_" + this.$$("#" + this.prefix + "PopFreqRangeField").value + ":" + this.$$("#" + this.prefix + "PopFreqRangeStart").value
                        + ":" + this.$$("#" + this.prefix + "PopFreqRangeEnd").value + ":" + this.$$("#" + this.prefix + "PopFreqRangeGap").value);
                    this.$$("#" + this.prefix + "PopFreqRangeField").value = "none";
                    this.$$("#" + this.prefix + "PopFreqRangeStart").value = "0";
                    this.$$("#" + this.prefix + "PopFreqRangeEnd").value = "1";
                    this.$$("#" + this.prefix + "PopFreqRangeGap").value = "0.1";
                }

//                // Chromosome
//                if (this.$$("#" + this.prefix + "ChromosomeInput").value !== "") {
//                    this.chromosome = this.$$("#" + this.prefix + "ChromosomeInput").value;
//                    this.push("facetRanges", "start:" + chromosomes)
//                }

            },
            removeFacetFields: function (e) {
                if (e.target.dataset.field == "field") {
                    let index = this.facetFields.indexOf(e.target.dataId);
                    this.splice('facetFields', index, 1);
                    for (let i = 0; i < this.facetFieldsName.length; i++) {
                        if (this.facetFieldsName[i].value == e.target.dataId) {
                            this.splice('facetFieldsName', i, 1);
                            break;
                        }
                    }
                } else if (e.target.dataset.field == "range") {
                    let index = this.facetRangeFields.indexOf(e.target.dataId);
                    this.splice('facetRangeFields', index, 1);
                    this.splice('facetRanges', index, 1);
                }
            },
            fetchVariants: function () {
                if (typeof this.opencgaClient !== "undefined") {
                    let queryParams = {
                        sid: this.opencgaClient._config.sessionId,
                        timeout: 60000,
                        summary: true,
                        limit: 1
                    };
                    Object.assign(queryParams, this.query);

                    if (typeof queryParams.studies === "undefined" || queryParams.studies === "" || queryParams.studies.split(new RegExp("[,;]")).length == 1) {
                        queryParams.studies = this.project.alias + ":" + this.study.alias;
                    }

                    let _this = this;
                    this.opencgaClient.variants().query(queryParams, {})
                        .then(function (response) {
                            _this.totalVariants = response.response[0].numTotalResults;
                        });
                }
            },
            loadPlots: function () {
                if (typeof this.opencgaClient === "undefined") {
                    return;
                }

                if (this.facetFields.length === 0 && this.facetRangeFields.length === 0) {
                    alert("Add some facet fields.");
                    return;
                }

                this.clearPlots();
                this.results = []; // Clear the previous divs
                this._loading = true;

                let fieldNamesMap = {};
                for (let f of this.config.facetFields) {
                    fieldNamesMap[f.value] = f.name;
                }

                let queryParams = {
                    sid: this.opencgaClient._config.sessionId,
                    timeout: 60000
                };
                Object.assign(queryParams, this.query);

                if (typeof queryParams.sid === "undefined" || queryParams.sid === "") {
                    delete queryParams["sid"];
                }

                if (typeof queryParams.studies === "undefined" || queryParams.studies === "" || queryParams.studies.split(new RegExp("[,;]")).length == 1) {
                    queryParams.studies = this.project.alias + ":" + this.study.alias;
                }

                if (this.facetFields.length > 0) {
                    queryParams.facet = this.facetFields.join(";");
                }
                if (this.facetRanges.length > 0) {
                    queryParams.facetRange = this.facetRanges.join(";");
                }

                let _this = this;
                this.opencgaClient.variants().facet(queryParams, {})
                    .then(function (queryResponse) {
                        let response = queryResponse.response[0].result[0].result;
                        let _results = [];

                        let facetMap = new Map();

                        // Facet fields
                        for (let field of response.fields) {
                            let obj = {
                                name: field.name,
                                title: fieldNamesMap[field.name],
                                categories: [],
                                series: []
                            };
                            let series = {};
                            let data = [];
                            for (let i = 0; i < field.counts.length; i++) {
                                let countObj = field.counts[i];
                                obj.categories.push(countObj.value);
                                if (typeof countObj.field !== "undefined") {
                                    obj.nestedField = countObj.field.name;
                                    for (let nestedCountObj of countObj.field.counts) {
                                        if (typeof series[nestedCountObj.value] === "undefined") {
                                            series[nestedCountObj.value] = [];
                                        }
                                        // It is important to push 'index' as we need to take care of the missing values
                                        series[nestedCountObj.value].push({index: i, count: nestedCountObj.count});
                                    }
                                } else {
                                    data.push(countObj.count);
                                }
                            }

                            if (Object.keys(series).length > 0) {
                                for (let key in series) {
                                    let data = [];
                                    for (let countIndex of series[key]) {
                                        data[countIndex.index] = countIndex.count;
                                    }
                                    for (let i = 0; i < data.length; i++) {
                                        if (typeof data[i] === "undefined") {
                                            data[i] = 0; // Setting '0' for missing fields
                                        }
                                    }
                                    obj.series.push({name: key, data: data});
                                }
                            } else {
                                obj.series.push({name: field.name, data: data});
                            }

                            facetMap.set(field.name, obj);
                            _results.push(obj);
                        }

                        // Facet Ranges
                        for (let range of response.ranges) {
                            let obj = {
                                name: range.name,
                                categories: [],
                                series: [],
                            };
                            let data = [];
                            let start = Number(range.start);
                            for (let rangeCount of range.counts) {
                                if(Math.round(start) !== start) {
                                    start = Number(start.toFixed(1));
                                }
                                let end = Number(start + range.gap);
                                if(Math.round(end) !== end) {
                                    end = Number(end.toFixed(1));
                                }
                                obj.categories.push(start + "-" + end);
                                data.push(rangeCount);
                                start = end;
                            }

                            obj.series.push({name: range.name, data: data});

                            facetMap.set(range.name, obj);
                            _results.push(obj);
                        }
                        _this._loading = false;

                        _this.results = _results;
                        _this.$.resultsDiv.render();
                        for (let result of _this.results) {
                            _this.renderPlots("#" + _this.prefix + result.name + "Plot", facetMap.get(result.name));
                        }
                    });
            },
            clearPlots: function () {
                if (typeof this.results !== "undefined" && this.results.length > 0) {
                    for (let result of this.results) {
                        $("#" + this.prefix + result.name + "Plot").remove();
                    }
                    this.results = [];
                }
            },
            clearAll: function () {
                this.clearPlots();
                this.facetFields = [];
                this.facetFieldsName = [];
                this.facetRangeFields = [];
                this.facetRanges = [];
            },
            setPieChart: function (e) {
//                this.plotType = "pie";
//                this.loadPlots();
//              debugger
            },
            renderPlots: function (id, params) {
                $(id).highcharts({
                    credits: {enabled: false},
                    chart: {
                        type: this.plotType
                    },
                    title: {
                        text: params.title || params.name
                    },
                    xAxis: {
                        categories: params.categories
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Total number of Variants'
                        }
                    },
                    tooltip: {
                        headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y:.1f} </b></td></tr>',
                        footerFormat: '</table>',
                        shared: true,
                        useHTML: true
                    },
                    plotOptions: {
                        column: {
                            pointPadding: 0.2,
                            borderWidth: 0
                        }
                    },
                    series: params.series
                });
            },
            _isValidField: function (item) {
                for (let field of this.config.facetFields) {
                    if (field.value == item.value) {
                        return false;
                    }
                }
                return true;
            }
        });
    </script>
</dom-module>
