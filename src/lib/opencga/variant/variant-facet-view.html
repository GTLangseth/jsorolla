<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="../opencga-active-filters.html">

<dom-module id="variant-facet-view">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div>

            <br>
            <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}" alias="{{activeFilterAlias}}"></opencga-active-filters>

            <h4>Total Number of Variants : {{totalVariants}}</h4>

            <div class="panel panel-default col-sm-12">
                <div class="panel-body col-sm-5">
                    <h4>Facet Field</h4>
                    <div style="float: right;">
                        <i class="fa fa-plus-square fa-lg" aria-hidden="true" on-click="addFacets"></i>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-4">
                            <select id="{{prefix}}FacetField" class$="form-control {{prefix}}FilterSelect">
                                <option value="none" selected>Select a field...</option>
                                <template is="dom-repeat" items="{{config.facetFields}}">
                                    <option value="{{item.value}}">{{item.name}}</option>
                                </template>
                            </select>
                        </div>
                        <div class="col-sm-4">
                            <select id="{{prefix}}FacetFieldNested" class$="form-control {{prefix}}FilterSelect">
                                <option value="none" selected>Select Nested field...</option>
                                <template is="dom-repeat" items="{{config.facetFields}}">
                                    <option value="{{item.value}}">{{item.name}}</option>
                                </template>
                            </select>
                        </div>
                    </div>
                    <template is="dom-repeat" items="{{facetFieldsName}}">
                                    <span style="font-size: 14px">
                                        <i class="fa fa-times fa-lg" aria-hidden="true" on-click="removeFacetFields" data-id="{{item.value}}" data-field="field"
                                           style="color: darkred;"></i>
                                        &nbsp;{{item.name}}</span><br>
                    </template>
                </div>

                <div class="panel-body col-sm-7">
                    <h4>Facet Range</h4>
                    <div style="float: right;">
                        <i class="fa fa-plus-square fa-lg" aria-hidden="true" on-click="addFacets"></i>
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-3">
                            <select id="{{prefix}}FacetRangeField" class$="form-control {{prefix}}FilterSelect">
                                <option value="none" selected>Select a field...</option>
                                <template is="dom-repeat" items="{{config.facetRangeFields}}">
                                    <option value="{{item}}">{{item}}</option>
                                </template>
                            </select>
                        </div>
                        <div class="col-sm-8">
                            <input type="text" class$="{{prefix}}FilterTextInput" id="{{prefix}}FacetRangeStart" placeholder="Start">
                            <input type="text" class$="{{prefix}}FilterTextInput" id="{{prefix}}FacetRangeEnd" placeholder="End">
                            <input type="text" class$="{{prefix}}FilterTextInput" id="{{prefix}}FacetRangeGap" placeholder="Interval">
                        </div>
                    </div>
                    <template is="dom-repeat" items="{{facetRangeFields}}">
                                    <span style="font-size: 14px">
                                        <i class="fa fa-times fa-lg" aria-hidden="true" on-click="removeFacetFields" data-id="{{item}}" data-field="range"
                                           style="color: darkred;"></i>
                                        &nbsp;{{item}}</span><br>
                    </template>
                </div>
                <div style="float: right; padding: 0px 0px 5px 0px">
                    <button type="button" class="btn btn-primary" on-click="loadPlots">OK</button>
                </div>
            </div>

            <!-- Facet Plots -->
            <h4>Results:</h4>
            <template is="dom-repeat" items="{{results}}" id="resultsDiv">
                <div id="{{prefix}}{{item.name}}Plot" style="min-width: 310px; height: 400px; margin: 0 auto">
                    {{item.name}}
                    <div class="btn-group" style="float: right">
                        <label class="btn btn-primary">
                            <i class="fa fa-bar-chart" style="padding-right: 5px" title="Bar Chart"></i>
                        </label>
                        <label class="btn btn-primary">
                            <i class="fa fa-pie-chart" style="padding-right: 5px" title="Pie Chart"></i>
                        </label>
                        <label class="btn btn-primary">
                            <i class="fa fa-table" style="padding-right: 5px" title="Tabular View"></i>
                        </label>
                    </div>
                </div>
            </template>

        </div>
    </template>
    <script>
        Polymer({
            is: 'variant-facet-view',
            properties: {
                project: {
                    type: Object
                },
                study: {
                    type: Object
                },
                config: {
                    type: Object
                },
                opencgaClient: {
                    type: Object
                },
                cellbaseClient: {
                    type: Object
                },
                query: {
                    type: Object
                },
                search: {
                    type: Object,
                    observer: 'fetchVariants'
                }
            },
            ready: function () {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "facet" + Utils.randomString(6);
                }

                this.activeFilterAlias = {
                    "annot-xref": "XRef",
                    "annot-biotype": "Biotype",
                    "annot-ct": "Consequence Types",
                    "annot-population-maf": "Population Frequency",
                    "annot-functional-score": "CADD",
                    "protein_substitution": "Protein Substitution",
                    "annot-go": "GO",
                    "annot-hpo": "HPO"
                };

                this.facetFields = [];
                this.facetFieldsName = [];
                this.facetRangeFields = [];
                this.facetRanges = [];
            },
            addFacets: function () {
                // Facets
                if (this.$$("#" + this.prefix + "FacetField").value != "none") {
                    // Check if the nested field is a valid value
                    if (this.$$("#" + this.prefix + "FacetFieldNested").value != "none"
                        && this.$$("#" + this.prefix + "FacetFieldNested").value != this.$$("#" + this.prefix + "FacetField").value) {
                        // Take it into account only if it is not present already in the selected values
                        if (this.facetFields.indexOf(this.$$("#" + this.prefix + "FacetField").value + ":" + this.$$("#" + this.prefix + "FacetFieldNested").value) == -1) {
                            this.push('facetFieldsName', {
                                name: $( "#" + this.prefix + "FacetField option:selected" ).text() + " >> " + $( "#" + this.prefix + "FacetFieldNested option:selected" ).text(),
                                value: this.$$("#" + this.prefix + "FacetField").value + ":" + this.$$("#" + this.prefix + "FacetFieldNested").value
                            });
                            this.push('facetFields', this.$$("#" + this.prefix + "FacetField").value + ":" + this.$$("#" + this.prefix + "FacetFieldNested").value);
                        }
                    } else {
                        this.push('facetFieldsName', {name: $( "#" + this.prefix + "FacetField option:selected" ).text(), value: this.$$("#" + this.prefix + "FacetField").value});
                        this.push('facetFields', this.$$("#" + this.prefix + "FacetField").value);
                    }
                    this.$$("#" + this.prefix + "FacetField").value = "none";
                    this.$$("#" + this.prefix + "FacetFieldNested").value = "none";
                    // TODO add this to query object [facet-field]
                }

                // Facets Range
                if (this.$$("#" + this.prefix + "FacetRangeField").value != "none" && this.$$("#" + this.prefix + "FacetRangeStart").value != ""
                    && this.$$("#" + this.prefix + "FacetRangeEnd").value != "" && this.$$("#" + this.prefix + "FacetRangeGap").value != "") {
                    // if any of the field is already selected, remove the old value before pushing
                    for (let i = 0; i < this.facetRanges.length; i++) {
                        if (this.facetRanges[i].startsWith(this.$$("#" + this.prefix + "FacetRangeField").value)) {
                            this.splice('facetRanges', i, 1);
                            this.splice('facetRangeFields', i, 1);
                            break;
                        }
                    }
                    let value = this.$$("#" + this.prefix + "FacetRangeField").value.charAt(0).toUpperCase() + this.$$("#" + this.prefix + "FacetRangeField").value.slice(1);
                    this.push('facetRangeFields', value + "[" + this.$$("#" + this.prefix + "FacetRangeStart").value
                        + "," + this.$$("#" + this.prefix + "FacetRangeEnd").value + "], Interval :" + this.$$("#" + this.prefix + "FacetRangeGap").value);
                    this.push('facetRanges', this.$$("#" + this.prefix + "FacetRangeField").value + ":" + this.$$("#" + this.prefix + "FacetRangeStart").value
                        + ":" + this.$$("#" + this.prefix + "FacetRangeEnd").value + ":" + this.$$("#" + this.prefix + "FacetRangeGap").value);
                    this.$$("#" + this.prefix + "FacetRangeField").value = "none";
                    this.$$("#" + this.prefix + "FacetRangeStart").value = "";
                    this.$$("#" + this.prefix + "FacetRangeEnd").value = "";
                    this.$$("#" + this.prefix + "FacetRangeGap").value = "";
                    // TODO add this to query object [facet-range]
                }

            },
            removeFacetFields: function (e) {
                if (e.target.dataset.field == "field") {
                    let index = this.facetFields.indexOf(e.target.dataId);
                    this.splice('facetFields', index, 1);
                    for (let i = 0; i < this.facetFieldsName.length; i++) {
                        if (this.facetFieldsName[i].value == e.target.dataId) {
                            this.splice('facetFieldsName', i, 1);
                            break;
                        }
                    }
                } else if (e.target.dataset.field == "range") {
                    let index = this.facetRangeFields.indexOf(e.target.dataId);
                    this.splice('facetRangeFields', index, 1);
                }
            },
            fetchVariants: function () {
                let queryParams = {
                    sid: this.opencgaClient._config.sessionId,
                    timeout: 60000,
                    summary: true,
                    limit: 1
                };
                Object.assign(queryParams, this.query);

                if (typeof queryParams.studies === "undefined" || queryParams.studies == "" || queryParams.studies.split(new RegExp("[,;]")).length == 1) {
                    queryParams.studies = this.project.alias + ":" + this.study.alias;
                }

                let _this = this;
                this.opencgaClient.variants().query(queryParams, {})
                    .then(function (response) {
                         _this.totalVariants = response.response[0].numTotalResults;
                    });
            },
            loadPlots: function () {
                // TODO call to facet query
                let _results = [];
                let _this = this;
                $.getJSON("facetAllTogether.json", function(response) {
                    debugger
                    if (typeof response.fields !== "undefined" && response.fields.length > 0) {
                        for (let i in response.fields) {
                            _results.push(response.fields[i]);
                        }
                    }
                    if (typeof response.ranges !== "undefined" && response.ranges.length > 0) {
                        for (let i in response.ranges) {
                            _results.push(response.ranges[i]);
                        }
                    }
                    _this.results = _results;
                    _this.$.resultsDiv.render();
                });
            },
            renderPlots: function (id, title) {
                $(id).highcharts({
                    credits: {enabled: false},
//                    chart: {
//                        type: 'column'
//                    },
//                    title: {
//                        text: title
//                    },
//                    xAxis: {
//                        categories: ['Apples', 'Oranges', 'Pears', 'Grapes', 'Bananas']
//                    },
//                    yAxis: {
//                        min: 0,
//                        title: {
//                            text: 'Total fruit consumption'
//                        },
//                        stackLabels: {
//                            enabled: true,
//                            style: {
//                                fontWeight: 'bold',
//                                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
//                            }
//                        }
//                    },
//                    legend: {
//                        align: 'right',
//                        x: -30,
//                        verticalAlign: 'top',
//                        y: 25,
//                        floating: true,
//                        backgroundColor: (Highcharts.theme && Highcharts.theme.background2) || 'white',
//                        borderColor: '#CCC',
//                        borderWidth: 1,
//                        shadow: false
//                    },
//                    tooltip: {
//                        headerFormat: '<b>{point.x}</b><br/>',
//                        pointFormat: '{series.name}: {point.y}<br/>Total: {point.stackTotal}'
//                    },
//                    plotOptions: {
//                        column: {
//                            stacking: 'normal',
//                            dataLabels: {
//                                enabled: true,
//                                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white'
//                            }
//                        }
//                    },
//                    series: [{
//                        name: 'John',
//                        data: [5, 3, 4, 7, 2]
//                    }, {
//                        name: 'Jane',
//                        data: [2, 2, 3, 2, 1]
//                    }, {
//                        name: 'Joe',
//                        data: [3, 4, 4, 2, 5]
//                    }]
                });
            }
        });
    </script>
</dom-module>
