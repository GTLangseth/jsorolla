<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="variant-browser-grid.html">
<link rel="import" href="../opencga-active-filters.html">
<link rel="import" href="../../cellbase/variation/cellbase-variantannotation-view.html">
<link rel="import" href="variant-beacon-network.html">
<link rel="import" href="variant-genome-browser.html">

<dom-module id="variant-prioritization-view">
    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style>
            .nav-pills > .highlight {
                background: whitesmoke;
            }

            .variant-menu-link:hover {
                cursor: pointer;
                background-color: #EEEEEE;
                text-decoration: none;
            }

            .variant-tab-title {
                font-size: 115%;
                font-weight: bold;
            }
        </style>

        <div>
            <br>
            <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}" filters="{{config.filters}}"
                                    filter-bioformat="VARIANT" fixed-filters="{{fixedFilters}}" alias="{{activeFilterAlias}}" refresh="{{search}}">
            </opencga-active-filters>


            <template is="dom-if" if="{{_isPrioritizationMode}}">
                <div id="{{prefix}}LeftToolbar" style="padding-bottom: 0px">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-success variant-prioritization-view-buttons active" data-view="TableResult" on-click="_changeView">
                            <i class="fa fa-table" aria-hidden="true"></i> Table Result
                        </button>
                        <button type="button" class="btn btn-success variant-prioritization-view-buttons" data-view="ClinicalData" on-click="_changeView">
                            <i class="fa fa-user-md" aria-hidden="true"></i> Clinical Data
                        </button>
                        <button type="button" class="btn btn-success variant-prioritization-view-buttons" data-view="GenomeBrowser" on-click="_changeView">
                            <i class="fa fa-list-alt" aria-hidden="true"></i> Genome Browser (Beta)
                        </button>
                    </div>
                </div>
            </template>

            <template is="dom-if" if="{{_isClinicalMode}}">
                <div style="float: left;padding-bottom: 0px" aria-label="...">
                    <span>
                        <i class="fa fa-file-text-o"></i>
                        <a id="{{prefix}}Files" class="variant-menu-link" data-view="TableResult" on-click="_changeView">TABLE RESULT</a>
                    </span>
                        <span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
                        <span>
                        <i class="fa fa-user-md"></i>
                        <a id="{{prefix}}Family" class="variant-menu-link" data-view="ClinicalData" on-click="_changeView">CLINICAL DATA</a>
                    </span>
                        <span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
                        <span>
                        <i class="fa fa-list-alt"></i>
                        <a id="{{prefix}}Browser" class="variant-menu-link" data-view="GenomeBrowser" on-click="_changeView">GENOME BROWSER (Beta)</a>
                    </span>
                        <span>&nbsp;&nbsp;|&nbsp;&nbsp;</span>
                        <span>
                        <i class="fa fa-save"></i>
                        <a id="{{prefix}}Save" class="variant-menu-link" on-click="_savePrioritization">SAVE</a>
                    </span>
                </div>
            </template>
            <br>

            <div>
                <!-- First TAB -->
                <div id="{{prefix}}TableResult" class="variant-prioritization-content">
                    <!-- Variant Browser Grid -->
                    <variant-browser-grid mode="{{mode}}" study="{{study}}" project="{{project}}" prefix="{{prefix}}" opencga-client="{{opencgaClient}}"
                                          cellbase-client="{{cellbaseClient}}" population-frequencies="{{populationFrequencies}}"
                                          samples="{{samples}}" protein-substitution-scores="{{proteinSubstitutionScores}}" consequence-types="{{consequenceTypes}}"
                                          query="[[query]]" search="[[search]]" variant="{{variant}}" on-selected="selectedGene" on-selectvariant="onSelectVariant"
                                          show-select="{{showSelect}}" style="font-size: 12px">
                    </variant-browser-grid>

                    <!-- Bottom tabs with specific variant information -->
                    <div style="padding-top: 20px" hidden$="{{!checkVariant(variant)}}">
                        <h3>Variant: {{variant}}</h3>
                        <div style="padding-top: 20px">
                            <ul id="{{prefix}}ViewTabs" class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active"><a href="#{{prefix}}Annotation" role="tab" data-toggle="tab" class="variant-tab-title">Advanced Annotation</a></li>
                                <li role="presentation"><a href="#{{prefix}}Beacon" role="tab" data-toggle="tab" class="variant-tab-title">Beacon Network</a></li>
                            </ul>

                            <div class="tab-content" style="height: 680px">
                                <!--Annotation Tab-->
                                <div role="tabpanel" class="tab-pane active" id="{{prefix}}Annotation">
                                    <cellbase-variantannotation-view data="{{variant}}" prefix="{{prefix}}" cellbase-client="{{cellbaseClient}}" mode="vertical"
                                                                     hash-fragment-credentials="{{hashFragmentCredentials}}" consequence-types="{{consequenceTypes}}"
                                                                     protein-substitution-scores="{{proteinSubstitutionScores}}" style="font-size: 12px">
                                    </cellbase-variantannotation-view>
                                </div>

                                <!--Beacon network-->
                                <div role="tabpanel" class="tab-pane" id="{{prefix}}Beacon">
                                    <br>
                                    <button class="btn btn-primary" type="button" on-click="triggerBeacon">Search Beacon Network</button>
                                    <a data-toggle="tooltip" title="Beacon Network is a search engine across the world's public beacons. You can find it here - https://beacon-network.org/#/"><i class="fa fa-info-circle" aria-hidden="true"></i></a>
                                    <br><br>
                                    <variant-beacon-network hosts="{{beaconHosts}}" clear="{{variant}}" variant="{{variantToBeacon}}"></variant-beacon-network>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Second TAB -->
                <div id="{{prefix}}ClinicalData" class="variant-prioritization-content" style="display: none">
                    <br>
                    <opencga-sample-comparator opencga-client="{{opencgaClient}}" samples="{{samples}}" variable-sets="{{variableSets}}"></opencga-sample-comparator>
                </div>

                <!-- Third TAB -->
                <div id="{{prefix}}GenomeBrowser" class="variant-prioritization-content" style="display: none">
                    <br>
                    <br>
                    <variant-genome-browser project="{{project}}" study="{{study}}" opencga-client="{{opencgaClient}}" cellbase-client="{{cellbaseClient}}"
                                            query={{query}} search={{search}} region="{{region}}">
                    </variant-genome-browser>
                </div>
            </div>
        </div>
    </template>

    <script>
        Polymer({
            is: 'variant-prioritization-view',
            properties: {
                mode: {
                    type: String
                },
                title: {
                    type: String
                },
                project: {
                    type: Object
                },
                study: {
                    type: Object
                },
                data: {
                    type: Array,
                    value: []
                },
                opencgaClient: {
                    type: Object
                },
                cellbaseClient: {
                    type: Object
                },
                samples: {
                    type: Array
                },
                populationFrequencies: {
                    type: Object
                },
                proteinSubstitutionScores: {
                    type: Object
                },
                consequenceTypes: {
                    type: Object
                },
                beaconHosts: {
                    type: Array
                },
                query: {
                    type: Object,
                    notify: true
                },
                search: {
                    type: Object
                },
                prefix: {
                    type: String
                },
                variant: {
                    type: String,
                    value: "No variant selected"
                }
            },
            ready: function () {

                // To allow more than 'prioritization instance in the same web application we add a prefix to all elements ID
                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "priorview" + Utils.randomString(6);
                }

                this.resultsViewActive = true;

                this.activeFilterAlias = {
                    "annot-xref": "XRef",
                    "annot-biotype": "Biotype",
                    "annot-ct": "Consequence Types",
                    "annot-population-maf": "Population Frequency",
                    "annot-functional-score": "CADD",
                    "protein_substitution": "Protein Substitution",
                    "annot-go": "GO",
                    "annot-hpo": "HPO"
                };

                this._isPrioritizationMode = this.mode === "prioritization";
                this._isClinicalMode = this.mode === "clinical";

                this.showSelect = true;

                this.fixedFilters = ["studies"];
            },
            checkVariant: function(variant) {
                return variant.split(':').length > 2;
            },
            onSelectVariant: function(e) {
                this.variant = e.detail.id;
            },
            selectedGene: function (e) {
                this.fire('propagate', {gene: e.detail.gene});
            },
            _changeView: function(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                $('.variant-prioritization-content').hide(); // hides all content divs
                if (typeof e.target !== "undefined" && typeof e.target.dataset.view !== "undefined") {
                    $("#" + this.prefix + e.target.dataset.view).show(); // get the href and use it find which div to show
                }

                // Show the active button
                $('.variant-prioritization-view-buttons').removeClass("active");
                $(e.target).addClass("active");

                if (e.target.dataset.view === "GenomeBrowser") {
//                    window.location.hash = "genomebrowser";
                }
            },
            triggerBeacon: function (e) {
                this.variantToBeacon = this.variant;
            },
            _savePrioritization: function () {
                alert("Not implemented yet");
            }
        });
    </script>
</dom-module>
