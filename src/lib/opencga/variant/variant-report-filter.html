<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="variant-analysis-selector.html">

<dom-module id="variant-report-filter">
    <template>
        <style is="custom-style" include="jso-styles">
            label {
                padding-top: 10px;
            }
        </style>


        <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">
            <br>

            <!-- Analysis Information -->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleAnalysisHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion" href="#{{prefix}}AnalysisSelector"
                           aria-expanded="true" aria-controls="{{prefix}}AnalysisSelector">
                            Analysis
                        </a>
                    </h4>
                </div>

                <div id="{{prefix}}AnalysisSelector" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleFilterHeading">
                    <div class="panel-body">
                        <label><i class="fa fa-sitemap" aria-hidden="true"></i>Select analysis:</label>
                        <br>
                        <button data-toggle="modal" role="button" data-placement="bottom" data-target$="#{{prefix}}AnalysisBrowser">
                            Browse...
                        </button>
                        <div id="{{prefix}}analysisSelectedDiv" style="display:none">
                            <label>Analysis selected:</label>
                            <input type="text" class$="custom-sized-input {{prefix}}FilterTextInput" placeholder="AN-28" aria-describedby="basic-addon1" disabled>
                        </div>
                        <br>
                        <br>
                        <div id="{{prefix}}analysisResumeDiv" hidden>
                            <input type="checkbox" name="analysisButtons" id="{{prefix}}AnalysisResume" value="analysisResume" class$="{{prefix}}FilterRadio" on-change="showAnalysisResume" style="padding-left: 20px"> Analysis resume<br>
                        </div>
                    </div>
                </div>

            </div>


            <!-- Sample Information -->
            <div class="panel panel-default" id="{{prefix}}SampleInformationDiv" style="display:none">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleInformationHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}SampleInformationContent" aria-expanded="true" aria-controls="{{prefix}}SampleInformationContent">
                            Sample Information
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Sample information">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}SampleInformationContent" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}SampleInformationHeading">
                    <div class="panel-body">
                        <div class="form-group">
                            <label>Select</label>
                            <br>
                            <input type="radio" name="sampleButtons" id="{{prefix}}AllRadio" value="all" class$="{{prefix}}FilterRadio" checked on-change="sampleInfoAll" style="padding-left: 20px"> All<br>
                            <input type="radio" name="sampleButtons" id="{{prefix}}SubsetRadio" value="range" class$="{{prefix}}FilterRadio" on-change="sampleInfoSubset" style="padding-left: 20px"> Subset
                            <div id="{{prefix}}SampleFields" class="panel-body">
                                <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}individualID" value="individualID" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> Individual ID<br>
                                <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}chromosomalGender" value="chromosomalGender" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> Chromosomal Gender<br>
                                <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}yearBirth" value="yearBirth" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> Year of Birth<br>
                                <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}birthPlace" value="birthPlace" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> Birth place<br>
                                <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}ethnicity" value="ethnicity" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> Ethnicity<br>
                                <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}HPO" value="HPO" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> HPO<br>
                                <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}diagnosis" value="diagnosis" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> Diagnosis<br>

                                <!-- SPECIFIC FIELDS FROM VARIABLE SET -->
                                <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" sort="_sortVariables">
                                    <input type="checkbox" name="sampleInfoButtons" id="{{prefix}}{{variable.name}}" value="{{variable.name}}" class$="{{prefix}}FilterRadio" checked disabled on-change="sampleInfoField" style="padding-left: 20px"> {{variable.title}}<br>
                                </template>

                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Prioritization information -->
            <div class="panel panel-default" id="{{prefix}}PrioritizationInformationDiv" style="display:none">
                <div class="panel-heading" role="tab" id="{{prefix}}PrioritizationInformationHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}PrioritizationInformationContent" aria-expanded="true" aria-controls="{{prefix}}PrioritizationInformationContent">
                            Prioritization Information
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Prioritization information">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}PrioritizationInformationContent" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}PrioritizationInformationHeading">
                    <div id="{{prefix}}PrioritizationFields" class="panel-body">
                        <div class="form-group">
                            <label>Select</label>
                            <br>
                            <input type="checkbox" name="prioritizationButtons" id="{{prefix}}VariantsTable" value="variantsTable" class$="{{prefix}}FilterRadio" on-change="showPrioritization" style="padding-left: 20px"> Variants table<br>
                            <input type="checkbox" name="prioritizationButtons" id="{{prefix}}SummaryResults" value="prioritizationSummary" class$="{{prefix}}FilterRadio" checked on-change="showPrioritization" style="padding-left: 20px"> Summary of results<br>
                            <input type="checkbox" name="prioritizationButtons" id="{{prefix}}FilterResume" value="filterResume" class$="{{prefix}}FilterRadio" on-change="showPrioritization" style="padding-left: 20px"> Filter resume<br>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Other information -->
            <div class="panel panel-default" id="{{prefix}}OtherInformationDiv" style="display:none">
                <div class="panel-heading" role="tab" id="{{prefix}}OtherInformationHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}OtherInformationContent" aria-expanded="true" aria-controls="{{prefix}}OtherInformationContent">
                            Other Information
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Other information">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}OtherInformationContent" class="panel-collapse collapse" role="tabpanel" aria-labelledby="{{prefix}}OtherInformationHeading">
                    <div class="panel-body">
                        <div class="form-group">
                            <label>Select</label>
                            <br>
                            <input type="checkbox" name="otherButtons" id="{{prefix}}Conclusions" value="conclusions" class$="{{prefix}}FilterRadio" on-change="selectSamples" style="padding-left: 20px"> Editable conclusions<br>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal dialog for Analysis Browser-->
        <div class="modal fade" id="{{prefix}}AnalysisBrowser" tabindex="-1" role="dialog"
             aria-labelledby="sampleBrowserLabel">
            <div class="modal-dialog modal-lg" role="document" style="width: 1024px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="{{prefix}}AnalysisBrowserLabel">Analysis Selector</h4>
                    </div>
                    <div class="modal-body" style="height: 500px">
                        <variant-analysis-selector></variant-analysis-selector>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" on-click="showReportOptions">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <div style="width: 60%;margin: 0 auto">
            <button type="button" class="btn btn-primary btn-md" style="width: 100%" on-click="onSave">
                <i class="fa fa-floppy-o" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                Save report
            </button>
        </div>
        <br>
        <div style="width: 60%;margin: 0 auto">
            <button type="button" class="btn btn-primary btn-md" style="width: 100%" on-click="onExport">
                <i class="fa fa-file-pdf-o" aria-hidden="true" style="padding: 0px 5px 0px 5px"></i>
                Export report
            </button>

        </div>



    </template>

    <script>
        Polymer({
            is: 'variant-report-filter',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Object,
                    observer: 'updateVariableSets'
                },
                prefix: {
                    type: String
                },
                config: {
                    type: Object
                },
                selection: {
                    type: Object,
                    notify: true
                },
                variables: {
                    type: Array,
                    notify: true
                },
                expReport : {
                    type: Boolean,
                    notify: true
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = Utils.randomString(6);
                }


            },
            updateVariableSets: function () {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                    .then(function (response) {
                        _this.variableSets = response.response[0].result[0].variableSets;
                        if (_this.variableSets.length > 0) {
                            _this.variables = _this.variableSets[0].variables; // setting first one by default
                            _this.filteredVariables = {
                                variableSet: _this.variableSets[0].id,
                                variables: []
                            };
                        } else {
                            _this.variableSets = [{name : "none"}];
                        }
                    })
                    .catch(function () {
                        console.log("Could not obtain the variable sets of the study " + _this.study);
                    });

            },
            _sortVariables: function (a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            },
            sampleInfoField: function () {

                let fields = this.$$("#" + this.prefix + "SampleFields").querySelectorAll("input[type='checkbox']");
                let fieldsAux = [];
                if (fields.length > 0) {
                    for (let i = 0; i < fields.length; i++) {
                        fieldsAux.push({name: fields[i].value , value: fields[i].checked});
                    }
                }

                let _obj = Object.assign({}, this.selection , {sampleInfo: fieldsAux});
                this.selection = _obj;

            },
            sampleInfoAll: function () {
                let fields = this.$$("#" + this.prefix + "SampleFields").querySelectorAll("input[type='checkbox']");
                for (let i = 0; i < fields.length; i++) {
                    $("#" + fields[i].id).prop("checked", true);
                    $("#" + fields[i].id).prop("disabled", true);
                }
                this.sampleInfoField();

            },
            sampleInfoSubset: function () {
                let fields = this.$$("#" + this.prefix + "SampleFields").querySelectorAll("input[type='checkbox']");
                for (let i = 0; i < fields.length; i++) {
                    $("#" + fields[i].id).prop("disabled", false);

                }

            },
            onExport: function () {
                this.expReport = true;
            },
            showReportOptions: function(e){
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed
                $("#" + this.prefix + "analysisSelectedDiv").show();
                $("#" + this.prefix + "SampleInformationDiv").show();
                $("#" + this.prefix + "PrioritizationInformationDiv").show();
                $("#" + this.prefix + "OtherInformationDiv").show();
                $("#" + this.prefix + "analysisResumeDiv").show();


                this.selection = {analysisID: "AN-28"}; // hardcoded!!!!



            },
            showAnalysisResume: function(e){
                e.preventDefault();
                let _obj = Object.assign({}, this.selection , {analysisResume: e.target.checked});
                this.selection = _obj;

            },
            showPrioritization: function(e){
                e.preventDefault();

                let fields = this.$$("#" + this.prefix + "PrioritizationFields").querySelectorAll("input[type='checkbox']");
                let fieldsAux = [];
                if (fields.length > 0) {
                    for (let i = 0; i < fields.length; i++) {
                        fieldsAux.push({name: fields[i].value , value: fields[i].checked});
                    }
                }

                let _obj = Object.assign({}, this.selection , {prioritizationInfo: fieldsAux});
                this.selection = _obj;



                /*                switch (e.target.id) {
                 case (this.prefix + 'VariantsTable'):
                 let _obj = Object.assign({}, this.selection , {summary: e.target.checked});
                 case (this.prefix + 'SummaryResults'):
                 let _obj = Object.assign({}, this.selection , {summary: e.target.checked});
                 case (this.prefix + 'FilterResume'):

                 }
                 this.selection = _obj;*/
            }


        });
    </script>
</dom-module>
