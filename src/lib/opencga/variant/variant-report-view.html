<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->


<dom-module id="variant-report-view">
    <template>
        <style is="custom-style" include="jso-styles">
            label {
                padding-top: 10px;
            }
            .input-group-addon {
                min-width:200px;
                text-align:left;
            }
            .form-control:read-only {
                background-color: white;
            }
        </style>

        <br>
        <div id="{{prefix}}reportDiv" class="panel panel-default" style="overflow-y: auto; height:550px;">
            <div class="panel-body">
                <h2 style="margin: 10px 5px 15px 25px">{{title}} Report</h2>
                <div style="float: right; padding: 0px 0px 10px 5px">
                    <span>{{requestDate}}</span>
                </div>
                <br>

                <!-- Analysis Information -->

                <div style="margin: 10px 5px 15px 50px" class="analysis-information col-sm-12" id="{{prefix}}analysisInformationDiv">
                    <h3>Analysis Information</h3>
                    <hr>
                    <div style="margin: 10px 0px 15px 5px" class="analysis-information" id="{{prefix}}analysisInformationContent">

                        <ul>
                            <div class="form-group row" id="{{prefix}}analysisInformationID">
                                <div class="col-sm-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">Analysis ID</span>
                                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}analysisID" name="analysisID" readonly value="">
                                    </div>
                                </div>

                            </div>

                            <div class="form-group-row" id="{{prefix}}analysisInformationResume" hidden>
                                <div class="col-sm-8">
                                    <table id="tableAnalysisResume" data-search="false" data-show-columns="false" data-pagination="false" data-page-list="[10, 25, 50]"
                                           data-checkbox-header="false" data-maintain-selected="true" style="cursor: pointer;">
                                        <thead style="background-color: #eee"></thead>
                                    </table>
                                </div>
                            </div>
                        </ul>
                    </div>
                </div>
                <br>

                <div style="margin: 10px 5px 15px 50px" class="sample-information col-sm-12" id="{{prefix}}sampleInformationDiv" hidden>
                    <h3>Sample Information</h3>
                    <hr>
                    <!-- Sample information related to individual -->
                    <ul>
                        <div class="form-group row" id="{{prefix}}sampleIDDiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">Sample ID</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}SampleID" name="sampleID" readonly value="HG00097">
                                </div>
                            </div>
                        </div>
                        <div class="form-group row" id="{{prefix}}individualIDDiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">Individual ID</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}IndividualID" name="individualID" readonly value="NUS2344234">
                                </div>
                            </div>
                        </div>
                        <div class="form-group row" id="{{prefix}}chromosomalGenderDiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">Chromosomal Gender</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}ChromosomalGender" name="chromosomalGender" readonly value="XX">
                                </div>
                            </div>
                        </div>
                        <div class="form-group row" id="{{prefix}}yearBirthDiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">Year of birth</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}BirthYear" name="birthYear" readonly value="1982">
                                </div>
                            </div>
                        </div>
                        <div class="form-group row" id="{{prefix}}birthPlaceDiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">Birth place</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}BirthPlace" name="birthPlace" readonly value="Spain">
                                </div>
                            </div>
                        </div>
                        <div class="form-group row" id="{{prefix}}ethnicityDiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">Ethnicity</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}Ethnicity" name="ethnicity" readonly value="white mediterranean">
                                </div>
                            </div>
                        </div>
                        <div class="form-group row" id="{{prefix}}HPODiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">HPO</span>
                                    <textarea class$="form-control {{prefix}}TextInput" id="{{prefix}}HPO" name="HPO"
                                              readonly rows="2" style="resize:none">"HP:0000947"</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row" id="{{prefix}}diagnosisDiv">
                            <div class="col-sm-4">
                                <div class="input-group">
                                    <span class="input-group-addon">Diagnosis</span>
                                    <textarea class$="form-control {{prefix}}TextInput" id="{{prefix}}diagnosis" name="diagnosis"
                                              readonly rows="2" style="resize:none">Disorders of thyroid gland (E00-E07)</textarea>
                                </div>
                            </div>
                        </div>


                        <!-- Sample information related to variable set -->

                        <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" sort="_sortVariables">
                            <div class="form-group row" id="{{prefix}}{{variable.name}}Div">
                                <div class="col-sm-4">
                                    <div class="input-group">
                                        <span class="input-group-addon">{{variable.title}}</span>
                                        <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}{{variable.name}}" readonly name="{{variable.name}}">
                                    </div>
                                </div>
                            </div>
                        </template>

                    </ul>
                </div>


                <div style="margin: 10px 5px 15px 50px" class="prioritization-information col-sm-12" id="{{prefix}}prioritizationInformationDiv" hidden>
                    <h3>Prioritization Information</h3>
                    <hr>

                    <div class="prioritization-summary col-sm-12" id="{{prefix}}variantsTableDiv" hidden>
                        <h4>Variants table</h4>
                        Variants table to be shown here
                    </div>

                    <div class="prioritization-summary col-sm-12" id="{{prefix}}prioritizationSummaryDiv" hidden>
                        <h4>Summary of results</h4>

                        <div class="form-group row">
                            <div class="col-sm-3">
                                <div class="input-group">
                                    <span class="input-group-addon">Total variants</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}totalVariants" name="totalVariants" readonly value="20">
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="input-group">
                                    <span class="input-group-addon">Diagnostic variants</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}diagnosticVariants" name="diagnosticVariants" readonly value="2">
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <div class="col-sm-3">
                                <div class="input-group">
                                    <span class="input-group-addon">VUS</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}vusVariants" name="vusVariants" readonly value="2">
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="input-group">
                                    <span class="input-group-addon">Unexpected variants</span>
                                    <input type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}unexpectedVariants" name="unexpectedVariants" readonly value="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="prioritization-summary col-sm-12" id="{{prefix}}filterResumeDiv" hidden>
                        <h4>Filter resume</h4>
                        For this analysis, the following filters were applied for prioritization:
                        <ul type="square">
                            <li><b>Genomic</b></li>
                            <ul type="disc">
                                <li>Location: <i>chr3</i></li>
                                <li>Biotype: <i>TR_V_gene</i></li>
                                <li>PanelApp: <i>Arthrogryposis</i></li>
                            </ul>
                            <li><b>Clinical</b></li>
                            <ul type="disc">
                                <li>Inheritance: <i>autosomal recessive</i></li>
                            </ul>
                            <li><b>Population frequency</b></li>
                            <ul type="disc">
                                <li>1000 Genomes: <i>MAF < 0.01</i></li>
                                <li>ESP6500: <i>MAF < 0.01</i></li>
                            </ul>
                            <li><b>Impact</b></li>
                            <ul type="disc">
                                <li>Protein Substitution Score: <i>SIFT < 0.05 AND Polyphen >0.95</i></li>
                                <li>Impact: <i>High</i></li>
                                <li>Effect (SO): <i>stop_gained</i></li>
                            </ul>
                            <li><b>Conservation</b></li>
                            <ul type="disc">
                                <li><i>Phylop < 0.01 AND PhastCons < 0.02 AND Gerp < 0.01</i></li>
                            </ul>
                            <li><b>Disease Databases</b>(No filters were applied)</li>
                        </ul>


                    </div>
                </div>


                <div style="margin: 10px 15px 15px 50px" class="other-information col-sm-12" id="{{prefix}}conclusionsDiv" hidden>
                    <h3>Other Information</h3>
                    <hr>
                    <div class="col-sm-10">
                        <textarea type="text" class$="form-control {{prefix}}TextInput" id="{{prefix}}conclusions" name="conclusions" placeholder="Editable conclusions" style="resize:none" row="5" maxlength="300"></textarea>
                    </div>
                </div>


            </div>
        </div>

        <!-- Modal dialog for Variants table-->
        <div class="modal fade" id="{{prefix}}variantsClassificationModal" tabindex="-1" role="dialog"
             aria-labelledby="variantsClassificationLabel" data-backdrop="static" data-keyboard="false">
            <div class="modal-dialog modal-sm" role="document" style="width: 500px;">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">Variants classification</h4>
                    </div>
                    <div class="modal-body" style="height: 200px">
                        <div class="col-sm-12" >
                            <label>Under progress.</label>
                            Variants table to be shown here. User will classify variants as diagnostic, VUS (Variants of Unkown Significance) and Unexpected variants
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>



    </template>

    <script>
        Polymer({
            is: 'variant-report-view',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Object
                },
                prefix: {
                    type: String
                },
                config: {
                    type: Object
                },
                selection: {
                    type: Object,
                    observer: 'fetchSelection'
                },
                title: {
                    type: String,
                    value: ""
                },
                expReport: {
                    type: Boolean,
                    observer: 'handleExportPDF',
                    notify: true
                },
                variables: {
                    type: Array
                },
                analysisSelected: {
                    type: Object
                },

            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = "repView" + Utils.randomString(6);
                }

                let date = new Date();
                this.requestDate = date.toLocaleString();





            },
            fetchSelection: function () {
                console.log(this);
                debugger;

                // AnalysisID
                //if (typeof this.analysisSelected.analysisID !== "undefined" && typeof this.analysisID === "undefined") {
                if (typeof this.analysisSelected.analysisID !== "undefined") {
                    this.$$("#" + this.prefix + "analysisID").value = this.analysisSelected.analysisID;
                    this.analysisID = this.analysisSelected.analysisID;
                    this.$$("#" + this.prefix + "sampleInformationDiv").hidden = false;
                }

                // Analysis resume

                if (typeof this.selection.analysisResume !== "undefined") {


                    $('#tableAnalysisResume').bootstrapTable('destroy');
                    $('#tableAnalysisResume').bootstrapTable({
                        columns: [
                            {
                                field: 'analysisSamples',
                                title: 'Samples'
                            },
                            {
                                field: 'analysisType',
                                title: 'Type of Analysis'
                            },
                            {
                                field: 'analysisDate',
                                title: 'Date'
                            },

                        ],

                    });

                    let _this=this;
                    $('#tableAnalysisResume').bootstrapTable('insertRow',{index:1 , row: {
                        analysisSamples : _this.analysisSelected.analysisSamples,
                        analysisType : _this.analysisSelected.analysisType,
                        analysisDate : _this.analysisSelected.analysisDate
                    }

                    });


                    this.$$("#" + this.prefix + "analysisInformationResume").hidden = ! this.selection.analysisResume;
                }

                // Sample Information
                if (typeof this.selection.sampleInfo !== "undefined") {
                    let _numFalseElements = 0;
                    for (let i = 0; i < this.selection.sampleInfo.length; i++) {
                        this.$$("#" + this.prefix + this.selection.sampleInfo[i].name + "Div").hidden = !this.selection.sampleInfo[i].value;
                        if (this.selection.sampleInfo[i].value == false)
                        {_numFalseElements++;}

                    }

                    if (_numFalseElements == this.selection.sampleInfo.length)
                    {
                        this.$$("#" + this.prefix + "sampleInformationDiv").hidden = true;
                    }
                    else
                    {
                        this.$$("#" + this.prefix + "sampleInformationDiv").hidden = false;
                    }

                }

                // Prioritization Information
                if (typeof this.selection.prioritizationInfo !== "undefined") {
                    let _numFalseElements = 0;
                    for (let i = 0; i < this.selection.prioritizationInfo.length; i++) {
                        if (this.selection.prioritizationInfo[i].name == 'variantsTable' && this.selection.prioritizationInfo[i].value &&
                            this.$$("#" + this.prefix + this.selection.prioritizationInfo[i].name + "Div").hidden)
                        {$('#' + this.prefix + 'variantsClassificationModal').modal("show");}
                        this.$$("#" + this.prefix + this.selection.prioritizationInfo[i].name + "Div").hidden = !this.selection.prioritizationInfo[i].value;
                        if (this.selection.prioritizationInfo[i].value == false)
                        {_numFalseElements++;}


                    }

                    if (_numFalseElements == this.selection.prioritizationInfo.length)
                    {this.$$("#" + this.prefix + "prioritizationInformationDiv").hidden = true;}
                    else
                    {this.$$("#" + this.prefix + "prioritizationInformationDiv").hidden = false;}

                }


                // Editable conclusions
                if (typeof this.selection.conclusions !== "undefined") {
                    this.$$("#" + this.prefix + "conclusionsDiv").hidden = ! this.selection.conclusions;

                }

            },
            print: function(data) {

                var mywindow = window.open('', '', 'height=1000,width=1000');
                mywindow.document.write('<html><head>');
                /* var styles = document.getElementsByTagName('style');

                 mywindow.document.write('<style>');
                 for (var i = 0; i < styles.length; i++) {
                 mywindow.document.write(styles[i].innerHTML);
                 }
                 mywindow.document.write('</style>');*/

                mywindow.document.write('</head><body>');
                mywindow.document.write(data);
                mywindow.document.write('</body></html>');

                mywindow.document.close(); // necessary for IE >= 10
                mywindow.focus(); // necessary for IE >= 10
                mywindow.print();
                mywindow.close();

            },
            _getTextInfo: function() {
                let elem =  this.$$("#" + this.prefix + "sampleInformationDiv").querySelectorAll("input");
                let reportFields = [];
                for (var i = 0; i < elem.length; i++) {
                    reportFields.push({name: elem[i].name , value: elem[i].value});
                }
                this.reportFields = reportFields;

            },
            handleExportPDF: function(e) {
                console.log(this);
                debugger;
                //this._getTextInfo();
                //this.print($('#' + this.prefix + "report")[0].innerHTML);
                this.print(this.$$('#' + this.prefix + "reportDiv").innerHTML);
                this.expReport = false; // Reset export report button again

            },
            _sortVariables: function (a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            },

        });
    </script>
</dom-module>