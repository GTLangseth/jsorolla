<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<dom-module id="variant-sample-grid">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div>
            <div id="{{prefix}}ToolbarLeft" style="float: left;margin: 20px 0px 0px 0px">
                <span style="font-size: 14px">Showing <label>{{from}}-{{to}}</label> of <label>{{numTotalResultsText}}</label> samples</span>
            </div>
            <table id="{{prefix}}SampleSelector" data-search="true" data-show-columns="true"
                   data-page-size="5" data-pagination="true" data-page-list="[5, 10]" style="cursor: pointer">
                <thead style="background-color: #eee"></thead>
            </table>
        </div>
    </template>

    <script>
        Polymer({
            is: 'variant-sample-grid',
            properties: {
                opencgaClient: {
                    type: Object,
                    observer: 'renderFromServer'
                },
                study: {
                    type: Object,
                    observer: 'renderFromServer'
                },
                samples: {
                    type: Array,
                    notify: true
                },
                prefix: {
                    type: String
                },
                filters: {
                    type: Object,
                    observer: "onFilterUpdate"
                },
                search: {
                    type: Object,
                    observer: 'renderFromServer'
                }
            },
            observers: [
                'calculateFilters(filteredVariables.variables.*)'
            ],
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "sample2" + Utils.randomString(6);
                }

//                this.renderFromServer();
                this._initTableColumns();
            },
            attached: function () {
                this.table = $('#' + this.prefix + "SampleSelector");
            },
            renderFromServer: function () {
                let filters = this.search;

                this.from = 1;
                this.to = 5;

                if (typeof this.opencgaClient !== "undefined" && typeof this.study !== "undefined" && this.study.id > 0) {
                    // Make a copy of the samples (if they exist), we will use this private copy until it is assigned to this.samples
                    if (typeof this.samples !== "undefined") {
                        this._samples = this.samples;
                    } else {
                        this._samples = [];
                    }

                    // Check that HTTP protocol is present and complete the URL
                    let opencgaHostUrl = this.opencgaClient.getConfig().host;
                    if (!opencgaHostUrl.startsWith("http://") && !opencgaHostUrl.startsWith("https://")) {
                        opencgaHostUrl = 'http://' + opencgaHostUrl;
                    }
                    opencgaHostUrl += '/webservices/rest/v1/samples/search';

                    let _this = this;
                    $('#' + _this.prefix + 'SampleSelector').bootstrapTable('destroy');
                    $('#' + _this.prefix + "SampleSelector").bootstrapTable({
                        url: opencgaHostUrl,
                        columns: _this._columns,
                        method: 'get',
                        sidePagination: 'server',
                        queryParams: function (params) {
                            let auxParams = {
                                studyId: _this.study.id,
                                lazy: "false",
                                sid: Cookies.get(_this.opencgaClient.getConfig().cookieSessionId),
                                order: params.order,
                                sort: params.sort,
                                limit: params.limit,
                                skip: params.offset
                            };

                            if (typeof filters === "undefined") {
                                filters = {};
                            }
                            return Object.assign(filters, auxParams);
                        },
                        responseHandler: function (response) {
                            if (!_this.hasOwnProperty("numTotalResults")) {
                                _this.numTotalResults = 0;
                            }
                            if (_this.numTotalResults !== response.response[0].numTotalResults
                                && response.response[0].numTotalResults > response.queryOptions.limit) {
                                _this.numTotalResults = response.response[0].numTotalResults;
                            }

                            _this.numTotalResultsText = _this.numTotalResults.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                            return {
                                total: _this.numTotalResults,
                                rows: response.response[0].result
                            };
                        },
                        onClickRow: function (row, element, field) {
                            let index = element[0].getAttribute("data-index");
                            // Check and uncheck actions trigger events that are captured below
                            if (row.state) {
                                $('#' + _this.prefix + "SampleSelector").bootstrapTable('uncheck', index);
                            } else {
                                $('#' + _this.prefix + "SampleSelector").bootstrapTable('check', index);
                            }
                        },
                        onCheck: function (row, elem) {
                            // check sample is not already selected
                            for (let i in _this._samples) {
                                if (_this._samples[i].name === row.name) {
                                    return;
                                }
                            }

                            // we add samples to selected samples
                            _this.push("_samples", row);
                            _this.set('samples', _this._samples.slice());

                            // Map each sample to its associated individual
//                            if (typeof row.individual !== "undefined" && typeof row.individual.id !== "undefined" && row.individual.id !== "-1") {
//                                if (typeof _this.individuals[row.individual.id] === "undefined") {
//                                    _this.individuals[row.individual.id] = [row];
//                                } else {
//                                    _this.individuals[row.individual.id].push(row);
//                                }
//                            }
                        },
                        onUncheck: function (row, elem) {
                            let sampleToDeleteIdx = -1;
                            for (let i in _this.samples) {
                                if (_this.samples[i].name === row.name) {
                                    sampleToDeleteIdx = i;
                                    break;
                                }
                            }

                            if (sampleToDeleteIdx === -1) {
                                return;
                            }

//                            if (typeof row.individual !== "undefined" && typeof row.individual.id !== "undefined"
//                                && row.individual.id !== "-1") {
//                                if (row.individual.id in _this.individuals) {
//                                    let samples = _this.individuals[row.individual.id];
//                                    for (let i in samples) {
//                                        if (row.name === samples[i].name) {
//                                            samples.splice(i, 1);
//                                            break;
//                                        }
//                                    }
//                                    _this.individuals[row.individual.id] = samples;
//                                }
//                            }

                            _this.splice('_samples', sampleToDeleteIdx, 1);
                            _this.set('samples', _this._samples.slice());
                        },
                        onLoadSuccess: function (data) {
                            // Check all already selected rows. Selected samples are stored in this.samples array
                            if (_this.samples !== "undefined") {
                                for (let idx in _this.samples) {
                                    for (let j in data.rows) {
                                        if (_this.samples[idx].name === data.rows[j].name) {
                                            $('#' + _this.prefix + "SampleSelector").bootstrapTable('check', j);
                                            break;
                                        }
                                    }
                                }
                            }
                        },
                        onPageChange: function (page, size) {
                            _this.from = (page - 1) * size + 1;
                            _this.to = page * size;
                        }
                    });

                    this.opencgaClient.studies().info(this.study.id)
                        .then(function (response) {
                            _this.variableSets = response.response[0].result[0].variableSets;
                        })
                        .catch(function () {
                            console.log("Could not obtain the variable sets of the study " + _this.study.id);
                        });
                } else {
                    // Delete table
                    $('#' + this.prefix + "SampleSelector").bootstrapTable('destroy');
                    this.numTotalResults = 0;
                }
            },
            stateFormatter: function (value, row, index) {
                if (typeof this.field.context.samples != "undefined") {
                    for (let idx in this.field.context.samples) {
                        if (this.field.context.samples[idx].name == row.name) {
                            console.log("Family Selector")
                            console.log('#' + this.field.context.prefix + "SampleSelector")
                            console.log($('#' + this.field.context.prefix + "SampleSelector"))

//                            $('#' + this.field.context.prefix + "SampleSelector").bootstrapTable('check', index);
//                            this.field.context.table.bootstrapTable('check', 9);
//                            this.field.context.table.bootstrapTable('check', 7);
//                            Polymer.dom(this.field.context.root).querySelector('#' + this.field.context.prefix + "SampleSelector").bootstrapTable('check', index);
//                            Polymer.dom(this.field.context.root).querySelector('#' + this.field.context.prefix + "SampleSelector").rows[index].setAttribute('class', 'success');
//                            debugger
                            break;
                        }
                    }
                }
            },
            individualFormatter: function (value, row) {
                if (typeof row.individual.name !== "undefined") {
                    return row.individual.name;
                } else {
                    return '-'
                }
            },
            dateFormatter: function (value, row) {
                let pattern = /^(\d\d\d\d)(\d\d)(\d\d)/;
                let matches = pattern.exec(value);
                if (matches) {
                    let [year, month, day] = [matches[1], matches[2] - 1, matches[3]];
                    return year + "-" + month + "-" + day;
                } else {
//                    throw new Error("Invalid string: " + value);
                    return "Invalid date: '" + value + "'";
                }
            },
            diagnosisFormatter: function (value, row) {
                if (row.individual.ontologyTerms.length > 0) {
                    return row.individual.ontologyTerms[1].name;
                } else {
                    return '-';
                }
            },
            fatherFormatter: function (value, row) {
                if (row.individual.fatherId > 0) {
                    return row.individual.fatherId;
                } else {
                    return '-';
                }
            },
            motherFormatter: function (value, row) {
                if (row.individual.motherId > 0) {
                    return row.individual.motherId;
                } else {
                    return '-';
                }
            },
            cellTypeFormatter: function (value, row) {
                return (row.somatic) ? "Somatic" : "Germline";
            },
            /**
             * If filters have been removed, clean the values from the forms.
             */
            onFilterUpdate: function () {
                this.updateForms(this.filters);
            },

            updateForms: function(filters) {
                // This is just to avoid entering here when it has just been initialized
                if (this.prefix === undefined) {
                    return;
                }

                let sampleName = this.$$("#" + this.prefix + "NameTextarea").value;
                if (!filters.hasOwnProperty("name") && sampleName !== undefined && sampleName.length > 0) {
                    this.$$("#" + this.prefix + "NameTextarea").value = "";
                }

                let individual = this.$$("#" + this.prefix + "IndividualTextarea").value;
                if (!filters.hasOwnProperty("individual.id") && individual !== undefined && individual.length > 0) {
                    this.$$("#" + this.prefix + "IndividualTextarea").value = "";
                }

                if (this.filteredVariables.variables.length > 0) {
                    if (!filters.hasOwnProperty("annotation")) {
                        // Remove the filter variableSetId as it won't make more sense.
//                        delete filters.variableSetId;
                        this.set("filteredVariables.variables", []);

                    } else if (filters.annotation.length < this.filteredVariables.variables.length) {
//                        debugger
                        let tmpVariables = [];
                        filters.annotation.forEach(function(variable) {
                            tmpVariables.push(variable);
                        });

                        this.set("filteredVariables.variables", tmpVariables);
                    }
//                    } else if (!filters.hasOwnProperty("variableSetId")) {
//                        // They have removed the variableSetId so all the annotations should be out
//                        delete filters.variables;
//                        this.filteredVariables.variables = [];
//                    }
                }

            },

            /**
             * Read from the values in the forms, and sets the filters.
             */
            calculateFilters: function() {
                let filters = {};
                let sampleName = "";
                let individual = "";

                if (this.$$("#" + this.prefix + "NameTextarea") !== null) {
                    sampleName = this.$$("#" + this.prefix + "NameTextarea").value;
                }
                if (this.$$("#" + this.prefix + "IndividualTextarea") !== null) {
                    individual = this.$$("#" + this.prefix + "IndividualTextarea").value;
                }

                if (sampleName !== undefined && sampleName.length > 0) {
                    filters["name"] = "~" + sampleName;
                }

                if (individual !== undefined && individual.length > 0) {
                    filters["individual.id"] = "~" + individual;
                }

                if (this.filteredVariables.variables !== undefined && this.filteredVariables.variables.length > 0) {
//                    filters["variableSetId"] = this.filteredVariables.variableSet;
                    let annotations = [];
                    this.filteredVariables.variables.forEach(function(variable) {
                        annotations.push(variable);
                    });
                    filters["annotation"] = annotations;
                }
                this.filters = filters;
            },

            onSearch: function () {
                // Convert the filters to an objectParam that can be directly send to the sample search
                let filterParams = {};

                let keys = Object.keys(this.filters);
                for (let i = 0; i < keys.length; i++) {
                    // Some filters can come as an array of things.
                    // annotation = [{name: name, value: Smith}, {name: age, value: >5}]
                    if (Array.isArray(this.filters[keys[i]])) {
                        let myArray = this.filters[keys[i]];

                        let myArrayFilter = [];

                        // The elements in the array can be either an object
                        if (Object.getPrototypeOf(myArray[0]) === Object.prototype) {
                            let myArray = this.filters[keys[i]];
                            for (let j = 0; j < myArray.length; j++) {
                                // TODO: We have to check if the value already has an operand
                                myArrayFilter.push(myArray[j].name + "=" + myArray[j].value);
                            }
                        } else {
                            // Or an array of strings or numbers
                            myArrayFilter = this.filters[keys[i]];
                        }

                        filterParams[keys[i]] = myArrayFilter.join(";");
                    } else {
                        filterParams[keys[i]] = this.filters[keys[i]];
                    }
                }

                if (this.filters.hasOwnProperty("annotation")) {
                    // Add the variable set whose annotations will be queried
                    filterParams["variableSetId"] = this.filteredVariables.variableSet;
                }

                this.search = filterParams;
            },
            _initTableColumns: function () {
                this._columns = [
                    [
                        {
//                            title: 'Select',
                            field: {source: 'state', context: this},
                            checkbox: true,
                            formatter: this.stateFormatter
                        },
                        {
                            title: 'Individual',
                            field: 'individual.id',
                            formatter: this.individualFormatter
                        },
                        {
                            title: 'Sample',
                            field: 'name'
                        },
                        {
                            title: 'Date',
                            field: 'creationDate',
                            formatter: this.dateFormatter
                        },
                        {
                            title: 'Status',
                            field: 'status.name'
                        },
                        {
                            title: 'Gender',
                            field: 'individual.sex'
                        },
                        {
                            title: 'Presumptive diagnosis',
                            formatter: this.diagnosisFormatter
                        },
                        {
                            title: 'Father',
//                            field: 'individual.fatherId',
                            formatter: this.fatherFormatter
                        },
                        {
                            title: 'Mother',
//                            field: 'individual.motherId',
                            formatter: this.motherFormatter
                        },
                        {
                            title: 'Cell Type',
//                            field: 'somatic',
                            formatter: this.cellTypeFormatter
                        }
                    ]
                ];
                return this._columns;
            }
        });
    </script>
</dom-module>
