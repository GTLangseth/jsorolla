<!--
  ~ Copyright 2015 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->


<dom-module id="variant-samples-filter">
    <template>
        <style is="custom-style" include="jso-styles">
            .top-space {
                padding-top: 12px;
            }
        </style>


        <div class="panel-group" id="{{prefix}}Accordion" role="tablist" aria-multiselectable="true">
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleSelectionHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}SampleSelection" aria-expanded="true" aria-controls="{{prefix}}SampleSelection">
                            Sample Selection
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Sample selection">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}SampleSelection" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="{{prefix}}SampleSelectionHeading">
                    <div class="panel-body">
                        <form>
                            <label>Select samples: </label>
                            <br>
                            <input type="radio" name="selectionButtons" id="recentlyRadio" value="recently" class$="{{prefix}}FilterRadio" checked on-change="selectSamples" style="padding-left: 20px"> Recently Uploaded<br>
                            <input type="radio" name="selectionButtons" id="rangeRadio" value="range" class$="{{prefix}}FilterRadio" on-change="selectSamples" style="padding-left: 20px">From
                            <input type="text" id="{{prefix}}fromSamples" class="form-control" placeholder="dd/mm/yyyy" aria-describedby="basic-addon1">
                            To
                            <input type="text" id="{{prefix}}toSamples" class="form-control" placeholder="dd/mm/yyyy" aria-describedby="basic-addon1">
                            <br>
                            <input type="radio" name="selectionButtons" id="allRadio" value="all" class$="{{prefix}}FilterRadio" on-change="selectSamples" style="padding-left: 20px"> All<br>
                            <hr>
                            <input type="checkbox" name="selectionButtons" id="controls" value="controls" class$="{{prefix}}FilterRadio" on-change="selectSamples" style="padding-left: 20px"> Controls<br>

                        </form>
                        <br>
                    </div>
                </div>
            </div>

            <!--Sample characteristics-->
            <div class="panel panel-default">
                <div class="panel-heading" role="tab" id="{{prefix}}SampleGeneralFilterHeading">
                    <h4 class="panel-title">
                        <a class="collapsed" role="button" data-toggle="collapse" data-parent="#{{prefix}}Accordion"
                           href="#{{prefix}}SampleGeneralFilter" aria-expanded="true" aria-controls="{{prefix}}SampleGeneralFilter">
                            Sample Characteristics
                            <div style="float: right" class="tooltip-div">
                                <a data-toggle="tooltip" title="Generic sample filters">
                                    <i class="fa fa-info-circle" aria-hidden="true"></i>
                                </a>
                            </div>
                        </a>
                    </h4>
                </div>
                <div id="{{prefix}}SampleGeneralFilter" class="panel-collapse" role="tabpanel" aria-labelledby="{{prefix}}SampleGeneralFilterHeading">




                    <div class="form-group has-feedback panel-body">


                        <template id="{{prefix}}VariableTemplate" is="dom-repeat" items="{{variables}}" as="variable" sort="_sortVariables">

                            <br>
                            <label for="{{prefix}}{{variable.name}}">{{variable.title}}:</label>
                            <template is="dom-if" if="{{checkVarType(variable, 'TEXT')}}">
                                <!-- TEXT type: include an input text and add suitable regular expression for text-->
                                <!-- http://stackoverflow.com/questions/14237686/disabling-controls-in-bootstrap-->
                                <input type="text" class="form-control" id="{{prefix}}{{variable.name}}" placeholder="{{variable.name}} name" pattern="{{variable.attributes.pattern}}" aria-describedby="basic-addon1">
                            </template>

                            <template is="dom-if" if="{{checkVarType(variable, 'NUMERIC')}}">
                                <!-- NUMERIC type: include an input text and add suitable regular expression for numbers -->
                                <input type="text" class="form-control" id="{{prefix}}{{variable.name}}" placeholder="{{variable.name}} number"
                                       pattern="^[0-9]+$">
                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 0, 1)}}">
                                <!-- CATEGORICAL type, no value: values to be filled in this code -->
                                <!-- Dropdown related to years : fill in with values contained in {{years}} -->
                                <template is="dom-if" if="{{checkType(variable.name,'Year')}}">
                                    <select class="form-control" id="{{prefix}}{{variable.name}}" on-change="checkYears">
                                        <option></option>
                                        <template is="dom-repeat" items="{{years}}">
                                            <option value="{{item}}">{{item}}</option>
                                        </template>
                                    </select>
                                    <div class="help-block with-errors" id="{{prefix}}_errorDiv_{{variable.name}}"></div>
                                </template>

                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 1, 2)}}">
                                <!-- CATEGORICAL type, single value: check box -->
                                <div class="col-sm-9">
                                    <input type="checkbox" id="{{prefix}}{{variable.name}}" style="padding-left: 20px">
                                </div>
                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 2, 3)}}">
                                <!-- CATEGORICAL type, 2 values: radio buttons for selection -->
                                <template is="dom-repeat" items="{{variable.allowedValues}}" as="value">
                                    <div class="form-check form-check-inline">
                                        <label class="form-check-label">
                                            <input id="{{prefix}}{{variable.name}}{{value}}" class="form-check-input" type="radio" name="{{variable.name}}Options"> {{value}} <br>
                                        </label>
                                    </div>
                                </template>
                            </template>

                            <template is="dom-if" if="{{checkCatType(variable, 'CATEGORICAL', 3, 500)}}">
                                <!-- CATEGORICAL type: dropdown: at least three elements in variable.allowedValues -->
                                <select class="form-control" id="{{prefix}}{{variable.name}}">
                                    <option></option>
                                    <template is="dom-repeat" items="{{variable.allowedValues}}">
                                        <option value="{{item}}">{{item}}</option>
                                    </template>
                                </select>
                            </template>

                            <template is="dom-if" if="{{checkVarType(variable, 'BOOLEAN')}}">
                                <!-- BOOLEAN type, 2 values: radio buttons for selection: yes or no -->
                                <div class="form-check form-check-inline">
                                    <label class="form-check-label">
                                        <input id="{{prefix}}{{variable.name}}yes" class="form-check-input" type="radio" name="{{variable.name}}Options"> yes <br>
                                        <input id="{{prefix}}{{variable.name}}no" class="form-check-input" type="radio" name="{{variable.name}}Options"> no <br>
                                    </label>
                                </div>
                            </template>

                        </template>



                        <!--<label>Hospital:</label>
                        <input type="text" id="{{prefix}}hospital" class="form-control" placeholder="Virgen del Rocio" aria-describedby="basic-addon1">

                        <label>Physician:</label>
                        <input type="text" id="{{prefix}}physician" class="form-control" placeholder="Dr. Jesus Florido" aria-describedby="basic-addon1">


                        <label class="top-space">Sample ID:</label>
                        <textarea id="{{prefix}}sampleId" class="form-control clearable" rows="3"
                                  placeholder="HG01879, HG01880, HG01881..."
                                  name="sampleId" on-keyup="calculateFilters"></textarea>

                        <label class="top-space">Chromosomal Sex:</label>
                        <select class="form-control" id="{{prefix}}chromosomalSexId">
                            <option selected>Choose...</option>
                            <option>46,XX</option>
                            <option>46,XY</option>
                            <option>Other</option>
                            <option>NE</option>
                        </select>
                        <label class="top-space">Year of Birth:</label>
                        <input type="text" class="form-control" id="{{prefix}}yearOfBirthId" placeholder="2017">

                        <label class="top-space">Year of Test:</label>
                        <input type="text" class="form-control" id="{{prefix}}yearOfTestId" placeholder="2017">

                        <label class="top-space">Age:</label>
                        <input type="text" class="form-control" id="{{prefix}}age" placeholder="2017">

                        <label class="top-space">Ethnicity:</label>
                        <select class="form-control" id="{{prefix}}ethnicity">
                            <option selected>Choose...</option>
                            <option>white mediterranean</option>
                            <option>white caucasian</option>
                            <option>black</option>
                            <option>asiatic</option>
                            <option>amerindian</option>
                            <option>gipsy</option>
                            <option>arabic</option>
                            <option>hindu</option>
                            <option>australian native</option>
                            <option>askenazi jew</option>
                            <option>sefardi jew</option>
                            <option>NE/unkown</option>
                        </select>

                        <label class="top-space">Parental Consanguinity:</label>
                        <br>
                        <input type="radio" name="parentalButtons" id="{{prefix}}yesParentalRadio" value="yes" class$="{{prefix}}FilterRadio" checked on-change="selectSamples" style="padding-left: 20px"> yes<br>
                        <input type="radio" name="parentalButtons" id="{{prefix}}noParentalRadio" value="no" class$="{{prefix}}FilterRadio" on-change="selectSamples" style="padding-left: 20px"> no<br>

                        <label class="top-space">Birth place country:</label>
                        <select class="form-control bfh-countries" data-country="Spain" id="{{prefix}}birthPlaceCountry"></select>

                        <label class="top-space">Birth place:</label>
                        <select class="form-control bfh-countries" data-country="Spain" id="{{prefix}}birthPlace"></select>

                        <label class="top-space">Status:</label>
                        <select class="form-control" id="{{prefix}}status">
                            <option selected>Choose...</option>
                            <option>affected</option>
                            <option>parent</option>
                            <option>obligate carrier chr X</option>
                            <option>obligate carrier chr 1-22</option>
                            <option>relative (of an affected individual and different parents)</option>
                            <option>healthy control</option>
                            <option>unknown</option>
                        </select>

                        <label class="top-space">Cell line:</label>
                        <br>
                        <input type="radio" name="cellLineButtons" id="{{prefix}}germlineRadio" value="germline" class$="{{prefix}}FilterRadio" checked on-change="selectSamples" style="padding-left: 20px">Constitutive<br>
                        <input type="radio" name="cellLineButtons" id="{{prefix}}somaticRadio" value="somatic" class$="{{prefix}}FilterRadio" on-change="selectSamples" style="padding-left: 20px">Somatic<br>

                        <label class="top-space">Type of sample:</label>
                        <select class="form-control" id="{{prefix}}sampleType">
                            <option selected>Choose...</option>
                            <option>blood</option>
                            <option>amniotic fluid</option>
                            <option>chorionic villi</option>
                            <option>circulating fetal</option>
                            <option>circulating tumor</option>
                            <option>tissue (fresh)</option>
                            <option>other fluids</option>
                            <option>NE/Unknown</option>
                        </select>

                        <label class="top-space">NGS platform:</label>
                        <input type="text" class="form-control" id="{{prefix}}ngsPlatform" placeholder="Illumina">-->

                    </div>
                </div>
            </div>
        </div>

    </template>

    <script>
        Polymer({
            is: 'variant-samples-filter',
            properties: {
                opencgaClient: {
                    type: Object
                },
                study: {
                    type: Object,
                    observer: 'updateVariableSets'
                },
                samples: {
                    type: Array,
                    notify: true
                },
                prefix: {
                    type: String
                },
                query: {
                    type: Object
                },
                config: {
                    type: Object
                },
                search: {
                    type: Object,
                    observer: 'renderHashQueryParams'
                },
                variableSets: {
                    type: Array
                },
                variables: {
                    type: Array,
                    observer: 'variablesChanged'
                },
                minYear: {
                    type: Number,
                    value: 1920
                }
            },
            ready: function() {
                if (typeof this.prefix === "undefined" || this.prefix == "") {
                    this.prefix = Utils.randomString(6);
                }
                let _years = [];
                let fullDate = new Date()
                let limitYear = fullDate.getFullYear();
                for (let year = this.minYear; year<=limitYear; year++)
                {_years.push(year);}
                // This change triggers the polymer dom-repeat
                this.years = _years;
            },
            updateVariableSets: function () {
                this.variables = [];
                let _this = this;
                this.opencgaClient.studies().info(this.study.id, {include: "variableSets"})
                    .then(function (response) {
                        _this.variableSets = response.response[0].result[0].variableSets;
                        if (_this.variableSets.length > 0) {
                            _this.variables = _this.variableSets[0].variables; // setting first one by default
                            _this.filteredVariables = {
                                variableSet: _this.variableSets[0].id,
                                variables: []
                            };
                        } else {
                            _this.variableSets = [{name : "none"}];
                        }
                    })
                    .catch(function () {
                        console.log("Could not obtain the variable sets of the study " + _this.study);
                    });


            },
            _sortVariables: function (a, b) {
                if (a.rank < b.rank) {
                    return -1;
                }
                return 1;
            },
            variablesChanged: function () {
                this._areVariablesEmpty = (this.variables.length === 0);
            },
            checkVarType: function (myVar, type) {
                return (myVar.type === type);
            },
            checkCatType: function (myVar, type, lowerLimit, upperLimit) {
                return (myVar.type === type && myVar.allowedValues.length >= lowerLimit && myVar.allowedValues.length < upperLimit);
            },
            checkType: function (str1, str2) {
                if (str1.search(str2) != -1)
                {return true;}
                else
                {return false;}

            },
            checkYears: function(e) {
                e.preventDefault(); // prevents the hash change to "#" and allows to manipulate the hash fragment as needed

                $("#" + this.prefix + "_errorDiv_birthYear").html("");
                $("#" + this.prefix + "_errorDiv_testYear").html("");

                let currentElement = $("#"+e.target.id);
                let identifier = e.target.id;
                let pairElement = '';
                let divSuffix = '';
                let message = '';

                if(identifier.search('birthYear')!=-1) // Birth year element raises the event -> check Test year
                {
                    pairElement = $("#" + this.prefix + "testYear");
                    divSuffix = "birthYear";
                    message = "Year of Birth must be prior to year of Test";
                }
                else { // Year of test element raises the event -> swap elements and check the birth year
                    currentElement = $("#" + this.prefix + "birthYear");
                    pairElement = $("#"+e.target.id);
                    divSuffix = "testYear";
                    message = "Year of Test must be posterior to year of Birth";
                }

                if(pairElement.find("option:selected")!='' && (parseInt(currentElement.find("option:selected").text())>parseInt(pairElement.find("option:selected").text())))
                { // Year of birth cannot be lower than Year of test
                    $("#" + this.prefix + "_errorDiv_"+divSuffix).html(message);
                }
            }
        });
    </script>
</dom-module>