<dom-module id="opencga-login">
    <template>
        <!--<custom-style>-->
            <style >
                .basic-margin {
                    width: 300px;
                    margin-left: 20px;
                    margin-right: auto;
                }
                .fields {
                    margin-top: 10px;
                }
            </style>
        <!--</custom-style>-->

        <div class="basic-margin">
            <div class="input-group fields">
                <span class="input-group-addon" id="username">
                    <i class="fa fa-user fa-lg"></i>
                </span>
                <input type="text" id="opencgaUser" value="{{user}}" class="form-control" placeholder="Username" aria-describedby="username"
                       on-keyup="checkEnterKey">
            </div>

            <div class="input-group fields">
                <span class="input-group-addon" id="password">
                    <i class="fa fa-key"></i>
                </span>
                <input id="opencgaPassword" value="{{password}}" type="password" class="form-control" placeholder="Password"
                       aria-describedby="password" on-keyup="checkEnterKey">
            </div>


            <div id="incorrect" hidden="true" style="color: #AF1616;">
                {{errorMessage}}
            </div>

            <div class="fields">
                <button type="button" on-click="login" class="btn btn-primary" style="text-align: center;">{{loginText}}</button>
            </div>
        </div>

    </template>
    <script>
        class OpencgaLogin extends Polymer.Element {

            static get is() { return 'opencga-login'; }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object
                    },
                    loginText: {
                        type: String,
                        value: "Login"
                    },
                    user: {
                        type: String,
                        value: ""
                    },
                    password: {
                        type: String,
                        value: ""
                    }
                }
            }

            constructor() {
                super();
            }
            
            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
            }

            login() {
                let user = this.$.opencgaUser.value;
                let pass = this.$.opencgaPassword.value;

                var _this = this;
                this.opencgaClient.users().login(user, pass)
                    .then(function(response) {
                        _this.$.opencgaUser.value = "";
                        _this.$.opencgaPassword.value = "";
                        _this.$.incorrect.hidden = true;
                        _this.dispatchEvent(new CustomEvent('login', {
                            detail: {
                                userId: user,
                                sessionId: response.response[0].result[0].id
                            }, bubbles: true, composed: true
                        }));
                    })
                    .catch(function(response) {
                        this.errorMessage = response.error;
                        this.$.incorrect.hidden = false;
                    }.bind(this));
            }

            checkEnterKey(e) {
                if (e.keyCode == 13) { // Enter was clicked
                    this.login();
                }
            }
        }

        window.customElements.define(OpencgaLogin.is, OpencgaLogin);
    </script>
</dom-module>
