<dom-module id="opencga-projects">
    <template>
        <style include="jso-styles">
            .center {
                margin: auto;
                text-align: justify;
            }
        </style>
        <div>
            <h2 hidden$="{{hideText}}" class="center">Projects</h2>
            <!--<br>-->
            <table class="table table-bordered center">
                <thead>
                <tr class="table-header bg-primary">
                    <th>Project</th>
                    <th>Study</th>
                    <th>Date</th>
                    <th>Files</th>
                    <th>Samples</th>
                    <!--<th>Jobs</th>-->
                    <!--<th>Individuals</th>-->
                </tr>
                </thead>
                <tbody>
                <template is="dom-repeat" items="{{_studies}}" as="summaries">
                    <template is="dom-repeat" items="{{summaries}}">
                        <tr>
                            <template is="dom-if" if="{{_exists(item.rowspan)}}">
                                <td rowspan$="{{item.rowspan}}">
                                    <a href="#" on-click="fireSelectProject" data-project="{{item._project}}">{{item._project.name}}</a>
                                </td>
                            </template>

                            <td>
                                <a href="#" on-click="fireSelectStudy" data-project="{{item._project}}"
                                   data-study="{{item}}">{{item.name}}</a>
                            </td>
                            <td>{{item.creationDate}}</td>
                            <td>{{item.files}}</td>
                            <td>{{item.samples}}</td>
                            <!--<td>{{item.jobs}}</td>-->
                            <!--<td>{{item.individuals}}</td>-->

                        </tr>
                    </template>
                </template>
                </tbody>
            </table>
        </div>
    </template>
    <script>
        class OpencgaProjects extends Polymer.Element {

            static get is() {
                return 'opencga-projects';
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object
                    },
                    projects: {
                        type: Array,
                        observer: 'projectsChanged'
                    },
                    studySummaries: {
                        type: Array,
                        observer: 'summariesChanged'
                    },
                    /*
                     Auto property is the mode that calls to web service from this component if set to true. By default,
                     it is false (study summaries are given preference over projects)
                     */
                    auto: {
                        type: Boolean,
                        value: false
                    },
                    hideText: {
                        type: Boolean,
                        reflectToAttribute: true,
                        value: false
                    }
                }
            }

            constructor() {
                super();
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();
                this._studies = [];

            }

            connectedCallback() {
                super.connectedCallback();
                this.summariesChanged();
            }

            projectsChanged() {
                if (UtilsNew.isNotUndefined(this.opencgaClient) && this.opencgaClient instanceof OpenCGAClient
                        && UtilsNew.isNotUndefined(this.projects) && this.projects.length > 0) {
                    let _this = this;

                    if (this.auto) {
                        let projectPromises = [];
                        this.projects.forEach(function (project) {
                            let studyPromises = [];
                            project.studies.forEach(function (study) {
                                let studyPromise = _this.opencgaClient.studies().summary(project.alias + ":" + study.alias)
                                        .then(function (response) {
                                            // We add the id to the summary
                                            response.response[0].result[0].id = this.studyId;
                                            response.response[0].result[0].acl = study.acl;
                                            return response;
                                        }.bind({studyId: study.id}));
                                studyPromises.push(studyPromise);
                            });
                            projectPromises.push(Promise.all(studyPromises)
                                    .then(function (responses) {
                                        let studies = [];
                                        responses.forEach(function (response) {
                                            let study = response.response[0].result[0];
                                            study.creationDate = moment(study.creationDate, "YYYYMMDDHHmmss").format('D MMM YY');
                                            studies.push(study);
                                        });
                                        return studies;
                                    }));
                        });

                        let _studySummaries = [];
                        Promise.all(projectPromises)
                                .then(function (responses) {
                                    for (let i = 0; i < responses.length; i++) {
                                        _studySummaries.push({
                                            id: _this.projects[i].id,
                                            alias: _this.projects[i].alias,
                                            name: _this.projects[i].name,
                                            studies: responses[i]
                                        });
                                    }
                                    _this.renderProjectsTable(_studySummaries);
                                });
                    }
                }
            }

            summariesChanged() {
                if (!this.auto) {
                    this.renderProjectsTable(this.studySummaries);
                }
            }

            renderProjectsTable(projects) {
                let summaries = [];
                projects.forEach(function (project) {
                    let data = project.studies;
                    data.forEach(function (study, index) {
                        if (index == 0) {
                            study.rowspan = data.length;
                        }
                        study._project = project;
                    });
                    summaries.push(data);

                });

                this._studies = summaries;
            }

            _exists(data) {
                return data !== undefined;
            }

            fireSelectProject(e) {
                e.preventDefault();
                this.dispatchEvent(new CustomEvent('project', {
                    detail: {project: e.target.dataProject},
                    bubbles: true,
                    composed: true
                }));
            }

            fireSelectStudy(e) {
                e.preventDefault();
                let study = e.target.dataStudy;
                delete study._project;
                this.dispatchEvent(new CustomEvent('study', {
                    detail: {study: study, project: e.target.dataProject},
                    bubbles: true,
                    composed: true
                }));
            }
        }

        customElements.define(OpencgaProjects.is, OpencgaProjects);


    </script>
</dom-module>