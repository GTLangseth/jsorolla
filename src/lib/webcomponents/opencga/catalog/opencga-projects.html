<dom-module id="opencga-projects">
    <template>
        <style is="custom-style" include="jso-styles"></style>
        <style>
            .center {
                margin: auto;
                text-align: justify;
            }
        </style>

        <div>
            <h2 hidden$="{{hideText}}" class="center">Projects</h2>
            <!--<br>-->
            <table class="table table-bordered center">
                <thead>
                    <tr class="table-header bg-primary">
                        <th>Project</th>
                        <th>Study</th>
                        <th>Date</th>
                        <th>Files</th>
                        <th>Samples</th>
                        <!--<th>Jobs</th>-->
                        <!--<th>Individuals</th>-->
                    </tr>
                </thead>
                <tbody>
                    <template is="dom-repeat" items="{{_studies}}" as="summaries">
                        <template is="dom-repeat" items="{{summaries}}">
                            <tr>
                                <template is="dom-if" if="{{_exists(item.rowspan)}}">
                                    <td rowspan$="{{item.rowspan}}">
                                        <a href="#" on-click="fireSelectProject" data-project="{{item._project}}">{{item._project.name}}</a>
                                    </td>
                                </template>

                                <td>
                                    <a href="#" on-click="fireSelectStudy" data-project="{{item._project}}" data-study="{{item}}">{{item.name}}</a>
                                </td>
                                <td>{{item.creationDate}}</td>
                                <td>{{item.files}}</td>
                                <td>{{item.samples}}</td>
                                <!--<td>{{item.jobs}}</td>-->
                                <!--<td>{{item.individuals}}</td>-->

                            </tr>
                        </template>
                    </template>
                </tbody>
            </table>
        </div>
    </template>
    <script>
        Polymer({
            is: 'opencga-projects',
            properties: {
                opencgaClient: {
                    type: Object
                },
                projects: {
                    type: Array,
                    observer: 'projectsChanged'
                },
                studySummaries: {
                    type: Array,
                    observer: 'summariesChanged'
                },
                 /*
                 Auto property is the mode that calls to web service from this component if set to true. By default,
                 it is false (study summaries are given preference over projects)
                 */
                auto: {
                    type: Boolean,
                    value: false
                },
                hideText: {
                    type: Boolean,
                    reflectToAttribute: true,
                    value: false
                }
            },
            ready: function() {
                this._studies = [];
            },
            projectsChanged: function() {
                if (typeof this.opencgaClient !== "undefined" && this.opencgaClient instanceof OpenCGAClient
                        && typeof this.projects !== "undefined" && this.projects.length > 0) {
                    let _this = this;

                    if (this.auto) {
                        let projectPromises = [];
                        this.projects.forEach(function(project) {
                            let studyPromises = [];
                            project.studies.forEach(function(study) {
                                let studyPromise = _this.opencgaClient.studies().summary(project.alias + ":" + study.alias)
                                    .then(function (response) {
                                        // We add the id to the summary
                                        response.response[0].result[0].id = this.studyId;
                                        response.response[0].result[0].acl = study.acl;
                                        return response;
                                    }.bind({studyId: study.id}));
                                studyPromises.push(studyPromise);
                            });
                            projectPromises.push(Promise.all(studyPromises)
                                .then(function(responses) {
                                    let studies = [];
                                    responses.forEach(function (response) {
                                        let study = response.response[0].result[0];
                                        study.creationDate = moment(study.creationDate, "YYYYMMDDHHmmss").format('D MMM YY');
                                        studies.push(study);
                                    });
                                    return studies;
                                }));
                        });

                        let _studySummaries = [];
                        Promise.all(projectPromises)
                            .then(function(responses) {
                                for (let i = 0; i < responses.length; i++) {
                                    _studySummaries.push({id: _this.projects[i].id, alias: _this.projects[i].alias, name: _this.projects[i].name, studies: responses[i]});
                                }
                                _this.renderProjectsTable(_studySummaries);
                            });
                    }
                }
            },
            summariesChanged: function () {
                if (!this.auto) {
                    this.renderProjectsTable(this.studySummaries);
                }
            },
            renderProjectsTable: function(projects) {
                let summaries = [];
                for (let i = 0; i < projects.length; i++) {
                    let data = projects[i].studies;
                    for (let j = 0; j < data.length; j++) {
                        // We only put the rowspan information in the first one so we are sure that we only put the project info once in the table
                        if (j == 0) {
                            data[j].rowspan = data.length;
                        }
                        data[j]._project = projects[i];
                    }
                    summaries.push(data);
                }

                this._studies = summaries;
            },
            _exists: function(data) {
                return data !== undefined;
            },
            fireSelectProject: function (e) {
                e.preventDefault();
                this.fire('project', {project: e.target.dataProject});
            },
            fireSelectStudy: function (e) {
                e.preventDefault();
                let study = e.target.dataStudy;
                delete study._project;
                this.fire('study', {study: study, project: e.target.dataProject});
            }
        });
    </script>
</dom-module>