<dom-module id="variant-beacon-network">
    <template>
        <style is="custom-style" include="jso-styles"></style>

        <div>
            <i class="fa fa-spinner fa-spin" aria-hidden="true" id="{{prefix}}spinGif" style="display:none"></i>
            <table class="table table-bordered" style="width: 50%">
                <thead style="background-color: #eee">
                <tr>
                    <th style="width: 50%">Host</th>
                    <th>Response</th>
                </tr>
                </thead>
                <tbody>
                <template is="dom-repeat" items="{{hosts}}">
                    <tr>
                        <td>{{item}}</td>
                        <td id="{{prefix}}{{item}}" class="beaconResponse"></td>
                    </tr>
                </template>
                </tbody>
            </table>
        </div>

    </template>

    <script>
        Polymer({
            is: 'variant-beacon-network',
            properties: {
                hosts: {
                    type: Array
                },
                variant: {
                    type: String,
                    observer: 'searchBeaconNetwork'
                },
                clear: {
                    type: String,
                    observer: 'clearResponse'
                },
                prefix: {
                    type: String
                }
            },
            ready: function () {
                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "view" + Utils.randomString(6);
                }
            },
            clearResponse: function () {
                // Empty previous response
                $(".beaconResponse").html("");
            },
            searchBeaconNetwork: function () {
                if (this.variant.split(':').length > 2) {
                    let [chromosome, position, reference, alternate] = this.variant.split(':');

                    $('#' + this.prefix + 'spinGif').show();
                    // url to search : https://beacon-network.org/api/responses?allele=C&beacon=[cosmic]&chrom=1&pos=99999&ref=GRCh37
                    // TODO: Assembly is hardcoded for now. It has to be taken care in the future

                    let _this = this;
                    for (let i = 0; i < this.hosts.length; i++) {
                        let xhr = new XMLHttpRequest();
                        // Beacon network uses zero-based numbering hence (position-1) is used in the url.
                        let url = "https://beacon-network.org/api/responses?allele=" + alternate + "&beacon=[" + this.hosts[i] + "]&chrom=" + chromosome
                            + "&pos=" + (position - 1) + "&ref=GRCh37";
                        xhr.onload = function (event) {
                            if (xhr.readyState === xhr.DONE) {
                                if (xhr.status === 200) {
                                    let contentType = xhr.getResponseHeader('Content-Type');
                                    if (contentType === 'application/json') {
                                        let beaconResponse = JSON.parse(xhr.response);
                                        for (let j = 0; j < beaconResponse.length; j++) {
                                            if (beaconResponse[j].response != null) {
                                                let response = beaconResponse[j].response.toString();
                                                $("#" + _this.prefix + _this.hosts[i]).html("" + response.charAt(0).toUpperCase() + response.slice(1));
                                                if (response == "true") {
                                                    $("#" + _this.prefix + _this.hosts[i]).css("color", "red"); // Highlighting the true response in the table
                                                } else {
                                                    $("#" + _this.prefix + _this.hosts[i]).css("color", "black");
                                                }
                                            } else {
                                                $("#" + _this.prefix + _this.hosts[i]).html("False");
                                                $("#" + _this.prefix + _this.hosts[i]).css("color", "black");
                                            }
                                        }
                                        $('#' + _this.prefix + 'spinGif').hide();
                                    }
                                } else {
                                    $("#" + _this.prefix + _this.hosts[i]).html("False (not 200)");
                                }
                            } else {
                                $("#" + _this.prefix + _this.hosts[i]).html("False (No response from server)");
                            }
                        };
                        xhr.open("GET", url, true);
                        xhr.send(null);
                    }
                }
            }
        });
    </script>
</dom-module>