<!--
  ~ Copyright 2015-2016 OpenCB
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<link rel="import" href="variant-sample-grid.html">
<link rel="import" href="../catalog/samples/opencga-sample-filter.html">
<link rel="import" href="../catalog/samples/opencga-family-editor.html">

<dom-module id="variant-sample-selector">
    <template>
        <style include="jso-styles"></style>

        <div>
            <div class="col-md-3">
                <opencga-sample-filter opencga-client="{{opencgaClient}}" query="{{query}}" search="{{search}}"></opencga-sample-filter>
            </div>

            <div class="col-md-9">
                <br>
                <opencga-active-filters opencga-client="{{opencgaClient}}" query="{{query}}" fixed-filters="{{fixedFilters}}"
                                        alias="{{activeFilterAlias}}" refresh="{{search}}" on-clear="onClear" on-filterchange="onFilterChange"></opencga-active-filters>
                <!--<h3>Sample results</h3>-->
                <variant-sample-grid opencga-client="{{opencgaClient}}" study="{{study}}" samples="{{samples}}" search="{{search}}"></variant-sample-grid>

                <!--<template is="dom-if" if="{{isFamilyMode}}">-->
                <div style="padding: 20px 5px">
                    <h3>Family editor</h3>
                    <opencga-family-editor samples="{{samples}}" opencga-client="{{opencgaClient}}"></opencga-family-editor>
                </div>
                <!--</template>-->
            </div>
        </div>
    </template>

    <script>
        class VariantSampleSelector extends Polymer.Element {

            constructor() {
                super();
            }

            static get is() {
                return 'variant-sample-selector';
            }

            static get properties() {
                return {
                    opencgaClient: {
                        type: Object
                    },
                    project: {
                        type: Object
                    },
                    study: {
                        type: Object
//                    observer: 'renderFromServer'
                    },
                    mode: {
                        type: String,
                        value: "sample"
                    },
                    samples: {
                        type: Array,
                        notify: true
                    },
                    family: {
                        type: Object,
                        notify: true
                    },
                    filters: {
                        type: Object,
                        notify: true,
                        observer: "onFilterUpdate"
                    },
                    query: {
                        type: Object
                    },
                    search: {
                        type: Object,
                        notify: true
                    },
                    prefix: {
                        type: String
                    }
                }
            }

            static get observers() {
                return ["calculateFilters(filteredVariables.variables.*)"];
            }

            _attachDom(dom) {
                this.appendChild(dom);
            }

            ready() {
                super.ready();

                if (typeof this.prefix === "undefined" || this.prefix === "") {
                    this.prefix = "Sample" + Utils.randomString(6);
                }

                this.compact = true;

                switch (this.mode) {
                    default:
                    case "sample":
                        this.isSampleMode = true;
                        break;
                    case "family":
                        this.isFamilyMode = true;
                        break;
                    case "cancer":
                        this.isCancerMode = true;
                        break;
                }

                this.fixedFilters = ["studies"];
            }

            connectedCallback() {
                this.table = PolymerUtils.getElementById(this.prefix + "FamilySelector");
            }
//            renderFromServer: function () {
//                let filters = this.search;
//
////                console.log(this.opencgaClient)
////                console.log(this.studyId)
////debugger
////                if (typeof this.table !== "undefined") {
////                    this.table.bootstrapTable('check', 1);
////                    this.table.bootstrapTable('check', 5);
////                    $('#' + this.prefix + "FamilySelector").bootstrapTable('check', 5);
////                }
////                    $('#' + this.prefix + "FamilySelector").bootstrapTable('check', 5);
//
//                if (typeof this.samples !== "undefined") {
//                    this._samples= this.samples;
//                } else {
//                    this._samples = [];
//                }
////
//                let _this = this;
//                if (typeof this.opencgaClient != "undefined" && this.opencgaClient instanceof OpenCGAClient && this.studyId > 0) {
//
//                    if (this.opencgaClient.getConfig().host.startsWith("https://")) {
//                        this._url = this.opencgaClient.getConfig().host;
//                    } else {
//                        this._url = 'http://' + this.opencgaClient.getConfig().host;
//                    }
//
//                    this._url = this._url + '/webservices/rest/v1/samples/search';
////                    $('#' + this.prefix + "FamilySelector").bootstrapTable('destroy');
//                    $('#' + this.prefix + "FamilySelector").bootstrapTable({
//                        url: this._url,
//                        sidePagination: 'server',
//                        queryParams: function (params) {
//                            let auxParams = {
//                                studyId: _this.studyId,
//                                sid: Cookies.get(_this.opencgaClient.getConfig().cookieSessionId),
//                                order: params.order,
//                                sort: params.sort,
//                                limit: params.limit,
//                                skip: params.offset
//                            };
////                            if (params.search !== undefined && params.search.length > 0) {
////                                auxParams["name"] = "~" + params.search;
////                            }
//                            return $.extend({}, filters, auxParams);
//                        },
//                        responseHandler: function (response) {
//                            if (!_this.hasOwnProperty("numTotalResults")) {
//                                _this.numTotalResults = 0;
//                            }
//                            if (_this.numTotalResults !== response.response[0].numTotalResults
//                                && response.response[0].numTotalResults > response.queryOptions.limit) {
//                                _this.numTotalResults = response.response[0].numTotalResults;
//                            }
//
//                            return {
//                                total: _this.numTotalResults,
//                                rows: response.response[0].result
//                            };
//                        },
//                        columns: this._columns,
//
//                        onClickRow: function (row, element, field) {
//                            let index = element[0].getAttribute("data-index");
//                            if (row.state) {
//                                $('#' + _this.prefix + "FamilySelector").bootstrapTable('uncheck', index);
//                            } else {
//                                $('#' + _this.prefix + "FamilySelector").bootstrapTable('check', index);
//                            }
//                        },
//
//                        onCheck: function (row, elem) {
//                            // check sample is not already selected
//                            for (let i in _this._samples) {
//                                if (_this._samples[i].name == row.name) {
//                                    return;
//                                }
//                            }
//
//                            // we add samples to selected samples
//                            _this.push("_samples", row);
//                            _this.set('samples', _this._samples.slice());
//
//                            // Map each sample to its associated individual
//                            if (typeof row.individual !== "undefined" && typeof row.individual.id !== "undefined"
//                                && row.individual.id != "-1") {
//                                if (typeof _this.individuals[row.individual.id] === "undefined") {
//                                    _this.individuals[row.individual.id] = [row];
//                                } else {
//                                    _this.individuals[row.individual.id].push(row);
//                                }
//                            }
//                        },
//
//                        onUncheck: function (row, elem) {
//                            let sampleToDeleteIdx = -1;
//                            for (let i in _this.samples) {
//                                if (_this.samples[i].name == row.name) {
//                                    sampleToDeleteIdx = i;
//                                    break;
//                                }
//                            }
//
//                            if (sampleToDeleteIdx == -1) {
//                                return;
//                            }
//
//                            if (typeof row.individual !== "undefined" && typeof row.individual.id !== "undefined"
//                                && row.individual.id != "-1") {
//                                if (row.individual.id in  _this.individuals) {
//                                    let samples = _this.individuals[row.individual.id];
//                                    for (let i in samples) {
//                                        if (row.name == samples[i].name) {
//                                            samples.splice(i, 1);
//                                            break;
//                                        }
//                                    }
//                                    _this.individuals[row.individual.id] = samples;
//                                }
//                            }
//
//                            _this.splice('_samples', sampleToDeleteIdx, 1);
//                            _this.set('samples', _this._samples.slice());
//                        },
//                        onLoadSuccess: function (data) {
//                            if (_this.samples != "undefined") {
//                                for (let idx in _this.samples) {
//                                    for (let j in data.rows) {
//                                        if (_this.samples[idx].name == data.rows[j].name) {
//                                            $('#' + _this.prefix + "FamilySelector").bootstrapTable('check', j);
//                                            break;
//                                        }
//                                    }
//                                }
//                            }
//                        }
//                    });
//
//                    this.opencgaClient.studies().info(this.studyId)
//                        .then(function (response) {
//                            _this.variableSets = response.response[0].result[0].variableSets;
//                        })
//                        .catch(function () {
//                            console.log("Could not obtain the variable sets of the study " + _this.studyId);
//                        });
//                } else {
//                    // Delete table
//                    $('#' + this.prefix + "FamilySelector").bootstrapTable('destroy');
//                    this.numTotalResults = 0;
//                }
//            },
//            stateFormatter: function (value, row, index) {
//                console.log(this.field)
//                console.log(this.field.context.samples)
////                debugger
//                if (typeof this.field.context.samples != "undefined") {
//                    for (let idx in this.field.context.samples) {
//                        if (this.field.context.samples[idx].name == row.name) {
//                            console.log("Family Selector")
//                            console.log('#' + this.field.context.prefix + "FamilySelector")
//                            console.log($('#' + this.field.context.prefix + "FamilySelector"))
//
////                            $('#' + this.field.context.prefix + "FamilySelector").bootstrapTable('check', index);
////                            this.field.context.table.bootstrapTable('check', 9);
////                            this.field.context.table.bootstrapTable('check', 7);
////                            Polymer.dom(this.field.context.root).querySelector('#' + this.field.context.prefix + "FamilySelector").bootstrapTable('check', index);
////                            Polymer.dom(this.field.context.root).querySelector('#' + this.field.context.prefix + "FamilySelector").rows[index].setAttribute('class', 'success');
////                            debugger
//                            break;
//                        }
//                    }
//                }
//            },
//            probandFormatter: function () {
//                return '<input type="checkbox">';
//            },

            /**
             * If filters have been removed, clean the values from the forms.
             */
            onFilterUpdate() {
                this.updateForms(this.filters);
            }

            updateForms(filters) {
                // This is just to avoid entering here when it has just been initialized
                if (UtilsNew.isUndefined(this.prefix)) {
                    return;
                }

                let sampleName = PolymerUtils.getValue(this.prefix + "NameTextarea");
                if (!filters.hasOwnProperty("name") && UtilsNew.isNotUndefined(sampleName) && sampleName.length > 0) {
                    PolymerUtils.setValue(this.prefix + "NameTextarea", "");
                }

                let individual =  PolymerUtils.getValue(this.prefix + "IndividualTextarea");
                if (!filters.hasOwnProperty("individual.id") && UtilsNew.isNotUndefined(individual) && individual.length > 0) {
                    PolymerUtils.setValue(this.prefix + "IndividualTextarea","");
                }

                if (this.filteredVariables.variables.length > 0) {
                    if (!filters.hasOwnProperty("annotation")) {
                        // Remove the filter variableSetId as it won't make more sense.
//                        delete filters.variableSetId;
                        this.set("filteredVariables.variables", []);

                    } else if (filters.annotation.length < this.filteredVariables.variables.length) {
                        let tmpVariables = [];
                        filters.annotation.forEach(function(variable) {
                            tmpVariables.push(variable);
                        });

                        this.set("filteredVariables.variables", tmpVariables);
                    }

                }

            }

            /**
             * Read from the values in the forms, and sets the filters.
             */
            calculateFilters() {
                let filters = {};
                let sampleName = "";
                let individual = "";

                if (PolymerUtils.getElementById(this.prefix + "NameTextarea") !== null) {
                    sampleName = PolymerUtils.getValue(this.prefix + "NameTextarea");
                }
                if (this.$$("#" + this.prefix + "IndividualTextarea") !== null) {
                    individual = PolymerUtils.getValue(this.prefix + "IndividualTextarea");
                }

                if (UtilsNew.isNotUndefined(sampleName) && sampleName.length > 0) {
                    filters["name"] = "~" + sampleName;
                }

                if (UtilsNew.isNotUndefined(individual) && individual.length > 0) {
                    filters["individual.id"] = "~" + individual;
                }

                if (UtilsNew.isNotUndefined(this.filteredVariables.variables) && this.filteredVariables.variables.length > 0) {
//                    filters["variableSetId"] = this.filteredVariables.variableSet;
                    let annotations = [];
                    this.filteredVariables.variables.forEach(function(variable) {
                        annotations.push(variable);
                    });
                    filters["annotation"] = annotations;
                }
                this.filters = filters;
            }

            onSearch() {
                // Convert the filters to an objectParam that can be directly send to the sample search
                let filterParams = {};

                let keys = Object.keys(this.filters);
                for (let i = 0; i < keys.length; i++) {
                    // Some filters can come as an array of things.
                    // annotation = [{name: name, value: Smith}, {name: age, value: >5}]
                    if (Array.isArray(this.filters[keys[i]])) {
                        let myArray = this.filters[keys[i]];

                        let myArrayFilter = [];

                        // The elements in the array can be either an object
                        if (Object.getPrototypeOf(myArray[0]) === Object.prototype) {
                            let myArray = this.filters[keys[i]];
                            for (let j = 0; j < myArray.length; j++) {
                                // TODO: We have to check if the value already has an operand
                                myArrayFilter.push(myArray[j].name + "=" + myArray[j].value);
                            }
                        } else {
                            // Or an array of strings or numbers
                            myArrayFilter = this.filters[keys[i]];
                        }

                        filterParams[keys[i]] = myArrayFilter.join(";");
                    } else {
                        filterParams[keys[i]] = this.filters[keys[i]];
                    }
                }

                if (this.filters.hasOwnProperty("annotation")) {
                    // Add the variable set whose annotations will be queried
                    filterParams["variableSetId"] = this.filteredVariables.variableSet;
                }

                this.search = filterParams;
            }

            onClear() {
                this.query = {studies: this.project.alias + ":" + this.study.alias};
                this.search = {};
            }

            onFilterChange(e) {
                this.query = e.detail;
                this.search = e.detail;
            }
        }

        customElements.define(VariantSampleSelector.is, VariantSampleSelector);
    </script>
</dom-module>
